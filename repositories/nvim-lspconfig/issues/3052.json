{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Description\r\n\r\n\r\n![1709570613](https://github.com/neovim/nvim-lspconfig/assets/58370433/e674314d-dc92-4f0d-8f4c-e2708eed5ebf)\r\n\r\n\r\nOn nightly, without a `luarc.json`, the suggested default [config](https://github.com/neovim/nvim-lspconfig/blob/c932a56bf25167b1e88d2a1ebe35bb774b41019a/lua/lspconfig/server_configurations/lua_ls.lua#L47) for `lua_ls` is broken.\r\n\r\nWhen a `.luarc.jsonc` is present in the directory of the config, I can complete global \"vim\":\r\n\r\n```jsonc\r\n{\r\n  \"$schema\": \"https://raw.githubusercontent.com/LuaLS/vscode-lua/master/setting/schema.json\",\r\n  \"runtime\": {\r\n    \"version\": \"LuaJIT\",\r\n    // \"path\": [\r\n    //   \"?.lua\",\r\n    //   \"?/init.lua\"\r\n    // ],\r\n    // Important setting:\r\n    \"pathStrict\": true\r\n  },\r\n  \"workspace\": {\r\n    \"library\": [\r\n      // No need to append /lua:\r\n      \"$VIMRUNTIME\",\r\n      //\r\n      \"${3rd}/luv/library\",\r\n      \"${3rd}/busted/library\"\r\n    ],\r\n    \"checkThirdParty\": false\r\n  }\r\n}\r\n```\r\n\r\nWhen I remove `.luarc.jsonc`, the code inside the condition in `on_init` kicks in. As a result, there is no completion for global \"vim\", and warnings appear:\r\n\r\n> Undefined global \"vim\"\r\n\r\nReproduce:\r\n\r\n1. Using the `repro` provided below, open `init.lua`, and observe the warnings.\r\n2. Type `vim.` and press `<c-x><c-o>`. Only text suggestions appear.\r\n\r\nRepeat the steps, switch the handlers:\r\n\r\n```lua\r\nhandlers = {\r\n  lua_ls = lua_ls_handler, -- no warnings!\r\n  -- lua_ls = lua_ls_handler_with_on_init, -- warnings...\r\n},\r\n```\r\n\r\nNightly version: `NVIM v0.10.0-dev-2507+g3df1211eb`\r\n\r\nUsing `0.9.5`, everything works as expected.\r\n\r\nRepro:\r\n\r\n```lua\r\n--[[\r\nUse:\r\n  mkdir ~/.config/repro\r\n  cd ~/.config/repro\r\n\r\n  git init .\r\n  touch init.lua\r\n  add the contents of this file to init.lua\r\n  NVIM_APPNAME=repro nvim init.lua ( no reboot necessary )\r\n\r\nRemove:\r\n  rm -rf ~/.local/share/repro ~/.local/state/repro ~/.local/cache/repro\r\n  rm -rf ~/.config/repro\r\n--]]\r\nlocal function clone(path_to_site)\r\n  local mini_path = path_to_site .. \"pack/deps/start/mini.deps\"\r\n  if not vim.loop.fs_stat(mini_path) then\r\n    vim.cmd('echo \"Installing `mini.deps`\" | redraw')\r\n    local clone_cmd =\r\n      { \"git\", \"clone\", \"--filter=blob:none\", \"https://github.com/echasnovski/mini.deps\", mini_path }\r\n    vim.fn.system(clone_cmd)\r\n    vim.cmd(\"packadd mini.deps | helptags ALL\")\r\n    vim.cmd('echo \"Installed `mini.deps`\" | redraw')\r\n  end\r\nend\r\n\r\n-- Setup lua_ls according to the documentation in nvim-lspconfig\r\n-- NOTE: Do not use on_init... Using this method, \"vim.\" completes correctly\r\nlocal function lua_ls_handler()\r\n  local settings = {\r\n    Lua = {\r\n      runtime = { version = \"LuaJIT\" },\r\n      workspace = {\r\n        checkThirdParty = false,\r\n        library = {\r\n          vim.env.VIMRUNTIME,\r\n          -- Depending on the usage, you might want to add additional paths here.\r\n          -- E.g.: For using `vim.*` functions, add vim.env.VIMRUNTIME/lua.\r\n          -- \"${3rd}/luv/library\"\r\n          -- \"${3rd}/busted/library\",\r\n        },\r\n      },\r\n    },\r\n  }\r\n  require(\"lspconfig\").lua_ls.setup({ settings = settings })\r\nend\r\n\r\n-- Setup lua_ls according to the documentation in nvim-lspconfig\r\n-- without a luarc.json: \"vim.\" does not complete\r\n-- warnings: undefined global \"vim\"\r\nlocal function lua_ls_handler_with_on_init()\r\n  local settings = {\r\n    Lua = {\r\n      -- Tell the language server which version of Lua you're using\r\n      -- (most likely LuaJIT in the case of Neovim)\r\n      runtime = { version = \"LuaJIT\" },\r\n      workspace = { -- Make the server aware of Neovim runtime files\r\n        checkThirdParty = false,\r\n        library = {\r\n          vim.env.VIMRUNTIME,\r\n          -- Depending on the usage, you might want to add additional paths here.\r\n          -- E.g.: For using `vim.*` functions, add vim.env.VIMRUNTIME/lua.\r\n          -- \"${3rd}/luv/library\"\r\n          -- \"${3rd}/busted/library\",\r\n        },\r\n        -- or pull in all of 'runtimepath'. NOTE: this is a lot slower\r\n        -- library = vim.api.nvim_get_runtime_file(\"\", true)\r\n      },\r\n    },\r\n  }\r\n  require(\"lspconfig\").lua_ls.setup({\r\n    on_init = function(client)\r\n      local path = client.workspace_folders[1].name\r\n      if not vim.loop.fs_stat(path .. \"/.luarc.json\") and not vim.loop.fs_stat(path .. \"/.luarc.jsonc\") then\r\n        client.config.settings = vim.tbl_deep_extend(\"force\", client.config.settings, settings)\r\n      end\r\n      return true\r\n    end,\r\n  })\r\nend\r\n\r\n -- package manager\r\nlocal path_to_site = vim.fn.stdpath(\"data\") .. \"/site/\"\r\nclone(path_to_site)\r\nlocal MiniDeps = require(\"mini.deps\")\r\nMiniDeps.setup({ path = { package = path_to_site } })\r\nlocal add, now = MiniDeps.add, MiniDeps.now\r\n\r\nnow(function() -- load plugins\r\n  add(\"folke/tokyonight.nvim\")\r\n  vim.cmd.colorscheme(\"tokyonight\")\r\n\r\n  add(\"nvim-treesitter/nvim-treesitter\")\r\n  require(\"nvim-treesitter.configs\").setup({ ensure_installed = { \"lua\" } })\r\n\r\n  add(\"williamboman/mason.nvim\")\r\n  require(\"mason-registry\"):on(\"package:install:success\", function()\r\n    --- stylua: ignore\r\n    vim.defer_fn(function() vim.cmd(\"LspStart\") end, 100)\r\n  end)\r\n  require(\"mason\").setup()\r\n\r\n  add({ source = \"neovim/nvim-lspconfig\", depends = { \"williamboman/mason-lspconfig.nvim\" } })\r\n  require(\"mason-lspconfig\").setup({\r\n    ensure_installed = { \"lua_ls\" },\r\n    handlers = {\r\n      -- lua_ls = lua_ls_handler,           -- no warnings.\r\n      lua_ls = lua_ls_handler_with_on_init, -- warnings!\r\n    },\r\n  })\r\nend)\r\n```\r\n\r\nRelated:\r\n\r\n1 [Neovim issue, closed](https://github.com/neovim/neovim/issues/27730)\r\n2 [PR luarc](https://github.com/neovim/neovim/pull/24592#issuecomment-1671044254)\r\n3 [nvim-lspconf, undefined variable vim](https://github.com/neovim/nvim-lspconfig/issues/2948)\r\n\r\n\r\n",
    "closed_at": null,
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3052/comments",
    "created_at": "2024-03-04T18:29:16Z",
    "events_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3052/events",
    "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3052",
    "id": 2167473343,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "Something isn't working",
            "id": 1674892761,
            "name": "bug",
            "node_id": "MDU6TGFiZWwxNjc0ODkyNzYx",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/labels/bug"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3052/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDODTQC186BMQS_",
    "number": 3052,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3052/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/nvim-lspconfig",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3052/timeline",
    "title": "On nightly, the default config for lua_ls is broken",
    "updated_at": "2024-03-04T21:58:15Z",
    "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3052",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/58370433?v=4",
        "events_url": "https://api.github.com/users/abeldekat/events{/privacy}",
        "followers_url": "https://api.github.com/users/abeldekat/followers",
        "following_url": "https://api.github.com/users/abeldekat/following{/other_user}",
        "gists_url": "https://api.github.com/users/abeldekat/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/abeldekat",
        "id": 58370433,
        "login": "abeldekat",
        "node_id": "MDQ6VXNlcjU4MzcwNDMz",
        "organizations_url": "https://api.github.com/users/abeldekat/orgs",
        "received_events_url": "https://api.github.com/users/abeldekat/received_events",
        "repos_url": "https://api.github.com/users/abeldekat/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/abeldekat/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/abeldekat/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/abeldekat"
    }
}