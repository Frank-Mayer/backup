{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Description\n\nSubmitting here as I believe the report is directly related to `nvim-lspconfig`.\r\n\r\n## Before the update\r\n\r\n`vim.api.nvim_list_bufs()` returns IDs of buffers.\r\n\r\n## After the update\r\n\r\n`vim.api.nvim_list_bufs()` has duplicated values. \r\n\r\n## Reproduction\r\n\r\nI will be using the following snippet to test the behaviour:\r\n\r\n```lua\r\nfor _, buf_nr in ipairs(vim.api.nvim_list_bufs()) do\r\n    if vim.api.nvim_buf_is_valid(buf_nr) then\r\n        local buf = vim.api.nvim_buf_get_name(buf_nr)\r\n        local buf_nm = vim.fn.expand(buf)\r\n        if buf_nm ~= '' then\r\n            buf_nm = vim.fn.substitute(buf_nm, vim.fn.getcwd(), '', 'g')\r\n            buf_nm = vim.fn.substitute(buf_nm, vim.fn.expand('$HOME'), '~', 'g')\r\n            buf_nm = vim.fs.basename(buf_nm)\r\n            table.insert(bufs_fn_len, string.len(buf_nm))\r\n        end\r\n    end\r\nend\r\nvim.print(bufs_fn_len)\r\n```\r\n\r\nLet's open 8 files via `nvim *.lua` command:\r\n```\r\n:buffers\r\n  2 #    \"ansible.lua\"                  line 3\r\n  3      \"autopairs.lua\"                line 1\r\n  4      \"comments.lua\"                 line 1\r\n  5      \"flash.lua\"                    line 1\r\n  6 %a   \"fzfx.lua\"                     line 62\r\n  7      \"lspconfig.lua\"                line 1\r\n  8      \"mini.lua\"                     line 1\r\n  9      \"themes.lua\"                   line 1\r\n```\r\n\r\n**Without** lspconfig, the output is as expected:\r\n\r\n```\r\n{ 11, 13, 12, 9, 8, 13, 8, 10 }\r\n```\r\n\r\n**With** lspconfig:\r\n\r\n```\r\n{ 11, 13, 12, 9, 8, 13, 8, 10, 7, 11, 7, 11, 8, 14 }\r\n```\r\n\r\nClearly, there are duplicates. Why?",
    "closed_at": "2024-05-18T04:13:15Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "can't reproduce. Please try use minimal first\r\n\r\n```lua\r\nvim.opt.rtp:append(\"~/workspace/nvim-lspconfig\")\r\n\r\nlocal lspconfig = require(\"lspconfig\")\r\n\r\nlspconfig.lua_ls.setup({})\r\n\r\nlocal bufs = {}\r\nfor i = 1, 5 do\r\n\tlocal buf = vim.api.nvim_create_buf(true, false)\r\n\tvim.api.nvim_buf_set_name(buf, \"test_\" .. i)\r\n\tbufs[#bufs + 1] = buf\r\nend\r\n\r\nlocal list_bufs = vim.api.nvim_list_bufs()\r\n--use vim --clean -u min_init.lua\r\nprint(#list_bufs - 1 == #bufs)\r\nprint(vim.inspect(list_bufs), vim.inspect(bufs))\r\n``` ",
            "created_at": "2024-05-18T04:13:15Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3161#issuecomment-2118631323",
            "id": 2118631323,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161",
            "node_id": "IC_kwDODTQC185-R7-b",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2118631323/reactions"
            },
            "updated_at": "2024-05-18T04:13:15Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2118631323",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/41671631?v=4",
                "events_url": "https://api.github.com/users/glepnir/events{/privacy}",
                "followers_url": "https://api.github.com/users/glepnir/followers",
                "following_url": "https://api.github.com/users/glepnir/following{/other_user}",
                "gists_url": "https://api.github.com/users/glepnir/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/glepnir",
                "id": 41671631,
                "login": "glepnir",
                "node_id": "MDQ6VXNlcjQxNjcxNjMx",
                "organizations_url": "https://api.github.com/users/glepnir/orgs",
                "received_events_url": "https://api.github.com/users/glepnir/received_events",
                "repos_url": "https://api.github.com/users/glepnir/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/glepnir/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/glepnir/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/glepnir"
            }
        },
        {
            "author_association": "NONE",
            "body": "@glepnir, the issue was introduces by the inclusion of the `lua_ls`:\r\n\r\n```lua\r\nlspconfig.lua_ls.setup({})\r\n```\r\n\r\n```bash\r\n$ lua-language-server --version\r\n3.7.0\r\n```\r\n\r\nExact reason is still unclear, investigating...",
            "created_at": "2024-05-20T22:21:45Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3161#issuecomment-2121313961",
            "id": 2121313961,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161",
            "node_id": "IC_kwDODTQC185-cK6p",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2121313961/reactions"
            },
            "updated_at": "2024-05-20T22:21:45Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2121313961",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/300146?v=4",
                "events_url": "https://api.github.com/users/savchenko/events{/privacy}",
                "followers_url": "https://api.github.com/users/savchenko/followers",
                "following_url": "https://api.github.com/users/savchenko/following{/other_user}",
                "gists_url": "https://api.github.com/users/savchenko/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/savchenko",
                "id": 300146,
                "login": "savchenko",
                "node_id": "MDQ6VXNlcjMwMDE0Ng==",
                "organizations_url": "https://api.github.com/users/savchenko/orgs",
                "received_events_url": "https://api.github.com/users/savchenko/received_events",
                "repos_url": "https://api.github.com/users/savchenko/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/savchenko/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/savchenko/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/savchenko"
            }
        },
        {
            "author_association": "NONE",
            "body": "@glepnir , \r\n\r\nI have tried the minimal config from your comment verbatim. \r\n\r\n```bash\r\nnvim --clean -u glepnir_conf.lua -- glepnir_conf.lua\r\n```\r\n\r\nit returns:\r\n\r\n```\r\ntrue\r\n{ 1, 2, 3, 4, 5, 6 } { 2, 3, 4, 5, 6 }\r\n```\r\n\r\nNow, slightly more verbose:\r\n\r\n```lua\r\nvim.opt.rtp:append(\"/home/user/.local/share/nvim/lazy/nvim-lspconfig\")\r\n\r\nlocal lspconfig = require(\"lspconfig\")\r\nlibrary = vim.api.nvim_get_runtime_file(\"\", true)\r\nlspconfig.lua_ls.setup({})\r\n\r\nListValidBuffers = function()\r\n    local bufs_fn_len = {}\r\n    for _, buf_nr in ipairs(vim.api.nvim_list_bufs()) do\r\n        if vim.api.nvim_buf_is_valid(buf_nr) then\r\n            local buf = vim.api.nvim_buf_get_name(buf_nr)\r\n            local buf_nm = vim.fn.expand(buf)\r\n            if buf_nm ~= '' then\r\n                buf_nm = vim.fn.substitute(buf_nm, vim.fn.getcwd(), '', 'g')\r\n                buf_nm = vim.fn.substitute(buf_nm, vim.fn.expand('$HOME'), '~', 'g')\r\n                buf_nm = vim.fs.basename(buf_nm)\r\n                local buf_len = string.len(buf_nm)\r\n                if (not bufs_fn_len[buf_len]) then\r\n                    table.insert(bufs_fn_len, buf_len)\r\n                    vim.print('Adding buffer ' .. buf_nm .. ', length ' .. buf_len)\r\n                    vim.print('Content: '.. table.concat(bufs_fn_len, '; '))\r\n                end\r\n            end\r\n        end\r\n    end\r\nend\r\n```\r\n\r\nand:\r\n\r\n```bash\r\nnvim --clean -u debug_conf.lua -- debug_conf.lua\r\n```\r\n\r\nCalling the `ListValidBuffers()` shows `.lua` files under `$PWD` that were not loaded explicitly. Why?\r\n\r\n```\r\nAdding buffer debug_conf.lua, length 14\r\nContent: 14                                                                                              \r\nAdding buffer glepnir_conf.lua, length 16                                                                \r\nContent: 14; 16                                                                                          \r\nAdding buffer lspconfig.lua, length 13                                                                   \r\nContent: 14; 16; 13                                                                                      \r\nAdding buffer abbreviations.lua, length 17                                                               \r\nContent: 14; 16; 13; 17                                                                                  \r\nAdding buffer autocommands.lua, length 16                                                                \r\nContent: 14; 16; 13; 17; 16                                                                              \r\nAdding buffer hotkeys.lua, length 11                                                                     \r\nContent: 14; 16; 13; 17; 16; 11                                                                          \r\nAdding buffer lazy.lua, length 8                                                                         \r\nContent: 14; 16; 13; 17; 16; 11; 8                                                                       \r\nAdding buffer options.lua, length 11                                                                     \r\nContent: 14; 16; 13; 17; 16; 11; 8; 11                                                                   \r\nAdding buffer autosession.lua, length 15                                                                 \r\nContent: 14; 16; 13; 17; 16; 11; 8; 11; 15                                                               \r\nAdding buffer list_buffers.lua, length 16                                                                \r\nContent: 14; 16; 13; 17; 16; 11; 8; 11; 15; 16\r\n```\r\n\r\nHere is the output of `vim.api.nvim_get_runtime_file(\"\", true)`:\r\n\r\n```json\r\n{ \"/usr/share/nvim/runtime\", \"/usr/lib/nvim\", \"/home/user/.local/share/nvim/lazy/nvim-lspconfig\" }\r\n````\r\n\r\nAfter all, this does look like `lua_ls` is influencing `vim.api.nvim_list_bufs()` behaviour.\r\nThis can be reproduced with the latest version of the language server:\r\n\r\n```bash\r\n$ lua-language-server --version\r\n3.9.1\r\n```\r\n\r\nShall this issue be re-opened?",
            "created_at": "2024-05-24T00:08:21Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3161#issuecomment-2128257589",
            "id": 2128257589,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161",
            "node_id": "IC_kwDODTQC185-2qI1",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2128257589/reactions"
            },
            "updated_at": "2024-05-24T00:09:46Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2128257589",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/300146?v=4",
                "events_url": "https://api.github.com/users/savchenko/events{/privacy}",
                "followers_url": "https://api.github.com/users/savchenko/followers",
                "following_url": "https://api.github.com/users/savchenko/following{/other_user}",
                "gists_url": "https://api.github.com/users/savchenko/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/savchenko",
                "id": 300146,
                "login": "savchenko",
                "node_id": "MDQ6VXNlcjMwMDE0Ng==",
                "organizations_url": "https://api.github.com/users/savchenko/orgs",
                "received_events_url": "https://api.github.com/users/savchenko/received_events",
                "repos_url": "https://api.github.com/users/savchenko/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/savchenko/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/savchenko/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/savchenko"
            }
        },
        {
            "author_association": "NONE",
            "body": "This issue has been mentioned on **Neovim Discourse**. There might be relevant details there:\n\nhttps://neovim.discourse.group/t/get-unique-list-of-buffers-odd-behaviour-after-update/4888/3\n",
            "created_at": "2024-05-24T00:14:23Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3161#issuecomment-2128262571",
            "id": 2128262571,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161",
            "node_id": "IC_kwDODTQC185-2rWr",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2128262571/reactions"
            },
            "updated_at": "2024-05-24T00:14:23Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2128262571",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/79666652?v=4",
                "events_url": "https://api.github.com/users/neovim-discourse/events{/privacy}",
                "followers_url": "https://api.github.com/users/neovim-discourse/followers",
                "following_url": "https://api.github.com/users/neovim-discourse/following{/other_user}",
                "gists_url": "https://api.github.com/users/neovim-discourse/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/neovim-discourse",
                "id": 79666652,
                "login": "neovim-discourse",
                "node_id": "MDQ6VXNlcjc5NjY2NjUy",
                "organizations_url": "https://api.github.com/users/neovim-discourse/orgs",
                "received_events_url": "https://api.github.com/users/neovim-discourse/received_events",
                "repos_url": "https://api.github.com/users/neovim-discourse/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/neovim-discourse/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/neovim-discourse/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/neovim-discourse"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161/comments",
    "created_at": "2024-05-18T03:50:35Z",
    "events_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161/events",
    "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3161",
    "id": 2303831922,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "Something isn't working",
            "id": 1674892761,
            "name": "bug",
            "node_id": "MDU6TGFiZWwxNjc0ODkyNzYx",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/labels/bug"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDODTQC186JUa9y",
    "number": 3161,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/nvim-lspconfig",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161/timeline",
    "title": "`vim.api.nvim_list_bufs()` seems to be affected after the update",
    "updated_at": "2024-05-24T00:14:24Z",
    "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/300146?v=4",
        "events_url": "https://api.github.com/users/savchenko/events{/privacy}",
        "followers_url": "https://api.github.com/users/savchenko/followers",
        "following_url": "https://api.github.com/users/savchenko/following{/other_user}",
        "gists_url": "https://api.github.com/users/savchenko/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/savchenko",
        "id": 300146,
        "login": "savchenko",
        "node_id": "MDQ6VXNlcjMwMDE0Ng==",
        "organizations_url": "https://api.github.com/users/savchenko/orgs",
        "received_events_url": "https://api.github.com/users/savchenko/received_events",
        "repos_url": "https://api.github.com/users/savchenko/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/savchenko/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/savchenko/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/savchenko"
    }
}