{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Description\n\nSubmitting here as I believe the report is directly related to `nvim-lspconfig`.\r\n\r\n## Before the update\r\n\r\n`vim.api.nvim_list_bufs()` returns IDs of buffers.\r\n\r\n## After the update\r\n\r\n`vim.api.nvim_list_bufs()` has duplicated values. \r\n\r\n## Reproduction\r\n\r\nI will be using the following snippet to test the behaviour:\r\n\r\n```lua\r\nfor _, buf_nr in ipairs(vim.api.nvim_list_bufs()) do\r\n    if vim.api.nvim_buf_is_valid(buf_nr) then\r\n        local buf = vim.api.nvim_buf_get_name(buf_nr)\r\n        local buf_nm = vim.fn.expand(buf)\r\n        if buf_nm ~= '' then\r\n            buf_nm = vim.fn.substitute(buf_nm, vim.fn.getcwd(), '', 'g')\r\n            buf_nm = vim.fn.substitute(buf_nm, vim.fn.expand('$HOME'), '~', 'g')\r\n            buf_nm = vim.fs.basename(buf_nm)\r\n            table.insert(bufs_fn_len, string.len(buf_nm))\r\n        end\r\n    end\r\nend\r\nvim.print(bufs_fn_len)\r\n```\r\n\r\nLet's open 8 files via `nvim *.lua` command:\r\n```\r\n:buffers\r\n  2 #    \"ansible.lua\"                  line 3\r\n  3      \"autopairs.lua\"                line 1\r\n  4      \"comments.lua\"                 line 1\r\n  5      \"flash.lua\"                    line 1\r\n  6 %a   \"fzfx.lua\"                     line 62\r\n  7      \"lspconfig.lua\"                line 1\r\n  8      \"mini.lua\"                     line 1\r\n  9      \"themes.lua\"                   line 1\r\n```\r\n\r\n**Without** lspconfig, the output is as expected:\r\n\r\n```\r\n{ 11, 13, 12, 9, 8, 13, 8, 10 }\r\n```\r\n\r\n**With** lspconfig:\r\n\r\n```\r\n{ 11, 13, 12, 9, 8, 13, 8, 10, 7, 11, 7, 11, 8, 14 }\r\n```\r\n\r\nClearly, there are duplicates. Why?",
    "closed_at": "2024-05-18T04:13:15Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "can't reproduce. Please try use minimal first\r\n\r\n```lua\r\nvim.opt.rtp:append(\"~/workspace/nvim-lspconfig\")\r\n\r\nlocal lspconfig = require(\"lspconfig\")\r\n\r\nlspconfig.lua_ls.setup({})\r\n\r\nlocal bufs = {}\r\nfor i = 1, 5 do\r\n\tlocal buf = vim.api.nvim_create_buf(true, false)\r\n\tvim.api.nvim_buf_set_name(buf, \"test_\" .. i)\r\n\tbufs[#bufs + 1] = buf\r\nend\r\n\r\nlocal list_bufs = vim.api.nvim_list_bufs()\r\n--use vim --clean -u min_init.lua\r\nprint(#list_bufs - 1 == #bufs)\r\nprint(vim.inspect(list_bufs), vim.inspect(bufs))\r\n``` ",
            "created_at": "2024-05-18T04:13:15Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3161#issuecomment-2118631323",
            "id": 2118631323,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161",
            "node_id": "IC_kwDODTQC185-R7-b",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2118631323/reactions"
            },
            "updated_at": "2024-05-18T04:13:15Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2118631323",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/41671631?v=4",
                "events_url": "https://api.github.com/users/glepnir/events{/privacy}",
                "followers_url": "https://api.github.com/users/glepnir/followers",
                "following_url": "https://api.github.com/users/glepnir/following{/other_user}",
                "gists_url": "https://api.github.com/users/glepnir/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/glepnir",
                "id": 41671631,
                "login": "glepnir",
                "node_id": "MDQ6VXNlcjQxNjcxNjMx",
                "organizations_url": "https://api.github.com/users/glepnir/orgs",
                "received_events_url": "https://api.github.com/users/glepnir/received_events",
                "repos_url": "https://api.github.com/users/glepnir/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/glepnir/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/glepnir/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/glepnir"
            }
        },
        {
            "author_association": "NONE",
            "body": "@glepnir, the issue was introduces by the inclusion of the `lua_ls`:\r\n\r\n```lua\r\nlspconfig.lua_ls.setup({})\r\n```\r\n\r\n```bash\r\n$ lua-language-server --version\r\n3.7.0\r\n```\r\n\r\nExact reason is still unclear, investigating...",
            "created_at": "2024-05-20T22:21:45Z",
            "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3161#issuecomment-2121313961",
            "id": 2121313961,
            "issue_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161",
            "node_id": "IC_kwDODTQC185-cK6p",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2121313961/reactions"
            },
            "updated_at": "2024-05-20T22:21:45Z",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/comments/2121313961",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/300146?v=4",
                "events_url": "https://api.github.com/users/savchenko/events{/privacy}",
                "followers_url": "https://api.github.com/users/savchenko/followers",
                "following_url": "https://api.github.com/users/savchenko/following{/other_user}",
                "gists_url": "https://api.github.com/users/savchenko/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/savchenko",
                "id": 300146,
                "login": "savchenko",
                "node_id": "MDQ6VXNlcjMwMDE0Ng==",
                "organizations_url": "https://api.github.com/users/savchenko/orgs",
                "received_events_url": "https://api.github.com/users/savchenko/received_events",
                "repos_url": "https://api.github.com/users/savchenko/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/savchenko/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/savchenko/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/savchenko"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161/comments",
    "created_at": "2024-05-18T03:50:35Z",
    "events_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161/events",
    "html_url": "https://github.com/neovim/nvim-lspconfig/issues/3161",
    "id": 2303831922,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "Something isn't working",
            "id": 1674892761,
            "name": "bug",
            "node_id": "MDU6TGFiZWwxNjc0ODkyNzYx",
            "url": "https://api.github.com/repos/neovim/nvim-lspconfig/labels/bug"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDODTQC186JUa9y",
    "number": 3161,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/nvim-lspconfig",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161/timeline",
    "title": "`vim.api.nvim_list_bufs()` seems to be affected after the update",
    "updated_at": "2024-05-20T22:21:47Z",
    "url": "https://api.github.com/repos/neovim/nvim-lspconfig/issues/3161",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/300146?v=4",
        "events_url": "https://api.github.com/users/savchenko/events{/privacy}",
        "followers_url": "https://api.github.com/users/savchenko/followers",
        "following_url": "https://api.github.com/users/savchenko/following{/other_user}",
        "gists_url": "https://api.github.com/users/savchenko/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/savchenko",
        "id": 300146,
        "login": "savchenko",
        "node_id": "MDQ6VXNlcjMwMDE0Ng==",
        "organizations_url": "https://api.github.com/users/savchenko/orgs",
        "received_events_url": "https://api.github.com/users/savchenko/received_events",
        "repos_url": "https://api.github.com/users/savchenko/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/savchenko/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/savchenko/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/savchenko"
    }
}