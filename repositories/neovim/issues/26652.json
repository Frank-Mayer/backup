{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Problem\r\n\r\n```\r\n=================================================================\r\n==38143==ERROR: AddressSanitizer: heap-use-after-free on address 0x000109706cd0 at pc 0x000102d4a374 bp 0x00016d5b8210 sp 0x00016d5b8208\r\nREAD of size 4 at 0x000109706cd0 thread T0\r\n    #0 0x102d4a370 in decor_providers_invoke_win decoration_provider.c:136\r\n    #1 0x102e4a160 in win_update drawscreen.c:1498\r\n    #2 0x102e41b48 in update_screen drawscreen.c:633\r\n    #3 0x103aa294c in normal_redraw normal.c:1347\r\n    #4 0x103a9fd20 in normal_check normal.c:1443\r\n    #5 0x104195ac4 in state_enter state.c:36\r\n    #6 0x103a14218 in normal_enter normal.c:508\r\n    #7 0x10369c37c in main main.c:638\r\n    #8 0x1876750dc  (<unknown module>)\r\n\r\n0x000109706cd0 is located 16 bytes inside of 352-byte region [0x000109706cc0,0x000109706e20)\r\nfreed by thread T0 here:\r\n    #0 0x106066e28 in wrap_realloc+0x9c (libclang_rt.asan_osx_dynamic.dylib:arm64e+0x52e28)\r\n    #1 0x1038ce9e0 in xrealloc memory.c:176\r\n    #2 0x102d508d4 in get_decor_provider decoration_provider.c:254\r\n    #3 0x102935ad0 in nvim_set_decoration_provider extmark.c:1022\r\n    #4 0x102864854 in nlua_api_nvim_set_decoration_provider lua_api_c_bindings.generated.c:2968\r\n    #5 0x10481f118 in lj_BC_FUNCC+0x28 (nvim:arm64+0x101fe3118)\r\n    #6 0x1048819cc in lj_cf_package_require lib_package.c:464\r\n    #7 0x10483552c in lua_pcall lj_api.c:1150\r\n    #8 0x10365e5d0 in nlua_typval_exec executor.c:1466\r\n    #9 0x10365ea3c in nlua_typval_call executor.c:1422\r\n    #10 0x10316f1c4 in call_func userfunc.c:1661\r\n    #11 0x10316bba4 in get_func_tv userfunc.c:552\r\n    #12 0x102f4e55c in call_func_rettv eval.c:3354\r\n    #13 0x102f4ce1c in handle_subscript eval.c:7590\r\n    #14 0x102f7d880 in eval7 eval.c:3238\r\n    #15 0x102f79648 in eval6 eval.c:2946\r\n    #16 0x102f773d8 in eval5 eval.c:2801\r\n    #17 0x102f7588c in eval4 eval.c:2676\r\n    #18 0x102f74398 in eval3 eval.c:2585\r\n    #19 0x102f11cd4 in eval2 eval.c:2507\r\n    #20 0x102efcd60 in eval1 eval.c:2411\r\n    #21 0x102ef8de8 in eval0 eval.c:2356\r\n    #22 0x102efe740 in eval_to_string eval.c:991\r\n    #23 0x102eff380 in eval_to_string_safe eval.c:1016\r\n    #24 0x1041c03b0 in build_stl_str_hl statusline.c:1450\r\n    #25 0x1041a9830 in win_redr_custom statusline.c:405\r\n    #26 0x10419f0a8 in redraw_custom_statusline statusline.c:643\r\n    #27 0x10419bbc4 in win_redr_status statusline.c:86\r\n    #28 0x102e41c78 in update_screen drawscreen.c:639\r\n    #29 0x103aa294c in normal_redraw normal.c:1347\r\n\r\npreviously allocated by thread T0 here:\r\n    #0 0x106066e28 in wrap_realloc+0x9c (libclang_rt.asan_osx_dynamic.dylib:arm64e+0x52e28)\r\n    #1 0x1038ce9e0 in xrealloc memory.c:176\r\n    #2 0x102d508d4 in get_decor_provider decoration_provider.c:254\r\n    #3 0x102935ad0 in nvim_set_decoration_provider extmark.c:1022\r\n    #4 0x102864854 in nlua_api_nvim_set_decoration_provider lua_api_c_bindings.generated.c:2968\r\n    #5 0x10481f118 in lj_BC_FUNCC+0x28 (nvim:arm64+0x101fe3118)\r\n    #6 0x1048819cc in lj_cf_package_require lib_package.c:464\r\n    #7 0x1048819cc in lj_cf_package_require lib_package.c:464\r\n    #8 0x1048819cc in lj_cf_package_require lib_package.c:464\r\n    #9 0x1048819cc in lj_cf_package_require lib_package.c:464\r\n    #10 0x10483552c in lua_pcall lj_api.c:1150\r\n    #11 0x10365b8e0 in nlua_exec_file executor.c:1825\r\n    #12 0x103edc64c in do_source runtime.c:2219\r\n    #13 0x1036bf164 in do_user_initialization main.c:1997\r\n    #14 0x1036b46a0 in source_startup_scripts main.c:2110\r\n    #15 0x10369abbc in main main.c:439\r\n    #16 0x1876750dc  (<unknown module>)\r\n\r\nSUMMARY: AddressSanitizer: heap-use-after-free decoration_provider.c:136 in decor_providers_invoke_win\r\nShadow bytes around the buggy address:\r\n  0x000109706a00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x000109706a80: 00 00 00 00 00 fa fa fa fa fa fa fa fa fa fa fa\r\n  0x000109706b00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x000109706b80: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x000109706c00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n=>0x000109706c80: fa fa fa fa fa fa fa fa fd fd[fd]fd fd fd fd fd\r\n  0x000109706d00: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\n  0x000109706d80: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\n  0x000109706e00: fd fd fd fd fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x000109706e80: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x000109706f00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07 \r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n==38143==ABORTING\r\n\r\n```\r\n\r\n### Steps to reproduce\r\n\r\nOnly partial: only included for reference\r\n\r\n- run my config https://github.com/lewis6991/dotfiles\r\n- `CC=clang make CMAKE_FLAGS=\"-DENABLE_ASAN_UBSAN=1\"`\r\n- `VIMRUNTIME=$(pwd)/runtime ./build/bin/nvim <FILE>`\r\n\r\n### Neovim version (nvim -v)\r\n\r\nNVIM v0.10.0-dev-693aea0e9\r\n\r\n### Operating system/version\r\n\r\nmacOS 14.1.1\r\n\r\n### Terminal name/version\r\n\r\nwezterm\r\n\r\n### $TERM environment variable\r\n\r\nwezterm\r\n\r\n### Installation\r\n\r\nsource",
    "closed_at": "2023-12-22T20:27:09Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "This is caused by `require'vim.treesitter'` in a statusline update which adds a decor provider during `win_update()`.\r\n\r\n```lua\r\nE5108: Error executing lua ...ojects/neovim/runtime/lua/vim/treesitter/highlighter.lua:350: cannot set decoration provider\r\nstack traceback:\r\n        [C]: in function 'nvim_set_decoration_provider'\r\n        ...ojects/neovim/runtime/lua/vim/treesitter/highlighter.lua:350: in function 'chunk'\r\n        /Users/lewrus01/projects/pckr.nvim/lua/pckr/loader.lua:49: in function </Users/lewrus01/projects/pckr.nvim/lua/pckr/loader.lua:47>\r\n        [C]: in function 'require'\r\n        .../lewrus01/projects/neovim/runtime/lua/vim/treesitter.lua:16: in function '__index'\r\n        ...1/projects/dotfiles/config/nvim/lua/lewis6991/status.lua:116: in function 'is_treesitter'\r\n        ...1/projects/dotfiles/config/nvim/lua/lewis6991/status.lua:125: in function <...1/projects/dotfiles/config/nvim/lua/lewis6991/status.lua:119>\r\n```\r\n\r\nWill raise a fix to disallow adding providers during redraw.",
            "created_at": "2023-12-19T13:13:12Z",
            "html_url": "https://github.com/neovim/neovim/issues/26652#issuecomment-1862736827",
            "id": 1862736827,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/26652",
            "node_id": "IC_kwDOAPphoM5vBxu7",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1862736827/reactions"
            },
            "updated_at": "2023-12-19T13:13:12Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1862736827",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/26652/comments",
    "created_at": "2023-12-19T12:41:58Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/26652/events",
    "html_url": "https://github.com/neovim/neovim/issues/26652",
    "id": 2048584105,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "0E8A16",
            "default": false,
            "description": "issue contains a stacktrace/ASAN log",
            "id": 435854079,
            "name": "has:backtrace",
            "node_id": "MDU6TGFiZWw0MzU4NTQwNzk=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/has:backtrace"
        },
        {
            "color": "F9D0C4",
            "default": false,
            "description": "issue reporting a crash or segfault",
            "id": 435854234,
            "name": "bug-crash",
            "node_id": "MDU6TGFiZWw0MzU4NTQyMzQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-crash"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "extmarks, decorations, virtual text, namespaces",
            "id": 1680119719,
            "name": "extmarks",
            "node_id": "MDU6TGFiZWwxNjgwMTE5NzE5",
            "url": "https://api.github.com/repos/neovim/neovim/labels/extmarks"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "tabline, winbar, statuscolumn",
            "id": 3385615828,
            "name": "statusline",
            "node_id": "LA_kwDOAPphoM7JzGXU",
            "url": "https://api.github.com/repos/neovim/neovim/labels/statusline"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/26652/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM56Gump",
    "number": 26652,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/26652/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/26652/timeline",
    "title": "`heap-use-after-free` with decor providers",
    "updated_at": "2023-12-22T20:27:09Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/26652",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
        "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
        "followers_url": "https://api.github.com/users/lewis6991/followers",
        "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
        "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/lewis6991",
        "id": 7904185,
        "login": "lewis6991",
        "node_id": "MDQ6VXNlcjc5MDQxODU=",
        "organizations_url": "https://api.github.com/users/lewis6991/orgs",
        "received_events_url": "https://api.github.com/users/lewis6991/received_events",
        "repos_url": "https://api.github.com/users/lewis6991/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/lewis6991"
    }
}