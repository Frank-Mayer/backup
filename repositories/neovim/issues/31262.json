{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Problem\n\nCopilot no longer works after: https://github.com/neovim/neovim/commit/989a37a594649528f28432388c0e7e28e8be2753\n\n```lua\nError executing vim.schedule lua callback: .../.local/share/nvim/lazy/copilot.lua/lua/copilot/util.lua:143: bad argument #1 to 'gsub' (string expected, got nil)\nstack traceback:\n\t[C]: in function 'gsub'\n\t.../.local/share/nvim/lazy/copilot.lua/lua/copilot/util.lua:143: in function 'get_language_id'\n\t...re/bob/nightly/share/nvim/runtime/lua/vim/lsp/client.lua:1030: in function '_text_document_did_open_handler'\n\t...re/bob/nightly/share/nvim/runtime/lua/vim/lsp/client.lua:1049: in function '_on_attach'\n\t...cal/share/bob/nightly/share/nvim/runtime/lua/vim/lsp.lua:665: in function 'buf_attach_client'\n\t...cal/share/bob/nightly/share/nvim/runtime/lua/vim/lsp.lua:272: in function 'lsp_start'\n\t...local/share/nvim/lazy/copilot.lua/lua/copilot/client.lua:100: in function 'buf_attach'\n\t...local/share/nvim/lazy/copilot.lua/lua/copilot/client.lua:254: in function ''\n\tvim/_editor.lua: in function <vim/_editor.lua:0>\n```\n\n\n\n### Steps to reproduce\n\ninstall copilot.lua\n\n### Expected behavior\n\nno error\n\n### Nvim version (nvim -v)\n\nnightly\n\n### Vim (not Nvim) behaves the same?\n\nnope\n\n### Operating system/version\n\nlinux\n\n### Terminal name/version\n\nghostty\n\n### $TERM environment variable\n\nghostty\n\n### Installation\n\nbob",
    "closed_at": "2024-11-19T12:19:07Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
        "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
        "followers_url": "https://api.github.com/users/lewis6991/followers",
        "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
        "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/lewis6991",
        "id": 7904185,
        "login": "lewis6991",
        "node_id": "MDQ6VXNlcjc5MDQxODU=",
        "organizations_url": "https://api.github.com/users/lewis6991/orgs",
        "received_events_url": "https://api.github.com/users/lewis6991/received_events",
        "repos_url": "https://api.github.com/users/lewis6991/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/lewis6991",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "good ðŸ˜ˆ ",
            "created_at": "2024-11-19T07:28:19Z",
            "html_url": "https://github.com/neovim/neovim/issues/31262#issuecomment-2484888603",
            "id": 2484888603,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31262",
            "node_id": "IC_kwDOAPphoM6UHGQb",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 2,
                "rocket": 1,
                "total_count": 3,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2484888603/reactions"
            },
            "updated_at": "2024-11-19T07:28:19Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2484888603",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I'm not sure if this is a bug or not.\nPreviously, the buffer filetype was always passed to `get_language_id`.\nWith the recent changes, this can now be `nil`.\n\nI've created a PR to fix this on the copilot side, but not sure what the intention is here.\n\n@lewis6991? ",
            "created_at": "2024-11-19T07:56:28Z",
            "html_url": "https://github.com/neovim/neovim/issues/31262#issuecomment-2484960724",
            "id": 2484960724,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31262",
            "node_id": "IC_kwDOAPphoM6UHX3U",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2484960724/reactions"
            },
            "updated_at": "2024-11-19T07:56:28Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2484960724",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/292349?v=4",
                "events_url": "https://api.github.com/users/folke/events{/privacy}",
                "followers_url": "https://api.github.com/users/folke/followers",
                "following_url": "https://api.github.com/users/folke/following{/other_user}",
                "gists_url": "https://api.github.com/users/folke/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/folke",
                "id": 292349,
                "login": "folke",
                "node_id": "MDQ6VXNlcjI5MjM0OQ==",
                "organizations_url": "https://api.github.com/users/folke/orgs",
                "received_events_url": "https://api.github.com/users/folke/received_events",
                "repos_url": "https://api.github.com/users/folke/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/folke/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/folke/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/folke",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Thanks. Didn't see get_language_id was called there. I'll look into it. The main intention was to simplify the code but I must have made a mistake.\n\nWeirdly, I use copilot.lua and haven't noticed this yet.",
            "created_at": "2024-11-19T07:59:16Z",
            "html_url": "https://github.com/neovim/neovim/issues/31262#issuecomment-2484965030",
            "id": 2484965030,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31262",
            "node_id": "IC_kwDOAPphoM6UHY6m",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2484965030/reactions"
            },
            "updated_at": "2024-11-19T07:59:52Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2484965030",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "So one change I made was:\n\n```diff\n@@ -342,4 +343,4 @@\n---- @param _bufnr integer\n---- @param filetype string\n-local function default_get_language_id(_bufnr, filetype)\n-  return filetype\n+--- @param bufnr integer\n+--- @param filetype? string\n+local function default_get_language_id(bufnr, filetype)\n+  return filetype or vim.bo[bufnr].filetype\n```\n\nSo the bufnr can be passed to get the filetype. Which I think is harmless.\n\nI think the main problem could be from:\n\n![Image](https://github.com/user-attachments/assets/98e6802e-d047-4f85-8aff-2356a73fa5bd)\n\nWhich changes the filetype resolution to happen within the notification handler. If the current buffer changes, then this could cause a problem. However, `vim.bo.filetype` should always return a string and never `nil`, which suggests something else is going on.\n\nEDIT: just saw your fix. I see the problem now.",
            "created_at": "2024-11-19T10:07:08Z",
            "html_url": "https://github.com/neovim/neovim/issues/31262#issuecomment-2485245173",
            "id": 2485245173,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31262",
            "node_id": "IC_kwDOAPphoM6UIdT1",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2485245173/reactions"
            },
            "updated_at": "2024-11-19T10:08:54Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2485245173",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I'm just going to revert the changes, they were unnecessary and I didn't realise they were breaking. #31266",
            "created_at": "2024-11-19T10:13:13Z",
            "html_url": "https://github.com/neovim/neovim/issues/31262#issuecomment-2485260027",
            "id": 2485260027,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31262",
            "node_id": "IC_kwDOAPphoM6UIg77",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2485260027/reactions"
            },
            "updated_at": "2024-11-19T10:13:13Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2485260027",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7904185?v=4",
                "events_url": "https://api.github.com/users/lewis6991/events{/privacy}",
                "followers_url": "https://api.github.com/users/lewis6991/followers",
                "following_url": "https://api.github.com/users/lewis6991/following{/other_user}",
                "gists_url": "https://api.github.com/users/lewis6991/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lewis6991",
                "id": 7904185,
                "login": "lewis6991",
                "node_id": "MDQ6VXNlcjc5MDQxODU=",
                "organizations_url": "https://api.github.com/users/lewis6991/orgs",
                "received_events_url": "https://api.github.com/users/lewis6991/received_events",
                "repos_url": "https://api.github.com/users/lewis6991/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lewis6991/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lewis6991/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lewis6991",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "ok, great. Thanks!",
            "created_at": "2024-11-19T10:46:08Z",
            "html_url": "https://github.com/neovim/neovim/issues/31262#issuecomment-2485341839",
            "id": 2485341839,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/31262",
            "node_id": "IC_kwDOAPphoM6UI06P",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2485341839/reactions"
            },
            "updated_at": "2024-11-19T10:46:08Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2485341839",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/292349?v=4",
                "events_url": "https://api.github.com/users/folke/events{/privacy}",
                "followers_url": "https://api.github.com/users/folke/followers",
                "following_url": "https://api.github.com/users/folke/following{/other_user}",
                "gists_url": "https://api.github.com/users/folke/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/folke",
                "id": 292349,
                "login": "folke",
                "node_id": "MDQ6VXNlcjI5MjM0OQ==",
                "organizations_url": "https://api.github.com/users/folke/orgs",
                "received_events_url": "https://api.github.com/users/folke/received_events",
                "repos_url": "https://api.github.com/users/folke/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/folke/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/folke/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/folke",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/31262/comments",
    "created_at": "2024-11-19T06:42:24Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/31262/events",
    "html_url": "https://github.com/neovim/neovim/issues/31262",
    "id": 2670943008,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/31262/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM6fM1sg",
    "number": 31262,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/31262/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/31262/timeline",
    "title": "Copilot is broken with recent changes to `get_language_id`",
    "updated_at": "2024-11-19T12:19:07Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/31262",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/292349?v=4",
        "events_url": "https://api.github.com/users/folke/events{/privacy}",
        "followers_url": "https://api.github.com/users/folke/followers",
        "following_url": "https://api.github.com/users/folke/following{/other_user}",
        "gists_url": "https://api.github.com/users/folke/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/folke",
        "id": 292349,
        "login": "folke",
        "node_id": "MDQ6VXNlcjI5MjM0OQ==",
        "organizations_url": "https://api.github.com/users/folke/orgs",
        "received_events_url": "https://api.github.com/users/folke/received_events",
        "repos_url": "https://api.github.com/users/folke/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/folke/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/folke/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/folke",
        "user_view_type": "public"
    }
}