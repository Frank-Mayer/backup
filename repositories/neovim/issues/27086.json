{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nIn certain cases, nvim will abort right before showing command preview if inccommand is set to `split`. In the *Steps to reproduce* section I showed some examples with `:substitute`, but I originally encountered this with a user command preview callback, so I don't think this is `:substitute`-specific.\r\n\r\nIt seems like the culprit here is: \r\nhttps://github.com/neovim/neovim/blob/78b000c74d631fb097bc2ada0c929153f96d9769/src/nvim/ex_getln.c#L2553-L2555\r\nwhich fails when there is an existing buffer with the name `[Preview]`. Setting a breakpoint at line `2922` in `buffer.c` seems to confirm this:\r\nhttps://github.com/neovim/neovim/blob/78b000c74d631fb097bc2ada0c929153f96d9769/src/nvim/buffer.c#L2909-L2926\r\n\r\n\r\n\r\n**Backtrace**:\r\n```c\r\nThread 0 Crashed::  Dispatch queue: com.apple.main-thread\r\n0   libsystem_kernel.dylib        \t       0x196134724 __pthread_kill + 8\r\n1   libsystem_pthread.dylib       \t       0x19616bc28 pthread_kill + 288\r\n2   libsystem_c.dylib             \t       0x196079ae8 abort + 180\r\n3   nvim                          \t       0x1046fbfd8 cmdpreview_may_show + 436 (ex_getln.c:2554)\r\n4   nvim                          \t       0x1046f9520 command_line_changed + 292 (ex_getln.c:2653)\r\n5   nvim                          \t       0x1046fbc58 command_line_handle_key + 4976 (ex_getln.c:2168)\r\n6   nvim                          \t       0x1046f8cb8 command_line_execute + 3960 (ex_getln.c:1385)\r\n7   nvim                          \t       0x104906534 state_enter + 676 (state.c:101)\r\n8   nvim                          \t       0x1046f34b4 command_line_enter + 2168 (ex_getln.c:839)\r\n9   nvim                          \t       0x1046f2c30 getcmdline + 56 (ex_getln.c:2715)\r\n10  nvim                          \t       0x1046f4660 getexline + 108 (ex_getln.c:2958)\r\n11  nvim                          \t       0x1046d6aac do_cmdline + 2116 (ex_docmd.c:525)\r\n12  nvim                          \t       0x1047ef9d4 nv_colon + 472 (normal.c:3223)\r\n13  nvim                          \t       0x1047ecbe4 normal_execute + 2380 (normal.c:1227)\r\n14  nvim                          \t       0x104906534 state_enter + 676 (state.c:101)\r\n15  nvim                          \t       0x1047e81ac normal_enter + 208 (normal.c:516)\r\n16  nvim                          \t       0x10477723c main + 4452 (main.c:651)\r\n17  dyld                          \t       0x195e13f28 start + 2236\r\n```\n\n### Steps to reproduce\n\nThe following two methods consistently cause SIGABRT:\r\n\r\n### Method 1\r\n`nvim --clean \"+set icm=split\"`\r\n\r\n1. Type `:s<esc>` to trigger cmdpreview\r\n2. Set `:set icm=nosplit<CR>`\r\n3. Type `:s<esc>` again to trigger cmdpreview\r\n4. Restore `:set icm=split<CR>`\r\n5. `:s`\r\n\r\nAs soon as `s` is typed in the final step, neovim aborts. Running `:ls!` prior to **(5)**,  a buffer with the name `[Preview]` is listed. Running `:bwipeout <bufnr of [Preview]>` does *not* cause a crash.\r\n\r\n### Method 2\r\n`nvim --clean \"+set icm=split\" '[Preview]'`\r\n\r\n1. `:s`\r\n\r\nNeovim should abort immediately. \n\n### Expected behavior\n\nNo crash\n\n### Neovim version (nvim -v)\n\nv0.10.0-dev-2128+g78b000c74\n\n### Vim (not Nvim) behaves the same?\n\nN/A\n\n### Operating system/version\n\nmacOS 13.4.1\n\n### Terminal name/version\n\nalacritty 0.12.3\n\n### $TERM environment variable\n\ntmux-256color\n\n### Installation\n\nbuild from repo, homebrew",
    "closed_at": "2024-01-19T03:04:03Z",
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "So it seems like the issue is two-fold:\r\n1. `cmdpreview_may_show()` aborts if there is an existing buffer with the name `[Preview]`.\r\n\r\n<br>\r\n\r\n2. After an initial preview with `icm=split`, the preview buffer is still in the buffer list. Setting `icm=nosplit` and then triggering a command preview resets the global value of `cmdpreview_bufnr`:\r\nhttps://github.com/neovim/neovim/blob/78b000c74d631fb097bc2ada0c929153f96d9769/src/nvim/ex_getln.c#L2551-L2552\r\ndespite the fact that the buffer still exists. Restoring `icm=split` and again triggering command preview, a new buffer is created, since the preview bufnr was cleared:\r\nhttps://github.com/neovim/neovim/blob/78b000c74d631fb097bc2ada0c929153f96d9769/src/nvim/ex_getln.c#L2232-L2237\r\nand then renaming the new buffer to `[Preview]` fails, because the previous preview buffer still exists:\r\nhttps://github.com/neovim/neovim/blob/78b000c74d631fb097bc2ada0c929153f96d9769/src/nvim/ex_getln.c#L2254-L2259\r\nand so the creation of the buffer fails, and neovim `abort()`s:\r\nhttps://github.com/neovim/neovim/blob/78b000c74d631fb097bc2ada0c929153f96d9769/src/nvim/ex_getln.c#L2553-L2555",
            "created_at": "2024-01-19T02:24:03Z",
            "html_url": "https://github.com/neovim/neovim/issues/27086#issuecomment-1899539175",
            "id": 1899539175,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27086",
            "node_id": "IC_kwDOAPphoM5xOKrn",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1899539175/reactions"
            },
            "updated_at": "2024-01-19T02:24:03Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1899539175",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/92238946?v=4",
                "events_url": "https://api.github.com/users/theofabilous/events{/privacy}",
                "followers_url": "https://api.github.com/users/theofabilous/followers",
                "following_url": "https://api.github.com/users/theofabilous/following{/other_user}",
                "gists_url": "https://api.github.com/users/theofabilous/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/theofabilous",
                "id": 92238946,
                "login": "theofabilous",
                "node_id": "U_kgDOBX90Yg",
                "organizations_url": "https://api.github.com/users/theofabilous/orgs",
                "received_events_url": "https://api.github.com/users/theofabilous/received_events",
                "repos_url": "https://api.github.com/users/theofabilous/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/theofabilous/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/theofabilous/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/theofabilous"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/27086/comments",
    "created_at": "2024-01-19T01:54:13Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/27086/events",
    "html_url": "https://github.com/neovim/neovim/issues/27086",
    "id": 2089402052,
    "labels": [
        {
            "color": "F9D0C4",
            "default": false,
            "description": "issue reporting a crash or segfault",
            "id": 435854234,
            "name": "bug-crash",
            "node_id": "MDU6TGFiZWw0MzU4NTQyMzQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-crash"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/27086/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM58ib7E",
    "number": 27086,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/27086/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/27086/timeline",
    "title": "inccommand=split can cause `SIGABRT`",
    "updated_at": "2024-01-19T03:04:03Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/27086",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/92238946?v=4",
        "events_url": "https://api.github.com/users/theofabilous/events{/privacy}",
        "followers_url": "https://api.github.com/users/theofabilous/followers",
        "following_url": "https://api.github.com/users/theofabilous/following{/other_user}",
        "gists_url": "https://api.github.com/users/theofabilous/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/theofabilous",
        "id": 92238946,
        "login": "theofabilous",
        "node_id": "U_kgDOBX90Yg",
        "organizations_url": "https://api.github.com/users/theofabilous/orgs",
        "received_events_url": "https://api.github.com/users/theofabilous/received_events",
        "repos_url": "https://api.github.com/users/theofabilous/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/theofabilous/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/theofabilous/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/theofabilous"
    }
}