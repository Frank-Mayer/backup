{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\r\n\r\nNvim crashes when the number of lines gets larger than the window height -- but this is possibly due to a plugin. ~~The root cause might be on somewhere `extmark`; I will try to modify the title and the reproduce step if I can find why the crash happens.~~\r\n\r\nI find that this happens when we call `nvim_buf_set_lines` for a buffer with `undolevels = -1`.\r\n\r\nWith git bisect I figured out that 008154954 (#24824) is the first bad commit. /cc @bfredl\r\n\r\nStacktraces tell that `u_force_get_undo_header` via `extmark_splice_impl` is where it aborts.\r\n\r\n<details>\r\n   <summary>Stacktrace</summary>\r\n\r\n```\r\nThread 0 Crashed::  Dispatch queue: com.apple.main-thread\r\n0   libsystem_kernel.dylib        \t       0x18b62e868 __pthread_kill + 8\r\n1   libsystem_pthread.dylib       \t       0x18b665cec pthread_kill + 288\r\n2   libsystem_c.dylib             \t       0x18b59e2c8 abort + 180\r\n3   nvim                          \t       0x102a42fa0 u_force_get_undo_header + 212 (undo.c:3220)\r\n4   nvim                          \t       0x10281f0b8 u_extmark_copy + 60 (extmark.c:455)\r\n5   nvim                          \t       0x10281f650 extmark_splice_impl + 292 (extmark.c:625)\r\n6   nvim                          \t       0x10282001c extmark_splice + 204 (extmark.c:603)\r\n7   nvim                          \t       0x1026ba524 nvim_buf_set_lines + 1716 (buffer.c:470)\r\n8   nvim                          \t       0x1026a03ec nlua_api_nvim_buf_set_lines + 524 (lua_api_c_bindings.generated.c:575)\r\n9   nvim                          \t       0x102b0d074 lj_BC_FUNCC + 44\r\n10  nvim                          \t       0x102b22f78 lua_pcall + 228 (lj_api.c:1145)\r\n11  nvim                          \t       0x10287abf8 nlua_schedule_event + 80 (executor.c:360)\r\n12  nvim                          \t       0x1029e9ed8 state_handle_k_event + 88 (state.c:117)\r\n13  nvim                          \t       0x10276f568 insert_handle_key + 2816 (edit.c:880)\r\n14  nvim                          \t       0x102768ac8 insert_execute + 1812 (edit.c:671)\r\n15  nvim                          \t       0x1029e9e44 state_enter + 600 (state.c:99)\r\n16  nvim                          \t       0x102769908 insert_enter + 2280 (edit.c:338)\r\n17  nvim                          \t       0x102768358 edit + 432 (edit.c:1266)\r\n18  nvim                          \t       0x1028f201c invoke_edit + 132 (normal.c:6270)\r\n19  nvim                          \t       0x1028ec8b0 nv_edit + 680 (normal.c:6247)\r\n20  nvim                          \t       0x1028e9aac normal_execute + 2144 (normal.c:1226)\r\n21  nvim                          \t       0x1029e9e44 state_enter + 600 (state.c:99)\r\n22  nvim                          \t       0x1028e5640 normal_enter + 196 (normal.c:517)\r\n23  nvim                          \t       0x10269733c main + 4292 (main.c:647)\r\n24  dyld                          \t       0x18b33be50 start + 2544\r\n```\r\n</details>\r\n\r\n### Steps to reproduce\r\n\r\n`$ nvim -u minimal.lua` where minimal.lua:\r\n\r\n```\r\nlocal buf = vim.api.nvim_create_buf(false, true)\r\nvim.api.nvim_buf_set_option(buf, 'undolevels', -1)\r\nvim.api.nvim_buf_set_lines(buf, 0, 1, false, { })\r\n```\r\n\r\n### Steps to reproduce (old)\r\n\r\n<details>\r\n   <summary>Click to expand</summary>\r\n\r\nThis happens when I use [nvim-scrollview](https://github.com/dstein64/nvim-scrollview) written by @dstein64, so I will provide steps with the plugin enabled:\r\n\r\n`$ nvim -u minimal.lua` where minimal.lua:\r\n\r\n```\r\nlocal root = vim.fn.fnamemodify(\"./.repro\", \":p\")\r\nfor _, name in ipairs({ \"config\", \"data\", \"state\", \"cache\" }) do\r\n  vim.env[(\"XDG_%s_HOME\"):format(name:upper())] = root .. \"/\" .. name\r\nend\r\nlocal lazypath = root .. \"/plugins/lazy.nvim\"\r\nif not vim.loop.fs_stat(lazypath) then\r\n  vim.fn.system({ \"git\", \"clone\", \"--filter=blob:none\", \"https://github.com/folke/lazy.nvim.git\", lazypath, })\r\nend\r\nvim.opt.runtimepath:prepend(lazypath)\r\nlocal plugins = {\r\n  'dstein64/nvim-scrollview';\r\n}\r\nrequire(\"lazy\").setup(plugins, {\r\n  root = root .. \"/plugins\",\r\n})\r\n```\r\n\r\nAnd then\r\n\r\n- Enter `<CR>` sufficient times to make scrollbar appear (e.g., the number of lines in the buffer exceeds the window height)\r\n- or open any files with many enough lines\r\n\r\n~I will try to narrow down to the root cause with (more) minimal steps to reproduce.~ UPDATE: See above.\r\n\r\n</details>\r\n\r\n\r\n### Expected behavior\r\n\r\nNo crashes.\r\n\r\n### Neovim version (nvim -v)\r\n\r\n0.10.0-dev 008154954\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nN/A\r\n\r\n### Operating system/version\r\n\r\nmacOS 12.3\r\n\r\n### Terminal name/version\r\n\r\nxterm\r\n\r\n### $TERM environment variable\r\n\r\nxterm-256color\r\n\r\n### Installation\r\n\r\nbuild from source (HEAD)",
    "closed_at": "2023-08-27T11:56:26Z",
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "Reading #24824, ~it seems that it's going to fixed by #24889.~ I tried #24889 but it still crashes (it seems to be a different issue). Sorry for a dup, but I will have this issue remaining open so that people may find the crashing neovim issue.",
            "created_at": "2023-08-27T02:31:11Z",
            "html_url": "https://github.com/neovim/neovim/issues/24894#issuecomment-1694552335",
            "id": 1694552335,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/24894",
            "node_id": "IC_kwDOAPphoM5lANEP",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1694552335/reactions"
            },
            "updated_at": "2023-08-27T02:37:45Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1694552335",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1009873?v=4",
                "events_url": "https://api.github.com/users/wookayin/events{/privacy}",
                "followers_url": "https://api.github.com/users/wookayin/followers",
                "following_url": "https://api.github.com/users/wookayin/following{/other_user}",
                "gists_url": "https://api.github.com/users/wookayin/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/wookayin",
                "id": 1009873,
                "login": "wookayin",
                "node_id": "MDQ6VXNlcjEwMDk4NzM=",
                "organizations_url": "https://api.github.com/users/wookayin/orgs",
                "received_events_url": "https://api.github.com/users/wookayin/received_events",
                "repos_url": "https://api.github.com/users/wookayin/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/wookayin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/wookayin/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/wookayin"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "should be fixed by updated #24889 . I'll include your repro as a test, thanks!",
            "created_at": "2023-08-27T09:49:28Z",
            "html_url": "https://github.com/neovim/neovim/issues/24894#issuecomment-1694622358",
            "id": 1694622358,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/24894",
            "node_id": "IC_kwDOAPphoM5lAeKW",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 1,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1694622358/reactions"
            },
            "updated_at": "2023-08-27T09:49:28Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1694622358",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
                "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
                "followers_url": "https://api.github.com/users/bfredl/followers",
                "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
                "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bfredl",
                "id": 1363104,
                "login": "bfredl",
                "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
                "organizations_url": "https://api.github.com/users/bfredl/orgs",
                "received_events_url": "https://api.github.com/users/bfredl/received_events",
                "repos_url": "https://api.github.com/users/bfredl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bfredl"
            }
        },
        {
            "author_association": "NONE",
            "body": "@bfredl I can confirm #24889 fixes this issue.\r\n(it's not suppose to fix other, Telescope issue, is it?)",
            "created_at": "2023-08-27T11:53:15Z",
            "html_url": "https://github.com/neovim/neovim/issues/24894#issuecomment-1694647658",
            "id": 1694647658,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/24894",
            "node_id": "IC_kwDOAPphoM5lAkVq",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1694647658/reactions"
            },
            "updated_at": "2023-08-27T11:53:15Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1694647658",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/69750637?v=4",
                "events_url": "https://api.github.com/users/gegoune/events{/privacy}",
                "followers_url": "https://api.github.com/users/gegoune/followers",
                "following_url": "https://api.github.com/users/gegoune/following{/other_user}",
                "gists_url": "https://api.github.com/users/gegoune/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/gegoune",
                "id": 69750637,
                "login": "gegoune",
                "node_id": "MDQ6VXNlcjY5NzUwNjM3",
                "organizations_url": "https://api.github.com/users/gegoune/orgs",
                "received_events_url": "https://api.github.com/users/gegoune/received_events",
                "repos_url": "https://api.github.com/users/gegoune/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/gegoune/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/gegoune/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/gegoune"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/24894/comments",
    "created_at": "2023-08-27T02:12:19Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/24894/events",
    "html_url": "https://github.com/neovim/neovim/issues/24894",
    "id": 1868328311,
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "libnvim, Nvim RPC API",
            "id": 103819671,
            "name": "api",
            "node_id": "MDU6TGFiZWwxMDM4MTk2NzE=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/api"
        },
        {
            "color": "F9D0C4",
            "default": false,
            "description": "issue reporting a crash or segfault",
            "id": 435854234,
            "name": "bug-crash",
            "node_id": "MDU6TGFiZWw0MzU4NTQyMzQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-crash"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/24894/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5vXG13",
    "number": 24894,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 1,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 1,
        "url": "https://api.github.com/repos/neovim/neovim/issues/24894/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/24894/timeline",
    "title": "nvim crashes by nvim_buf_set_lines() when undolevels = -1",
    "updated_at": "2023-08-27T11:56:26Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/24894",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1009873?v=4",
        "events_url": "https://api.github.com/users/wookayin/events{/privacy}",
        "followers_url": "https://api.github.com/users/wookayin/followers",
        "following_url": "https://api.github.com/users/wookayin/following{/other_user}",
        "gists_url": "https://api.github.com/users/wookayin/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/wookayin",
        "id": 1009873,
        "login": "wookayin",
        "node_id": "MDQ6VXNlcjEwMDk4NzM=",
        "organizations_url": "https://api.github.com/users/wookayin/orgs",
        "received_events_url": "https://api.github.com/users/wookayin/received_events",
        "repos_url": "https://api.github.com/users/wookayin/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/wookayin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/wookayin/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/wookayin"
    }
}