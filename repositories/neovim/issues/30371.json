{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\r\n\r\nI did not check the root cause but apparently qffields_T->user_data stored by qf_add_entry (setloclist) is not reference counted correctly.\r\nIt is freed when you still have the access through set_ref_in_quickfix.\r\nUsers may have experienced this crash when they have closed the buffer window before closing the location list window bound to the buffer.\r\nReverting commit 131a1ee82d15ce9d1356a46117c9a1651947d4b8 practically seems to fix this crash.\r\n\r\n### Steps to reproduce\r\n\r\nExecute below script with `nvim -u poc.lua` of luafile command\r\n\r\n```lua\r\nvim.opt.updatetime = 0\r\n\r\nlocal items = { {\r\n    bufnr = 1,\r\n    user_data = {},\r\n} }\r\n\r\nvim.fn.setloclist(0, items)\r\n\r\nlocal win = vim.api.nvim_get_current_win()\r\n\r\nvim.cmd('lopen')\r\n\r\nvim.api.nvim_set_current_win(win)\r\n\r\nvim.cmd('close')\r\n\r\nvim.api.nvim_set_current_win(0)\r\n\r\nlocal timer = vim.uv.new_timer()\r\n\r\ntimer:start(100, 0, vim.schedule_wrap(function()\r\n    local key = vim.api.nvim_replace_termcodes(\"<cr>\", true, false, true)\r\n    vim.api.nvim_feedkeys(key, 'n', false)\r\nend))\r\n```\r\n\r\n### asan report\r\n\r\n```c\r\n=================================================================\r\n==41850==ERROR: AddressSanitizer: heap-use-after-free on address 0x0001083d878c at pc 0x000102da320c bp 0x00016d6c0130 sp 0x00016d6c0128\r\nREAD of size 4 at 0x0001083d878c thread T0\r\n    #0 0x102da3208 in set_ref_in_item eval.c:4797\r\n    #1 0x103bd66cc in mark_quickfix_user_data quickfix.c:6872\r\n    #2 0x103bd4d64 in set_ref_in_quickfix quickfix.c:6925\r\n    #3 0x102d666d8 in garbage_collect eval.c:4617\r\n    #4 0x103328cc4 in before_blocking getchar.c:1467\r\n\r\n    #5 0x103b10d84 in os_inchar input.c:149\r\n    #6 0x10407f008 in state_enter state.c:80\r\n    #7 0x1038e73e4 in normal_enter normal.c:518\r\n    #8 0x10358809c in main main.c:662\r\n    #9 0x18c774270  (<unknown module>)\r\n\r\n0x0001083d878c is located 12 bytes inside of 360-byte region [0x0001083d8780,0x0001083d88e8)\r\nfreed by thread T0 here:\r\n    #0 0x105b8f260 in wrap_free+0x98 (libclang_rt.asan_osx_dynamic.dylib:arm64e+0x53260)\r\n    #1 0x1037c3d84 in xfree memory.c:144\r\n    #2 0x102faf9a8 in tv_dict_free_dict typval.c:2125\r\n    #3 0x102da681c in free_unref_items eval.c:4684\r\n    #4 0x102d66734 in garbage_collect eval.c:4622\r\n    #5 0x103328cc4 in before_blocking getchar.c:1467\r\n\r\n    #6 0x103b10d84 in os_inchar input.c:149\r\n    #7 0x10407f008 in state_enter state.c:80\r\n    #8 0x1038e73e4 in normal_enter normal.c:518\r\n    #9 0x10358809c in main main.c:662\r\n    #10 0x18c774270  (<unknown module>)\r\n\r\npreviously allocated by thread T0 here:\r\n    #0 0x105b8f4f0 in wrap_calloc+0x9c (libclang_rt.asan_osx_dynamic.dylib:arm64e+0x534f0)\r\n    #1 0x1037c3e4c in xcalloc memory.c:158\r\n    #2 0x102fabddc in tv_dict_alloc typval.c:2055\r\n    #3 0x1035169b4 in nlua_pop_typval converter.c:353\r\n    #4 0x10354a414 in nlua_call executor.c:1187\r\n    #5 0x1056bd818  (libluajit-5.1.2.1.1723675123.dylib:arm64+0x5818)\r\n    #6 0x1056ca420 in lua_pcall+0x90 (libluajit-5.1.2.1.1723675123.dylib:arm64+0x12420)\r\n    #7 0x10355d1c8 in nlua_schedule_event executor.c:371\r\n    #8 0x10407f674 in state_handle_k_event state.c:119\r\n    #9 0x103954ea0 in nv_event normal.c:6585\r\n    #10 0x10390ebcc in normal_execute normal.c:1229\r\n\r\n    #11 0x10407f364 in state_enter state.c:101\r\n    #12 0x1038e73e4 in normal_enter normal.c:518\r\n    #13 0x10358809c in main main.c:662\r\n    #14 0x18c774270  (<unknown module>)\r\n\r\nSUMMARY: AddressSanitizer: heap-use-after-free eval.c:4797 in set_ref_in_item\r\nShadow bytes around the buggy address:\r\n  0x0001083d8500: fd fd fd fd fd fd fd fd fd fd fd fd fd fa fa fa\r\n  0x0001083d8580: fa fa fa fa fa fa fa fa fd fd fd fd fd fd fd fd\r\n  0x0001083d8600: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\n  0x0001083d8680: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\n  0x0001083d8700: fd fd fd fd fd fa fa fa fa fa fa fa fa fa fa fa\r\n=>0x0001083d8780: fd[fd]fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\n  0x0001083d8800: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\n  0x0001083d8880: fd fd fd fd fd fd fd fd fd fd fd fd fd fa fa fa\r\n  0x0001083d8900: fa fa fa fa fa fa fa fa fd fd fd fd fd fd fd fd\r\n  0x0001083d8980: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\n  0x0001083d8a00: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07 \r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n==41850==ABORTING\r\n```\r\n\r\n### Expected behavior\r\n\r\nno crash\r\n\r\n### Neovim version (nvim -v)\r\n\r\ndeac7df80a1491ae65b68a1a1047902bcd775adc\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nprobably no\r\n\r\n### Operating system/version\r\n\r\nmacOS sequoia\r\n\r\n### Terminal name/version\r\n\r\nalacritty\r\n\r\n### $TERM environment variable\r\n\r\nxterm-256color\r\n\r\n### Installation\r\n\r\nrepo cloning",
    "closed_at": "2024-09-14T11:38:34Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
        "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
        "followers_url": "https://api.github.com/users/zeertzjq/followers",
        "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
        "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/zeertzjq",
        "id": 35768171,
        "login": "zeertzjq",
        "node_id": "MDQ6VXNlcjM1NzY4MTcx",
        "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
        "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
        "repos_url": "https://api.github.com/users/zeertzjq/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/zeertzjq"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Reproducer without timers:\r\n```vim\r\nlet v:testing = 1\r\ncall setloclist(0, [#{bufnr: bufnr(), user_data: {}}])\r\nlopen\r\nwincmd t\r\nclose\r\ncall test_garbagecollect_now()\r\ncall feedkeys(\"\\<CR>\", 'tx')\r\ncall test_garbagecollect_now()\r\n```",
            "created_at": "2024-09-14T00:26:26Z",
            "html_url": "https://github.com/neovim/neovim/issues/30371#issuecomment-2350737738",
            "id": 2350737738,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/30371",
            "node_id": "IC_kwDOAPphoM6MHWlK",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2350737738/reactions"
            },
            "updated_at": "2024-09-14T01:09:51Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2350737738",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/30371/comments",
    "created_at": "2024-09-13T21:23:31Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/30371/events",
    "html_url": "https://github.com/neovim/neovim/issues/30371",
    "id": 2525722006,
    "labels": [
        {
            "color": "c7def8",
            "default": false,
            "description": "",
            "id": 109899557,
            "name": "vimscript",
            "node_id": "MDU6TGFiZWwxMDk4OTk1NTc=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/vimscript"
        },
        {
            "color": "F9D0C4",
            "default": false,
            "description": "wrong behavior inherited from vim",
            "id": 154310492,
            "name": "bug-vim",
            "node_id": "MDU6TGFiZWwxNTQzMTA0OTI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-vim"
        },
        {
            "color": "0E8A16",
            "default": false,
            "description": "issue contains a stacktrace/ASAN log",
            "id": 435854079,
            "name": "has:backtrace",
            "node_id": "MDU6TGFiZWw0MzU4NTQwNzk=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/has:backtrace"
        },
        {
            "color": "F9D0C4",
            "default": false,
            "description": "issue reporting a crash or segfault",
            "id": 435854234,
            "name": "bug-crash",
            "node_id": "MDU6TGFiZWw0MzU4NTQyMzQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-crash"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "",
            "id": 6937717172,
            "name": "quickfix",
            "node_id": "LA_kwDOAPphoM8AAAABnYUptA",
            "url": "https://api.github.com/repos/neovim/neovim/labels/quickfix"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/30371/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM6Wi3WW",
    "number": 30371,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/30371/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/30371/timeline",
    "title": "heap use-after-free in set_ref_in_quickfix",
    "updated_at": "2024-09-14T11:38:34Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/30371",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/61380567?v=4",
        "events_url": "https://api.github.com/users/po6ix/events{/privacy}",
        "followers_url": "https://api.github.com/users/po6ix/followers",
        "following_url": "https://api.github.com/users/po6ix/following{/other_user}",
        "gists_url": "https://api.github.com/users/po6ix/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/po6ix",
        "id": 61380567,
        "login": "po6ix",
        "node_id": "MDQ6VXNlcjYxMzgwNTY3",
        "organizations_url": "https://api.github.com/users/po6ix/orgs",
        "received_events_url": "https://api.github.com/users/po6ix/received_events",
        "repos_url": "https://api.github.com/users/po6ix/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/po6ix/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/po6ix/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/po6ix"
    }
}