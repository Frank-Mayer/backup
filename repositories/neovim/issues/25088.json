{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\r\n\r\nThis is the result of investigation into #25074 @lewis6991. Tree-sitter queries can return a prohibitively large number of matches if run on the wrong filetype, causing a performance regression and rendering the editor unusable.\r\n\r\nregression introduced in: #24647\r\n\r\n### Steps to reproduce\r\n\r\n`nvim -u init.lua`:\r\n```lua\r\nvim.opt.cursorcolumn = true\r\nlocal lazypath = vim.fn.stdpath(\"data\") .. \"/lazy/lazy.nvim\"\r\nif not vim.loop.fs_stat(lazypath) then vim.fn.system({ \"git\", \"clone\", \"--filter=blob:none\", \"https://github.com/folke/lazy.nvim.git\", \"--branch=stable\", lazypath, }) end\r\nvim.opt.rtp:prepend(lazypath)\r\n\r\nlocal plugins = {\r\n\t{\r\n\t\t\"nvim-treesitter/nvim-treesitter\", build = \":TSUpdate\", dependencies = { \"nvim-lua/plenary.nvim\" }, event = { \"BufReadPost\", \"BufNewFile\" },\r\n\t\topts = { highlight = { enable = true, }, indent = { enable = true }, ensure_installed = \"typescript\", sync_install = false, auto_install = true, },\r\n\t\tconfig = function(_, opts) require(\"nvim-treesitter.configs\").setup(opts) end,\r\n\t},\r\n}\r\n\r\nrequire(\"lazy\").setup(plugins)\r\n```\r\n\r\nSample file with pathological number of query matches:\r\nhttps://gist.github.com/llllvvuu/d0e897bd7c3fe1a6daab6861f3dc3001\r\n\r\n(Optional) Instrument `runtime/lua/vim/treesitter/query.lua:iter_captures()` to print the query, range, and/or iteration depth; or set up some kind of debugger.\r\n\r\nOpen the sample file, press O, and start typing.\r\n\r\n### Expected behavior\r\n\r\nThe injection query should only run on the injection.\r\n\r\n### Neovim version (nvim -v)\r\n\r\nNVIM v0.10.0-dev-814+g2ca076e45\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nno\r\n\r\n### Operating system/version\r\n\r\nmacOS 13.4.1\r\n\r\n### Terminal name/version\r\n\r\nkitty 0.28.1\r\n\r\n### $TERM environment variable\r\n\r\nxterm-kitty\r\n\r\n### Installation\r\n\r\nbuild from repo",
    "closed_at": "2023-09-10T20:31:37Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Sorry, but unless you can reproduce this without any plugins, this looks to me like an nvim-treesitter issue -- why are you reporting this here?",
            "created_at": "2023-09-10T19:58:24Z",
            "html_url": "https://github.com/neovim/neovim/issues/25088#issuecomment-1712923825",
            "id": 1712923825,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25088",
            "node_id": "IC_kwDOAPphoM5mGSSx",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1712923825/reactions"
            },
            "updated_at": "2023-09-10T19:58:24Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1712923825",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason"
            }
        },
        {
            "author_association": "NONE",
            "body": "> Sorry, but unless you can reproduce this without any plugins, this looks to me like an nvim-treesitter issue -- why are you reporting this here?\r\n\r\nThe bad query is being called from TSHighlighter which is part of Neovim. It shouldn't be possible for a plugin to mess up Neovim internals like this, so I consider it to quite possibly be a Neovim issue.",
            "created_at": "2023-09-10T20:00:50Z",
            "html_url": "https://github.com/neovim/neovim/issues/25088#issuecomment-1712924310",
            "id": 1712924310,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25088",
            "node_id": "IC_kwDOAPphoM5mGSaW",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1712924310/reactions"
            },
            "updated_at": "2023-09-10T20:00:50Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1712924310",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5601392?v=4",
                "events_url": "https://api.github.com/users/llllvvuu/events{/privacy}",
                "followers_url": "https://api.github.com/users/llllvvuu/followers",
                "following_url": "https://api.github.com/users/llllvvuu/following{/other_user}",
                "gists_url": "https://api.github.com/users/llllvvuu/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/llllvvuu",
                "id": 5601392,
                "login": "llllvvuu",
                "node_id": "MDQ6VXNlcjU2MDEzOTI=",
                "organizations_url": "https://api.github.com/users/llllvvuu/orgs",
                "received_events_url": "https://api.github.com/users/llllvvuu/received_events",
                "repos_url": "https://api.github.com/users/llllvvuu/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/llllvvuu/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/llllvvuu/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/llllvvuu"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> The bad query is being called from TSHighlighter which is part of Neovim. It shouldn't be possible for a plugin to mess up Neovim internals like this\r\n\r\nOh, you sweet summer child...\r\n\r\nSeriously, everything I've seen from you so far points towards nvim-treesitter's indent to need adaptation. Injection queries are also called from identation, you know.\r\n\r\n> tree-sitter queries can return a prohibitively large number of matches if run on the wrong filetype\r\n\r\nis also a huge red flag -- _why_ are these matches being run on the wrong filetype in the first place?\r\n",
            "created_at": "2023-09-10T20:04:00Z",
            "html_url": "https://github.com/neovim/neovim/issues/25088#issuecomment-1712925001",
            "id": 1712925001,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25088",
            "node_id": "IC_kwDOAPphoM5mGSlJ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1712925001/reactions"
            },
            "updated_at": "2023-09-10T20:05:03Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1712925001",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "For the record, I cannot reproduce this with the `main` branch of nvim-treesitter.",
            "created_at": "2023-09-10T20:08:39Z",
            "html_url": "https://github.com/neovim/neovim/issues/25088#issuecomment-1712925882",
            "id": 1712925882,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25088",
            "node_id": "IC_kwDOAPphoM5mGSy6",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1712925882/reactions"
            },
            "updated_at": "2023-09-10T20:08:39Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1712925882",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason"
            }
        },
        {
            "author_association": "NONE",
            "body": "Huh, `main` vs `master` is brutal. Thanks for your pointer, I'm going to port your commit to my `master` since none of my plugins work against `master`.",
            "created_at": "2023-09-10T20:31:38Z",
            "html_url": "https://github.com/neovim/neovim/issues/25088#issuecomment-1712930198",
            "id": 1712930198,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25088",
            "node_id": "IC_kwDOAPphoM5mGT2W",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1712930198/reactions"
            },
            "updated_at": "2023-09-10T20:31:38Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1712930198",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5601392?v=4",
                "events_url": "https://api.github.com/users/llllvvuu/events{/privacy}",
                "followers_url": "https://api.github.com/users/llllvvuu/followers",
                "following_url": "https://api.github.com/users/llllvvuu/following{/other_user}",
                "gists_url": "https://api.github.com/users/llllvvuu/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/llllvvuu",
                "id": 5601392,
                "login": "llllvvuu",
                "node_id": "MDQ6VXNlcjU2MDEzOTI=",
                "organizations_url": "https://api.github.com/users/llllvvuu/orgs",
                "received_events_url": "https://api.github.com/users/llllvvuu/received_events",
                "repos_url": "https://api.github.com/users/llllvvuu/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/llllvvuu/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/llllvvuu/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/llllvvuu"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "`main` is the work-in-progress total rewrite of nvim-treesitter, which will become the default branch when it's finished (at which point `master` will likely be renamed); this was the least disruptive strategy. It's not something you're expected to know about -- in fact, the changes to `indent.lua` were backported to `master`. My comment was meant to indicate that your reproducing example has more going on than it seems to (mentioning the non-default branch for the sake of transparency).",
            "created_at": "2023-09-10T20:40:26Z",
            "html_url": "https://github.com/neovim/neovim/issues/25088#issuecomment-1712931921",
            "id": 1712931921,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25088",
            "node_id": "IC_kwDOAPphoM5mGURR",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1712931921/reactions"
            },
            "updated_at": "2023-09-10T20:40:26Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1712931921",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/25088/comments",
    "created_at": "2023-09-10T19:53:07Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/25088/events",
    "html_url": "https://github.com/neovim/neovim/issues/25088",
    "id": 1889303259,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/25088/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5wnHrb",
    "number": 25088,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/25088/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/25088/timeline",
    "title": "regression: #24647 with indent+highlight causes injection queries to run on root document",
    "updated_at": "2023-09-10T20:40:26Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/25088",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/5601392?v=4",
        "events_url": "https://api.github.com/users/llllvvuu/events{/privacy}",
        "followers_url": "https://api.github.com/users/llllvvuu/followers",
        "following_url": "https://api.github.com/users/llllvvuu/following{/other_user}",
        "gists_url": "https://api.github.com/users/llllvvuu/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/llllvvuu",
        "id": 5601392,
        "login": "llllvvuu",
        "node_id": "MDQ6VXNlcjU2MDEzOTI=",
        "organizations_url": "https://api.github.com/users/llllvvuu/orgs",
        "received_events_url": "https://api.github.com/users/llllvvuu/received_events",
        "repos_url": "https://api.github.com/users/llllvvuu/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/llllvvuu/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/llllvvuu/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/llllvvuu"
    }
}