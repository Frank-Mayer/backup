{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Neovim version (nvim -v)\n\n0.6.1\n\n### Vim (not Nvim) behaves the same?\n\nno, 8.1.3741\n\n### Operating system/version\n\nArch Linux Kernel Version 5.16.11\n\n### Terminal name/version\n\nkitty\n\n### $TERM environment variable\n\nxterm-kitty\n\n### Installation\n\nsystem package manager (community repo)\n\n### How to reproduce the issue\n\nCompile the following C program:\r\n\r\n```c\r\n#include <stdio.h>\r\n#include <stdlib.h>\r\n#include <unistd.h>\r\n\r\nint main(int argc, char **argv) {\r\n    for (int i = 0; i < strtol(argv[1], NULL, 10); i++) {\r\n        int n = fork();\r\n        printf(\"ppid = %d, pid = %d, i = %d\\n\", getppid(), getpid(), i);\r\n        if (n == 0) {\r\n            return 0;\r\n        }\r\n    }\r\n\r\n    return 0;\r\n}\r\n```\r\n\r\n`nvim --clean`\r\n`:!./a.out 2`\n\n### Expected behavior\n\n4 lines should be printed, two by the parent, and 1 by each of the children. This happens in a shell and in normal vim, the output is something like the following, though the actual pids will differ between runs:\r\n\r\n```\r\nppid = 1809450, pid = 1837561, i = 0\r\nppid = 1837561, pid = 1837562, i = 0\r\nppid = 1809450, pid = 1837561, i = 1\r\nppid = 1837561, pid = 1837563, i = 1\r\n```\n\n### Actual behavior\n\n5 lines are printed, with the first line of the parent process being repeated when the parent prints its second line:\r\n\r\n```\r\nppid = 1838888, pid = 1838889, i = 0\r\nppid = 1838675, pid = 1838888, i = 0\r\nppid = 1838888, pid = 1838890, i = 1\r\nppid = 1838675, pid = 1838888, i = 0\r\nppid = 1838675, pid = 1838888, i = 1\r\n```\r\n\r\nIf you run the compiled executable with a larger number like 4, it becomes apparent that all previous lines printed by the parent process are being repeated each time the parent prints something:\r\n\r\n```\r\nppid = 1839280, pid = 1839281, i = 0\r\nppid = 1839085, pid = 1839280, i = 0\r\nppid = 1839280, pid = 1839282, i = 1\r\nppid = 1839085, pid = 1839280, i = 0\r\nppid = 1839085, pid = 1839280, i = 1\r\nppid = 1839280, pid = 1839283, i = 2\r\nppid = 1839085, pid = 1839280, i = 0\r\nppid = 1839085, pid = 1839280, i = 1\r\nppid = 1839085, pid = 1839280, i = 2\r\nppid = 1839280, pid = 1839284, i = 3\r\nppid = 1839085, pid = 1839280, i = 0\r\nppid = 1839085, pid = 1839280, i = 1\r\nppid = 1839085, pid = 1839280, i = 2\r\nppid = 1839085, pid = 1839280, i = 3\r\n```\r\n\r\nAlso, one time I managed to get things printed out of order:\r\n\r\n```\r\nppid = 1846712, pid = 1846713, i = 0\r\nppid = 1846507, pid = 1846712, i = 0\r\nppid = 1846712, pid = 1846714, i = 1\r\nppid = 1846507, pid = 1846712, i = 0\r\nppid = 1846507, pid = 1846712, i = 1\r\nppid = 1846712, pid = 1846715, i = 2\r\nppid = 1846507, pid = 1846712, i = 0\r\nppid = 1846507, pid = 1846712, i = 1\r\nppid = 1846507, pid = 1846712, i = 2\r\nppid = 1846507, pid = 1846712, i = 3 <-- here the parent's 3 is printed, then the previous lines are printed afterwards...\r\nppid = 1846507, pid = 1846712, i = 0\r\nppid = 1846507, pid = 1846712, i = 1\r\nppid = 1846507, pid = 1846712, i = 2\r\nppid = 1846712, pid = 1846716, i = 3\r\n```\r\n\r\nI know this program is very contrived, and that this is kind of an edge case, but there's definitely something strange going on here.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "I try `nvim --clean -c 'te ./a.out 2'` and occasionally (~20%) get 3 lines:\r\n```\r\nppid = 45032, pid = 45034, i = 0\r\nppid = 45034, pid = 45041, i = 0\r\nppid = 45032, pid = 45034, i = 1\r\n\r\n[Process exited 0]\r\n```\r\n\r\nNVIM v0.7.0-dev+1274-gc1b98cfa5/Debian 11.2",
            "created_at": "2022-03-18T08:26:27Z",
            "html_url": "https://github.com/neovim/neovim/issues/17644#issuecomment-1072151830",
            "id": 1072151830,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/17644",
            "node_id": "IC_kwDOAPphoM4_570W",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1072151830/reactions"
            },
            "updated_at": "2022-03-18T08:37:20Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1072151830",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/11627708?v=4",
                "events_url": "https://api.github.com/users/e-kwsm/events{/privacy}",
                "followers_url": "https://api.github.com/users/e-kwsm/followers",
                "following_url": "https://api.github.com/users/e-kwsm/following{/other_user}",
                "gists_url": "https://api.github.com/users/e-kwsm/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/e-kwsm",
                "id": 11627708,
                "login": "e-kwsm",
                "node_id": "MDQ6VXNlcjExNjI3NzA4",
                "organizations_url": "https://api.github.com/users/e-kwsm/orgs",
                "received_events_url": "https://api.github.com/users/e-kwsm/received_events",
                "repos_url": "https://api.github.com/users/e-kwsm/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/e-kwsm/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/e-kwsm/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/e-kwsm"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Not a bug. Your program doesn't flush the output before forking, so both parent and child print the same lines.",
            "created_at": "2023-10-19T09:36:35Z",
            "html_url": "https://github.com/neovim/neovim/issues/17644#issuecomment-1770437434",
            "id": 1770437434,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/17644",
            "node_id": "IC_kwDOAPphoM5phrs6",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1770437434/reactions"
            },
            "updated_at": "2023-10-19T09:36:35Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1770437434",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/105592020?v=4",
                "events_url": "https://api.github.com/users/nwounkn/events{/privacy}",
                "followers_url": "https://api.github.com/users/nwounkn/followers",
                "following_url": "https://api.github.com/users/nwounkn/following{/other_user}",
                "gists_url": "https://api.github.com/users/nwounkn/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/nwounkn",
                "id": 105592020,
                "login": "nwounkn",
                "node_id": "U_kgDOBks01A",
                "organizations_url": "https://api.github.com/users/nwounkn/orgs",
                "received_events_url": "https://api.github.com/users/nwounkn/received_events",
                "repos_url": "https://api.github.com/users/nwounkn/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/nwounkn/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/nwounkn/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/nwounkn"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Ah, you're right, thanks @nwounkn, that explains the double prints. If I add `fflush(stdout)` after the `printf`, the double prints disappear. I was able to reproduce the missing lines reported by @e-kwsm, but I suspect that might be intended behaviour too: the missing lines always seem to belong to children, and if the parent exits before any of the children, we should immediately report the stdout at that point, so the child's output won't be shown, right? If that sounds correct, I'll close this.",
            "created_at": "2023-10-19T15:56:58Z",
            "html_url": "https://github.com/neovim/neovim/issues/17644#issuecomment-1771280704",
            "id": 1771280704,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/17644",
            "node_id": "IC_kwDOAPphoM5pk5lA",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1771280704/reactions"
            },
            "updated_at": "2023-10-19T15:56:58Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1771280704",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/36740602?v=4",
                "events_url": "https://api.github.com/users/mtoohey31/events{/privacy}",
                "followers_url": "https://api.github.com/users/mtoohey31/followers",
                "following_url": "https://api.github.com/users/mtoohey31/following{/other_user}",
                "gists_url": "https://api.github.com/users/mtoohey31/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mtoohey31",
                "id": 36740602,
                "login": "mtoohey31",
                "node_id": "MDQ6VXNlcjM2NzQwNjAy",
                "organizations_url": "https://api.github.com/users/mtoohey31/orgs",
                "received_events_url": "https://api.github.com/users/mtoohey31/received_events",
                "repos_url": "https://api.github.com/users/mtoohey31/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mtoohey31/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mtoohey31/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mtoohey31"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/17644/comments",
    "created_at": "2022-03-07T23:20:45Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/17644/events",
    "html_url": "https://github.com/neovim/neovim/issues/17644",
    "id": 1162038360,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "OS processes, spawn",
            "id": 182884815,
            "name": "job-control",
            "node_id": "MDU6TGFiZWwxODI4ODQ4MTU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/job-control"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/17644/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5FQ0xY",
    "number": 17644,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/17644/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/17644/timeline",
    "title": "Duplicate output lines with child processes",
    "updated_at": "2023-10-19T15:56:58Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/17644",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/36740602?v=4",
        "events_url": "https://api.github.com/users/mtoohey31/events{/privacy}",
        "followers_url": "https://api.github.com/users/mtoohey31/followers",
        "following_url": "https://api.github.com/users/mtoohey31/following{/other_user}",
        "gists_url": "https://api.github.com/users/mtoohey31/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/mtoohey31",
        "id": 36740602,
        "login": "mtoohey31",
        "node_id": "MDQ6VXNlcjM2NzQwNjAy",
        "organizations_url": "https://api.github.com/users/mtoohey31/orgs",
        "received_events_url": "https://api.github.com/users/mtoohey31/received_events",
        "repos_url": "https://api.github.com/users/mtoohey31/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/mtoohey31/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mtoohey31/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/mtoohey31"
    }
}