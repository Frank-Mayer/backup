{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nWhen sending requests to LSP servers to get code actions, when there are 2 or more LSP clients with diagnostics, the correct diagnostics are only sent to the first server. All other servers get the diagnostics from the first server.\r\n\r\nFor me, specifically, this means that ESLint code actions no longer show up when TypeScript has some diagnostics on that line.\r\n\r\nOn 720b309c786c4a258adccc9c468d433fb0f755b9 (the commit after #29501 was merged), I cannot see any code actions from the ESLint LSP:\r\n\r\n<img width=\"859\" alt=\"image\" src=\"https://github.com/user-attachments/assets/11ea4f30-83f7-4b88-842b-24bcf979e444\">\r\n\r\n\r\nThe problem started appearing after #29501 was merged.\r\n\r\n\r\nI narrowed it down to the following assignment: https://github.com/neovim/neovim/blob/11a6f3c9301b3deb71f7e5886fce3718420355be/runtime/lua/vim/lsp/buf.lua#L908\r\n\r\nThe problem is related to assigning `context.diagnostics` which is shared between all clients in that function.\r\n\r\nThe execution is as follows:\r\n1. For the first client, `context.diagnostics` is `nil`, so the code gets the diagnostics from that client and sets it to `context.diagnostics`, which is then used in `params.context = context`\r\n2. For the next client, `context.diagnostics` **is set** from the previous iteration, so this `if` that sets `context.diagnostics` is not executed. This means that when `params.context = context` is assigned, `params.context.diagnostics` for the 2nd client contain the diagnostics from the first client (because that was set in `context.diagnostics`).\r\n\r\nThe fix would be to avoid setting `context.diagnostics` (which is shared between clients), and instead set `params.context.diagnostics` directly (which is related only to the current client).\n\n### Steps to reproduce using \"nvim -u minimal_init.lua\"\n\n1. Clone https://github.com/Gelio/neovim-eslint-lsp-code-action-bug-repro\r\n2. `npm install`\r\n3. `nvim -u minimal_init.lua index.ts`\r\n4. Wait for the diagnostics to show up inside the `if`\r\n  \r\n    <img width=\"657\" alt=\"image\" src=\"https://github.com/user-attachments/assets/c316444a-22c9-4531-bb04-1c57894fcd23\">\r\n\r\n5. `gra` to get code actions\n\n### Expected behavior\n\nAll LSP servers should get correct diagnostics when retrieving code actions (so they can produce the correct code actions).\r\n\r\nOn 32e128f20992e350b3e39c7469baa1f692418203 (a commit before #29501 was merged), I am able to get code actions from ESLint LSP:\r\n\r\n<img width=\"866\" alt=\"image\" src=\"https://github.com/user-attachments/assets/6dd7e3ab-9bac-48dd-951b-63477e675c7d\">\r\n\n\n### Neovim version (nvim -v)\n\nv0.11.0-dev-588+g11a6f3c930\n\n### Language server name/version\n\nnot related to any particular LSP server, but I was using vscode-langservers-extracted@4.10.0 and typescript-language-server@4.3.3\n\n### Operating system/version\n\nMacOS Sonoma 14.5\n\n### Log file\n\n_No response_",
    "closed_at": "2024-08-07T15:28:02Z",
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "Since I already found the root cause, I created a PR with a fix: https://github.com/neovim/neovim/pull/30002",
            "created_at": "2024-08-07T10:38:18Z",
            "html_url": "https://github.com/neovim/neovim/issues/30001#issuecomment-2273163026",
            "id": 2273163026,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/30001",
            "node_id": "IC_kwDOAPphoM6HfbcS",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2273163026/reactions"
            },
            "updated_at": "2024-08-07T10:38:18Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2273163026",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/889383?v=4",
                "events_url": "https://api.github.com/users/Gelio/events{/privacy}",
                "followers_url": "https://api.github.com/users/Gelio/followers",
                "following_url": "https://api.github.com/users/Gelio/following{/other_user}",
                "gists_url": "https://api.github.com/users/Gelio/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Gelio",
                "id": 889383,
                "login": "Gelio",
                "node_id": "MDQ6VXNlcjg4OTM4Mw==",
                "organizations_url": "https://api.github.com/users/Gelio/orgs",
                "received_events_url": "https://api.github.com/users/Gelio/received_events",
                "repos_url": "https://api.github.com/users/Gelio/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Gelio/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Gelio/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Gelio"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/30001/comments",
    "created_at": "2024-08-07T10:27:36Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/30001/events",
    "html_url": "https://github.com/neovim/neovim/issues/30001",
    "id": 2453136890,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/30001/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM6SN-X6",
    "number": 30001,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/30001/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/30001/timeline",
    "title": "Code actions are reported only for the first LSP server that has diagnostics",
    "updated_at": "2024-08-07T15:28:02Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/30001",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/889383?v=4",
        "events_url": "https://api.github.com/users/Gelio/events{/privacy}",
        "followers_url": "https://api.github.com/users/Gelio/followers",
        "following_url": "https://api.github.com/users/Gelio/following{/other_user}",
        "gists_url": "https://api.github.com/users/Gelio/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/Gelio",
        "id": 889383,
        "login": "Gelio",
        "node_id": "MDQ6VXNlcjg4OTM4Mw==",
        "organizations_url": "https://api.github.com/users/Gelio/orgs",
        "received_events_url": "https://api.github.com/users/Gelio/received_events",
        "repos_url": "https://api.github.com/users/Gelio/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/Gelio/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Gelio/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/Gelio"
    }
}