{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nExiting a floating prompt buffer window **while in insert mode** over terminal buffer unexpectedly returns to the terminal buffer terminal mode despite originally being in normal mode.\r\nThe same does not happen when using a floating prompt buffer window over a regular (`buftype=''`) buffer. Instead, exiting a floating prompt buffer window over a regular buffer while in insert mode will return to the original buffer/window in normal mode.\r\n\r\nrelated downstream issue: https://github.com/nvim-telescope/telescope.nvim/issues/2785\n\n### Steps to reproduce\n\n1. Create `repro.lua` with the following\r\n```lua\r\nlocal function win_fun()\r\n  local bufnr = vim.api.nvim_create_buf(false, true)\r\n\r\n  local win_opts = {\r\n    relative = \"editor\",\r\n    width = 10,\r\n    height = 10,\r\n    row = 10,\r\n    col = 10,\r\n    style = \"minimal\",\r\n  }\r\n\r\n  vim.api.nvim_open_win(bufnr, true, win_opts)\r\n  vim.api.nvim_set_option_value(\"buftype\", \"prompt\", { buf = bufnr })\r\n\r\n  vim.keymap.set({ \"n\", \"i\" }, \"<esc>\", function()\r\n    vim.api.nvim_buf_delete(bufnr, { force = true })\r\n  end, { buffer = bufnr })\r\nend\r\n\r\nvim.api.nvim_create_user_command(\"WinFun\", win_fun, {})\r\n```\r\n2. Start neovim with `nvim --clean +\"repro.lua\"`\r\n3. Enter terminal buffer `:term`\r\n4. Open floating prompt buffer window `:WinFun`\r\n5. Enter insert mode in the floating window buffer\r\n6. Exit the window/buffer with the `<esc>` mapping (while in insert mode)\n\n### Expected behavior\n\nReturn to the terminal buffer in normal mode rather than terminal mode. \r\nThis is the observed behavior when the non-floating buffer is a regular buffer.\r\nOr put differently, this behavior of staying in the same mode when exiting floating windows currently only applies to regular buffer type floating windows (ie. try the repro steps without setting `buftype='prompt'` and over a regular buffer, exiting the floating buffer/window in insert mode will keep you in insert mode in the original buffer). Whichever way you put it, I think the current behavior at least feels inconsistent with itself. \n\n### Neovim version (nvim -v)\n\nNVIM v0.10.0-dev-2095+ga34451982\n\n### Vim (not Nvim) behaves the same?\n\nnot sure, probably yes but I'm using lua API\n\n### Operating system/version\n\nLinux archlinux 6.6.10-arch1-1\n\n### Terminal name/version\n\nkitty 0.31.0\n\n### $TERM environment variable\n\ntmux-256color\n\n### Installation\n\nbuild from repo",
    "closed_at": "2024-01-16T02:42:11Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Hmm, the same bug applies to `:stopinsert`.",
            "created_at": "2024-01-16T02:16:39Z",
            "html_url": "https://github.com/neovim/neovim/issues/27031#issuecomment-1892972251",
            "id": 1892972251,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27031",
            "node_id": "IC_kwDOAPphoM5w1Hbb",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1892972251/reactions"
            },
            "updated_at": "2024-01-16T02:16:39Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1892972251",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/27031/comments",
    "created_at": "2024-01-16T02:00:15Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/27031/events",
    "html_url": "https://github.com/neovim/neovim/issues/27031",
    "id": 2082894189,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "built-in :terminal or :shell",
            "id": 212696822,
            "name": "terminal",
            "node_id": "MDU6TGFiZWwyMTI2OTY4MjI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/terminal"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/27031/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM58JnFt",
    "number": 27031,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 1,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 1,
        "url": "https://api.github.com/repos/neovim/neovim/issues/27031/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/27031/timeline",
    "title": "Exiting floating prompt buffer window over terminal buffer unexpectedly enters terminal mode",
    "updated_at": "2024-01-16T02:42:11Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/27031",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/66286082?v=4",
        "events_url": "https://api.github.com/users/jamestrew/events{/privacy}",
        "followers_url": "https://api.github.com/users/jamestrew/followers",
        "following_url": "https://api.github.com/users/jamestrew/following{/other_user}",
        "gists_url": "https://api.github.com/users/jamestrew/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/jamestrew",
        "id": 66286082,
        "login": "jamestrew",
        "node_id": "MDQ6VXNlcjY2Mjg2MDgy",
        "organizations_url": "https://api.github.com/users/jamestrew/orgs",
        "received_events_url": "https://api.github.com/users/jamestrew/received_events",
        "repos_url": "https://api.github.com/users/jamestrew/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/jamestrew/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jamestrew/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/jamestrew"
    }
}