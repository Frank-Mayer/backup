{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Problem\r\n\r\nPlain sourcing of `vim.lsp` object results into redraw when not done directly during startup.\r\n\r\nAs one side effect, this results into intro text disappearing if user/plugin uses `vim.lsp` not during startup (for example, by setting LSP handler via `vim.lsp.handler`).\r\n\r\n------\r\n\r\nBisecting 'vim.lsp' code to find the problem lead to following results:\r\n- 'runtime/vim/lsp.lua' eagerly requires ['vim.lsp.semantic_tokens'](https://github.com/neovim/neovim/blob/4ffc20c9515294481486e81271a8edeeff203140/runtime/lua/vim/lsp.lua#L9) and ['vim.lsp.inlay_hint'](https://github.com/neovim/neovim/blob/4ffc20c9515294481486e81271a8edeeff203140/runtime/lua/vim/lsp.lua#L27).\r\n- Both of them set decoration provider ([here](https://github.com/neovim/neovim/blob/4ffc20c9515294481486e81271a8edeeff203140/runtime/lua/vim/lsp/semantic_tokens.lua#L795-L802) and [here](https://github.com/neovim/neovim/blob/4ffc20c9515294481486e81271a8edeeff203140/runtime/lua/vim/lsp/inlay_hint.lua#L312-L358)) when sourced. Commenting out these two blocks fixes the issue.\r\n- The `vim.api.nvim_set_decoration_provider()` [explicitly redraws \"later\"](https://github.com/neovim/neovim/blob/4ffc20c9515294481486e81271a8edeeff203140/src/nvim/api/extmark.c#L1048-L1049). @bfredl, mentioning you here as there is a `TODO(bfredl)` comment.\r\n\r\n### Steps to reproduce\r\n\r\n1. Create init file with the following content:\r\n```lua\r\nvim.schedule(function() local lsp = vim.lsp end)\r\n```\r\n2. `nvim --clean -u init.lua`. Intro text may be seen for split second but then is not shown.\r\n\r\nThis also happens with `nvim --clean` followed by `:lua require('vim.lsp')`.\r\nThis does not happen if 'init.lua' is plain `local lsp = vim.lsp`.\r\n\r\n### Expected behavior\r\n\r\nOne of:\r\n- Redraw to not happen at least when requiring `vim.lsp` or parts of it not related to decoration provider.\r\n- Do not redraw or more smart redraw when setting decoration provider.\r\n\r\n### Neovim version (nvim -v)\r\n\r\nNVIM v0.10.0-dev-2243+g4ffc20c95\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nNo\r\n\r\n### Operating system/version\r\n\r\nEndeavourOS Linux x86_64 (6.7.1-arch1-1)\r\n\r\n### Terminal name/version\r\n\r\nst-0.9\r\n\r\n### $TERM environment variable\r\n\r\nst-256color\r\n\r\n### Installation\r\n\r\nBoth appimage and from source",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I am not sure if this is a low complexity Lua issue. Postponing setting decoration provider for inlay hints and semantic tokens is not trivial (if even reasonably possible). So this relies on `vim.api.nvim_set_decoration_provider()` to not redraw immediately, which again might have unwanted side effects.",
            "created_at": "2024-02-01T09:12:47Z",
            "html_url": "https://github.com/neovim/neovim/issues/27266#issuecomment-1920850181",
            "id": 1920850181,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27266",
            "node_id": "IC_kwDOAPphoM5yfdkF",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1920850181/reactions"
            },
            "updated_at": "2024-02-01T09:12:47Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1920850181",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/24854248?v=4",
                "events_url": "https://api.github.com/users/echasnovski/events{/privacy}",
                "followers_url": "https://api.github.com/users/echasnovski/followers",
                "following_url": "https://api.github.com/users/echasnovski/following{/other_user}",
                "gists_url": "https://api.github.com/users/echasnovski/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/echasnovski",
                "id": 24854248,
                "login": "echasnovski",
                "node_id": "MDQ6VXNlcjI0ODU0MjQ4",
                "organizations_url": "https://api.github.com/users/echasnovski/orgs",
                "received_events_url": "https://api.github.com/users/echasnovski/received_events",
                "repos_url": "https://api.github.com/users/echasnovski/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/echasnovski/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/echasnovski/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/echasnovski"
            }
        },
        {
            "author_association": "MEMBER",
            "body": ">'runtime/vim/lsp.lua' eagerly requires ['vim.lsp.semantic_tokens'](https://github.com/neovim/neovim/blob/4ffc20c9515294481486e81271a8edeeff203140/runtime/lua/vim/lsp.lua#L9) and ['vim.lsp.inlay_hint'](https://github.com/neovim/neovim/blob/4ffc20c9515294481486e81271a8edeeff203140/runtime/lua/vim/lsp.lua#L27).\r\n\r\nWill this be addressed by [Dundarloading](https://github.com/neovim/neovim/pull/27216)?",
            "created_at": "2024-02-01T15:20:18Z",
            "html_url": "https://github.com/neovim/neovim/issues/27266#issuecomment-1921573681",
            "id": 1921573681,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27266",
            "node_id": "IC_kwDOAPphoM5yiOMx",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1921573681/reactions"
            },
            "updated_at": "2024-02-01T15:20:18Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1921573681",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/8965202?v=4",
                "events_url": "https://api.github.com/users/gpanders/events{/privacy}",
                "followers_url": "https://api.github.com/users/gpanders/followers",
                "following_url": "https://api.github.com/users/gpanders/following{/other_user}",
                "gists_url": "https://api.github.com/users/gpanders/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/gpanders",
                "id": 8965202,
                "login": "gpanders",
                "node_id": "MDQ6VXNlcjg5NjUyMDI=",
                "organizations_url": "https://api.github.com/users/gpanders/orgs",
                "received_events_url": "https://api.github.com/users/gpanders/received_events",
                "repos_url": "https://api.github.com/users/gpanders/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/gpanders/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/gpanders/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/gpanders"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Will this be addressed by [Dundarloading](https://github.com/neovim/neovim/pull/27216)?\r\n\r\nI've just tested that PR and I don't see an intro text disappearing. Neither with issue's 'init.lua', nor with slightly more complicated one:\r\n\r\n```lua\r\nvim.schedule(function()\r\n  vim.lsp.handlers['$/progress'] = function() print('Hello') end\r\nend)\r\n```\r\n\r\nSo it fixes this particular issue but would imply that calling `vim.api.nvim_set_decoration_provider()` inside a script will cause a redraw (so should be used carefully).",
            "created_at": "2024-02-01T15:30:18Z",
            "html_url": "https://github.com/neovim/neovim/issues/27266#issuecomment-1921596134",
            "id": 1921596134,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27266",
            "node_id": "IC_kwDOAPphoM5yiTrm",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1921596134/reactions"
            },
            "updated_at": "2024-02-01T15:30:18Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1921596134",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/24854248?v=4",
                "events_url": "https://api.github.com/users/echasnovski/events{/privacy}",
                "followers_url": "https://api.github.com/users/echasnovski/followers",
                "following_url": "https://api.github.com/users/echasnovski/following{/other_user}",
                "gists_url": "https://api.github.com/users/echasnovski/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/echasnovski",
                "id": 24854248,
                "login": "echasnovski",
                "node_id": "MDQ6VXNlcjI0ODU0MjQ4",
                "organizations_url": "https://api.github.com/users/echasnovski/orgs",
                "received_events_url": "https://api.github.com/users/echasnovski/received_events",
                "repos_url": "https://api.github.com/users/echasnovski/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/echasnovski/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/echasnovski/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/echasnovski"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> So this relies on vim.api.nvim_set_decoration_provider() to not redraw immediately, which again might have unwanted side effects.\r\n\r\nI think this should be allowed. it could be a flag to avoid changing the (for plugins actually reasonable) default.",
            "created_at": "2024-02-01T18:30:18Z",
            "html_url": "https://github.com/neovim/neovim/issues/27266#issuecomment-1921961311",
            "id": 1921961311,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27266",
            "node_id": "IC_kwDOAPphoM5yjs1f",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1921961311/reactions"
            },
            "updated_at": "2024-02-01T18:30:18Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1921961311",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
                "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
                "followers_url": "https://api.github.com/users/bfredl/followers",
                "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
                "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bfredl",
                "id": 1363104,
                "login": "bfredl",
                "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
                "organizations_url": "https://api.github.com/users/bfredl/orgs",
                "received_events_url": "https://api.github.com/users/bfredl/received_events",
                "repos_url": "https://api.github.com/users/bfredl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bfredl"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/27266/comments",
    "created_at": "2024-01-30T09:56:01Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/27266/events",
    "html_url": "https://github.com/neovim/neovim/issues/27266",
    "id": 2107409554,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "BFDADC",
            "default": false,
            "description": "High-risk, potential for delicate/cascading effects",
            "id": 407247013,
            "name": "complexity:high",
            "node_id": "MDU6TGFiZWw0MDcyNDcwMTM=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/complexity:high"
        },
        {
            "color": "0E8A16",
            "default": false,
            "description": "issue contains minimal reproducing steps",
            "id": 435851959,
            "name": "has:repro",
            "node_id": "MDU6TGFiZWw0MzU4NTE5NTk=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/has:repro"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "stdlib",
            "id": 573222693,
            "name": "lua",
            "node_id": "MDU6TGFiZWw1NzMyMjI2OTM=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lua"
        },
        {
            "color": "0E8A16",
            "default": false,
            "description": "",
            "id": 606691254,
            "name": "has:plan",
            "node_id": "MDU6TGFiZWw2MDY2OTEyNTQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/has:plan"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "extmarks, decorations, virtual text, namespaces",
            "id": 1680119719,
            "name": "extmarks",
            "node_id": "MDU6TGFiZWwxNjgwMTE5NzE5",
            "url": "https://api.github.com/repos/neovim/neovim/labels/extmarks"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/27266/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 599,
        "created_at": "2014-05-10T20:43:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk"
        },
        "description": "Low priority. Not planned for the current target, may be reassigned.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/6",
        "id": 655037,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/6/labels",
        "node_id": "MDk6TWlsZXN0b25lNjU1MDM3",
        "number": 6,
        "open_issues": 424,
        "state": "open",
        "title": "backlog",
        "updated_at": "2024-02-05T01:01:45Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/6"
    },
    "node_id": "I_kwDOAPphoM59nISS",
    "number": 27266,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/27266/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/27266/timeline",
    "title": "Sourcing `vim.lsp` results in redraw",
    "updated_at": "2024-02-01T18:30:19Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/27266",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/24854248?v=4",
        "events_url": "https://api.github.com/users/echasnovski/events{/privacy}",
        "followers_url": "https://api.github.com/users/echasnovski/followers",
        "following_url": "https://api.github.com/users/echasnovski/following{/other_user}",
        "gists_url": "https://api.github.com/users/echasnovski/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/echasnovski",
        "id": 24854248,
        "login": "echasnovski",
        "node_id": "MDQ6VXNlcjI0ODU0MjQ4",
        "organizations_url": "https://api.github.com/users/echasnovski/orgs",
        "received_events_url": "https://api.github.com/users/echasnovski/received_events",
        "repos_url": "https://api.github.com/users/echasnovski/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/echasnovski/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/echasnovski/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/echasnovski"
    }
}