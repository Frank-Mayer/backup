{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "To put it simple, `FocusGained` `autocmd` is triggered on startup in `neovim` within `tmux`. Or say it in another way, the `FocusGained` with neovim+tmux behaves like `VimEnter`.\r\n\r\nIt doesn't happen with `tmux + vim` but only `tmux + neovim`.\r\n\r\nIt doesn't happen with `neovim` without `tmux` but only `tmux + neovim`.\r\n\r\nI mean the `FocusGained` should not be triggered on startup, but only when user switching back to neovim.\r\n\r\nI only tested this on my notebook. Need some help to test whether it could be reproduced on other environments. \r\n\r\n### Tested Environments\r\n\r\nI reproduced the bug successfully with different env combinations, I'll list them all.\r\n\r\n- `nvim --version`:\r\n  - v0.4.4\r\n  - v0.5.0-dev+1326-ge0a01bdf7\r\n- Operating system/version: macOS 10.14.6\r\n- Terminal name/version:\r\n  - kitty 0.20.3, TERM=xterm-kitty\r\n  - iTerm 3.4.6, TERM=xterm256color\r\n  - tmux 3.2, TERM=screen, TERM=tmux-256color\r\n\r\n\r\n### Steps to reproduce\r\n\r\nTo leave alone impacts from other factors, create the following minimal conf for `tmux` and `neovim`.\r\n\r\nCreate a new tmp dir and create following conf files,\r\n\r\n`tmux.conf`\r\n\r\n```conf\r\nset -g focus-events on\r\n```\r\n\r\n`focus.vim`\r\n\r\n```vim\r\nset nocompatible\r\n\r\nfunction FocusGainedTest()\r\n  echom \"FocusGainedTest\"\r\nendfunction\r\n\r\naugroup FocusGainedTest\r\n  autocmd!\r\n  autocmd FocusGained * call FocusGainedTest()\r\naugroup END\r\n```\r\n\r\nSteps\r\n\r\n- Start a tmux sever with `tmux -f ./tmux.conf -S tmux.socket`\r\n- Once enter the tmux pane, start neovim with `nvim -u ./focus.vim`\r\n- Then you'll find the messages `FocusGainedTest`\r\n\r\nWhile, this doesn't happen with `vim -u ./focus.vim`, or `nvim` outside `tmux`.\r\n\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I can reproduce it. The weird thing is that it doesn't happen when you explicitly enable focus reporting before starting nvim:\r\n\r\n```\r\n$ tmux\r\n$ printf \"\\e[?1004h\"\r\n$ nvim\r\n```",
            "created_at": "2021-05-18T18:42:19Z",
            "html_url": "https://github.com/neovim/neovim/issues/14572#issuecomment-843439110",
            "id": 843439110,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14572",
            "node_id": "MDEyOklzc3VlQ29tbWVudDg0MzQzOTExMA==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/843439110/reactions"
            },
            "updated_at": "2021-05-18T18:43:04Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/843439110",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/972014?v=4",
                "events_url": "https://api.github.com/users/mhinz/events{/privacy}",
                "followers_url": "https://api.github.com/users/mhinz/followers",
                "following_url": "https://api.github.com/users/mhinz/following{/other_user}",
                "gists_url": "https://api.github.com/users/mhinz/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mhinz",
                "id": 972014,
                "login": "mhinz",
                "node_id": "MDQ6VXNlcjk3MjAxNA==",
                "organizations_url": "https://api.github.com/users/mhinz/orgs",
                "received_events_url": "https://api.github.com/users/mhinz/received_events",
                "repos_url": "https://api.github.com/users/mhinz/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mhinz/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mhinz/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mhinz"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Confirmed on 338b9032194a . It might be time to revert this hack (without regressing #7649): https://github.com/neovim/neovim/blob/338b9032194a4bc4c98439eb00f65a8ec86609f2/src/nvim/tui/tui.c#L503\r\n\r\nBut the patch below doesn't fix the issue... \r\n\r\nFor years I've noticed that \"enabling focus events\" in tmux also _triggers_ a focus event. Either we're doing something wrong, or Vim has a workaround?\r\n\r\n```diff\r\ndiff --git a/src/nvim/tui/tui.c b/src/nvim/tui/tui.c\r\nindex 720abb1cec2c..be3ed90d968e 100644\r\n--- a/src/nvim/tui/tui.c\r\n+++ b/src/nvim/tui/tui.c\r\n@@ -488,6 +488,7 @@ static void tui_main(UIBridgeData *bridge, UI *ui)\r\n #endif\r\n   tinput_init(&data->input, &tui_loop);\r\n   tui_terminal_start(ui);\r\n+  tui_terminal_after_startup(ui);\r\n \r\n   // Allow main thread to continue, we are ready to handle UI callbacks.\r\n   CONTINUE(bridge);\r\n@@ -499,9 +500,6 @@ static void tui_main(UIBridgeData *bridge, UI *ui)\r\n   for (size_t ms = 0; ms < 100 && !tui_is_stopped(ui);) {\r\n     ms += (loop_poll_events(&tui_loop, 20) ? 20 : 1);\r\n   }\r\n-  if (!tui_is_stopped(ui)) {\r\n-    tui_terminal_after_startup(ui);\r\n-  }\r\n   // \"Passive\" (I/O-driven) loop: TUI thread \"main loop\".\r\n   while (!tui_is_stopped(ui)) {\r\n     loop_poll_events(&tui_loop, -1);  // tui_loop.events is never processed\r\n```\r\n\r\n",
            "created_at": "2022-04-30T21:15:45Z",
            "html_url": "https://github.com/neovim/neovim/issues/14572#issuecomment-1114055383",
            "id": 1114055383,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14572",
            "node_id": "IC_kwDOAPphoM5CZyLX",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1114055383/reactions"
            },
            "updated_at": "2022-04-30T21:15:45Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1114055383",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk"
            }
        },
        {
            "author_association": "NONE",
            "body": "This issue still exists on nvim 0.9.1 and tmux 3.3a (need to set `set -g focus-events on`), I tried alacritty/terminal.app on macos and alacritty/windows terminal on windows 11, all of them can be used to reproduce this bug (I think linux desktop is the same).\r\n\r\n```bash\r\nnvim -i NONE -u NONE -c 'autocmd FocusGained * set number'\r\n```\r\n\r\nOne side effect of this issue is that if users set options in the FocusGained hook like above, the greeting text of neovim disappears immediately on startup.\r\n\r\n```bash\r\nvim -i NONE -u NONE -c 'autocmd FocusGained * set number'\r\n```\r\n\r\nVim doesn't have this issue.\r\n\r\nEdited:\r\n\r\nIt seems that tmux have fixed this bug on their side https://github.com/tmux/tmux/issues/3354 on https://github.com/tmux/tmux/commit/8edece2cdb7b4425526bae904506a246edbb6409#diff-bf43f6805d04e8b7c52a539d73952c30250fe3acaf513ef487261f94b30cba81, so the next release of tmux might resolve this issue.\r\n\r\nWorkaround for now:\r\n\r\n```bash\r\nalias nvim='printf \"\\e[?1004h\"; nvim'\r\n```",
            "created_at": "2023-08-06T12:03:48Z",
            "html_url": "https://github.com/neovim/neovim/issues/14572#issuecomment-1666835548",
            "id": 1666835548,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/14572",
            "node_id": "IC_kwDOAPphoM5jWeRc",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 1,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1666835548/reactions"
            },
            "updated_at": "2023-08-06T13:17:05Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1666835548",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/13472805?v=4",
                "events_url": "https://api.github.com/users/networkhermit/events{/privacy}",
                "followers_url": "https://api.github.com/users/networkhermit/followers",
                "following_url": "https://api.github.com/users/networkhermit/following{/other_user}",
                "gists_url": "https://api.github.com/users/networkhermit/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/networkhermit",
                "id": 13472805,
                "login": "networkhermit",
                "node_id": "MDQ6VXNlcjEzNDcyODA1",
                "organizations_url": "https://api.github.com/users/networkhermit/orgs",
                "received_events_url": "https://api.github.com/users/networkhermit/received_events",
                "repos_url": "https://api.github.com/users/networkhermit/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/networkhermit/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/networkhermit/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/networkhermit"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/14572/comments",
    "created_at": "2021-05-17T12:10:03Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/14572/events",
    "html_url": "https://github.com/neovim/neovim/issues/14572",
    "id": 893266362,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 197254545,
            "name": "tui",
            "node_id": "MDU6TGFiZWwxOTcyNTQ1NDU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/tui"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "events, autocommands",
            "id": 3341085842,
            "name": "events",
            "node_id": "MDU6TGFiZWwzMzQxMDg1ODQy",
            "url": "https://api.github.com/repos/neovim/neovim/labels/events"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/14572/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 189,
        "created_at": "2014-11-26T22:13:11Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk"
        },
        "description": "Zero priority; no timeline. Promote an item from this state by taking ownership of it.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/9",
        "id": 881978,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/9/labels",
        "node_id": "MDk6TWlsZXN0b25lODgxOTc4",
        "number": 9,
        "open_issues": 219,
        "state": "open",
        "title": "unplanned",
        "updated_at": "2023-08-04T13:50:38Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/9"
    },
    "node_id": "MDU6SXNzdWU4OTMyNjYzNjI=",
    "number": 14572,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/14572/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/14572/timeline",
    "title": "[Bug Report] FocusGained autocmd is triggered on startup within tmux",
    "updated_at": "2023-08-06T13:17:05Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/14572",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/12206611?v=4",
        "events_url": "https://api.github.com/users/laggardkernel/events{/privacy}",
        "followers_url": "https://api.github.com/users/laggardkernel/followers",
        "following_url": "https://api.github.com/users/laggardkernel/following{/other_user}",
        "gists_url": "https://api.github.com/users/laggardkernel/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/laggardkernel",
        "id": 12206611,
        "login": "laggardkernel",
        "node_id": "MDQ6VXNlcjEyMjA2NjEx",
        "organizations_url": "https://api.github.com/users/laggardkernel/orgs",
        "received_events_url": "https://api.github.com/users/laggardkernel/received_events",
        "repos_url": "https://api.github.com/users/laggardkernel/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/laggardkernel/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/laggardkernel/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/laggardkernel"
    }
}