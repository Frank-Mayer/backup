{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\nOccasionally, when I am using `nvim-treesitter`'s incremental selection, neovim crashes. I see it occurring while editing Rust and Python files.\r\n\r\nAt first I was pretty sure it was https://github.com/neovim/neovim/issues/24783 and https://github.com/neovim/neovim/issues/23613, which was finally fixed by https://github.com/neovim/neovim/pull/24796 and back ported to nvim v0.9.2. But even after updating I am still seeing similar crashes.\r\n\r\nIn the archive below are two coredumps of the crash, and following it the output of `bt` in gdb for the last coredump.\r\n\r\n[coredumps.tar.gz](https://github.com/neovim/neovim/files/12667664/coredumps.tar.gz)\r\n\r\n<details>\r\n  <summary>Backtrace</summary>\r\n\r\n```gdb\r\n           PID: 4597 (nvim)\r\n           UID: 1000 (rodrigodd)\r\n           GID: 1000 (rodrigodd)\r\n        Signal: 11 (SEGV)\r\n     Timestamp: Tue 2023-09-19 21:39:53 -03 (39min ago)\r\n  Command Line: nvim --embed render/src/lib.rs\r\n    Executable: /usr/bin/nvim\r\n Control Group: /user.slice/user-1000.slice/session-3.scope\r\n          Unit: session-3.scope\r\n         Slice: user-1000.slice\r\n       Session: 3\r\n     Owner UID: 1000 (rodrigodd)\r\n       Boot ID: 41590c1a451849c9b790cc567bbcc5f5\r\n    Machine ID: e031b41f9df244e2b74641456973fcab\r\n      Hostname: nb-rodrigo\r\n       Storage: /var/lib/systemd/coredump/core.nvim.1000.41590c1a451849c9b790cc567bbcc5f5.4597.1695170393000000.zst (present)\r\n  Size on Disk: 9.8M\r\n       Message: Process 4597 (nvim) of user 1000 dumped core.\r\n\r\n                Stack trace of thread 4597:\r\n                #0  0x00007f4067ec5f74 ts_node_end_point (libtree-sitter.so.0 + 0x7f74)\r\n                #1  0x0000556dc036fbee n/a (nvim + 0x1e9bee)\r\n                #2  0x00007f4067e1fef6 n/a (libluajit-5.1.so.2 + 0x9ef6)\r\n                #3  0x00007f4067e32ab3 lua_pcall (libluajit-5.1.so.2 + 0x1cab3)\r\n                #4  0x0000556dc03639b1 n/a (nvim + 0x1dd9b1)\r\n                #5  0x0000556dc0373163 n/a (nvim + 0x1ed163)\r\n                #6  0x0000556dc0374638 ex_lua (nvim + 0x1ee638)\r\n                #7  0x0000556dc0515881 n/a (nvim + 0x38f881)\r\n                #8  0x0000556dc0309559 do_cmdline (nvim + 0x183559)\r\n                #9  0x0000556dc03ca777 n/a (nvim + 0x244777)\r\n                #10 0x0000556dc03c4436 n/a (nvim + 0x23e436)\r\n                #11 0x0000556dc04931c7 state_enter (nvim + 0x30d1c7)\r\n                #12 0x0000556dc03c3309 normal_enter (nvim + 0x23d309)\r\n                #13 0x0000556dc01fb777 main (nvim + 0x75777)\r\n                #14 0x00007f4067a27cd0 n/a (libc.so.6 + 0x27cd0)\r\n                #15 0x00007f4067a27d8a __libc_start_main (libc.so.6 + 0x27d8a)\r\n                #16 0x0000556dc01fdb85 _start (nvim + 0x77b85)\r\n\r\n                Stack trace of thread 13134:\r\n                #0  0x0000000000000000 n/a (n/a + 0x0)\r\n                ELF object binary architecture: AMD x86-64\r\n\r\nGNU gdb (GDB) 13.2\r\nCopyright (C) 2023 Free Software Foundation, Inc.\r\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\r\nThis is free software: you are free to change and redistribute it.\r\nThere is NO WARRANTY, to the extent permitted by law.\r\nType \"show copying\" and \"show warranty\" for details.\r\nThis GDB was configured as \"x86_64-pc-linux-gnu\".\r\nType \"show configuration\" for configuration details.\r\nFor bug reporting instructions, please see:\r\n<https://www.gnu.org/software/gdb/bugs/>.\r\nFind the GDB manual and other documentation resources online at:\r\n    <http://www.gnu.org/software/gdb/documentation/>.\r\n\r\nFor help, type \"help\".\r\nType \"apropos word\" to search for commands related to \"word\"...\r\nReading symbols from /usr/bin/nvim...\r\nReading symbols from /home/rodrigodd/.cache/debuginfod_client/c581c5fbec614fe78eb1c89dc0bf1cb2eebcc357/debuginfo...\r\n\r\nwarning: Can't open file anon_inode:[io_uring] which was expanded to anon_inode:[io_uring] during file-backed mapping note processing\r\n\r\nwarning: Can't open file anon_inode:[io_uring] which was expanded to anon_inode:[io_uring] during file-backed mapping note processing\r\n\r\nwarning: Can't open file anon_inode:[io_uring] which was expanded to anon_inode:[io_uring] during file-backed mapping note processing\r\n\r\nwarning: Can't open file anon_inode:[io_uring] which was expanded to anon_inode:[io_uring] during file-backed mapping note processing\r\n\r\nwarning: Can't open file anon_inode:[io_uring] which was expanded to anon_inode:[io_uring] during file-backed mapping note processing\r\n\r\nwarning: Can't open file anon_inode:[io_uring] which was expanded to anon_inode:[io_uring] during file-backed mapping note processing\r\n\r\nwarning: Can't open file anon_inode:[io_uring] which was expanded to anon_inode:[io_uring] during file-backed mapping note processing\r\n\r\nwarning: Can't open file anon_inode:[io_uring] which was expanded to anon_inode:[io_uring] during file-backed mapping note processing\r\n[New LWP 4597]\r\n[New LWP 13134]\r\n[New LWP 4599]\r\n[New LWP 4616]\r\n[New LWP 19958]\r\n[New LWP 18796]\r\n[New LWP 4600]\r\n                                                                                                                                                                          --Type <RET> for more, q to quit, c to continue without paging--\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/usr/lib/libthread_db.so.1\".\r\nCore was generated by `nvim --embed render/src/lib.rs'.\r\nProgram terminated with signal SIGSEGV, Segmentation fault.\r\n#0  0x00007f4067ec5f74 in ts_node_end_point () from /usr/lib/libtree-sitter.so.0\r\n[Current thread is 1 (Thread 0x7f4067ccb740 (LWP 4597))]\r\n(gdb) bt\r\n#0  0x00007f4067ec5f74 in ts_node_end_point () from /usr/lib/libtree-sitter.so.0\r\n#1  0x0000556dc036fbee in node_range (L=0x7f4067cab380) at /usr/src/debug/neovim/neovim-0.9.2/src/nvim/lua/treesitter.c:821\r\n#2  0x00007f4067e1fef6 in lj_BC_FUNCC () at buildvm_x86.dasc:857\r\n#3  0x00007f4067e32ab3 in lua_pcall (L=L@entry=0x7f4067cab380, nargs=nargs@entry=0, nresults=nresults@entry=0, errfunc=errfunc@entry=-2)\r\n    at /usr/src/debug/luajit/luajit-2.0-4611e25/src/lj_api.c:1116\r\n#4  0x0000556dc03639b1 in nlua_pcall (lstate=0x7f4067cab380, nargs=0, nresults=0) at /usr/src/debug/neovim/neovim-0.9.2/src/nvim/lua/executor.c:159\r\n#5  0x0000556dc0373163 in nlua_typval_exec (lcmd=<optimized out>, lcmd_len=<optimized out>, name=<optimized out>, args=<optimized out>, argcount=0, special=false,\r\n    ret_tv=0x0) at /usr/src/debug/neovim/neovim-0.9.2/src/nvim/lua/executor.c:1443\r\n#6  0x0000556dc0374638 in nlua_typval_exec (ret_tv=0x0, special=false, argcount=0, args=0x0, name=0x556dc052730d \":lua\", lcmd_len=<optimized out>,\r\n    lcmd=0x556dc283d260 \"require'nvim-treesitter.incremental_selection'.node_incremental()\") at /usr/src/debug/neovim/neovim-0.9.2/src/nvim/memory.c:134\r\n#7  ex_lua (eap=<optimized out>) at /usr/src/debug/neovim/neovim-0.9.2/src/nvim/lua/executor.c:1639\r\n#8  0x0000556dc0515881 in execute_cmd0.constprop.0 (retv=0x7fffeda90c68, eap=0x7fffeda90cf0, errormsg=0x7fffeda90c60, preview=false)\r\n    at /usr/src/debug/neovim/neovim-0.9.2/src/nvim/ex_docmd.c:1620\r\n#9  0x0000556dc0309559 in do_one_cmd (cookie=0x0, fgetline=0x556dc031c830 <getexline>, cstack=0x7fffeda90eb0, flags=<optimized out>, cmdlinep=0x7fffeda90c58)\r\n    at /usr/src/debug/neovim/neovim-0.9.2/src/nvim/ex_docmd.c:2279\r\n#10 do_cmdline (cmdline=<optimized out>, fgetline=0x556dc031c830 <getexline>, cookie=0x0, flags=0) at /usr/src/debug/neovim/neovim-0.9.2/src/nvim/ex_docmd.c:578\r\n#11 0x0000556dc03ca777 in nv_colon (cap=0x7fffeda915d0) at /usr/src/debug/neovim/neovim-0.9.2/src/nvim/normal.c:3247\r\n#12 0x0000556dc03c4436 in normal_execute (state=0x7fffeda91550, key=<optimized out>) at /usr/src/debug/neovim/neovim-0.9.2/src/nvim/normal.c:1207\r\n#13 0x0000556dc04931c7 in state_enter (s=0x7fffeda91550) at /usr/src/debug/neovim/neovim-0.9.2/src/nvim/state.c:99\r\n#14 0x0000556dc03c3309 in normal_enter (cmdwin=<optimized out>, noexmode=<optimized out>) at /usr/src/debug/neovim/neovim-0.9.2/src/nvim/normal.c:497\r\n#15 0x0000556dc01fb777 in main (argc=<optimized out>, argv=<optimized out>) at /usr/src/debug/neovim/neovim-0.9.2/src/nvim/main.c:642\r\n```\r\n\r\n</details>\n\n### Steps to reproduce\n\nI tried both reproduction steps in https://github.com/neovim/neovim/issues/24783 and https://github.com/neovim/neovim/issues/23613, but they either did not triggered the crash or didn't work in v0.9.2 (missing treesitter parser, even though `:help treesitter-parsers` says neovim bundles them by default?).\r\n\r\nI could not create a reproduction, at least not yet.\n\n### Expected behavior\n\nnot crash\n\n### Neovim version (nvim -v)\n\nNVIM v0.9.2 Build type: Release LuaJIT 2.1.1694285958     system vimrc file: \"$VIM/sysinit.vim\"   fall-back for $VIM: \"/usr/share/nvim\"  Run :checkhealth for more info\n\n### Vim (not Nvim) behaves the same?\n\nN/A\n\n### Operating system/version\n\nArch Linux, kernel 6.5.3-zen1-1-zen\n\n### Terminal name/version\n\nalacritty 0.12.2 (9d9982df)\n\n### $TERM environment variable\n\nxterm-256color\n\n### Installation\n\npacman -S neovim",
    "closed_at": null,
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/25254/comments",
    "created_at": "2023-09-20T01:41:24Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/25254/events",
    "html_url": "https://github.com/neovim/neovim/issues/25254",
    "id": 1903940316,
    "labels": [
        {
            "color": "F9D0C4",
            "default": false,
            "description": "issue reporting a crash or segfault",
            "id": 435854234,
            "name": "bug-crash",
            "node_id": "MDU6TGFiZWw0MzU4NTQyMzQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-crash"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 1799626557,
            "name": "treesitter",
            "node_id": "MDU6TGFiZWwxNzk5NjI2NTU3",
            "url": "https://api.github.com/repos/neovim/neovim/labels/treesitter"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/25254/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5xe9Lc",
    "number": 25254,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/25254/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/25254/timeline",
    "title": "SIGSEGV in ts_node_end_point()",
    "updated_at": "2023-09-20T01:45:43Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/25254",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/51273772?v=4",
        "events_url": "https://api.github.com/users/Rodrigodd/events{/privacy}",
        "followers_url": "https://api.github.com/users/Rodrigodd/followers",
        "following_url": "https://api.github.com/users/Rodrigodd/following{/other_user}",
        "gists_url": "https://api.github.com/users/Rodrigodd/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/Rodrigodd",
        "id": 51273772,
        "login": "Rodrigodd",
        "node_id": "MDQ6VXNlcjUxMjczNzcy",
        "organizations_url": "https://api.github.com/users/Rodrigodd/orgs",
        "received_events_url": "https://api.github.com/users/Rodrigodd/received_events",
        "repos_url": "https://api.github.com/users/Rodrigodd/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/Rodrigodd/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Rodrigodd/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/Rodrigodd"
    }
}