{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\r\n\r\nThis assertion fails occasionally while editing code:\r\n\r\nhttps://github.com/neovim/neovim/blob/f67517bba30b6233bea85e1f6a8505171142d4ca/src/nvim/msgpack_rpc/unpacker.c#L467\r\n\r\nI can force it to fail by scrolling very quickly.\r\n\r\n### Steps to reproduce\r\n\r\n`repro.lua`:\r\n```lua\r\nfunction Repro()\r\n  vim.defer_fn(function()\r\n    local move_direction = math.random(2)\r\n    if move_direction == 1 then\r\n      for i=1,10 do\r\n        vim.api.nvim_feedkeys(\"5k\", \"n\", false)\r\n      end\r\n    else\r\n      for i=1,10 do\r\n        vim.api.nvim_feedkeys(\"5j\", \"n\", false)\r\n      end\r\n    end\r\n    Repro()\r\n  end, 0.05)\r\nend\r\n```\r\n\r\n```sh\r\nnvim --noplugin --clean -u repro.lua src/nvim/msgpack_rpc/unpacker.c\r\n```\r\n\r\nIt should crash within 30 seconds. If you get bored you can drag the corner of the terminal around while spamming `<C-c>` to try and mess with it more. Also having plugins (IDK if it matters which ones) seems to make it happen faster / more reliably.\r\n\r\n### Expected behavior\r\n\r\nNo crash.\r\n\r\n### Neovim version (nvim -v)\r\n\r\nbe10d65bf (0.10 nightly)\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nno\r\n\r\n### Operating system/version\r\n\r\nMacOS 13.4.1\r\n\r\n### Terminal name/version\r\n\r\nkitty 0.28.1\r\n\r\n### $TERM environment variable\r\n\r\nxterm-kitty\r\n\r\n### Installation\r\n\r\nbuild from repo",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "I'm now getting this at least once a day, so when I find some time I'll see if I can turn on an ELOG of the full state history of the state machine (if it's not too many bytes per second)\r\n\r\nI am using the bundled TUI (`nvim`), so if the msgpack is invalid, will need to look into both fixing it in the client-side, as well as converting the server-side response to a validation error (or just drop it and/or recover) instead of an assertion error ",
            "created_at": "2023-10-08T11:34:50Z",
            "html_url": "https://github.com/neovim/neovim/issues/25184#issuecomment-1752005050",
            "id": 1752005050,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25184",
            "node_id": "IC_kwDOAPphoM5obXm6",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1752005050/reactions"
            },
            "updated_at": "2023-10-08T11:38:09Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1752005050",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5601392?v=4",
                "events_url": "https://api.github.com/users/llllvvuu/events{/privacy}",
                "followers_url": "https://api.github.com/users/llllvvuu/followers",
                "following_url": "https://api.github.com/users/llllvvuu/following{/other_user}",
                "gists_url": "https://api.github.com/users/llllvvuu/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/llllvvuu",
                "id": 5601392,
                "login": "llllvvuu",
                "node_id": "MDQ6VXNlcjU2MDEzOTI=",
                "organizations_url": "https://api.github.com/users/llllvvuu/orgs",
                "received_events_url": "https://api.github.com/users/llllvvuu/received_events",
                "repos_url": "https://api.github.com/users/llllvvuu/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/llllvvuu/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/llllvvuu/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/llllvvuu"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "The only place we are touching `icells` within the loop is the increment:\r\n\r\nhttps://github.com/neovim/neovim/blob/9ff6f73f838a1f90d09922448c434033ba5e094e/src/nvim/msgpack_rpc/unpacker.c#L509\r\n\r\nTHat can't break it, so it must be already failing before the loop:\r\n\r\nhttps://github.com/neovim/neovim/blob/9ff6f73f838a1f90d09922448c434033ba5e094e/src/nvim/msgpack_rpc/unpacker.c#L453-L454\r\n\r\nEither `ncells` is negative or zero. I am going to instrument my code to find out:\r\n\r\n```diff\r\ng->ncells = (int)tok.length;\r\n+ assert(g->ncells >= 0);\r\n+ assert(g->ncells > 0);\r\n```\r\n\r\nBut I have a question, is is illegal to have zero `cells` in the [`ui-event-grid_line`](https://neovim.io/doc/user/ui.html#ui-event-grid_line)? Reading the spec, it seems like that should just be a no-op?\r\n\r\nI can only find this possible source of the message:\r\n\r\nhttps://github.com/neovim/neovim/blob/9ff6f73f838a1f90d09922448c434033ba5e094e/src/nvim/api/ui.c#L831",
            "created_at": "2023-10-10T13:12:17Z",
            "html_url": "https://github.com/neovim/neovim/issues/25184#issuecomment-1755403492",
            "id": 1755403492,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25184",
            "node_id": "IC_kwDOAPphoM5ooVTk",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1755403492/reactions"
            },
            "updated_at": "2023-10-10T13:17:14Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1755403492",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5601392?v=4",
                "events_url": "https://api.github.com/users/llllvvuu/events{/privacy}",
                "followers_url": "https://api.github.com/users/llllvvuu/followers",
                "following_url": "https://api.github.com/users/llllvvuu/following{/other_user}",
                "gists_url": "https://api.github.com/users/llllvvuu/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/llllvvuu",
                "id": 5601392,
                "login": "llllvvuu",
                "node_id": "MDQ6VXNlcjU2MDEzOTI=",
                "organizations_url": "https://api.github.com/users/llllvvuu/orgs",
                "received_events_url": "https://api.github.com/users/llllvvuu/received_events",
                "repos_url": "https://api.github.com/users/llllvvuu/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/llllvvuu/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/llllvvuu/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/llllvvuu"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> it seems like that should just be a no-op?\r\n\r\nYes.",
            "created_at": "2023-10-10T13:17:18Z",
            "html_url": "https://github.com/neovim/neovim/issues/25184#issuecomment-1755411762",
            "id": 1755411762,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25184",
            "node_id": "IC_kwDOAPphoM5ooXUy",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1755411762/reactions"
            },
            "updated_at": "2023-10-10T13:17:18Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1755411762",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
                "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
                "followers_url": "https://api.github.com/users/zeertzjq/followers",
                "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
                "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/zeertzjq",
                "id": 35768171,
                "login": "zeertzjq",
                "node_id": "MDQ6VXNlcjM1NzY4MTcx",
                "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
                "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
                "repos_url": "https://api.github.com/users/zeertzjq/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/zeertzjq"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "So that was not the only issue, it seems suspension is also an issue:\r\n\r\n```diff\r\nbool unpacker_advance(Unpacker *p)\r\n{\r\n+  if (p->state == 15) {\r\n+    GridLineEvent* g = p->grid_line_event;\r\n+    assert(g->icell < g->ncells + 1);\r\n+    // ^ doesn't crash, which makes memory corruption / concurrency less likely\r\n+    assert(g->icell < g->ncells); // issue is here\r\n+  }\r\n```\r\n\r\nNow to figure out: how do we finish parsing a grid line but not exit state 15 (thus re-entering it)?",
            "created_at": "2023-10-11T11:11:17Z",
            "html_url": "https://github.com/neovim/neovim/issues/25184#issuecomment-1757447111",
            "id": 1757447111,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25184",
            "node_id": "IC_kwDOAPphoM5owIPH",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 1,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1757447111/reactions"
            },
            "updated_at": "2023-10-11T11:28:38Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1757447111",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5601392?v=4",
                "events_url": "https://api.github.com/users/llllvvuu/events{/privacy}",
                "followers_url": "https://api.github.com/users/llllvvuu/followers",
                "following_url": "https://api.github.com/users/llllvvuu/following{/other_user}",
                "gists_url": "https://api.github.com/users/llllvvuu/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/llllvvuu",
                "id": 5601392,
                "login": "llllvvuu",
                "node_id": "MDQ6VXNlcjU2MDEzOTI=",
                "organizations_url": "https://api.github.com/users/llllvvuu/orgs",
                "received_events_url": "https://api.github.com/users/llllvvuu/received_events",
                "repos_url": "https://api.github.com/users/llllvvuu/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/llllvvuu/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/llllvvuu/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/llllvvuu"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> Now to figure out: how do we finish parsing a grid line but not exit state 15 (thus re-entering it)?\r\n\r\nOK I found this out. There is actually a control flow tucked behind a macro, where we can return \"unfinished\" state after finishing:\r\n\r\nhttps://github.com/neovim/neovim/blob/f67517bba30b6233bea85e1f6a8505171142d4ca/src/nvim/msgpack_rpc/unpacker.c#L513-L514\r\n\r\nhttps://github.com/neovim/neovim/blob/f67517bba30b6233bea85e1f6a8505171142d4ca/src/nvim/msgpack_rpc/unpacker.c#L388-L391\r\n\r\ni.e. we're suspending right after parsing the last cell but before parsing `wrap` in:\r\n```\r\n[\"grid_line\", grid, row, col_start, cells, wrap]\r\n```\r\n\r\nAnd now we're stuck thinking we're still parsing `cells` instead of parsing `wrap`.\r\n\r\nThe easiest way to handle this is just adding a state 16 for `wrap`. I'm gonna work on a patch.",
            "created_at": "2023-10-11T13:05:02Z",
            "html_url": "https://github.com/neovim/neovim/issues/25184#issuecomment-1757659898",
            "id": 1757659898,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25184",
            "node_id": "IC_kwDOAPphoM5ow8L6",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 2,
                "total_count": 2,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1757659898/reactions"
            },
            "updated_at": "2023-10-11T13:05:35Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1757659898",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5601392?v=4",
                "events_url": "https://api.github.com/users/llllvvuu/events{/privacy}",
                "followers_url": "https://api.github.com/users/llllvvuu/followers",
                "following_url": "https://api.github.com/users/llllvvuu/following{/other_user}",
                "gists_url": "https://api.github.com/users/llllvvuu/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/llllvvuu",
                "id": 5601392,
                "login": "llllvvuu",
                "node_id": "MDQ6VXNlcjU2MDEzOTI=",
                "organizations_url": "https://api.github.com/users/llllvvuu/orgs",
                "received_events_url": "https://api.github.com/users/llllvvuu/received_events",
                "repos_url": "https://api.github.com/users/llllvvuu/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/llllvvuu/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/llllvvuu/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/llllvvuu"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/25184/comments",
    "created_at": "2023-09-16T05:09:36Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/25184/events",
    "html_url": "https://github.com/neovim/neovim/issues/25184",
    "id": 1899300479,
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 197254545,
            "name": "tui",
            "node_id": "MDU6TGFiZWwxOTcyNTQ1NDU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/tui"
        },
        {
            "color": "c7def8",
            "default": false,
            "description": null,
            "id": 242522707,
            "name": "rpc",
            "node_id": "MDU6TGFiZWwyNDI1MjI3MDc=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/rpc"
        },
        {
            "color": "FBCA04",
            "default": false,
            "description": "We need minimal steps to reproduce the issue",
            "id": 298863445,
            "name": "needs:repro",
            "node_id": "MDU6TGFiZWwyOTg4NjM0NDU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/needs:repro"
        },
        {
            "color": "0E8A16",
            "default": false,
            "description": "issue contains a stacktrace/ASAN log",
            "id": 435854079,
            "name": "has:backtrace",
            "node_id": "MDU6TGFiZWw0MzU4NTQwNzk=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/has:backtrace"
        },
        {
            "color": "F9D0C4",
            "default": false,
            "description": "issue reporting a crash or segfault",
            "id": 435854234,
            "name": "bug-crash",
            "node_id": "MDU6TGFiZWw0MzU4NTQyMzQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-crash"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/25184/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5xNQZ_",
    "number": 25184,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 1,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 1,
        "url": "https://api.github.com/repos/neovim/neovim/issues/25184/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/25184/timeline",
    "title": "assertion failure at unpacker.c:466",
    "updated_at": "2023-10-11T13:05:35Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/25184",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/5601392?v=4",
        "events_url": "https://api.github.com/users/llllvvuu/events{/privacy}",
        "followers_url": "https://api.github.com/users/llllvvuu/followers",
        "following_url": "https://api.github.com/users/llllvvuu/following{/other_user}",
        "gists_url": "https://api.github.com/users/llllvvuu/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/llllvvuu",
        "id": 5601392,
        "login": "llllvvuu",
        "node_id": "MDQ6VXNlcjU2MDEzOTI=",
        "organizations_url": "https://api.github.com/users/llllvvuu/orgs",
        "received_events_url": "https://api.github.com/users/llllvvuu/received_events",
        "repos_url": "https://api.github.com/users/llllvvuu/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/llllvvuu/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/llllvvuu/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/llllvvuu"
    }
}