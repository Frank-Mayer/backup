{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\r\n\r\nWhen calling `syntax enable` or `syntax on` (or `vim.cmd.syntax(...)`) in init.lua, Neovim sources filetype plugins on the `packpath` immediately, when starting Neovim with a filetype as an argument.\r\n\r\nThis behaviour is not reproducible in Vim.\r\n\r\n### Steps to reproduce\r\n\r\nI have created [a repository](https://github.com/mrcjkb/neovim-syntax-bug) to reproduce this issue.\r\nIt contains examples in Lua (`startup-lua` directory) and Vimscript (`startup-vimscript` directory) , which each contains:\r\n\r\n- An init file that calls `syntax on` and then sets `vim.g.init_lua_sourced = true`.\r\n- A `pack/debug/start/myPlugin/ftplugin/rust.lua` (and `rust.vim` respectiveley), which prints an error if `vim.g.init_lua_sourced` is not set.\r\n\r\nTo reproduce, call\r\n\r\n```console\r\n# from the startup-lua directory\r\nnvim --cmd \"set packpath^=$PWD\"  -u init.lua main.rs`\r\n```\r\nor \r\n\r\n```console\r\n# from the startup-vimscript directory\r\nnvim --cmd \"set packpath^=$PWD\" -u init.vim main.rs`\r\n```\r\n\r\n-> This prints an error message, because the filetype plugin is sourced as soon as `syntax on` or `syntax enable` is called, before the init file is sourced.\r\n\r\nTo confirm that this is a Neovim bug, and not present in Vim, one can run the same command from the startup-vimscript directory (which enables the `filetype` plugin):\r\n\r\n```console\r\n# from the startup-vimscript directory\r\nvim --cmd \"set packpath^=$PWD\"  -u init.vim main.rs`\r\n```\r\n\r\n-> Echos `init.vim sourced before ftplugin on packpath/start`; no error message is printed.\r\n\r\nVersions used:\r\n\r\n- NVIM v0.10.0-dev-eae6727\r\n- NVIM v0.9.4\r\n- vim 9.0 (Huge version without GUI.)\r\n\r\nNote: I have reproduced this on NixOS, but the behaviour has also [been observed on MacOS](https://github.com/mrcjkb/rustaceanvim/discussions/77).\r\n\r\n### Expected behavior\r\n\r\nNo error message is printed, because the init file is sourced completely before the filetype plugin.\r\n\r\n### Neovim version (nvim -v)\r\n\r\nv0.10.0-dev-eae6727\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nno, vim 9.0 (Huge version without GUI.)\r\n\r\n### Operating system/version\r\n\r\nNixOS 24.05 unstable + macOS 14.1.1\r\n\r\n### Terminal name/version\r\n\r\nalacritty 0.12.3 \r\n\r\n### $TERM environment variable\r\n\r\nalacritty\r\n\r\n### Installation\r\n\r\nnixpkgs\r\n\r\n### Additional info\r\n\r\n<details>\r\n<summary>\r\nStack trace (lua version)\r\n</summary>\r\n\r\n```\r\nError detected while processing BufNewFile Autocommands for \"*\":\r\nError executing lua callback: ...neovim-unwrapped-eae6727/share/nvim/runtime/filetype.lua:30: Error executing lua: ...neovim-unwrapped-eae6727/share/nvim/runtime/filetype.lua:31: BufNewFile Au\r\ntocommands for \"*\"..FileType Autocommands for \"*\"..function <SNR>1_LoadFTPlugin[20]..script /home/mrcjk/playground/neovim/neovim-syntax-bug/startup-lua/pack/debug/start/myPlugin/ftplugin/rust.\r\nlua: Vim(runtime):E5113: Error while calling lua chunk: .../startup-lua/pack/debug/start/myPlugin/ftplugin/rust.lua:2: init.lua sourced after ftplugin on packpath/start\r\nstack traceback:\r\n        [C]: in function 'error'\r\n        .../startup-lua/pack/debug/start/myPlugin/ftplugin/rust.lua:2: in main chunk\r\n        [C]: in function 'nvim_cmd'\r\n        ...neovim-unwrapped-eae6727/share/nvim/runtime/filetype.lua:31: in function <...neovim-unwrapped-eae6727/share/nvim/runtime/filetype.lua:30>\r\n        [C]: in function 'nvim_buf_call'\r\n        ...neovim-unwrapped-eae6727/share/nvim/runtime/filetype.lua:30: in function <...neovim-unwrapped-eae6727/share/nvim/runtime/filetype.lua:10>\r\nstack traceback:\r\n        [C]: in function 'nvim_cmd'\r\n        ...neovim-unwrapped-eae6727/share/nvim/runtime/filetype.lua:31: in function <...neovim-unwrapped-eae6727/share/nvim/runtime/filetype.lua:30>\r\n        [C]: in function 'nvim_buf_call'\r\n        ...neovim-unwrapped-eae6727/share/nvim/runtime/filetype.lua:30: in function <...neovim-unwrapped-eae6727/share/nvim/runtime/filetype.lua:10>\r\nstack traceback:\r\n        [C]: in function 'nvim_buf_call'\r\n        ...neovim-unwrapped-eae6727/share/nvim/runtime/filetype.lua:30: in function <...neovim-unwrapped-eae6727/share/nvim/runtime/filetype.lua:10>\r\n```\r\n\r\n</details>\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "Note: The order of the CLI arguments is important here.\r\nSetting the packpath after `-u init.lua` does not reproduce the behaviour (the order of arguments doesn't matter for Vim).\r\nHowever, this may be an issue for plugin managers like minpac, where the packpath can be set before plugin configuration globals are set.\r\n\r\n[This](https://github.com/mrcjkb/neovim-fork/blob/b3eda5e73f65092d50ccd27a0373e8b9fad076b0/runtime/lua/vim/filetype/options.lua#L5C1-L5C1) is where Neovim's filetype.lua searches for filetype plugins.\r\n\r\nIt appears that setting the packpath adds it to the runtimepath before [plugins are loaded](https://github.com/MrcJkb/neovim-fork/blob/b3eda5e73f65092d50ccd27a0373e8b9fad076b0/src/nvim/runtime.c#L1236)?",
            "created_at": "2024-01-02T21:52:33Z",
            "html_url": "https://github.com/neovim/neovim/issues/26859#issuecomment-1874610765",
            "id": 1874610765,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/26859",
            "node_id": "IC_kwDOAPphoM5vvEpN",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1874610765/reactions"
            },
            "updated_at": "2024-01-02T22:15:20Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1874610765",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/12857160?v=4",
                "events_url": "https://api.github.com/users/mrcjkb/events{/privacy}",
                "followers_url": "https://api.github.com/users/mrcjkb/followers",
                "following_url": "https://api.github.com/users/mrcjkb/following{/other_user}",
                "gists_url": "https://api.github.com/users/mrcjkb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mrcjkb",
                "id": 12857160,
                "login": "mrcjkb",
                "node_id": "MDQ6VXNlcjEyODU3MTYw",
                "organizations_url": "https://api.github.com/users/mrcjkb/orgs",
                "received_events_url": "https://api.github.com/users/mrcjkb/received_events",
                "repos_url": "https://api.github.com/users/mrcjkb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mrcjkb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mrcjkb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mrcjkb"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/26859/comments",
    "created_at": "2024-01-02T21:09:44Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/26859/events",
    "html_url": "https://github.com/neovim/neovim/issues/26859",
    "id": 2062958797,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "Nvim startup sequence (`:h startup`)",
            "id": 870629450,
            "name": "startup",
            "node_id": "MDU6TGFiZWw4NzA2Mjk0NTA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/startup"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/26859/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM569kDN",
    "number": 26859,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/26859/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/26859/timeline",
    "title": "`syntax [enable|on]` leads to `start` filetype plugins on the `packpath` being sourced prematurely",
    "updated_at": "2024-01-02T22:15:20Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/26859",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/12857160?v=4",
        "events_url": "https://api.github.com/users/mrcjkb/events{/privacy}",
        "followers_url": "https://api.github.com/users/mrcjkb/followers",
        "following_url": "https://api.github.com/users/mrcjkb/following{/other_user}",
        "gists_url": "https://api.github.com/users/mrcjkb/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/mrcjkb",
        "id": 12857160,
        "login": "mrcjkb",
        "node_id": "MDQ6VXNlcjEyODU3MTYw",
        "organizations_url": "https://api.github.com/users/mrcjkb/orgs",
        "received_events_url": "https://api.github.com/users/mrcjkb/received_events",
        "repos_url": "https://api.github.com/users/mrcjkb/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/mrcjkb/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mrcjkb/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/mrcjkb"
    }
}