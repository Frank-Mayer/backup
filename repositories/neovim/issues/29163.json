{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\r\n\r\nhttps://github.com/neovim/neovim/pull/28943 changed the lsp code to use `vim.b[bufnr].changedtick` as the LSP document version.\r\n\r\nNow there’s no way to send the correct document version in a `workspace/executeCommand` after saving a modified buffer. This is because `changedtick` is incremented when \"Resetting modified when writing the buffer\" https://neovim.io/doc/user/eval.html#b:changedtick but the server is not notified of this new version.\r\n\r\n### Steps to reproduce\r\n\r\n1. User edits buffer\r\n    * Client sends `textDocument/didChange` (version 1)\r\n2. User saves buffer\r\n    * `changedtick` is incremented to version 2\r\n    * Client sends `textDocument/didSave` (no version sent)\r\n4. User runs custom lsp command (ex: `:EslintFixAll`)\r\n    * Client sends `workspace/executeCommand` (version 2)\r\n    * LSP ignores command because it hasn’t seen version 2 yet.\r\n\r\n### Expected behavior\r\n\r\nSome way to get the last sent buffer version for `workspace/executeCommand` usage.\r\n\r\n### Neovim version (nvim -v)\r\n\r\nNVIM v0.11.0-dev-158+g05435a915\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nN/A\r\n\r\n### Operating system/version\r\n\r\nUbuntu 22.04.4 LTS\r\n\r\n### Terminal name/version\r\n\r\nalacritty 0.12.2\r\n\r\n### $TERM environment variable\r\n\r\nalacritty\r\n\r\n### Installation\r\n\r\nbob",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "cc @mfussenegger",
            "created_at": "2024-06-03T13:52:49Z",
            "html_url": "https://github.com/neovim/neovim/issues/29163#issuecomment-2145263798",
            "id": 2145263798,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/29163",
            "node_id": "IC_kwDOAPphoM5_3iC2",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2145263798/reactions"
            },
            "updated_at": "2024-06-03T13:52:49Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2145263798",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/943597?v=4",
                "events_url": "https://api.github.com/users/icholy/events{/privacy}",
                "followers_url": "https://api.github.com/users/icholy/followers",
                "following_url": "https://api.github.com/users/icholy/following{/other_user}",
                "gists_url": "https://api.github.com/users/icholy/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/icholy",
                "id": 943597,
                "login": "icholy",
                "node_id": "MDQ6VXNlcjk0MzU5Nw==",
                "organizations_url": "https://api.github.com/users/icholy/orgs",
                "received_events_url": "https://api.github.com/users/icholy/received_events",
                "repos_url": "https://api.github.com/users/icholy/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/icholy/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/icholy/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/icholy"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "## Repro:\r\n\r\n**init.lua**\r\n\r\n``` lua\r\nvim.api.nvim_create_autocmd(\"FileType\", {\r\n    pattern = \"go\",\r\n    callback = function()\r\n        vim.lsp.start({ cmd = { \"gopls\" } })\r\n    end\r\n})\r\n```\r\n\r\n**main.go**\r\n\r\n``` go\r\n// delete me\r\npackage main\r\n\r\nfunc main() {\r\n\tfmt.Println()\r\n}\r\n```\r\n\r\n**Steps:**\r\n\r\n1. `nvim --clean -u init.lua main.go`\r\n2. Delete the first line `dd`\r\n3. Save the buffer `:w`\r\n4. Run code action `:lua vim.lsp.buf.code_action({ apply = true })`",
            "created_at": "2024-06-03T16:55:41Z",
            "html_url": "https://github.com/neovim/neovim/issues/29163#issuecomment-2145698334",
            "id": 2145698334,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/29163",
            "node_id": "IC_kwDOAPphoM5_5MIe",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2145698334/reactions"
            },
            "updated_at": "2024-06-03T17:38:04Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2145698334",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/943597?v=4",
                "events_url": "https://api.github.com/users/icholy/events{/privacy}",
                "followers_url": "https://api.github.com/users/icholy/followers",
                "following_url": "https://api.github.com/users/icholy/following{/other_user}",
                "gists_url": "https://api.github.com/users/icholy/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/icholy",
                "id": 943597,
                "login": "icholy",
                "node_id": "MDQ6VXNlcjk0MzU5Nw==",
                "organizations_url": "https://api.github.com/users/icholy/orgs",
                "received_events_url": "https://api.github.com/users/icholy/received_events",
                "repos_url": "https://api.github.com/users/icholy/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/icholy/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/icholy/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/icholy"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Thanks for the repro.\r\nI'm not entirely sure if https://github.com/neovim/neovim/pull/29170 is a sound approach, but it would fix the issue as far as I can tell.",
            "created_at": "2024-06-03T20:27:03Z",
            "html_url": "https://github.com/neovim/neovim/issues/29163#issuecomment-2146062472",
            "id": 2146062472,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/29163",
            "node_id": "IC_kwDOAPphoM5_6lCI",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2146062472/reactions"
            },
            "updated_at": "2024-06-03T20:27:03Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2146062472",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/38700?v=4",
                "events_url": "https://api.github.com/users/mfussenegger/events{/privacy}",
                "followers_url": "https://api.github.com/users/mfussenegger/followers",
                "following_url": "https://api.github.com/users/mfussenegger/following{/other_user}",
                "gists_url": "https://api.github.com/users/mfussenegger/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mfussenegger",
                "id": 38700,
                "login": "mfussenegger",
                "node_id": "MDQ6VXNlcjM4NzAw",
                "organizations_url": "https://api.github.com/users/mfussenegger/orgs",
                "received_events_url": "https://api.github.com/users/mfussenegger/received_events",
                "repos_url": "https://api.github.com/users/mfussenegger/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mfussenegger/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mfussenegger/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mfussenegger"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "The change seems reasonable to me (I tested locally and can't break it). But I suspect we're going to have similar issues with the semantic tokens & inlay hints. If that does end up being the case and more edge-case handling is required, I think it might make sense to revert https://github.com/neovim/neovim/pull/28943",
            "created_at": "2024-06-03T21:01:25Z",
            "html_url": "https://github.com/neovim/neovim/issues/29163#issuecomment-2146115362",
            "id": 2146115362,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/29163",
            "node_id": "IC_kwDOAPphoM5_6x8i",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2146115362/reactions"
            },
            "updated_at": "2024-06-03T21:01:25Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2146115362",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/943597?v=4",
                "events_url": "https://api.github.com/users/icholy/events{/privacy}",
                "followers_url": "https://api.github.com/users/icholy/followers",
                "following_url": "https://api.github.com/users/icholy/following{/other_user}",
                "gists_url": "https://api.github.com/users/icholy/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/icholy",
                "id": 943597,
                "login": "icholy",
                "node_id": "MDQ6VXNlcjk0MzU5Nw==",
                "organizations_url": "https://api.github.com/users/icholy/orgs",
                "received_events_url": "https://api.github.com/users/icholy/received_events",
                "repos_url": "https://api.github.com/users/icholy/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/icholy/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/icholy/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/icholy"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> But I suspect we're going to have similar issues with the semantic tokens & inlay hints.\r\n\r\nI was wondering about that too, but can't think of a scenario where it could be a problem. If the buffer is unchanged (modified=false), there shouldn't be any updates for semantic tokens, inlay hints, code lens and so on anyway.",
            "created_at": "2024-06-03T21:15:06Z",
            "html_url": "https://github.com/neovim/neovim/issues/29163#issuecomment-2146136636",
            "id": 2146136636,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/29163",
            "node_id": "IC_kwDOAPphoM5_63I8",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2146136636/reactions"
            },
            "updated_at": "2024-06-03T21:15:06Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2146136636",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/38700?v=4",
                "events_url": "https://api.github.com/users/mfussenegger/events{/privacy}",
                "followers_url": "https://api.github.com/users/mfussenegger/followers",
                "following_url": "https://api.github.com/users/mfussenegger/following{/other_user}",
                "gists_url": "https://api.github.com/users/mfussenegger/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mfussenegger",
                "id": 38700,
                "login": "mfussenegger",
                "node_id": "MDQ6VXNlcjM4NzAw",
                "organizations_url": "https://api.github.com/users/mfussenegger/orgs",
                "received_events_url": "https://api.github.com/users/mfussenegger/received_events",
                "repos_url": "https://api.github.com/users/mfussenegger/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mfussenegger/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mfussenegger/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mfussenegger"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I'm having a difficult time figuring out how a plugin should call `workspace/executeCommand` with the right version. I'm using the `:EslintFixAll` command as the example here.\r\n\r\nThe original (current) implementation has the problem where the version is being rejected on the server side because it's too new.\r\n\r\n``` lua\r\nlocal bufnr = util.validate_bufnr(opts.bufnr or 0)\r\nrequest(0, 'workspace/executeCommand', {\r\n\tcommand = 'eslint.applyAllFixes',\r\n\targuments = {\r\n\t\t{\r\n\t\t\turi = vim.uri_from_bufnr(bufnr),\r\n\t\t\tversion = lsp.util.buf_versions[bufnr],\r\n\t\t},\r\n\t},\r\n})\r\n```\r\n\r\nI tried rewriting it to use `vim.lsp.buf.code_action`. This doesn't work because `code_action` automatically populates the request `context` with diagnostics from the current line.\r\n\r\n``` lua\r\nlsp.buf.code_action({\r\n\tapply = true,\r\n\tfilter = function(a)\r\n\t\treturn vim.tbl_get(a, 'command', 'command') == 'eslint.applyAllFixes'\r\n\tend,\r\n})\r\n```\r\n\r\nI would need to use the unexported `diagnostic_vim_to_lsp` from `vim.diagnostic.lsp` to send all the diagnostics in the current file to achieve the original behaviour.\r\n\r\n``` lua\r\nlsp.buf.code_action({\r\n\tapply = true,\r\n\tcontext = {\r\n\t\tdiagnostics = diagnostic_vim_to_lsp(vim.diagnostic.get(0)),\r\n\t},\r\n\tfilter = function(a)\r\n\t\treturn vim.tbl_get(a, 'command', 'command') == 'eslint.applyAllFixes'\r\n\tend,\r\n})\r\n```\r\n\r\nThis feels like a lot of hoops to jump through to do something relatively simple.",
            "created_at": "2024-06-04T02:00:32Z",
            "html_url": "https://github.com/neovim/neovim/issues/29163#issuecomment-2146425492",
            "id": 2146425492,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/29163",
            "node_id": "IC_kwDOAPphoM5_79qU",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2146425492/reactions"
            },
            "updated_at": "2024-06-04T02:02:50Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2146425492",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/943597?v=4",
                "events_url": "https://api.github.com/users/icholy/events{/privacy}",
                "followers_url": "https://api.github.com/users/icholy/followers",
                "following_url": "https://api.github.com/users/icholy/following{/other_user}",
                "gists_url": "https://api.github.com/users/icholy/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/icholy",
                "id": 943597,
                "login": "icholy",
                "node_id": "MDQ6VXNlcjk0MzU5Nw==",
                "organizations_url": "https://api.github.com/users/icholy/orgs",
                "received_events_url": "https://api.github.com/users/icholy/received_events",
                "repos_url": "https://api.github.com/users/icholy/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/icholy/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/icholy/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/icholy"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/29163/comments",
    "created_at": "2024-06-03T13:16:39Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/29163/events",
    "html_url": "https://github.com/neovim/neovim/issues/29163",
    "id": 2331136540,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/29163/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM6K8lIc",
    "number": 29163,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/29163/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/29163/timeline",
    "title": "LSP: using changedtick as the document version breaks workspace/executeCommand usage",
    "updated_at": "2024-06-04T02:02:50Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/29163",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/943597?v=4",
        "events_url": "https://api.github.com/users/icholy/events{/privacy}",
        "followers_url": "https://api.github.com/users/icholy/followers",
        "following_url": "https://api.github.com/users/icholy/following{/other_user}",
        "gists_url": "https://api.github.com/users/icholy/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/icholy",
        "id": 943597,
        "login": "icholy",
        "node_id": "MDQ6VXNlcjk0MzU5Nw==",
        "organizations_url": "https://api.github.com/users/icholy/orgs",
        "received_events_url": "https://api.github.com/users/icholy/received_events",
        "repos_url": "https://api.github.com/users/icholy/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/icholy/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/icholy/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/icholy"
    }
}