{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\r\n\r\nNeovim generates an invalid `textDocument/didChange` message when deleting and pasting the entire file.\r\nThe message references the range {line 0 col 0 - line 1 col 0}, but when you delete the entire file, there is no line 1.\r\n\r\nI'm making a language server, and my server gets confused by this range, because it goes past the end of the file.\r\n\r\nEvery other language server I've tried seems to tolerate the invalid message, but I'm fairly sure Neovim's behavior isn't correct.\r\n\r\n### Steps to reproduce using \"nvim -u minimal_init.lua\"\r\n\r\nYou should be able to reproduce this really easily with almost any setup, as long as the language supports the `{\"change\":2}` mode. (pretty much all language servers do this).\r\n\r\nAt this point, skip down to the Steps section.\r\n\r\n# Probably unnecessary details\r\nIf you *really* want the exact same setup as me, you can follow these steps:\r\n<details>\r\n<summary>The exact steps to set up the environment</summary>\r\n\r\nDownload [fennel-ls](https://git.sr.ht/~xerool/fennel-ls/refs/0.1.0) and put it on the path. To run it, you also need need `lua` on the path, because fennel-ls runs in lua.\r\nThen, init.lua:\r\n\r\n```lua\r\n--- CHANGED THESE\r\nlocal pattern = '*.fnl'\r\nlocal cmd = {'fennel-ls'}\r\n-- Add files/folders here that indicate the root of a project\r\nlocal root_markers = {'.git', '.editorconfig'}\r\n-- Change to table with settings if required\r\nlocal settings = vim.empty_dict()\r\n\r\nvim.api.nvim_create_autocmd('BufEnter', {\r\n  pattern = pattern,\r\n  callback = function(args)\r\n    print(\"reached callback\")\r\n    local match = vim.fs.find(root_markers, { path = args.file, upward = true })[1]\r\n    local root_dir = match and vim.fn.fnamemodify(match, ':p:h') or nil\r\n    vim.lsp.start({\r\n      name = 'fennel-ls',\r\n      cmd = cmd,\r\n      root_dir = root_dir,\r\n      settings = settings\r\n    })\r\n  end\r\n})\r\n```\r\nI know bufenter is the wrong autocmd, but there is no filetype for .fnl.\r\n\r\nThen, `touch .editorconfig` so that the current dir is a root dir. `fennel-ls` needs a workspace to run in, so this is important.\r\nFinally, run the following steps, using `broken.fnl` as the filename.\r\n</details>\r\n\r\n# Steps\r\n1. Open a new file that starts a language server\r\n2. Type any text. (in my logs, I type the letter `o`)\r\n3. Move the cursor to the start of the file and use `dG` to delete everything\r\n4. Press `p` to paste everything back\r\n5. Observe that the message sent to the language server isn't valid.\r\n\r\n# Description of each sync step\r\nFor each step, I'll show the `textDocument/didOpen` and `textDocument/didChange` messages that are sent to the server, and what the file should contain.\r\n## Open a new file that starts a language server\r\n```json\r\n{\r\n  \"params\": {\r\n    \"textDocument\": {\r\n      \"version\": 0,\r\n      \"text\": \"\\n\",\r\n      \"uri\": \"file:///home/xerool/Documents/bug/broken.fnl\",\r\n      \"languageId\": \"fennel\"\r\n    }\r\n  },\r\n  \"jsonrpc\": \"2.0\",\r\n  \"method\": \"textDocument/didOpen\"\r\n}\r\n```\r\nOkay, so Neovim starts an \"empty\" file with a newline. That's fine. The contents of the file are `\"\\n\"`.\r\n\r\n## Type any text.\r\nIn this instance, I simply typed the letter `o`.\r\n```json\r\n{\r\n  \"params\": {\r\n    \"textDocument\": {\r\n      \"uri\": \"file:///home/xerool/Documents/bug/broken.fnl\",\r\n      \"version\": 4\r\n    },\r\n    \"contentChanges\": [\r\n      {\r\n        \"range\": {\r\n          \"end\": {\r\n            \"line\": 0,\r\n            \"character\": 0\r\n          },\r\n          \"start\": {\r\n            \"line\": 0,\r\n            \"character\": 0\r\n          }\r\n        },\r\n        \"text\": \"o\",\r\n        \"rangeLength\": 0\r\n      }\r\n    ]\r\n  },\r\n  \"jsonrpc\": \"2.0\",\r\n  \"method\": \"textDocument/didChange\"\r\n}\r\n```\r\nOkay, so we take the range {line 0 char 0 - line 0 char 0} and replace it with `\"o\"`. The contents of the file are `\"o\\n\"`.\r\n\r\n## Delete everything\r\n```json\r\n{\r\n  \"params\": {\r\n    \"textDocument\": {\r\n      \"uri\": \"file:///home/xerool/Documents/bug/broken.fnl\",\r\n      \"version\": 5\r\n    },\r\n    \"contentChanges\": [\r\n      {\r\n        \"range\": {\r\n          \"end\": {\r\n            \"line\": 1,\r\n            \"character\": 0\r\n          },\r\n          \"start\": {\r\n            \"line\": 0,\r\n            \"character\": 0\r\n          }\r\n        },\r\n        \"text\": \"\",\r\n        \"rangeLength\": 2\r\n      }\r\n    ]\r\n  },\r\n  \"jsonrpc\": \"2.0\",\r\n  \"method\": \"textDocument/didChange\"\r\n}\r\n```\r\nOkay, so we replace from {line 0 char 0 - line 1 char 0} with \"\". Now, the current content of the file is `\"\"`, with no newline. The file is empty.\r\n\r\n## Press `p`\r\n```json\r\n{\r\n  \"params\": {\r\n    \"textDocument\": {\r\n      \"uri\": \"file:///home/xerool/Documents/bug/broken.fnl\",\r\n      \"version\": 6\r\n    },\r\n    \"contentChanges\": [\r\n      {\r\n        \"range\": {\r\n          \"end\": {\r\n            \"line\": 1,\r\n            \"character\": 0\r\n          },\r\n          \"start\": {\r\n            \"line\": 0,\r\n            \"character\": 0\r\n          }\r\n        },\r\n        \"text\": \"\\no\\n\",\r\n        \"rangeLength\": 1\r\n      }\r\n    ]\r\n  },\r\n  \"jsonrpc\": \"2.0\",\r\n  \"method\": \"textDocument/didChange\"\r\n}\r\n```\r\nHere's where I've got a problem. According to the previous messages, the file's contents are `\"\"`. It's empty. However, the server is being asked to replace from {line 0 char 0 - line 1 char 0} with some text.\r\n\r\nThere is no position that corresponds to line 1 char 0, because there is no newline character in the file, and therefore no line 1.\r\n\r\nNow, you may argue that [the protocol](https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#range) says:\r\n>  If you want to specify a range that contains a line including the line ending character(s) then use an end position denoting the start of the next line.\r\n\r\nHowever, this doesn't apply here, because there is no \"line ending character(s)\" that could possibly be included here. I believe that Neovim's message isn't valid, and that it is correct for the language server to crash.\r\n\r\n### Expected behavior\r\n\r\nI expected the the content changes to be applicable to the file. For example: I would be okay if the final message did not try to reference line 1:\r\n```json\r\n{\r\n  \"params\": {\r\n    \"textDocument\": {\r\n      \"uri\": \"file:///home/xerool/Documents/bug/broken.fnl\",\r\n      \"version\": 6\r\n    },\r\n    \"contentChanges\": [\r\n      {\r\n        \"range\": {\r\n          \"end\": {\r\n            \"line\": 0,\r\n            \"character\": 0\r\n          },\r\n          \"start\": {\r\n            \"line\": 0,\r\n            \"character\": 0\r\n          }\r\n        },\r\n        \"text\": \"\\no\\n\",\r\n        \"rangeLength\": 1\r\n      }\r\n    ]\r\n  },\r\n  \"jsonrpc\": \"2.0\",\r\n  \"method\": \"textDocument/didChange\"\r\n}\r\n```\r\nIt would also be okay if instead, there was an extra \"contentChanges\" message after the `dP` that re-introduces the newline after telling the server that the newline was deleted. I'm not sure exactly where the server and client are desyncing, but I would like them to stay in sync.\r\n\r\n### Neovim version (nvim -v)\r\n\r\n0.9.5 Release\r\n\r\n### Language server name/version\r\n\r\nfennel-ls 0.1.0\r\n\r\n### Operating system/version\r\n\r\nArch Linux\r\n\r\n### Log file\r\n\r\nhttps://gist.github.com/XeroOl/873a8ab9968861cf33c73f8acea3ab28",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "i get a similar error when `yy`ing some line then `p`ing it somewhere on some other line. there's a chance that `p`ing will make the lsp get very out of sync. (have noticed this on tsx files). often get diagnostics about syntax error or something ridiculous that will go away when `:e`ing. treesitter syntax highlighting turns chaotic too",
            "created_at": "2024-03-08T02:34:09Z",
            "html_url": "https://github.com/neovim/neovim/issues/27383#issuecomment-1984940814",
            "id": 1984940814,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27383",
            "node_id": "IC_kwDOAPphoM52T8sO",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 4,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 4,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1984940814/reactions"
            },
            "updated_at": "2024-03-08T02:35:55Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1984940814",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/17482349?v=4",
                "events_url": "https://api.github.com/users/dylan-chong/events{/privacy}",
                "followers_url": "https://api.github.com/users/dylan-chong/followers",
                "following_url": "https://api.github.com/users/dylan-chong/following{/other_user}",
                "gists_url": "https://api.github.com/users/dylan-chong/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/dylan-chong",
                "id": 17482349,
                "login": "dylan-chong",
                "node_id": "MDQ6VXNlcjE3NDgyMzQ5",
                "organizations_url": "https://api.github.com/users/dylan-chong/orgs",
                "received_events_url": "https://api.github.com/users/dylan-chong/received_events",
                "repos_url": "https://api.github.com/users/dylan-chong/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/dylan-chong/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/dylan-chong/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/dylan-chong"
            }
        },
        {
            "author_association": "NONE",
            "body": "Yeah, I've seen desyncs happen like that, but I couldn't figure out how to reliably reproduce it. `dGp` was the first sequence of edits I tried that reliably reproduced the issue.\r\nI suspect there are other combinations of edits that causes more serious desyncs",
            "created_at": "2024-03-08T11:39:07Z",
            "html_url": "https://github.com/neovim/neovim/issues/27383#issuecomment-1985544871",
            "id": 1985544871,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27383",
            "node_id": "IC_kwDOAPphoM52WQKn",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1985544871/reactions"
            },
            "updated_at": "2024-03-12T15:49:59Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1985544871",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/6820998?v=4",
                "events_url": "https://api.github.com/users/XeroOl/events{/privacy}",
                "followers_url": "https://api.github.com/users/XeroOl/followers",
                "following_url": "https://api.github.com/users/XeroOl/following{/other_user}",
                "gists_url": "https://api.github.com/users/XeroOl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/XeroOl",
                "id": 6820998,
                "login": "XeroOl",
                "node_id": "MDQ6VXNlcjY4MjA5OTg=",
                "organizations_url": "https://api.github.com/users/XeroOl/orgs",
                "received_events_url": "https://api.github.com/users/XeroOl/received_events",
                "repos_url": "https://api.github.com/users/XeroOl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/XeroOl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/XeroOl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/XeroOl"
            }
        },
        {
            "author_association": "NONE",
            "body": "This could be related https://github.com/neovim/neovim/pull/16669\r\n\r\ncc @rish987 @mjlbach ",
            "created_at": "2024-03-11T01:13:56Z",
            "html_url": "https://github.com/neovim/neovim/issues/27383#issuecomment-1987461762",
            "id": 1987461762,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27383",
            "node_id": "IC_kwDOAPphoM52dkKC",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1987461762/reactions"
            },
            "updated_at": "2024-03-11T01:13:56Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1987461762",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/17482349?v=4",
                "events_url": "https://api.github.com/users/dylan-chong/events{/privacy}",
                "followers_url": "https://api.github.com/users/dylan-chong/followers",
                "following_url": "https://api.github.com/users/dylan-chong/following{/other_user}",
                "gists_url": "https://api.github.com/users/dylan-chong/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/dylan-chong",
                "id": 17482349,
                "login": "dylan-chong",
                "node_id": "MDQ6VXNlcjE3NDgyMzQ5",
                "organizations_url": "https://api.github.com/users/dylan-chong/orgs",
                "received_events_url": "https://api.github.com/users/dylan-chong/received_events",
                "repos_url": "https://api.github.com/users/dylan-chong/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/dylan-chong/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/dylan-chong/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/dylan-chong"
            }
        },
        {
            "author_association": "NONE",
            "body": "dear god this issue is constant. i'm running neovim `NVIM v0.10.0-dev-1495+g3d8f0cb69`. i have to run `:e` after writing a few lines of code, or pasting anything, otherwise the lsp is way out of sync. ocassionally `:e` doesnt even get the lsp to sync properly",
            "created_at": "2024-03-19T02:15:53Z",
            "html_url": "https://github.com/neovim/neovim/issues/27383#issuecomment-2005616294",
            "id": 2005616294,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27383",
            "node_id": "IC_kwDOAPphoM53i0am",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2005616294/reactions"
            },
            "updated_at": "2024-03-19T02:15:53Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2005616294",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/17482349?v=4",
                "events_url": "https://api.github.com/users/dylan-chong/events{/privacy}",
                "followers_url": "https://api.github.com/users/dylan-chong/followers",
                "following_url": "https://api.github.com/users/dylan-chong/following{/other_user}",
                "gists_url": "https://api.github.com/users/dylan-chong/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/dylan-chong",
                "id": 17482349,
                "login": "dylan-chong",
                "node_id": "MDQ6VXNlcjE3NDgyMzQ5",
                "organizations_url": "https://api.github.com/users/dylan-chong/orgs",
                "received_events_url": "https://api.github.com/users/dylan-chong/received_events",
                "repos_url": "https://api.github.com/users/dylan-chong/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/dylan-chong/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/dylan-chong/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/dylan-chong"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "For what it's worth, I've noticed similar issues with `typescript-language-server` as @dylan-chong. Could be related to https://github.com/neovim/neovim/issues/26483 - is dynamic registration enabled in this case?",
            "created_at": "2024-03-27T12:05:05Z",
            "html_url": "https://github.com/neovim/neovim/issues/27383#issuecomment-2022606579",
            "id": 2022606579,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27383",
            "node_id": "IC_kwDOAPphoM54jobz",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2022606579/reactions"
            },
            "updated_at": "2024-03-27T12:05:05Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2022606579",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/46619169?v=4",
                "events_url": "https://api.github.com/users/rudiejd/events{/privacy}",
                "followers_url": "https://api.github.com/users/rudiejd/followers",
                "following_url": "https://api.github.com/users/rudiejd/following{/other_user}",
                "gists_url": "https://api.github.com/users/rudiejd/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/rudiejd",
                "id": 46619169,
                "login": "rudiejd",
                "node_id": "MDQ6VXNlcjQ2NjE5MTY5",
                "organizations_url": "https://api.github.com/users/rudiejd/orgs",
                "received_events_url": "https://api.github.com/users/rudiejd/received_events",
                "repos_url": "https://api.github.com/users/rudiejd/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/rudiejd/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/rudiejd/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/rudiejd"
            }
        },
        {
            "author_association": "NONE",
            "body": "This is a different issue. I can reproduce this one regardless of if didChangeWatchedFiles is on or off.",
            "created_at": "2024-03-27T18:25:50Z",
            "html_url": "https://github.com/neovim/neovim/issues/27383#issuecomment-2023559248",
            "id": 2023559248,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27383",
            "node_id": "IC_kwDOAPphoM54nRBQ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2023559248/reactions"
            },
            "updated_at": "2024-03-27T18:25:50Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2023559248",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/6820998?v=4",
                "events_url": "https://api.github.com/users/XeroOl/events{/privacy}",
                "followers_url": "https://api.github.com/users/XeroOl/followers",
                "following_url": "https://api.github.com/users/XeroOl/following{/other_user}",
                "gists_url": "https://api.github.com/users/XeroOl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/XeroOl",
                "id": 6820998,
                "login": "XeroOl",
                "node_id": "MDQ6VXNlcjY4MjA5OTg=",
                "organizations_url": "https://api.github.com/users/XeroOl/orgs",
                "received_events_url": "https://api.github.com/users/XeroOl/received_events",
                "repos_url": "https://api.github.com/users/XeroOl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/XeroOl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/XeroOl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/XeroOl"
            }
        },
        {
            "author_association": "NONE",
            "body": "Angular language service crashes with\r\n```\r\n[ERROR][2024-03-29 09:21:11] .../vim/lsp/rpc.lua:789    \"rpc\"   \"ngserver\"\r\n\"stderr\"\r\n\"/home/iuri/.local/share/nvim/mason/packages/angular-language-server/node_modules/typescript/lib/tsserverlibrary.js:35508\\n\n\r\nDebug.assert(oldText.length - textChangeRange.span.length + textChangeRange.newLength === newText.length);\r\n\\n                  ^\\n\\nError:\r\nDebug Failure. False expression.\\n    at checkChangeRange\n\r\n(/home/iuri/.local/share/nvim/mason/packages/angular-language-server/node_modules/typescript/lib/tsserverlibrary.js:35508:19)\\n\r\nat Object.updateSourceFile2 [as updateSourceFile]\r\n(/home/iuri/.local/share/nvim/mason/packages/angular-language-server/node_modules/typescript/lib/tsserverlibrary.js:35213:11)\\n\r\nat updateSourceFile\r\n(/home/iuri/.local/share/nvim/mason/packages/angular-language-server/node_modules/typescript/lib/tsserverlibrary.js:27912:45)\\n\r\nat updateLanguageServiceSourceFile\r\n(/home/iuri/.local/share/nvim/mason/packages/angular-language-server/node_modules/typescript/lib/tsserverlibrary.js:139642:31)\\n\r\nat acquireOrUpdateDocument\r\n(/home/iuri/.local/share/nvim/mason/packages/angular-language-server/node_modules/typescript/lib/tsserverlibrary.js:131539:30)\\n\r\nat Object.updateDocumentWithKey\r\n(/home/iuri/.local/share/nvim/mason/packages/angular-language-server/node_modules/typescript/lib/tsserverlibrary.js:131464:14)\\n\r\nat Object.getOrCreateSourceFileByPath [as getSourceFileByPath]\r\n(/home/iuri/.local/share/nvim/mason/packages/angular-language-server/node_modules/typescript/lib/tsserverlibrary.js:139868:39)\\n\r\nat tryReuseStructureFromOldProgram\r\n(/home/iuri/.local/share/nvim/mason/packages/angular-language-server/node_modules/typescript/lib/tsserverlibrary.js:117260:61)\\n\r\nat createProgram\r\n(/home/iuri/.local/share/nvim/mason/packages/angular-language-server/node_modules/typescript/lib/tsserverlibrary.js:116680:25)\\n\r\nat synchronizeHostData\r\n(/home/iuri/.local/share/nvim/mason/packages/angular-language-server/node_modules/typescript/lib/tsserverlibrary.js:139809:17)\\n\\nNode.js\r\nv18.18.2\\n\"\r\n```\r\n\r\n---\r\n\r\nNot sure if related but  `buf_state.refs` https://github.com/neovim/neovim/blob/master/runtime/lua/vim/lsp/_changetracking.lua#L204 may be 0 while there's still clients attached to the loaded buffer, which causes `buf_state[bufnr]` to be nil on  https://github.com/neovim/neovim/blob/master/runtime/lua/vim/lsp/_changetracking.lua#L174.\r\n\r\n---\r\n\r\n`attempt to get length of a nil value` when `compute_diff` received\r\n```\r\n  curr_lines = { \"\",\r\n    [351] = \"      @if (uploadingVideo) {\",\r\n    [352] = \"\",\r\n    [353] = \"      )}\"\r\n  },\r\n  firstline = 353,\r\n  prev_lines = { \"\",\r\n    [351] = \"      @if (uploadingVideo) {\",\r\n    [352] = \"\"\r\n  }\r\n}\r\n```\r\nnote that `prev_lines[firstline]` is nil. (forgot to log the remaining values...)\r\n",
            "created_at": "2024-03-31T11:32:13Z",
            "html_url": "https://github.com/neovim/neovim/issues/27383#issuecomment-2028661506",
            "id": 2028661506,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27383",
            "node_id": "IC_kwDOAPphoM546usC",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2028661506/reactions"
            },
            "updated_at": "2024-03-31T12:59:21Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2028661506",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/20242530?v=4",
                "events_url": "https://api.github.com/users/iurimateus/events{/privacy}",
                "followers_url": "https://api.github.com/users/iurimateus/followers",
                "following_url": "https://api.github.com/users/iurimateus/following{/other_user}",
                "gists_url": "https://api.github.com/users/iurimateus/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/iurimateus",
                "id": 20242530,
                "login": "iurimateus",
                "node_id": "MDQ6VXNlcjIwMjQyNTMw",
                "organizations_url": "https://api.github.com/users/iurimateus/orgs",
                "received_events_url": "https://api.github.com/users/iurimateus/received_events",
                "repos_url": "https://api.github.com/users/iurimateus/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/iurimateus/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/iurimateus/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/iurimateus"
            }
        },
        {
            "author_association": "NONE",
            "body": "Looks like this may be a duplicate of https://github.com/neovim/neovim/issues/16259",
            "created_at": "2024-03-31T15:50:56Z",
            "html_url": "https://github.com/neovim/neovim/issues/27383#issuecomment-2028804084",
            "id": 2028804084,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27383",
            "node_id": "IC_kwDOAPphoM547Rf0",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2028804084/reactions"
            },
            "updated_at": "2024-03-31T15:50:56Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2028804084",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/6820998?v=4",
                "events_url": "https://api.github.com/users/XeroOl/events{/privacy}",
                "followers_url": "https://api.github.com/users/XeroOl/followers",
                "following_url": "https://api.github.com/users/XeroOl/following{/other_user}",
                "gists_url": "https://api.github.com/users/XeroOl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/XeroOl",
                "id": 6820998,
                "login": "XeroOl",
                "node_id": "MDQ6VXNlcjY4MjA5OTg=",
                "organizations_url": "https://api.github.com/users/XeroOl/orgs",
                "received_events_url": "https://api.github.com/users/XeroOl/received_events",
                "repos_url": "https://api.github.com/users/XeroOl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/XeroOl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/XeroOl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/XeroOl"
            }
        },
        {
            "author_association": "NONE",
            "body": "This line seems to be describing the issue, but I can still reproduce the bug.\r\n\r\nhttps://github.com/neovim/neovim/blob/master/runtime/lua/vim/lsp/_changetracking.lua#L101\r\n\r\nPerhaps this fixes it internally, but doesn't share with the language servers?\r\nPerhaps this line was added recently and my version of Neovim isn't up to date?\r\nAt least I have some possibilities to investigate.",
            "created_at": "2024-03-31T15:58:21Z",
            "html_url": "https://github.com/neovim/neovim/issues/27383#issuecomment-2028805914",
            "id": 2028805914,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27383",
            "node_id": "IC_kwDOAPphoM547R8a",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2028805914/reactions"
            },
            "updated_at": "2024-03-31T15:59:18Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2028805914",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/6820998?v=4",
                "events_url": "https://api.github.com/users/XeroOl/events{/privacy}",
                "followers_url": "https://api.github.com/users/XeroOl/followers",
                "following_url": "https://api.github.com/users/XeroOl/following{/other_user}",
                "gists_url": "https://api.github.com/users/XeroOl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/XeroOl",
                "id": 6820998,
                "login": "XeroOl",
                "node_id": "MDQ6VXNlcjY4MjA5OTg=",
                "organizations_url": "https://api.github.com/users/XeroOl/orgs",
                "received_events_url": "https://api.github.com/users/XeroOl/received_events",
                "repos_url": "https://api.github.com/users/XeroOl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/XeroOl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/XeroOl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/XeroOl"
            }
        },
        {
            "author_association": "NONE",
            "body": "I also have the same issue, with lua_ls and with tsserver.\r\n\r\nonce it get out of sync if I try to restart the lsp or execute `:e` I get weird errors like \r\n\r\n`tsserver: -32603: Request textDocument/documentHighlight failed with message: The document should be opened first: file:///some/path/to/file.ts\r\n`\r\nHere are the relevent errors in `:messages`\r\n```\r\n   Error  06:56:50 msg_show.lua_error Error executing lua callback: ...tly/nvim-linux64/share/nvim/runtime/lua/vim/lsp/sync.lua:380: attempt to get length of a nil value\r\nstack traceback:\r\n\t...tly/nvim-linux64/share/nvim/runtime/lua/vim/lsp/sync.lua:380: in function 'compute_range_length'\r\n\t...tly/nvim-linux64/share/nvim/runtime/lua/vim/lsp/sync.lua:443: in function 'compute_diff'\r\n\t...nux64/share/nvim/runtime/lua/vim/lsp/_changetracking.lua:106: in function 'incremental_changes'\r\n\t...nux64/share/nvim/runtime/lua/vim/lsp/_changetracking.lua:311: in function 'send_changes_for_group'\r\n\t...nux64/share/nvim/runtime/lua/vim/lsp/_changetracking.lua:348: in function 'send_changes'\r\n\t.../nightly/nvim-linux64/share/nvim/runtime/lua/vim/lsp.lua:461: in function <.../nightly/nvim-linux64/share/nvim/runtime/lua/vim/lsp.lua:448>\r\n```\r\n```\r\n   Error  06:58:27 msg_show.lua_error   e Error executing lua callback: ...nux64/share/nvim/runtime/lua/vim/lsp/_changetracking.lua:202: attempt to index local 'buf_state' (a nil value)\r\nstack traceback:\r\n\t...nux64/share/nvim/runtime/lua/vim/lsp/_changetracking.lua:202: in function 'reset_buf'\r\n\t.../nightly/nvim-linux64/share/nvim/runtime/lua/vim/lsp.lua:562: in function <.../nightly/nvim-linux64/share/nvim/runtime/lua/vim/lsp.lua:559>\r\n```\r\n\r\nThe only ways to \"fix it\" is to restart teh LspServer 2 ou 3 times. or quit and reopen nvim",
            "created_at": "2024-04-11T11:06:22Z",
            "html_url": "https://github.com/neovim/neovim/issues/27383#issuecomment-2049444016",
            "id": 2049444016,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27383",
            "node_id": "IC_kwDOAPphoM56KAiw",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2049444016/reactions"
            },
            "updated_at": "2024-04-14T23:56:33Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2049444016",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/342110?v=4",
                "events_url": "https://api.github.com/users/sudo-tee/events{/privacy}",
                "followers_url": "https://api.github.com/users/sudo-tee/followers",
                "following_url": "https://api.github.com/users/sudo-tee/following{/other_user}",
                "gists_url": "https://api.github.com/users/sudo-tee/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/sudo-tee",
                "id": 342110,
                "login": "sudo-tee",
                "node_id": "MDQ6VXNlcjM0MjExMA==",
                "organizations_url": "https://api.github.com/users/sudo-tee/orgs",
                "received_events_url": "https://api.github.com/users/sudo-tee/received_events",
                "repos_url": "https://api.github.com/users/sudo-tee/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/sudo-tee/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/sudo-tee/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/sudo-tee"
            }
        },
        {
            "author_association": "NONE",
            "body": "That sounds like a very different issue.\r\nThis issue is specifically about the incremental `textDocument/didChange` sync, and your `tsserver` log isn't complaining about a malformed `textDocument/didChange` notification.",
            "created_at": "2024-04-11T21:42:47Z",
            "html_url": "https://github.com/neovim/neovim/issues/27383#issuecomment-2050603551",
            "id": 2050603551,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27383",
            "node_id": "IC_kwDOAPphoM56Obof",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2050603551/reactions"
            },
            "updated_at": "2024-04-11T21:44:01Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2050603551",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/6820998?v=4",
                "events_url": "https://api.github.com/users/XeroOl/events{/privacy}",
                "followers_url": "https://api.github.com/users/XeroOl/followers",
                "following_url": "https://api.github.com/users/XeroOl/following{/other_user}",
                "gists_url": "https://api.github.com/users/XeroOl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/XeroOl",
                "id": 6820998,
                "login": "XeroOl",
                "node_id": "MDQ6VXNlcjY4MjA5OTg=",
                "organizations_url": "https://api.github.com/users/XeroOl/orgs",
                "received_events_url": "https://api.github.com/users/XeroOl/received_events",
                "repos_url": "https://api.github.com/users/XeroOl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/XeroOl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/XeroOl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/XeroOl"
            }
        }
    ],
    "comments": 11,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/27383/comments",
    "created_at": "2024-02-08T03:51:32Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/27383/events",
    "html_url": "https://github.com/neovim/neovim/issues/27383",
    "id": 2124307858,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/27383/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5-nl2S",
    "number": 27383,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 3,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 3,
        "url": "https://api.github.com/repos/neovim/neovim/issues/27383/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/27383/timeline",
    "title": "lsp: deleting entire file breaks incremental synchronization",
    "updated_at": "2024-04-14T23:56:33Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/27383",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/6820998?v=4",
        "events_url": "https://api.github.com/users/XeroOl/events{/privacy}",
        "followers_url": "https://api.github.com/users/XeroOl/followers",
        "following_url": "https://api.github.com/users/XeroOl/following{/other_user}",
        "gists_url": "https://api.github.com/users/XeroOl/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/XeroOl",
        "id": 6820998,
        "login": "XeroOl",
        "node_id": "MDQ6VXNlcjY4MjA5OTg=",
        "organizations_url": "https://api.github.com/users/XeroOl/orgs",
        "received_events_url": "https://api.github.com/users/XeroOl/received_events",
        "repos_url": "https://api.github.com/users/XeroOl/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/XeroOl/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/XeroOl/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/XeroOl"
    }
}