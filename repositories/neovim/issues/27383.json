{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\r\n\r\nNeovim generates an invalid `textDocument/didChange` message when deleting and pasting the entire file.\r\nThe message references the range {line 0 col 0 - line 1 col 0}, but when you delete the entire file, there is no line 1.\r\n\r\nI'm making a language server, and my server gets confused by this range, because it goes past the end of the file.\r\n\r\nEvery other language server I've tried seems to tolerate the invalid message, but I'm fairly sure Neovim's behavior isn't correct.\r\n\r\n### Steps to reproduce using \"nvim -u minimal_init.lua\"\r\n\r\nYou should be able to reproduce this really easily with almost any setup, as long as the language supports the `{\"change\":2}` mode. (pretty much all language servers do this).\r\n\r\nAt this point, skip down to the Steps section.\r\n\r\n# Probably unnecessary details\r\nIf you *really* want the exact same setup as me, you can follow these steps:\r\n<details>\r\n<summary>The exact steps to set up the environment</summary>\r\n\r\nDownload [fennel-ls](https://git.sr.ht/~xerool/fennel-ls/refs/0.1.0) and put it on the path. To run it, you also need need `lua` on the path, because fennel-ls runs in lua.\r\nThen, init.lua:\r\n\r\n```lua\r\n--- CHANGED THESE\r\nlocal pattern = '*.fnl'\r\nlocal cmd = {'fennel-ls'}\r\n-- Add files/folders here that indicate the root of a project\r\nlocal root_markers = {'.git', '.editorconfig'}\r\n-- Change to table with settings if required\r\nlocal settings = vim.empty_dict()\r\n\r\nvim.api.nvim_create_autocmd('BufEnter', {\r\n  pattern = pattern,\r\n  callback = function(args)\r\n    print(\"reached callback\")\r\n    local match = vim.fs.find(root_markers, { path = args.file, upward = true })[1]\r\n    local root_dir = match and vim.fn.fnamemodify(match, ':p:h') or nil\r\n    vim.lsp.start({\r\n      name = 'fennel-ls',\r\n      cmd = cmd,\r\n      root_dir = root_dir,\r\n      settings = settings\r\n    })\r\n  end\r\n})\r\n```\r\nI know bufenter is the wrong autocmd, but there is no filetype for .fnl.\r\n\r\nThen, `touch .editorconfig` so that the current dir is a root dir. `fennel-ls` needs a workspace to run in, so this is important.\r\nFinally, run the following steps, using `broken.fnl` as the filename.\r\n</details>\r\n\r\n# Steps\r\n1. Open a new file that starts a language server\r\n2. Type any text. (in my logs, I type the letter `o`)\r\n3. Move the cursor to the start of the file and use `dG` to delete everything\r\n4. Press `p` to paste everything back\r\n5. Observe that the message sent to the language server isn't valid.\r\n\r\n# Description of each sync step\r\nFor each step, I'll show the `textDocument/didOpen` and `textDocument/didChange` messages that are sent to the server, and what the file should contain.\r\n## Open a new file that starts a language server\r\n```json\r\n{\r\n  \"params\": {\r\n    \"textDocument\": {\r\n      \"version\": 0,\r\n      \"text\": \"\\n\",\r\n      \"uri\": \"file:///home/xerool/Documents/bug/broken.fnl\",\r\n      \"languageId\": \"fennel\"\r\n    }\r\n  },\r\n  \"jsonrpc\": \"2.0\",\r\n  \"method\": \"textDocument/didOpen\"\r\n}\r\n```\r\nOkay, so Neovim starts an \"empty\" file with a newline. That's fine. The contents of the file are `\"\\n\"`.\r\n\r\n## Type any text.\r\nIn this instance, I simply typed the letter `o`.\r\n```json\r\n{\r\n  \"params\": {\r\n    \"textDocument\": {\r\n      \"uri\": \"file:///home/xerool/Documents/bug/broken.fnl\",\r\n      \"version\": 4\r\n    },\r\n    \"contentChanges\": [\r\n      {\r\n        \"range\": {\r\n          \"end\": {\r\n            \"line\": 0,\r\n            \"character\": 0\r\n          },\r\n          \"start\": {\r\n            \"line\": 0,\r\n            \"character\": 0\r\n          }\r\n        },\r\n        \"text\": \"o\",\r\n        \"rangeLength\": 0\r\n      }\r\n    ]\r\n  },\r\n  \"jsonrpc\": \"2.0\",\r\n  \"method\": \"textDocument/didChange\"\r\n}\r\n```\r\nOkay, so we take the range {line 0 char 0 - line 0 char 0} and replace it with `\"o\"`. The contents of the file are `\"o\\n\"`.\r\n\r\n## Delete everything\r\n```json\r\n{\r\n  \"params\": {\r\n    \"textDocument\": {\r\n      \"uri\": \"file:///home/xerool/Documents/bug/broken.fnl\",\r\n      \"version\": 5\r\n    },\r\n    \"contentChanges\": [\r\n      {\r\n        \"range\": {\r\n          \"end\": {\r\n            \"line\": 1,\r\n            \"character\": 0\r\n          },\r\n          \"start\": {\r\n            \"line\": 0,\r\n            \"character\": 0\r\n          }\r\n        },\r\n        \"text\": \"\",\r\n        \"rangeLength\": 2\r\n      }\r\n    ]\r\n  },\r\n  \"jsonrpc\": \"2.0\",\r\n  \"method\": \"textDocument/didChange\"\r\n}\r\n```\r\nOkay, so we replace from {line 0 char 0 - line 1 char 0} with \"\". Now, the current content of the file is `\"\"`, with no newline. The file is empty.\r\n\r\n## Press `p`\r\n```json\r\n{\r\n  \"params\": {\r\n    \"textDocument\": {\r\n      \"uri\": \"file:///home/xerool/Documents/bug/broken.fnl\",\r\n      \"version\": 6\r\n    },\r\n    \"contentChanges\": [\r\n      {\r\n        \"range\": {\r\n          \"end\": {\r\n            \"line\": 1,\r\n            \"character\": 0\r\n          },\r\n          \"start\": {\r\n            \"line\": 0,\r\n            \"character\": 0\r\n          }\r\n        },\r\n        \"text\": \"\\no\\n\",\r\n        \"rangeLength\": 1\r\n      }\r\n    ]\r\n  },\r\n  \"jsonrpc\": \"2.0\",\r\n  \"method\": \"textDocument/didChange\"\r\n}\r\n```\r\nHere's where I've got a problem. According to the previous messages, the file's contents are `\"\"`. It's empty. However, the server is being asked to replace from {line 0 char 0 - line 1 char 0} with some text.\r\n\r\nThere is no position that corresponds to line 1 char 0, because there is no newline character in the file, and therefore no line 1.\r\n\r\nNow, you may argue that [the protocol](https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#range) says:\r\n>  If you want to specify a range that contains a line including the line ending character(s) then use an end position denoting the start of the next line.\r\n\r\nHowever, this doesn't apply here, because there is no \"line ending character(s)\" that could possibly be included here. I believe that Neovim's message isn't valid, and that it is correct for the language server to crash.\r\n\r\n### Expected behavior\r\n\r\nI expected the the content changes to be applicable to the file. For example: I would be okay if the final message did not try to reference line 1:\r\n```json\r\n{\r\n  \"params\": {\r\n    \"textDocument\": {\r\n      \"uri\": \"file:///home/xerool/Documents/bug/broken.fnl\",\r\n      \"version\": 6\r\n    },\r\n    \"contentChanges\": [\r\n      {\r\n        \"range\": {\r\n          \"end\": {\r\n            \"line\": 0,\r\n            \"character\": 0\r\n          },\r\n          \"start\": {\r\n            \"line\": 0,\r\n            \"character\": 0\r\n          }\r\n        },\r\n        \"text\": \"\\no\\n\",\r\n        \"rangeLength\": 1\r\n      }\r\n    ]\r\n  },\r\n  \"jsonrpc\": \"2.0\",\r\n  \"method\": \"textDocument/didChange\"\r\n}\r\n```\r\nIt would also be okay if instead, there was an extra \"contentChanges\" message after the `dP` that re-introduces the newline after telling the server that the newline was deleted. I'm not sure exactly where the server and client are desyncing, but I would like them to stay in sync.\r\n\r\n### Neovim version (nvim -v)\r\n\r\n0.9.5 Release\r\n\r\n### Language server name/version\r\n\r\nfennel-ls 0.1.0\r\n\r\n### Operating system/version\r\n\r\nArch Linux\r\n\r\n### Log file\r\n\r\nhttps://gist.github.com/XeroOl/873a8ab9968861cf33c73f8acea3ab28",
    "closed_at": null,
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/27383/comments",
    "created_at": "2024-02-08T03:51:32Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/27383/events",
    "html_url": "https://github.com/neovim/neovim/issues/27383",
    "id": 2124307858,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/27383/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5-nl2S",
    "number": 27383,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/27383/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/27383/timeline",
    "title": "lsp: deleting entire file breaks incremental synchronization",
    "updated_at": "2024-02-08T05:20:30Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/27383",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/6820998?v=4",
        "events_url": "https://api.github.com/users/XeroOl/events{/privacy}",
        "followers_url": "https://api.github.com/users/XeroOl/followers",
        "following_url": "https://api.github.com/users/XeroOl/following{/other_user}",
        "gists_url": "https://api.github.com/users/XeroOl/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/XeroOl",
        "id": 6820998,
        "login": "XeroOl",
        "node_id": "MDQ6VXNlcjY4MjA5OTg=",
        "organizations_url": "https://api.github.com/users/XeroOl/orgs",
        "received_events_url": "https://api.github.com/users/XeroOl/received_events",
        "repos_url": "https://api.github.com/users/XeroOl/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/XeroOl/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/XeroOl/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/XeroOl"
    }
}