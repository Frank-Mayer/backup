{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\r\n\r\nWith barely lsp setup and nothing else, goto def takes 15~ 20ms in 0.10 and 5~ 8ms in 0.9.5, which is much laggy when treesitter also take part in.\r\n\r\n### Steps to reproduce\r\n\r\ninit.lua\r\n```lua\r\nlocal lazypath = vim.fn.stdpath(\"data\") .. \"/lazy/lazy.nvim\"\r\n\r\n-- vim.o.sessionoptions = \"blank,buffers,curdir,help,tabpages,terminal,winsize,winpos,resize\"\r\nif not vim.loop.fs_stat(lazypath) then\r\n\tvim.fn.system({\r\n\t\t\"git\",\r\n\t\t\"clone\",\r\n\t\t\"--filter=blob:none\",\r\n\t\t\"https://github.com/folke/lazy.nvim.git\",\r\n\t\t\"--branch=stable\", -- latest stable release\r\n\t\tlazypath,\r\n\t})\r\nend\r\nvim.opt.rtp:prepend(lazypath)\r\nrequire(\"lazy\").setup({\r\n\t{\r\n\t\t\"neovim/nvim-lspconfig\",\r\n\t\tconfig = function()\r\n\t\t\trequire(\"lspconfig\")[\"rust_analyzer\"].setup({})\r\n\t\tend,\r\n\t},\r\n})\r\n\r\nlocal start_time = nil\r\n\r\nvim.api.nvim_create_autocmd(\"BufLeave\", {\r\n\tcallback = function()\r\n\t\tstart_time = vim.loop.hrtime()\r\n\tend,\r\n})\r\nvim.keymap.set(\"n\", \"gd\", function()\r\n\tvim.lsp.buf.definition()\r\nend)\r\n\r\nvim.api.nvim_create_autocmd(\"BufEnter\", {\r\n\tcallback = function()\r\n\t\tif start_time then\r\n\t\t\tlocal duration = 0.000001 * (vim.loop.hrtime() - start_time)\r\n\t\t\t-- __AUTO_GENERATED_PRINT_VAR_START__\r\n\t\t\tprint([==[function duration:]==], vim.inspect(duration)) -- __AUTO_GENERATED_PRINT_VAR_END__\r\n\t\tend\r\n\tend,\r\n})\r\n```\r\n2. take rust for example, which has the biggest lag feel\r\n3. mkdir ~/deftest && cd ~/deftest\r\n4. cargo new foo && nvim foo/src/main.rs\r\n5. in function main add `Vec::new`\r\n6. cursor on new and gd and see the print time\r\nperf result \r\n[profile10.json version 0.10](https://github.com/neovim/neovim/files/15123325/profile.json)\r\n[profile9.json version 0.9.5](https://github.com/neovim/neovim/files/15123328/profile2.json)\r\nbased on [profile.nvim](https://github.com/stevearc/profile.nvim)\r\nThe time is spend on `vim.lsp.buf_attach_client` and `FileType`\r\n### Expected behavior\r\n\r\nThe time should not differ 2x\r\n\r\n### Neovim version (nvim -v)\r\n\r\nNVIM v0.10.0-dev-2987+g3305bb9e4 Build type: RelWithDebInfo LuaJIT 2.1.1713484068 Run \"nvim -V1 -v\" for more info\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\ndon't know\r\n\r\n### Operating system/version\r\n\r\nmacos 14.2 (m1)\r\n\r\n### Terminal name/version\r\n\r\nkitty latest\r\n\r\n### $TERM environment variable\r\n\r\nxterm-kitty\r\n\r\n### Installation\r\n\r\ngithub release page",
    "closed_at": "2024-04-26T14:12:48Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "emm I tried a simple script result is different...\r\n\r\n```lua\r\nvim.cmd(\"syntax off\")\r\n\r\nvim.api.nvim_create_autocmd(\"FileType\", {\r\n\tpattern = \"rust\",\r\n\tcallback = function(opt)\r\n\t\tvim.lsp.start({\r\n\t\t\tcmd = { \"rust-analyzer\" },\r\n\t\t\troot_dir = vim.fs.dirname(vim.fs.find(\"cargo.toml\", { upward = true })[1]),\r\n\t\t}, { bufnr = opt.buf })\r\n\tend,\r\n})\r\n\r\nvim.keymap.set(\"n\", \"gd\", function()\r\n\tlocal orignal_fn = vim.lsp.buf_attach_client\r\n\tvim.lsp.buf_attach_client = function(bufnr, client_id)\r\n\t\tlocal s = (vim.uv or vim.loop).hrtime()\r\n\t\torignal_fn(bufnr, client_id)\r\n\t\t-- 0.9.5: 1743042\r\n\t\t-- 0.10 : 111875\r\n\t\tprint((vim.uv or vim.loop).hrtime() - s)\r\n\tend\r\n\tvim.lsp.buf.definition()\r\nend)\r\n```",
            "created_at": "2024-04-26T08:19:01Z",
            "html_url": "https://github.com/neovim/neovim/issues/28509#issuecomment-2078882150",
            "id": 2078882150,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/28509",
            "node_id": "IC_kwDOAPphoM576Tlm",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2078882150/reactions"
            },
            "updated_at": "2024-04-26T08:20:38Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2078882150",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/41671631?v=4",
                "events_url": "https://api.github.com/users/glepnir/events{/privacy}",
                "followers_url": "https://api.github.com/users/glepnir/followers",
                "following_url": "https://api.github.com/users/glepnir/following{/other_user}",
                "gists_url": "https://api.github.com/users/glepnir/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/glepnir",
                "id": 41671631,
                "login": "glepnir",
                "node_id": "MDQ6VXNlcjQxNjcxNjMx",
                "organizations_url": "https://api.github.com/users/glepnir/orgs",
                "received_events_url": "https://api.github.com/users/glepnir/received_events",
                "repos_url": "https://api.github.com/users/glepnir/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/glepnir/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/glepnir/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/glepnir"
            }
        },
        {
            "author_association": "NONE",
            "body": "> emm I tried a simple script result is different...\r\n> \r\n> ```lua\r\n> vim.cmd(\"syntax off\")\r\n> \r\n> vim.api.nvim_create_autocmd(\"FileType\", {\r\n> \tpattern = \"rust\",\r\n> \tcallback = function(opt)\r\n> \t\tvim.lsp.start({\r\n> \t\t\tcmd = { \"rust-analyzer\" },\r\n> \t\t\troot_dir = vim.fs.dirname(vim.fs.find(\"cargo.toml\", { upward = true })[1]),\r\n> \t\t}, { bufnr = opt.buf })\r\n> \tend,\r\n> })\r\n> \r\n> vim.keymap.set(\"n\", \"gd\", function()\r\n> \tlocal orignal_fn = vim.lsp.buf_attach_client\r\n> \tvim.lsp.buf_attach_client = function(bufnr, client_id)\r\n> \t\tlocal s = (vim.uv or vim.loop).hrtime()\r\n> \t\torignal_fn(bufnr, client_id)\r\n> \t\t-- 0.9.5: 1743042\r\n> \t\t-- 0.10 : 111875\r\n> \t\tprint((vim.uv or vim.loop).hrtime() - s)\r\n> \tend\r\n> \tvim.lsp.buf.definition()\r\n> end)\r\n> ```\r\n\r\nI test it and it shows 249167 in 0.9.5 and 1082250 in 0.10, with nvim -u NORC -u. not sure why.",
            "created_at": "2024-04-26T13:32:12Z",
            "html_url": "https://github.com/neovim/neovim/issues/28509#issuecomment-2079405562",
            "id": 2079405562,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/28509",
            "node_id": "IC_kwDOAPphoM578TX6",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2079405562/reactions"
            },
            "updated_at": "2024-04-26T13:32:12Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2079405562",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/97848247?v=4",
                "events_url": "https://api.github.com/users/xzbdmw/events{/privacy}",
                "followers_url": "https://api.github.com/users/xzbdmw/followers",
                "following_url": "https://api.github.com/users/xzbdmw/following{/other_user}",
                "gists_url": "https://api.github.com/users/xzbdmw/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/xzbdmw",
                "id": 97848247,
                "login": "xzbdmw",
                "node_id": "U_kgDOBdULtw",
                "organizations_url": "https://api.github.com/users/xzbdmw/orgs",
                "received_events_url": "https://api.github.com/users/xzbdmw/received_events",
                "repos_url": "https://api.github.com/users/xzbdmw/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/xzbdmw/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/xzbdmw/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/xzbdmw"
            }
        },
        {
            "author_association": "NONE",
            "body": "My bad, I try with an old version of 0.10 that is two month ago, with the newest one, it is faster in \r\nhttps://github.com/neovim/neovim/issues/28509#issuecomment-2078882150\r\nand with this script without lspconfig\r\n```lua\r\nlocal start_time = nil\r\n\r\nvim.api.nvim_create_autocmd(\"BufLeave\", {\r\n\tcallback = function()\r\n\t\tstart_time = vim.loop.hrtime()\r\n\tend,\r\n})\r\nvim.keymap.set(\"n\", \"gd\", function()\r\n\tvim.lsp.buf.definition()\r\nend)\r\n\r\nvim.api.nvim_create_autocmd(\"BufEnter\", {\r\n\tcallback = function()\r\n\t\tif start_time then\r\n\t\t\tlocal duration = 0.000001 * (vim.loop.hrtime() - start_time)\r\n\t\t\t-- __AUTO_GENERATED_PRINT_VAR_START__\r\n\t\t\tprint([==[function duration:]==], vim.inspect(duration)) -- __AUTO_GENERATED_PRINT_VAR_END__\r\n\t\tend\r\n\tend,\r\n})\r\n```\r\ntheir time is the same\r\n\r\nbut the orignal script with lspconfig is still 2x slower, so the problem is in lspconfig.",
            "created_at": "2024-04-26T14:12:49Z",
            "html_url": "https://github.com/neovim/neovim/issues/28509#issuecomment-2079478909",
            "id": 2079478909,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/28509",
            "node_id": "IC_kwDOAPphoM578lR9",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2079478909/reactions"
            },
            "updated_at": "2024-04-26T14:12:49Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2079478909",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/97848247?v=4",
                "events_url": "https://api.github.com/users/xzbdmw/events{/privacy}",
                "followers_url": "https://api.github.com/users/xzbdmw/followers",
                "following_url": "https://api.github.com/users/xzbdmw/following{/other_user}",
                "gists_url": "https://api.github.com/users/xzbdmw/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/xzbdmw",
                "id": 97848247,
                "login": "xzbdmw",
                "node_id": "U_kgDOBdULtw",
                "organizations_url": "https://api.github.com/users/xzbdmw/orgs",
                "received_events_url": "https://api.github.com/users/xzbdmw/received_events",
                "repos_url": "https://api.github.com/users/xzbdmw/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/xzbdmw/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/xzbdmw/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/xzbdmw"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "lspconfig has an extra check here. Since the jump to stdlib needs to check some paths and workspace clients reuse.",
            "created_at": "2024-04-27T02:27:52Z",
            "html_url": "https://github.com/neovim/neovim/issues/28509#issuecomment-2080326230",
            "id": 2080326230,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/28509",
            "node_id": "IC_kwDOAPphoM57_0JW",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2080326230/reactions"
            },
            "updated_at": "2024-04-27T02:27:52Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2080326230",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/41671631?v=4",
                "events_url": "https://api.github.com/users/glepnir/events{/privacy}",
                "followers_url": "https://api.github.com/users/glepnir/followers",
                "following_url": "https://api.github.com/users/glepnir/following{/other_user}",
                "gists_url": "https://api.github.com/users/glepnir/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/glepnir",
                "id": 41671631,
                "login": "glepnir",
                "node_id": "MDQ6VXNlcjQxNjcxNjMx",
                "organizations_url": "https://api.github.com/users/glepnir/orgs",
                "received_events_url": "https://api.github.com/users/glepnir/received_events",
                "repos_url": "https://api.github.com/users/glepnir/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/glepnir/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/glepnir/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/glepnir"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/28509/comments",
    "created_at": "2024-04-25T23:32:30Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/28509/events",
    "html_url": "https://github.com/neovim/neovim/issues/28509",
    "id": 2264657338,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "FEF2C0",
            "default": false,
            "description": "issues reporting performance problems",
            "id": 101930601,
            "name": "performance",
            "node_id": "MDU6TGFiZWwxMDE5MzA2MDE=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/performance"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/28509/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 611,
        "created_at": "2014-05-10T20:43:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk"
        },
        "description": "Low priority. Not planned for the current target, may be reassigned.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/6",
        "id": 655037,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/6/labels",
        "node_id": "MDk6TWlsZXN0b25lNjU1MDM3",
        "number": 6,
        "open_issues": 530,
        "state": "open",
        "title": "backlog",
        "updated_at": "2024-04-29T21:47:33Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/6"
    },
    "node_id": "I_kwDOAPphoM6G--26",
    "number": 28509,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/28509/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/28509/timeline",
    "title": "Lsp goto definition loading buffer twice slow in 0.10 ",
    "updated_at": "2024-04-27T02:27:53Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/28509",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/97848247?v=4",
        "events_url": "https://api.github.com/users/xzbdmw/events{/privacy}",
        "followers_url": "https://api.github.com/users/xzbdmw/followers",
        "following_url": "https://api.github.com/users/xzbdmw/following{/other_user}",
        "gists_url": "https://api.github.com/users/xzbdmw/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/xzbdmw",
        "id": 97848247,
        "login": "xzbdmw",
        "node_id": "U_kgDOBdULtw",
        "organizations_url": "https://api.github.com/users/xzbdmw/orgs",
        "received_events_url": "https://api.github.com/users/xzbdmw/received_events",
        "repos_url": "https://api.github.com/users/xzbdmw/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/xzbdmw/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/xzbdmw/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/xzbdmw"
    }
}