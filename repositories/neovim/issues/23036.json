{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\r\n\r\nThe output when using `--startuptime` includes two blocks of data.\r\n\r\nI noticed this when using Neovim 0.9 with a plugin I wrote that reports startuptime measurements, [vim-startuptime](https://github.com/dstein64/vim-startuptime).\r\n\r\n### Steps to reproduce\r\n\r\n```\r\n# first remove any existing startuptime output (assumed file tmpfile), otherwise the startuptime\r\n# output is appended to the existing file.\r\nrm tmpfile\r\n\r\nnvim --clean --startuptime tmpfile\r\n:quit\r\n```\r\n\r\nThis results in two blocks of data in `tmpfile` (I replaced some of the output with `...`). The numbers in the second block do not match the first, and also the second block has less lines than the first.\r\n\r\n```\r\n\r\ntimes in msec\r\n clock   self+sourced   self:  sourced script\r\n clock   elapsed:              other lines\r\n\r\n000.004  000.004: --- NVIM STARTING ---\r\n000.091  000.087: event init\r\n000.168  000.077: early init\r\n000.211  000.043: locale set\r\n000.252  000.041: init first window\r\n000.469  000.217: inits 1\r\n000.483  000.014: window checked\r\n000.487  000.004: parsing arguments\r\n000.812  000.038  000.038: require('vim.shared')\r\n000.885  000.027  000.027: require('vim._meta')\r\n000.887  000.072  000.046: require('vim._editor')\r\n000.888  000.147  000.037: require('vim._init_packages')\r\n...\r\n012.380  000.002: editing files in windows\r\n012.440  000.060: VimEnter autocommands\r\n012.442  000.002: UIEnter autocommands\r\n012.443  000.001: before starting main loop\r\n013.327  000.885: first screen update\r\n013.329  000.001: --- NVIM STARTED ---\r\n\r\n\r\ntimes in msec\r\n clock   self+sourced   self:  sourced script\r\n clock   elapsed:              other lines\r\n\r\n000.006  000.006: --- NVIM STARTING ---\r\n009.772  009.766: event init\r\n017.254  007.482: early init\r\n017.296  000.042: locale set\r\n021.391  004.095: init first window\r\n027.266  005.875: inits 1\r\n027.273  000.007: window checked\r\n027.276  000.003: parsing arguments\r\n031.589  000.031  000.031: require('vim.shared')\r\n031.668  000.034  000.034: require('vim._meta')\r\n031.669  000.077  000.043: require('vim._editor')\r\n031.670  000.141  000.033: require('vim._init_packages')\r\n031.673  004.255: init lua interpreter\r\n032.279  000.606: expanding arguments\r\n032.307  000.028: inits 2\r\n032.544  000.237: init highlight\r\n```\r\n\r\n### Expected behavior\r\n\r\nI expected a single block of data:\r\n\r\n```\r\ntimes in msec\r\n clock   self+sourced   self:  sourced script\r\n clock   elapsed:              other lines\r\n\r\n000.004  000.004: --- NVIM STARTING ---\r\n000.091  000.087: event init\r\n000.168  000.077: early init\r\n000.211  000.043: locale set\r\n000.252  000.041: init first window\r\n000.469  000.217: inits 1\r\n000.483  000.014: window checked\r\n000.487  000.004: parsing arguments\r\n000.812  000.038  000.038: require('vim.shared')\r\n000.885  000.027  000.027: require('vim._meta')\r\n000.887  000.072  000.046: require('vim._editor')\r\n000.888  000.147  000.037: require('vim._init_packages')\r\n...\r\n012.380  000.002: editing files in windows\r\n012.440  000.060: VimEnter autocommands\r\n012.442  000.002: UIEnter autocommands\r\n012.443  000.001: before starting main loop\r\n013.327  000.885: first screen update\r\n013.329  000.001: --- NVIM STARTED ---\r\n```\r\n\r\n### Neovim version (nvim -v)\r\n\r\nNVIM v0.9.0\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nNo (9.0.242)\r\n\r\n### Operating system/version\r\n\r\nKubuntu 22.10\r\n\r\n### Terminal name/version\r\n\r\nKonsole 22.08.2\r\n\r\n### $TERM environment variable\r\n\r\nxterm-256color\r\n\r\n### Installation\r\n\r\nappimage",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "`git bisect` shows that this started at one of the following commits:\r\n\r\n- 2448816\r\n- 43e8ec9\r\n\r\nI had to skip checking the first due to the following build error:\r\n```\r\nsrc/nvim/tui/tui.c:1262: undefined reference to `show_verbose_terminfo'\r\n```\r\n\r\nCc: @bfredl ",
            "created_at": "2023-04-12T03:56:16Z",
            "html_url": "https://github.com/neovim/neovim/issues/23036#issuecomment-1504554132",
            "id": 1504554132,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23036",
            "node_id": "IC_kwDOAPphoM5ZrayU",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1504554132/reactions"
            },
            "updated_at": "2023-04-12T03:56:26Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1504554132",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/541289?v=4",
                "events_url": "https://api.github.com/users/dstein64/events{/privacy}",
                "followers_url": "https://api.github.com/users/dstein64/followers",
                "following_url": "https://api.github.com/users/dstein64/following{/other_user}",
                "gists_url": "https://api.github.com/users/dstein64/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/dstein64",
                "id": 541289,
                "login": "dstein64",
                "node_id": "MDQ6VXNlcjU0MTI4OQ==",
                "organizations_url": "https://api.github.com/users/dstein64/orgs",
                "received_events_url": "https://api.github.com/users/dstein64/received_events",
                "repos_url": "https://api.github.com/users/dstein64/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/dstein64/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/dstein64/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/dstein64"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "yep, we need to integrate the output from the TUI process with the main process somehow.",
            "created_at": "2023-04-12T11:06:18Z",
            "html_url": "https://github.com/neovim/neovim/issues/23036#issuecomment-1505083034",
            "id": 1505083034,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23036",
            "node_id": "IC_kwDOAPphoM5Ztb6a",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1505083034/reactions"
            },
            "updated_at": "2023-04-12T11:06:18Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1505083034",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
                "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
                "followers_url": "https://api.github.com/users/bfredl/followers",
                "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
                "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bfredl",
                "id": 1363104,
                "login": "bfredl",
                "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
                "organizations_url": "https://api.github.com/users/bfredl/orgs",
                "received_events_url": "https://api.github.com/users/bfredl/received_events",
                "repos_url": "https://api.github.com/users/bfredl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bfredl"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "First and foremost we should ensure that each process writes to its own file. The way this is implemented today we have two processes that simultaneously write their times to the same file. It may look more or less well formatted but that's just because the TUI process happens to flush only until the process is stopped (i.e. when nvim is closed). You can verify this by inspecting the startuptimes file while nvim is still running. We can maybe include the pid in the filename, or create two files: filename.tui and filename.main.\r\n\r\nAlternatively each process can write to a memory buffer and flush it to the file once its initialization is done.\r\n\r\nOnce we have both files we must merge them into a single report, IMO a concatenation of both is probably acceptable:\r\n\r\n```\r\n-- TUI Process --\r\n(Startup times of TUI process)\r\n\r\n-- Main Process --\r\n(Startup times of Main process)\r\n```\r\nWe can try to merge the times of both processes into a single timeline but that is challeging as they don't start at the same time.\r\n\r\n@bfredl what do you think?",
            "created_at": "2023-12-25T17:18:20Z",
            "html_url": "https://github.com/neovim/neovim/issues/23036#issuecomment-1869060174",
            "id": 1869060174,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23036",
            "node_id": "IC_kwDOAPphoM5vZ5hO",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1869060174/reactions"
            },
            "updated_at": "2023-12-25T20:55:14Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1869060174",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/20794509?v=4",
                "events_url": "https://api.github.com/users/pabloariasal/events{/privacy}",
                "followers_url": "https://api.github.com/users/pabloariasal/followers",
                "following_url": "https://api.github.com/users/pabloariasal/following{/other_user}",
                "gists_url": "https://api.github.com/users/pabloariasal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/pabloariasal",
                "id": 20794509,
                "login": "pabloariasal",
                "node_id": "MDQ6VXNlcjIwNzk0NTA5",
                "organizations_url": "https://api.github.com/users/pabloariasal/orgs",
                "received_events_url": "https://api.github.com/users/pabloariasal/received_events",
                "repos_url": "https://api.github.com/users/pabloariasal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/pabloariasal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pabloariasal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/pabloariasal"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/23036/comments",
    "created_at": "2023-04-12T03:31:54Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/23036/events",
    "html_url": "https://github.com/neovim/neovim/issues/23036",
    "id": 1663656459,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 197254545,
            "name": "tui",
            "node_id": "MDU6TGFiZWwxOTcyNTQ1NDU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/tui"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "Nvim startup sequence (`:h startup`)",
            "id": 870629450,
            "name": "startup",
            "node_id": "MDU6TGFiZWw4NzA2Mjk0NTA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/startup"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/23036/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 42,
        "created_at": "2023-10-09T10:31:49Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
            "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
            "followers_url": "https://api.github.com/users/zeertzjq/followers",
            "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
            "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/zeertzjq",
            "id": 35768171,
            "login": "zeertzjq",
            "node_id": "MDQ6VXNlcjM1NzY4MTcx",
            "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
            "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
            "repos_url": "https://api.github.com/users/zeertzjq/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/zeertzjq"
        },
        "description": "",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/40",
        "id": 10019067,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/40/labels",
        "node_id": "MI_kwDOAPphoM4AmOD7",
        "number": 40,
        "open_issues": 6,
        "state": "open",
        "title": "0.9.5",
        "updated_at": "2023-12-26T01:26:25Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/40"
    },
    "node_id": "I_kwDOAPphoM5jKWIL",
    "number": 23036,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 2,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 2,
        "url": "https://api.github.com/repos/neovim/neovim/issues/23036/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/23036/timeline",
    "title": "TUI: recurring --startuptime output from both processes",
    "updated_at": "2023-12-25T20:55:14Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/23036",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/541289?v=4",
        "events_url": "https://api.github.com/users/dstein64/events{/privacy}",
        "followers_url": "https://api.github.com/users/dstein64/followers",
        "following_url": "https://api.github.com/users/dstein64/following{/other_user}",
        "gists_url": "https://api.github.com/users/dstein64/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/dstein64",
        "id": 541289,
        "login": "dstein64",
        "node_id": "MDQ6VXNlcjU0MTI4OQ==",
        "organizations_url": "https://api.github.com/users/dstein64/orgs",
        "received_events_url": "https://api.github.com/users/dstein64/received_events",
        "repos_url": "https://api.github.com/users/dstein64/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/dstein64/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/dstein64/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/dstein64"
    }
}