{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nIf running Neovim with the `-V1` flag, expanding `<afile>` inside an autocmd produces an error:\r\n\r\n```\r\nError executing vim.schedule lua callback: [string \":source (no file)\"]:10: BufNew Autocommands for \"*\": Vim(append):Error executing lua callback: Vim:E495: No autocommand file name to substitute for \"<afile>\"\r\nstack traceback:\r\n        [C]: in function 'expand'\r\n        [string \":source (no file)\"]:5: in function <[string \":source (no file)\"]:4>\r\n        [C]: in function 'tabnew'\r\n        [string \":source (no file)\"]:10: in function ''\r\n        vim/_editor.lua: in function ''\r\n        vim/_editor.lua: in function <vim/_editor.lua:0>\r\nstack traceback:\r\n        [C]: in function 'tabnew'\r\n        [string \":source (no file)\"]:10: in function ''\r\n        vim/_editor.lua: in function ''\r\n        vim/_editor.lua: in function <vim/_editor.lua:0>\r\n```\n\n### Steps to reproduce\n\n```lua\r\n-- bug.lua\r\nlocal aug = vim.api.nvim_create_augroup(\"bug\", {})\r\nvim.api.nvim_create_autocmd(\"BufNew\", {\r\n  group = aug,\r\n  callback = function()\r\n    print(vim.fn.expand(\"<afile>\"))\r\n  end,\r\n})\r\n\r\nvim.defer_fn(function()\r\n  vim.cmd.tabnew()\r\nend, 500)\r\n```\r\n\r\n1. nvim --clean -V1 bug.lua\r\n2. `:source`\r\n\r\nNote that this _only_ reproduces with `-V1`. Running `nvim --clean bug.lua` produces the expected result. I was also able to get this to reproduce with vimscript, which was how I was able to test this with vanilla vim.\r\n\r\n```vim\r\n\" bug.vim\r\naug foo\r\n  autocmd BufNew * echomsg expand('<afile>')\r\naug END\r\n\r\ntabnew\r\n```\n\n### Expected behavior\n\nNo error\n\n### Neovim version (nvim -v)\n\nNVIM v0.10.0 Build type: Release LuaJIT 2.1.1713773202\n\n### Vim (not Nvim) behaves the same?\n\nyes, 9.0 \n\n### Operating system/version\n\nmacOS 14.5\n\n### Terminal name/version\n\nkitty 0.34.1\n\n### $TERM environment variable\n\ntmux-256color\n\n### Installation\n\nhomebrew",
    "closed_at": "2024-06-04T15:15:14Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "From `:help expand()`\r\n\r\n>\t\tWhen 'verbose' is set then expanding '%', '#' and <> items\r\n>\t\twill result in an error message if the argument cannot be\r\n>\t\texpanded.\r\n\r\nPer the documentation, it is not quite clear whether printing error message should result in the Lua executor throwing Error (which is the current implementation) or shouldn't interfere with the control flow. So I assumed this is by design (from upstream vim).\r\n\r\nFor the record, this behavior has been there since Neovim 0.8.0 -- it was not throwing an error before (a9e6cf0e64ede3fc26226fed3a5f94a7f5020918). Ref #19905 \r\n\r\nA possible workaround is: (see also https://github.com/nvim-neo-tree/neo-tree.nvim/issues/1145#issuecomment-1769026842)\r\n\r\n```lua\r\n-- Simply ignore expand(...) error when &verbose>0\r\nlocal function safe_expand(args)\r\n  if vim.o.verbose > 0 then\r\n    return vim.F.npcall(vim.fn.expand, args) or ''\r\n  else\r\n    return vim.fn.expand(args)\r\n  end\r\nend\r\n```",
            "created_at": "2024-06-04T14:41:12Z",
            "html_url": "https://github.com/neovim/neovim/issues/29175#issuecomment-2147713776",
            "id": 2147713776,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/29175",
            "node_id": "IC_kwDOAPphoM6AA4Lw",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2147713776/reactions"
            },
            "updated_at": "2024-06-04T14:42:41Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2147713776",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1009873?v=4",
                "events_url": "https://api.github.com/users/wookayin/events{/privacy}",
                "followers_url": "https://api.github.com/users/wookayin/followers",
                "following_url": "https://api.github.com/users/wookayin/following{/other_user}",
                "gists_url": "https://api.github.com/users/wookayin/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/wookayin",
                "id": 1009873,
                "login": "wookayin",
                "node_id": "MDQ6VXNlcjEwMDk4NzM=",
                "organizations_url": "https://api.github.com/users/wookayin/orgs",
                "received_events_url": "https://api.github.com/users/wookayin/received_events",
                "repos_url": "https://api.github.com/users/wookayin/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/wookayin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/wookayin/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/wookayin"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Ah, so the idea is that expanding `<afile>` is actually \"failing\" in the normal case by expanding to the empty string, and that with `-V1` it is intentionally throwing an error instead. I don't love that changing the verbosity affects control flow, but agree that it makes sense to align with upstream vim.\r\n\r\nThanks for the clarification!",
            "created_at": "2024-06-04T15:15:14Z",
            "html_url": "https://github.com/neovim/neovim/issues/29175#issuecomment-2147794419",
            "id": 2147794419,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/29175",
            "node_id": "IC_kwDOAPphoM6ABL3z",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2147794419/reactions"
            },
            "updated_at": "2024-06-04T15:15:14Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2147794419",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/506791?v=4",
                "events_url": "https://api.github.com/users/stevearc/events{/privacy}",
                "followers_url": "https://api.github.com/users/stevearc/followers",
                "following_url": "https://api.github.com/users/stevearc/following{/other_user}",
                "gists_url": "https://api.github.com/users/stevearc/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/stevearc",
                "id": 506791,
                "login": "stevearc",
                "node_id": "MDQ6VXNlcjUwNjc5MQ==",
                "organizations_url": "https://api.github.com/users/stevearc/orgs",
                "received_events_url": "https://api.github.com/users/stevearc/received_events",
                "repos_url": "https://api.github.com/users/stevearc/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/stevearc/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/stevearc/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/stevearc"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/29175/comments",
    "created_at": "2024-06-04T06:14:48Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/29175/events",
    "html_url": "https://github.com/neovim/neovim/issues/29175",
    "id": 2332642575,
    "labels": [
        {
            "color": "F9D0C4",
            "default": false,
            "description": "wrong behavior inherited from vim",
            "id": 154310492,
            "name": "bug-vim",
            "node_id": "MDU6TGFiZWwxNTQzMTA0OTI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-vim"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "events, autocommands",
            "id": 3341085842,
            "name": "events",
            "node_id": "MDU6TGFiZWwzMzQxMDg1ODQy",
            "url": "https://api.github.com/repos/neovim/neovim/labels/events"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/29175/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 623,
        "created_at": "2014-05-10T20:43:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk"
        },
        "description": "Low priority. Not planned for the current target, may be reassigned.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/6",
        "id": 655037,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/6/labels",
        "node_id": "MDk6TWlsZXN0b25lNjU1MDM3",
        "number": 6,
        "open_issues": 543,
        "state": "open",
        "title": "backlog",
        "updated_at": "2024-06-10T11:17:36Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/6"
    },
    "node_id": "I_kwDOAPphoM6LCU0P",
    "number": 29175,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/29175/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/29175/timeline",
    "title": "<afile> cannot be expanded when running with -V1",
    "updated_at": "2024-06-04T15:15:14Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/29175",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/506791?v=4",
        "events_url": "https://api.github.com/users/stevearc/events{/privacy}",
        "followers_url": "https://api.github.com/users/stevearc/followers",
        "following_url": "https://api.github.com/users/stevearc/following{/other_user}",
        "gists_url": "https://api.github.com/users/stevearc/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/stevearc",
        "id": 506791,
        "login": "stevearc",
        "node_id": "MDQ6VXNlcjUwNjc5MQ==",
        "organizations_url": "https://api.github.com/users/stevearc/orgs",
        "received_events_url": "https://api.github.com/users/stevearc/received_events",
        "repos_url": "https://api.github.com/users/stevearc/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/stevearc/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/stevearc/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/stevearc"
    }
}