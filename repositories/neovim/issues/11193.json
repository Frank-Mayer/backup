{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "- `nvim --version`: NVIM v0.5.0-164-g3b3a40978\r\n- `vim -u DEFAULTS` (version: ) behaves differently? N/A\r\n- Operating system/version: N/A\r\n- Terminal name/version: N/A\r\n- `$TERM`: N/A\r\n\r\n### Steps to reproduce using `nvim -u NORC`\r\nCreate the following test.vim.\r\n```vim\r\nfunction! Count()\r\n  let g:counter += 1\r\n  return g:counter\r\nendfunction\r\n\r\nlet g:num_trails = 0\r\nlet timer = timer_start(1, { -> execute('sleep 150m') }, {'repeat' : -1 })\r\nwhile(v:true)\r\n  let g:counter = 0\r\n  let g:num_trails += 1\r\n  call wait(100, 'Count() >= 5', 20)\r\n  if g:counter == 1\r\n    echomsg \"g:counter is 1, trails \"..g:num_trails\r\n    break\r\n  endif\r\nendwhile\r\ncall timer_stop(timer)\r\n```\r\n\r\n```\r\nnvim -u NORC\r\n:so test.vim\r\n```\r\n\r\n### Actual behaviour\r\nEventually, the while loop ends.\r\n\r\nOne case:\r\n\r\n```\r\ng:counter is 1, trails 147752\r\n```\r\n\r\n### Expected behaviour\r\nWhile loops should not end forever.\r\n\r\nAs is apparent from the code, after the condition is first evaluated(0 sec), the condition may not be evaluated once during the timeout period. Is this intended?\r\n\r\nI think it should be implemented like follow, but is it wrong?\r\n\r\n```C\r\n#define WAIT_UNTIL(loop, multiqueue, timeout, condtion) \\\r\n  do { \\\r\n    if (!(condtion) && timeout != 0) { \\\r\n      int remaining = timeout; \\\r\n      uint64_t before = os_hrtime(); \\\r\n      do { \\\r\n        if (remaining > 0) { \\\r\n          uint64_t now = os_hrtime(); \\\r\n          remaining  -= (int) ((now - before) / 1000000); \\\r\n          before = now; \\\r\n          if (remaining <= 0) { \\\r\n            break; \\\r\n          } \\\r\n        } \\\r\n        LOOP_PROCESS_EVENTS(loop, multiqueue, remaining); \\\r\n      } while (!(condtion)); \\\r\n    } \\\r\n  } while(0)\r\n```\r\n\r\nIf we keep the current implementation, I think the following help description should be modified.\r\n\r\n> Condition is evaluated on user events, internal events, and every {interval} milliseconds (default: 200).\r\n\r\nIn practice, the condition is evaluated if the timeout has not been reached at the end of processing the user event, internal events. I don't know how to explain the interval, but there is no guarantee that the condition will be evaluated for every interval.\r\n\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "/cc @abdelhakeem",
            "created_at": "2019-10-10T20:26:51Z",
            "html_url": "https://github.com/neovim/neovim/issues/11193#issuecomment-540775120",
            "id": 540775120,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/11193",
            "node_id": "MDEyOklzc3VlQ29tbWVudDU0MDc3NTEyMA==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/540775120/reactions"
            },
            "updated_at": "2019-10-10T20:26:51Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/540775120",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/9766?v=4",
                "events_url": "https://api.github.com/users/blueyed/events{/privacy}",
                "followers_url": "https://api.github.com/users/blueyed/followers",
                "following_url": "https://api.github.com/users/blueyed/following{/other_user}",
                "gists_url": "https://api.github.com/users/blueyed/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/blueyed",
                "id": 9766,
                "login": "blueyed",
                "node_id": "MDQ6VXNlcjk3NjY=",
                "organizations_url": "https://api.github.com/users/blueyed/orgs",
                "received_events_url": "https://api.github.com/users/blueyed/received_events",
                "repos_url": "https://api.github.com/users/blueyed/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/blueyed/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/blueyed/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/blueyed"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Not sure what the issue is here. If some other code runs a loop like `let timer = timer_start(1, { -> execute('sleep 150m') }, {'repeat' : 10 }` (which is an anti-pattern anyway) is run inside the `wait()`, it will by necessity block the \"condition\" loop until the inner `:sleep` loop is done. To avoid this from happening,  just don't use `sleep` within a timer.",
            "created_at": "2019-10-10T21:27:25Z",
            "html_url": "https://github.com/neovim/neovim/issues/11193#issuecomment-540806680",
            "id": 540806680,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/11193",
            "node_id": "MDEyOklzc3VlQ29tbWVudDU0MDgwNjY4MA==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/540806680/reactions"
            },
            "updated_at": "2019-10-10T21:27:25Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/540806680",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
                "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
                "followers_url": "https://api.github.com/users/bfredl/followers",
                "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
                "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bfredl",
                "id": 1363104,
                "login": "bfredl",
                "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
                "organizations_url": "https://api.github.com/users/bfredl/orgs",
                "received_events_url": "https://api.github.com/users/bfredl/received_events",
                "repos_url": "https://api.github.com/users/bfredl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bfredl"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Not sure what the issue is here.\r\n\r\nThe example I gave seems not good. But, if the execution of the first event(can't control what that event is) after the first condition evaluation takes longer than the timeout, the second condition is not evaluated. In that case it does not serve as a `wait()` function.",
            "created_at": "2019-10-11T03:46:39Z",
            "html_url": "https://github.com/neovim/neovim/issues/11193#issuecomment-540888986",
            "id": 540888986,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/11193",
            "node_id": "MDEyOklzc3VlQ29tbWVudDU0MDg4ODk4Ng==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/540888986/reactions"
            },
            "updated_at": "2019-10-11T03:46:39Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/540888986",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/11682285?v=4",
                "events_url": "https://api.github.com/users/erw7/events{/privacy}",
                "followers_url": "https://api.github.com/users/erw7/followers",
                "following_url": "https://api.github.com/users/erw7/following{/other_user}",
                "gists_url": "https://api.github.com/users/erw7/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/erw7",
                "id": 11682285,
                "login": "erw7",
                "node_id": "MDQ6VXNlcjExNjgyMjg1",
                "organizations_url": "https://api.github.com/users/erw7/orgs",
                "received_events_url": "https://api.github.com/users/erw7/received_events",
                "repos_url": "https://api.github.com/users/erw7/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/erw7/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/erw7/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/erw7"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> if the execution of the first event ... takes longer than the timeout, the second condition is not evaluated.\r\n\r\nIOW: what if some code takes a long time doing actual work (instead of just `:sleep`)?\r\n\r\nMy thoughts:\r\n\r\n- The purpose of `interval` is to \"tickle\" Nvim, to avoid a hang during _idle_.  If Nvim is busy doing work, `condition` may not be eval'd again before `timeout`.\r\n- This is how repeating timers work, too. E.g. a timer with 1ms repeat-interval may not actually fire until 1 minute later, if the editor is in a while-loop for 1 minute. (No preemptive multitasking.)\r\n\r\n@erw7 It sounds like you want a `count` parameter. Then one could use `timeout=-1`, `interval=20`, `count=5`.  ",
            "created_at": "2019-10-11T04:41:30Z",
            "html_url": "https://github.com/neovim/neovim/issues/11193#issuecomment-540901120",
            "id": 540901120,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/11193",
            "node_id": "MDEyOklzc3VlQ29tbWVudDU0MDkwMTEyMA==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/540901120/reactions"
            },
            "updated_at": "2019-10-11T04:41:30Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/540901120",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "What would be the purpose of `count` parameter exactly? This sounds like the \"condition\" func has some side effect that must be executed N times, which is certainly not the usecase of `wait()`.\r\n\r\nThe change of behavior I could imagine is that if the loop ends with timeout, and `exprval` is not yet nonzero, then `eval_expr_typval(&expr, &argv, 0, &exprval)`' should be tried once more _after_ the loop. This means that a slowness issue could be hidden effectively instead of failing fast, but if plugin B blocks the event loop perhaps it is not very useful to get timeout error in plugin A anyway.",
            "created_at": "2019-10-11T09:05:28Z",
            "html_url": "https://github.com/neovim/neovim/issues/11193#issuecomment-540982398",
            "id": 540982398,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/11193",
            "node_id": "MDEyOklzc3VlQ29tbWVudDU0MDk4MjM5OA==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/540982398/reactions"
            },
            "updated_at": "2019-10-11T09:05:28Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/540982398",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
                "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
                "followers_url": "https://api.github.com/users/bfredl/followers",
                "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
                "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bfredl",
                "id": 1363104,
                "login": "bfredl",
                "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
                "organizations_url": "https://api.github.com/users/bfredl/orgs",
                "received_events_url": "https://api.github.com/users/bfredl/received_events",
                "repos_url": "https://api.github.com/users/bfredl/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bfredl"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "As others have said, this is a consistent behavior. Maybe it should be stated in the docs that the condition gets evaluated every `{interval}` milliseconds _unless Nvim is busy_ (i.e.: if the processing of an internal event during the wait loop takes more than `{interval}` milliseconds).\r\n\r\nOn a side note, it would be helpful to tell if you were trying to do something specific and this behavior got in the way so that we can consider alternatives or possible modifications.",
            "created_at": "2019-10-11T12:27:22Z",
            "html_url": "https://github.com/neovim/neovim/issues/11193#issuecomment-541043391",
            "id": 541043391,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/11193",
            "node_id": "MDEyOklzc3VlQ29tbWVudDU0MTA0MzM5MQ==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/541043391/reactions"
            },
            "updated_at": "2019-10-11T12:27:22Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/541043391",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/20467669?v=4",
                "events_url": "https://api.github.com/users/abdelhakeem/events{/privacy}",
                "followers_url": "https://api.github.com/users/abdelhakeem/followers",
                "following_url": "https://api.github.com/users/abdelhakeem/following{/other_user}",
                "gists_url": "https://api.github.com/users/abdelhakeem/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/abdelhakeem",
                "id": 20467669,
                "login": "abdelhakeem",
                "node_id": "MDQ6VXNlcjIwNDY3NjY5",
                "organizations_url": "https://api.github.com/users/abdelhakeem/orgs",
                "received_events_url": "https://api.github.com/users/abdelhakeem/received_events",
                "repos_url": "https://api.github.com/users/abdelhakeem/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/abdelhakeem/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/abdelhakeem/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/abdelhakeem"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I understand that it was the intended behavior. What about the following examples of help changes?\r\n\r\nCondition is evaluated once at the beginning, and then evaluated for each user event and internal event that ended within the `{timeout}` period. Even if no internal or user events occur, condition is evaluated every `{interval}` milliseconds maximum (default 200).\r\n",
            "created_at": "2019-10-12T05:04:55Z",
            "html_url": "https://github.com/neovim/neovim/issues/11193#issuecomment-541285602",
            "id": 541285602,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/11193",
            "node_id": "MDEyOklzc3VlQ29tbWVudDU0MTI4NTYwMg==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/541285602/reactions"
            },
            "updated_at": "2019-10-12T05:04:55Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/541285602",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/11682285?v=4",
                "events_url": "https://api.github.com/users/erw7/events{/privacy}",
                "followers_url": "https://api.github.com/users/erw7/followers",
                "following_url": "https://api.github.com/users/erw7/following{/other_user}",
                "gists_url": "https://api.github.com/users/erw7/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/erw7",
                "id": 11682285,
                "login": "erw7",
                "node_id": "MDQ6VXNlcjExNjgyMjg1",
                "organizations_url": "https://api.github.com/users/erw7/orgs",
                "received_events_url": "https://api.github.com/users/erw7/received_events",
                "repos_url": "https://api.github.com/users/erw7/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/erw7/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/erw7/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/erw7"
            }
        }
    ],
    "comments": 7,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/11193/comments",
    "created_at": "2019-10-10T04:56:38Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/11193/events",
    "html_url": "https://github.com/neovim/neovim/issues/11193",
    "id": 505034122,
    "labels": [
        {
            "color": "c5def5",
            "default": true,
            "description": "",
            "id": 84744038,
            "name": "documentation",
            "node_id": "MDU6TGFiZWw4NDc0NDAzOA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/documentation"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 520282574,
            "name": "event-loop",
            "node_id": "MDU6TGFiZWw1MjAyODI1NzQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/event-loop"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/11193/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 601,
        "created_at": "2014-05-10T20:43:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk"
        },
        "description": "Low priority. Not planned for the current target, may be reassigned.",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/6",
        "id": 655037,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/6/labels",
        "node_id": "MDk6TWlsZXN0b25lNjU1MDM3",
        "number": 6,
        "open_issues": 515,
        "state": "open",
        "title": "backlog",
        "updated_at": "2024-04-01T02:46:11Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/6"
    },
    "node_id": "MDU6SXNzdWU1MDUwMzQxMjI=",
    "number": 11193,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 1,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 1,
        "url": "https://api.github.com/repos/neovim/neovim/issues/11193/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/11193/timeline",
    "title": "wait(): timeout may occur, before condition is eval'd timeout/interval times",
    "updated_at": "2024-03-30T13:14:19Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/11193",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/11682285?v=4",
        "events_url": "https://api.github.com/users/erw7/events{/privacy}",
        "followers_url": "https://api.github.com/users/erw7/followers",
        "following_url": "https://api.github.com/users/erw7/following{/other_user}",
        "gists_url": "https://api.github.com/users/erw7/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/erw7",
        "id": 11682285,
        "login": "erw7",
        "node_id": "MDQ6VXNlcjExNjgyMjg1",
        "organizations_url": "https://api.github.com/users/erw7/orgs",
        "received_events_url": "https://api.github.com/users/erw7/received_events",
        "repos_url": "https://api.github.com/users/erw7/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/erw7/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/erw7/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/erw7"
    }
}