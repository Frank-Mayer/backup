{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Problem\r\n\r\nWhen the (experimental) Lua module loader `vim.loader.enable()` is used, `--luamod-dev` will result in **stack overflow** and infinite loop on startup.\r\n\r\nOther than the minimal repro below, an user might run into this issue when, for example, lazy.nvim is used for the plugin manager (`vim.loader.enable()` is turned on by default). See also #24044.\r\n\r\nWhat `vim.loader.enable()` does:\r\n\r\n> Enables the experimental Lua module loader:\r\n    • overrides loadfile\r\n    • adds the Lua loader using the byte-compilation cache\r\n    • adds the libs loader\r\n    • removes the default Nvim loader\r\n\r\nThe option `--luamod-dev` conflicts with the second item, but this CLI flag could override.\r\n\r\nOne workaround would be to write some if conditions in an user config by detecting whether `--luamod-dev` is used or not, but I don't find yet an easy way to do so.\r\n\r\n### Steps to reproduce\r\n\r\n```\r\nnvim --luamod-dev --clean -u init_luamod_dev.lua\r\n```\r\n\r\ninit_luamod_dev.lua:\r\n```\r\nvim.loader.enable()\r\nrequire('vim.fs')\r\n```\r\n\r\nError:\r\n\r\n```\r\nE5113: Error while calling lua chunk: stack overflow\r\nstack traceback:\r\n        [C]: in function 'require'\r\n        vim/_init_packages.lua: in function '__index'\r\n        /usr/local/share/nvim/runtime/lua/vim/loader.lua:66: in function 'normalize'\r\n        /usr/local/share/nvim/runtime/lua/vim/loader.lua:83: in function 'get_rtp'\r\n        /usr/local/share/nvim/runtime/lua/vim/loader.lua:351: in function 'find'\r\n        /usr/local/share/nvim/runtime/lua/vim/loader.lua:172: in function </usr/local/share/nvim/runtime/lua/vim/loader.lua:170>\r\n        [C]: in function 'require'\r\n        vim/_init_packages.lua: in function '__index'\r\n        /usr/local/share/nvim/runtime/lua/vim/loader.lua:66: in function 'normalize'\r\n        /usr/local/share/nvim/runtime/lua/vim/loader.lua:83: in function 'get_rtp'\r\n        /usr/local/share/nvim/runtime/lua/vim/loader.lua:351: in function 'find'\r\n        ...\r\n        /usr/local/share/nvim/runtime/lua/vim/loader.lua:351: in function 'find'\r\n        /usr/local/share/nvim/runtime/lua/vim/loader.lua:172: in function </usr/local/share/nvim/runtime/lua/vim/loader.lua:170>\r\n```\r\n\r\nNote: `vim/loader.lua:66` reads\r\n\r\n```lua\r\nlocal function normalize(path)\r\n  return vim.fs.normalize(path, { expand_env = false })\r\nend\r\n```\r\n\r\n25fa051fa157ca4bce712e61602447a4222581ca, 3c82ce0d625184a90e6b2dda96e38fcb44f901d2 (#22791) seems relevant.\r\n\r\n### Expected behavior\r\n\r\nNo errors, works as if `--luamod-dev` are not used.\t\r\n\r\n\r\n### Neovim version (nvim -v)\r\n\r\nNVIM 0.9.1+, and 0.10-HEAD (8e739af06)\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nN/A\r\n\r\n### Operating system/version\r\n\r\nmacOS 14\r\n\r\n### Terminal name/version\r\n\r\nnot relevant\r\n\r\n### $TERM environment variable\r\n\r\nxterm-256color\r\n\r\n### Installation\r\n\r\nbuild from source",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "The root cause of this is that `vim.loader` depends on `vim.fs` (#22791) but `require(\"vim.fs\")` or `vim.fs` via deferred loading (if not byte-compiled) can be loaded via `vim.loader`, hence a cyclic dependency.\r\n\r\nTherefore the obvious workaround is to eager-load `vim.fs` *before* `vim.loader.enable()`: (in user config before `lazy.setup` or sometime early in `init.lua`); and also a possible fix is to `require(\"vim.fs\")` upon `vim.loader`.",
            "created_at": "2024-02-10T08:46:12Z",
            "html_url": "https://github.com/neovim/neovim/issues/27413#issuecomment-1936935993",
            "id": 1936935993,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27413",
            "node_id": "IC_kwDOAPphoM5zc0w5",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1936935993/reactions"
            },
            "updated_at": "2024-02-10T08:46:40Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1936935993",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1009873?v=4",
                "events_url": "https://api.github.com/users/wookayin/events{/privacy}",
                "followers_url": "https://api.github.com/users/wookayin/followers",
                "following_url": "https://api.github.com/users/wookayin/following{/other_user}",
                "gists_url": "https://api.github.com/users/wookayin/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/wookayin",
                "id": 1009873,
                "login": "wookayin",
                "node_id": "MDQ6VXNlcjEwMDk4NzM=",
                "organizations_url": "https://api.github.com/users/wookayin/orgs",
                "received_events_url": "https://api.github.com/users/wookayin/received_events",
                "repos_url": "https://api.github.com/users/wookayin/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/wookayin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/wookayin/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/wookayin"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/27413/comments",
    "created_at": "2024-02-10T05:48:28Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/27413/events",
    "html_url": "https://github.com/neovim/neovim/issues/27413",
    "id": 2128126369,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "stdlib",
            "id": 573222693,
            "name": "lua",
            "node_id": "MDU6TGFiZWw1NzMyMjI2OTM=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lua"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "Nvim startup sequence (`:h startup`)",
            "id": 870629450,
            "name": "startup",
            "node_id": "MDU6TGFiZWw4NzA2Mjk0NTA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/startup"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/27413/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5-2KGh",
    "number": 27413,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/27413/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/27413/timeline",
    "title": "vim.loader.enable and --luamod-dev are not compatible",
    "updated_at": "2024-02-10T08:46:40Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/27413",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1009873?v=4",
        "events_url": "https://api.github.com/users/wookayin/events{/privacy}",
        "followers_url": "https://api.github.com/users/wookayin/followers",
        "following_url": "https://api.github.com/users/wookayin/following{/other_user}",
        "gists_url": "https://api.github.com/users/wookayin/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/wookayin",
        "id": 1009873,
        "login": "wookayin",
        "node_id": "MDQ6VXNlcjEwMDk4NzM=",
        "organizations_url": "https://api.github.com/users/wookayin/orgs",
        "received_events_url": "https://api.github.com/users/wookayin/received_events",
        "repos_url": "https://api.github.com/users/wookayin/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/wookayin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/wookayin/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/wookayin"
    }
}