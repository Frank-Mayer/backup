{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\r\n\r\nIf a file does not have a newline at end of file then inlay hints are not working and rust-analyzer sends an error\r\nmessage: `rust-analyzer: -32603: Invalid offset`\r\n\r\n### Steps to reproduce using \"nvim -u minimal_init.lua\"\r\n\r\n<details>\r\n\r\n<summary>Minimal configuration</summary>\r\n\r\n```lua\r\nlocal pattern = 'rust'\r\nlocal cmd = {'rust-analyzer'}\r\nlocal root_markers = {'.git', '.editorconfig', 'Cargo.toml'}\r\nlocal settings = vim.empty_dict()\r\n\r\nvim.api.nvim_create_autocmd('FileType', {\r\n  pattern = pattern,\r\n  callback = function(args)\r\n    local match = vim.fs.find(root_markers, { path = args.file, upward = true })[1]\r\n    local root_dir = match and vim.fn.fnamemodify(match, ':p:h') or nil\r\n    vim.lsp.start({\r\n      name = 'rust-analyzer',\r\n      cmd = cmd,\r\n      root_dir = root_dir,\r\n      settings = settings\r\n    })\r\n  end\r\n})\r\n\r\nvim.api.nvim_create_autocmd('LspAttach', {\r\n    group = vim.api.nvim_create_augroup('InlayHintsAttach', {}),\r\n    callback = function(args)\r\n      local buf = args.buf\r\n      vim.lsp.inlay_hint(buf, true)\r\n    end,\r\n})\r\n```\r\n\r\n</details>\r\n\r\n1. Create an executable crate: `cargo new hints`\r\n2. Write some code that should display inlay hints, e.g. `let x = 12;`\r\n3. Delete the newline somehow, I did that using `vscode`\r\n4. Open `main.rs`\r\n5. Observe an error and no inlay hints\r\n\r\n\r\n### Expected behavior\r\n\r\nWorking inlay hints and no error message.\r\n\r\n### Neovim version (nvim -v)\r\n\r\nv0.10.0-dev-664+g0ce391086\r\n\r\n### Language server name/version\r\n\r\nrust-analyzer 0.3.1583-standalone (2023-07-10)\r\n\r\n### Operating system/version\r\n\r\nWindows 11, WSL2\r\n\r\n### Log file\r\n\r\nNo log messages produced",
    "closed_at": "2023-09-21T10:06:41Z",
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "I just did some little tests, this problem seems to be specific to `rust-analyzer`, `clangd`, `gopls` and `tsserver` all show no error and display inlay hints correctly after deleting the `0x0A` at the end of a file (at least in my side).",
            "created_at": "2023-07-14T08:47:09Z",
            "html_url": "https://github.com/neovim/neovim/issues/24339#issuecomment-1635521466",
            "id": 1635521466,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/24339",
            "node_id": "IC_kwDOAPphoM5hfBO6",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1635521466/reactions"
            },
            "updated_at": "2023-07-14T09:01:30Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1635521466",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/57218218?v=4",
                "events_url": "https://api.github.com/users/TinusgragLin/events{/privacy}",
                "followers_url": "https://api.github.com/users/TinusgragLin/followers",
                "following_url": "https://api.github.com/users/TinusgragLin/following{/other_user}",
                "gists_url": "https://api.github.com/users/TinusgragLin/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/TinusgragLin",
                "id": 57218218,
                "login": "TinusgragLin",
                "node_id": "MDQ6VXNlcjU3MjE4MjE4",
                "organizations_url": "https://api.github.com/users/TinusgragLin/orgs",
                "received_events_url": "https://api.github.com/users/TinusgragLin/received_events",
                "repos_url": "https://api.github.com/users/TinusgragLin/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/TinusgragLin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/TinusgragLin/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/TinusgragLin"
            }
        },
        {
            "author_association": "NONE",
            "body": "When I deleted the entire content of the rs file using `ggdG`, I encountered the same error, possibly due to the same reason.",
            "created_at": "2023-08-01T09:37:10Z",
            "html_url": "https://github.com/neovim/neovim/issues/24339#issuecomment-1659944971",
            "id": 1659944971,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/24339",
            "node_id": "IC_kwDOAPphoM5i8MAL",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1659944971/reactions"
            },
            "updated_at": "2023-08-01T09:37:10Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1659944971",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/59051928?v=4",
                "events_url": "https://api.github.com/users/cosmicethics/events{/privacy}",
                "followers_url": "https://api.github.com/users/cosmicethics/followers",
                "following_url": "https://api.github.com/users/cosmicethics/following{/other_user}",
                "gists_url": "https://api.github.com/users/cosmicethics/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/cosmicethics",
                "id": 59051928,
                "login": "cosmicethics",
                "node_id": "MDQ6VXNlcjU5MDUxOTI4",
                "organizations_url": "https://api.github.com/users/cosmicethics/orgs",
                "received_events_url": "https://api.github.com/users/cosmicethics/received_events",
                "repos_url": "https://api.github.com/users/cosmicethics/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/cosmicethics/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/cosmicethics/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/cosmicethics"
            }
        },
        {
            "author_association": "NONE",
            "body": "I believe the problem is caused by:\r\n1. `neovim` uses `(line_count, 0)` to indicate the end of a file when requesting inlay hints.\r\n2. The `line-index` crate in `rust-analyzer` project, which is used to converting between `(line, col)` pairs and text sizes (from the start) for a file, counts lines by only searching for `\\n`, resulting in not counting the last line if a file does not end with `\\n`. This is actually fine if you assume that `(line, col)` pairs passed in are in the range `(0, 0) ~ (line_count - 1, last_line_length - 1)`.\r\n\r\n`vscode` uses `(line_count - 1, last_line_length - 1)` to indicate the end of a file, and thus does not have this problem.\r\n\r\nSome other lsp servers seem to handle `(line_count, 0)`  correctly. I checked `gopls` and it actually [checks for this specific case](https://github.com/golang/tools/blob/75f6f9c0b004228b5a2a6f4c6a7a9719321e29bd/gopls/internal/lsp/protocol/mapper.go#L361) when converting `(line, pos)`s to text sizes.",
            "created_at": "2023-08-02T04:53:09Z",
            "html_url": "https://github.com/neovim/neovim/issues/24339#issuecomment-1661493347",
            "id": 1661493347,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/24339",
            "node_id": "IC_kwDOAPphoM5jCGBj",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1661493347/reactions"
            },
            "updated_at": "2023-08-02T09:06:05Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1661493347",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/57218218?v=4",
                "events_url": "https://api.github.com/users/TinusgragLin/events{/privacy}",
                "followers_url": "https://api.github.com/users/TinusgragLin/followers",
                "following_url": "https://api.github.com/users/TinusgragLin/following{/other_user}",
                "gists_url": "https://api.github.com/users/TinusgragLin/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/TinusgragLin",
                "id": 57218218,
                "login": "TinusgragLin",
                "node_id": "MDQ6VXNlcjU3MjE4MjE4",
                "organizations_url": "https://api.github.com/users/TinusgragLin/orgs",
                "received_events_url": "https://api.github.com/users/TinusgragLin/received_events",
                "repos_url": "https://api.github.com/users/TinusgragLin/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/TinusgragLin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/TinusgragLin/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/TinusgragLin"
            }
        },
        {
            "author_association": "NONE",
            "body": "This still happens to me in svelte files",
            "created_at": "2024-08-29T21:39:50Z",
            "html_url": "https://github.com/neovim/neovim/issues/24339#issuecomment-2319071887",
            "id": 2319071887,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/24339",
            "node_id": "IC_kwDOAPphoM6KOjqP",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2319071887/reactions"
            },
            "updated_at": "2024-08-29T21:39:50Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2319071887",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/26071571?v=4",
                "events_url": "https://api.github.com/users/TGlide/events{/privacy}",
                "followers_url": "https://api.github.com/users/TGlide/followers",
                "following_url": "https://api.github.com/users/TGlide/following{/other_user}",
                "gists_url": "https://api.github.com/users/TGlide/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/TGlide",
                "id": 26071571,
                "login": "TGlide",
                "node_id": "MDQ6VXNlcjI2MDcxNTcx",
                "organizations_url": "https://api.github.com/users/TGlide/orgs",
                "received_events_url": "https://api.github.com/users/TGlide/received_events",
                "repos_url": "https://api.github.com/users/TGlide/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/TGlide/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/TGlide/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/TGlide"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/24339/comments",
    "created_at": "2023-07-13T15:14:01Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/24339/events",
    "html_url": "https://github.com/neovim/neovim/issues/24339",
    "id": 1803244624,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "BFDADC",
            "default": false,
            "description": "Low-risk, self-contained. Do NOT ask \"can I work on this\", just read CONTRIBUTING.md",
            "id": 407246773,
            "name": "complexity:low",
            "node_id": "MDU6TGFiZWw0MDcyNDY3NzM=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/complexity:low"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/24339/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": "2024-05-16T14:11:42Z",
        "closed_issues": 438,
        "created_at": "2023-02-02T14:11:43Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
            "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
            "followers_url": "https://api.github.com/users/bfredl/followers",
            "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
            "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/bfredl",
            "id": 1363104,
            "login": "bfredl",
            "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
            "organizations_url": "https://api.github.com/users/bfredl/orgs",
            "received_events_url": "https://api.github.com/users/bfredl/received_events",
            "repos_url": "https://api.github.com/users/bfredl/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/bfredl"
        },
        "description": "",
        "due_on": "2024-05-12T07:00:00Z",
        "html_url": "https://github.com/neovim/neovim/milestone/36",
        "id": 8997654,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/36/labels",
        "node_id": "MI_kwDOAPphoM4AiUsW",
        "number": 36,
        "open_issues": 0,
        "state": "closed",
        "title": "0.10",
        "updated_at": "2024-08-26T01:36:27Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/36"
    },
    "node_id": "I_kwDOAPphoM5re1RQ",
    "number": 24339,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/24339/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/24339/timeline",
    "title": "Inlay hints not working if a file does not have a newline at end of file",
    "updated_at": "2024-08-29T21:39:52Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/24339",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/61948252?v=4",
        "events_url": "https://api.github.com/users/lostl1ght/events{/privacy}",
        "followers_url": "https://api.github.com/users/lostl1ght/followers",
        "following_url": "https://api.github.com/users/lostl1ght/following{/other_user}",
        "gists_url": "https://api.github.com/users/lostl1ght/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/lostl1ght",
        "id": 61948252,
        "login": "lostl1ght",
        "node_id": "MDQ6VXNlcjYxOTQ4MjUy",
        "organizations_url": "https://api.github.com/users/lostl1ght/orgs",
        "received_events_url": "https://api.github.com/users/lostl1ght/received_events",
        "repos_url": "https://api.github.com/users/lostl1ght/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/lostl1ght/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/lostl1ght/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/lostl1ght"
    }
}