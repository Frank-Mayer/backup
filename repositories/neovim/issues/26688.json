{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\n(Preface: I'm not sure whether this is considered a Neovim bug or a LuaJIT bug. Since it's causing an end-user visible bug in Neovim I decided to post it here, but I'm happy to move it elsewhere if maintainers believe that's the best thing to do.)\r\n\r\nOn my machine (macOS 14.2), attempting to use the osc52 clipboard plugin fails when when the encoded OSC52 command is greater than 1024 bytes. Tracing through this in a debugger, I found that:\r\n\r\n- `runtim/elua/vim/ui/clipboard/osc52.lua` calls `io.stdout:write()` with the payload: https://github.com/neovim/neovim/blob/0c120307ca1ab613e63865c634d7e10ad67fb0ba/runtime/lua/vim/ui/clipboard/osc52.lua#L16\r\n- This calls `io_file_write` in `LuaJIT/src/lib_io.c`: https://github.com/LuaJIT/LuaJIT/blob/29b0b282f59ac533313199f4f7be79490b7eee51/src/lib_io.c#L228\r\n- `io_file_write` calls `fwrite` with the buffer\r\n- `fwrite` returns 1024 and sets `errno` to `EAGAIN`. I think this means the first 1024 bytes of the payload were written successfully, but that writing further data would block and `stdout` is opened with `O_NONBLOCK`.\r\n- LuaJIT does not handle the `EAGAIN` error and returns failure (which is ignored by `osc52.lua`).\r\n\r\nRunning kitty in `--dump-commands` mode reveals that kitty does indeed receive the osc52 command truncated to 1024 bytes (cutting off the `ST` sequence to end the command, which often leads to screen corruption.)\n\n### Steps to reproduce\n\nMinimal reproducible configuration:\r\n\r\n```lua\r\nvim.opt.clipboard = 'unnamedplus'\r\nlocal ok, osc52 = pcall(require, \"vim.ui.clipboard.osc52\")\r\n\r\nvim.g.clipboard = {\r\n    name = 'OSC 52',\r\n    copy = {\r\n    ['+'] = osc52.copy('+'),\r\n    ['*'] = osc52.copy('*'),\r\n    },\r\n    paste = {\r\n    ['+'] = osc52.paste('+'),\r\n    ['*'] = osc52.paste('*'),\r\n    },\r\n}\r\n```\r\n\r\n- Open some file with `nvim --clean -u minimal.lua`\r\n- Use the `y` command to copy a large chunk of text, (longer than 1024 bytes when base64-encoded)\r\n- Observe that the text is not successfully copied. You may also encounter screen corruption.\n\n### Expected behavior\n\nIt seems to me that `io_file_write` within LuaJIT should loop and retry the write upon receiving EAGAIN until the entire buffer is written successfully, but I'm not familiar enough with the internals of Neovim and LuaJIT to be sure that's the best course of action. I can open a LuaJIT PR with this change if maintainers agree.\n\n### Neovim version (nvim -v)\n\nNVIM v0.10.0-dev-1909+g0c120307c\n\n### Vim (not Nvim) behaves the same?\n\nN/A, vim does not have osc52 or lua\n\n### Operating system/version\n\nmacOS 14.2\n\n### Terminal name/version\n\nkitty 0.30.0\n\n### $TERM environment variable\n\nxterm-kitty\n\n### Installation\n\nBuilt from source",
    "closed_at": "2023-12-21T03:47:05Z",
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "I tried that patch, as well as making the same change in `osc52.lua`, and got the same result both times. \r\n\r\nIt looks like the channel send function just uses a bare `fwrite` call without handling `EAGAIN` as well: https://github.com/neovim/neovim/blob/0c120307ca1ab613e63865c634d7e10ad67fb0ba/src/nvim/channel.c#L577",
            "created_at": "2023-12-21T01:29:32Z",
            "html_url": "https://github.com/neovim/neovim/issues/26688#issuecomment-1865350698",
            "id": 1865350698,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/26688",
            "node_id": "IC_kwDOAPphoM5vLv4q",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1865350698/reactions"
            },
            "updated_at": "2023-12-21T01:29:39Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1865350698",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/19418817?v=4",
                "events_url": "https://api.github.com/users/NobodyNada/events{/privacy}",
                "followers_url": "https://api.github.com/users/NobodyNada/followers",
                "following_url": "https://api.github.com/users/NobodyNada/following{/other_user}",
                "gists_url": "https://api.github.com/users/NobodyNada/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/NobodyNada",
                "id": 19418817,
                "login": "NobodyNada",
                "node_id": "MDQ6VXNlcjE5NDE4ODE3",
                "organizations_url": "https://api.github.com/users/NobodyNada/orgs",
                "received_events_url": "https://api.github.com/users/NobodyNada/received_events",
                "repos_url": "https://api.github.com/users/NobodyNada/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/NobodyNada/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/NobodyNada/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/NobodyNada"
            }
        },
        {
            "author_association": "NONE",
            "body": "I can confirm that your PR resolves the issue, thanks for the quick fix!",
            "created_at": "2023-12-21T03:50:37Z",
            "html_url": "https://github.com/neovim/neovim/issues/26688#issuecomment-1865436552",
            "id": 1865436552,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/26688",
            "node_id": "IC_kwDOAPphoM5vME2I",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1865436552/reactions"
            },
            "updated_at": "2023-12-21T03:50:37Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1865436552",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/19418817?v=4",
                "events_url": "https://api.github.com/users/NobodyNada/events{/privacy}",
                "followers_url": "https://api.github.com/users/NobodyNada/followers",
                "following_url": "https://api.github.com/users/NobodyNada/following{/other_user}",
                "gists_url": "https://api.github.com/users/NobodyNada/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/NobodyNada",
                "id": 19418817,
                "login": "NobodyNada",
                "node_id": "MDQ6VXNlcjE5NDE4ODE3",
                "organizations_url": "https://api.github.com/users/NobodyNada/orgs",
                "received_events_url": "https://api.github.com/users/NobodyNada/received_events",
                "repos_url": "https://api.github.com/users/NobodyNada/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/NobodyNada/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/NobodyNada/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/NobodyNada"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/26688/comments",
    "created_at": "2023-12-21T01:05:25Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/26688/events",
    "html_url": "https://github.com/neovim/neovim/issues/26688",
    "id": 2051507980,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "clipboard, paste",
            "id": 186192409,
            "name": "clipboard",
            "node_id": "MDU6TGFiZWwxODYxOTI0MDk=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/clipboard"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/26688/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM56R4cM",
    "number": 26688,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 1,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 1,
        "url": "https://api.github.com/repos/neovim/neovim/issues/26688/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/26688/timeline",
    "title": "osc52 copy fails for large payloads due to stdout write failing with EAGAIN",
    "updated_at": "2023-12-21T03:50:38Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/26688",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/19418817?v=4",
        "events_url": "https://api.github.com/users/NobodyNada/events{/privacy}",
        "followers_url": "https://api.github.com/users/NobodyNada/followers",
        "following_url": "https://api.github.com/users/NobodyNada/following{/other_user}",
        "gists_url": "https://api.github.com/users/NobodyNada/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/NobodyNada",
        "id": 19418817,
        "login": "NobodyNada",
        "node_id": "MDQ6VXNlcjE5NDE4ODE3",
        "organizations_url": "https://api.github.com/users/NobodyNada/orgs",
        "received_events_url": "https://api.github.com/users/NobodyNada/received_events",
        "repos_url": "https://api.github.com/users/NobodyNada/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/NobodyNada/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/NobodyNada/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/NobodyNada"
    }
}