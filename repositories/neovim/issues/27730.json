{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\r\n\r\nThe configuration for `lua_ls`, as suggested in [nvim-lspconfig](https://github.com/neovim/nvim-lspconfig/blob/c932a56bf25167b1e88d2a1ebe35bb774b41019a/lua/lspconfig/server_configurations/lua_ls.lua#L47) is not working as I would expect.\r\n\r\nWhen a `.luarc.jsonc` is present in the directory of the config, I can complete global \"vim\":\r\n\r\n```jsonc\r\n{\r\n  \"$schema\": \"https://raw.githubusercontent.com/LuaLS/vscode-lua/master/setting/schema.json\",\r\n  \"runtime\": {\r\n    \"version\": \"LuaJIT\",\r\n    // \"path\": [\r\n    //   \"?.lua\",\r\n    //   \"?/init.lua\"\r\n    // ],\r\n    // Important setting:\r\n    \"pathStrict\": true\r\n  },\r\n  \"workspace\": {\r\n    \"library\": [\r\n      // No need to append /lua:\r\n      \"$VIMRUNTIME\",\r\n      //\r\n      \"${3rd}/luv/library\",\r\n      \"${3rd}/busted/library\"\r\n    ],\r\n    \"checkThirdParty\": false\r\n  }\r\n}\r\n```\r\n\r\nWhen I remove `.luarc.jsonc`, the code inside the condition in `on_init` kicks in. As a result, there is no completion for global \"vim\", and warnings appear:\r\n> Undefined global \"vim\"\r\n\r\nReproduce:\r\n\r\n1. Using the repro provided below, open `init.lua` and append a line: `local unused = \"unused\"`. This triggers the diagnostics, showing warnings on all lines containing \"vim\"\r\n2. Type `vim.` and press `<c-x><c-o>`. Only text suggestions appear.\r\n\r\nRepeat the steps, switch the handlers:\r\n\r\n```lua\r\nhandlers = {\r\n  lua_ls = lua_ls_handler, --\r\n  -- lua_ls = lua_ls_handler_with_on_init, \r\n},\r\n```\r\n\r\n\r\n### Steps to reproduce using \"nvim -u minimal_init.lua\"\r\n\r\n```lua\r\n--[[\r\nUse:\r\n  mkdir ~/.config/repro\r\n  cd ~/.config/repro\r\n\r\n  git init .\r\n  touch init.lua\r\n  add the contents of this file to init.lua\r\n  NVIM_APPNAME=repro nvim init.lua ( no need to reboot after installation )\r\n\r\nRemove:\r\n  rm -rf ~/.local/share/repro ~/.local/state/repro ~/.local/cache/repro\r\n  rm -rf ~/.config/repro\r\n--]]\r\n\r\nlocal function clone()\r\n\tlocal path_package = vim.fn.stdpath(\"data\") .. \"/site/\"\r\n\tlocal mini_path = path_package .. \"pack/deps/start/mini.deps\"\r\n\r\n\tif not vim.loop.fs_stat(mini_path) then\r\n\t\tvim.cmd('echo \"Installing `mini.deps`\" | redraw')\r\n\t\tlocal clone_cmd =\r\n\t\t\t{ \"git\", \"clone\", \"--filter=blob:none\", \"https://github.com/echasnovski/mini.deps\", mini_path }\r\n\t\tvim.fn.system(clone_cmd)\r\n\t\tvim.cmd(\"packadd mini.deps | helptags ALL\")\r\n\t\tvim.cmd('echo \"Installed `mini.deps`\" | redraw')\r\n\tend\r\n\r\n\treturn path_package\r\nend\r\n\r\n-- Setup lua_ls\r\n-- Using this method, \"vim.\" completes correctly\r\nlocal function lua_ls_handler()\r\n\trequire(\"lspconfig\").lua_ls.setup({\r\n\t\tsettings = {\r\n\t\t\tLua = {\r\n\t\t\t\truntime = {\r\n\t\t\t\t\tversion = \"LuaJIT\",\r\n\t\t\t\t},\r\n\t\t\t\tworkspace = {\r\n\t\t\t\t\tcheckThirdParty = false,\r\n\t\t\t\t\tlibrary = {\r\n\t\t\t\t\t\tvim.env.VIMRUNTIME,\r\n\t\t\t\t\t\t-- Depending on the usage, you might want to add additional paths here.\r\n\t\t\t\t\t\t-- E.g.: For using `vim.*` functions, add vim.env.VIMRUNTIME/lua.\r\n\t\t\t\t\t\t-- \"${3rd}/luv/library\"\r\n\t\t\t\t\t\t-- \"${3rd}/busted/library\",\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t\t-- diagnostics = { globals = { \"vim\" } }, -- should not be necessary?\r\n\t\t\t},\r\n\t\t},\r\n\t})\r\nend\r\n\r\n-- Setup lua_ls according to the documentation in nvim-lspconfig\r\n-- without a luarc.json:\r\n-- Using this method, \"vim.\" does not complete\r\n-- warnings: undefined global \"vim\"\r\nlocal function lua_ls_handler_with_on_init()\r\n\trequire(\"lspconfig\").lua_ls.setup({\r\n\t\ton_init = function(client)\r\n\t\t\tlocal path = client.workspace_folders[1].name\r\n\t\t\tif not vim.loop.fs_stat(path .. \"/.luarc.json\") and not vim.loop.fs_stat(path .. \"/.luarc.jsonc\") then\r\n\t\t\t\tclient.config.settings = vim.tbl_deep_extend(\"force\", client.config.settings, {\r\n\t\t\t\t\tLua = {\r\n\t\t\t\t\t\truntime = {\r\n\t\t\t\t\t\t\t-- Tell the language server which version of Lua you're using\r\n\t\t\t\t\t\t\t-- (most likely LuaJIT in the case of Neovim)\r\n\t\t\t\t\t\t\tversion = \"LuaJIT\",\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t-- Make the server aware of Neovim runtime files\r\n\t\t\t\t\t\tworkspace = {\r\n\t\t\t\t\t\t\tcheckThirdParty = false,\r\n\t\t\t\t\t\t\tlibrary = {\r\n\t\t\t\t\t\t\t\tvim.env.VIMRUNTIME,\r\n\t\t\t\t\t\t\t\t-- Depending on the usage, you might want to add additional paths here.\r\n\t\t\t\t\t\t\t\t-- E.g.: For using `vim.*` functions, add vim.env.VIMRUNTIME/lua.\r\n\t\t\t\t\t\t\t\t-- \"${3rd}/luv/library\"\r\n\t\t\t\t\t\t\t\t-- \"${3rd}/busted/library\",\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t-- or pull in all of 'runtimepath'. NOTE: this is a lot slower\r\n\t\t\t\t\t\t\t-- library = vim.api.nvim_get_runtime_file(\"\", true)\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t},\r\n\t\t\t\t})\r\n\t\t\tend\r\n\t\t\treturn true\r\n\t\tend,\r\n\t})\r\nend\r\n\r\n-- package manager\r\nlocal path_package = clone()\r\nlocal MiniDeps = require(\"mini.deps\")\r\nMiniDeps.setup({ path = { package = path_package } })\r\n\r\n-- options\r\nvim.opt.number = true -- Print line number\r\nvim.opt.expandtab = true -- Use spaces instead of tabs\r\nvim.opt.shiftround = true -- Round indent\r\nvim.opt.shiftwidth = 2 -- Size of an indent\r\nvim.opt.tabstop = 2 -- Number of spaces tabs count for\r\n\r\n-- load\r\nlocal add, now = MiniDeps.add, MiniDeps.now\r\nnow(function()\r\n\tadd(\"folke/tokyonight.nvim\")\r\n\tvim.cmd.colorscheme(\"tokyonight\")\r\n\r\n\tadd(\"nvim-treesitter/nvim-treesitter\")\r\n\trequire(\"nvim-treesitter.configs\").setup({\r\n\t\thighlight = { enable = true },\r\n\t\tindent = { enable = true },\r\n\t\tensure_installed = { \"lua\" },\r\n\t})\r\n\r\n\tadd(\"williamboman/mason.nvim\")\r\n\trequire(\"mason-registry\"):on(\"package:install:success\", function()\r\n    -- stylua: ignore\r\n\t\tvim.defer_fn(function() vim.cmd(\"LspStart\") end, 100)\r\n\tend)\r\n\trequire(\"mason\").setup()\r\n\r\n\tadd({\r\n\t\tsource = \"neovim/nvim-lspconfig\",\r\n\t\tdepends = {\r\n\t\t\t\"williamboman/mason-lspconfig.nvim\",\r\n\t\t},\r\n\t})\r\n\trequire(\"mason-lspconfig\").setup({\r\n\t\tensure_installed = { \"lua_ls\" },\r\n\t\thandlers = {\r\n\t\t\t-- lua_ls = lua_ls_handler,\r\n\t\t\tlua_ls = lua_ls_handler_with_on_init,\r\n\t\t},\r\n\t})\r\nend)\r\n```\r\n\r\n### Expected behavior\r\n\r\nWithout a .luarc.jsonc in the config, I would expect that the \"vim\" global is recognized and completion is active.\r\n\r\nI think that somehow, the code inside the condition in `on_init`, has no effect. For example, adding an extra path to a plugin, does not result in completion for that plugin. \r\n\r\nRelated issues:\r\nhttps://github.com/neovim/neovim/issues/21686\r\nhttps://github.com/neovim/neovim/pull/24592#issuecomment-1671044254\r\n\r\n### Neovim version (nvim -v)\r\n\r\nNVIM v0.10.0-dev-2507+g3df1211eb\r\n\r\n### Language server name/version\r\n\r\nlua_ls 3.7.4\r\n\r\n### Operating system/version\r\n\r\narch linux\r\n\r\n### Log file\r\n\r\n_No response_",
    "closed_at": "2024-03-04T11:16:56Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Please report that at nvim-lspconfig.",
            "created_at": "2024-03-04T11:16:56Z",
            "html_url": "https://github.com/neovim/neovim/issues/27730#issuecomment-1976349595",
            "id": 1976349595,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27730",
            "node_id": "IC_kwDOAPphoM51zLOb",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1976349595/reactions"
            },
            "updated_at": "2024-03-04T11:16:56Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1976349595",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason"
            }
        },
        {
            "author_association": "NONE",
            "body": "Hello @clason,\r\n\r\n> Please report that at nvim-lspconfig.\r\n\r\nMy apologies. I did consider that, but stumbled on the following:\r\n\r\n> Do NOT file bugs in this repo. The configs in this repo are unsupported and provided only as a starting point. We depend on users (like you) to troubleshoot issues with their specific LSP setups and [send improvements](https://github.com/neovim/nvim-lspconfig/blob/master/CONTRIBUTING.md).\r\n\r\nRegardless, I now added the issue to the [nvim-lspconfig](https://github.com/neovim/nvim-lspconfig/issues/3052) repo.\r\n\r\nBest regards!\r\n\r\n",
            "created_at": "2024-03-04T18:32:23Z",
            "html_url": "https://github.com/neovim/neovim/issues/27730#issuecomment-1977212127",
            "id": 1977212127,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27730",
            "node_id": "IC_kwDOAPphoM512dzf",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1977212127/reactions"
            },
            "updated_at": "2024-03-04T18:32:23Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1977212127",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/58370433?v=4",
                "events_url": "https://api.github.com/users/abeldekat/events{/privacy}",
                "followers_url": "https://api.github.com/users/abeldekat/followers",
                "following_url": "https://api.github.com/users/abeldekat/following{/other_user}",
                "gists_url": "https://api.github.com/users/abeldekat/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/abeldekat",
                "id": 58370433,
                "login": "abeldekat",
                "node_id": "MDQ6VXNlcjU4MzcwNDMz",
                "organizations_url": "https://api.github.com/users/abeldekat/orgs",
                "received_events_url": "https://api.github.com/users/abeldekat/received_events",
                "repos_url": "https://api.github.com/users/abeldekat/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/abeldekat/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/abeldekat/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/abeldekat"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Do NOT file bugs in this repo.\r\n\r\nThat does NOT imply that you're supposed to file the bug somewhere else ;) Some things are just left as exercises to the user. Feel free to ask on https://app.element.io/#/room/#neovim:matrix.org, though.",
            "created_at": "2024-03-04T18:48:19Z",
            "html_url": "https://github.com/neovim/neovim/issues/27730#issuecomment-1977237168",
            "id": 1977237168,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27730",
            "node_id": "IC_kwDOAPphoM512j6w",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1977237168/reactions"
            },
            "updated_at": "2024-03-04T18:48:19Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1977237168",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/27730/comments",
    "created_at": "2024-03-04T11:15:49Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/27730/events",
    "html_url": "https://github.com/neovim/neovim/issues/27730",
    "id": 2166591311,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/27730/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM6BI49P",
    "number": 27730,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/27730/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "not_planned",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/27730/timeline",
    "title": "Using the default setup for lua_ls: Undefined global \"vim\"",
    "updated_at": "2024-03-04T18:48:20Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/27730",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/58370433?v=4",
        "events_url": "https://api.github.com/users/abeldekat/events{/privacy}",
        "followers_url": "https://api.github.com/users/abeldekat/followers",
        "following_url": "https://api.github.com/users/abeldekat/following{/other_user}",
        "gists_url": "https://api.github.com/users/abeldekat/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/abeldekat",
        "id": 58370433,
        "login": "abeldekat",
        "node_id": "MDQ6VXNlcjU4MzcwNDMz",
        "organizations_url": "https://api.github.com/users/abeldekat/orgs",
        "received_events_url": "https://api.github.com/users/abeldekat/received_events",
        "repos_url": "https://api.github.com/users/abeldekat/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/abeldekat/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/abeldekat/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/abeldekat"
    }
}