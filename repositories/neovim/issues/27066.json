{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\r\n\r\nLooks like bug introduced in commit 551998b7eed7dd411e4d14f65b108ae8a93c4081 (\"vim-patch:9.0.1725: cursor pos wrong after concealed text with 'virtualedit'\")\r\n\r\n```\r\n=================================================================\r\n==1033999==ERROR: AddressSanitizer: heap-use-after-free on address 0x6020000b8f10 at pc 0x5632220a5a2b bp 0x7ffdccede520 sp 0x7ffdccede518\r\nREAD of size 1 at 0x6020000b8f10 thread T0\r\n    #0 0x5632220a5a2a in skipwhite /home/khlebnikov/src/nvim/neovim/src/nvim/charset.c:895:24\r\n    #1 0x56322210d328 in win_line /home/khlebnikov/src/nvim/neovim/src/nvim/drawline.c:1988:34\r\n    #2 0x563222132085 in win_update /home/khlebnikov/src/nvim/neovim/src/nvim/drawscreen.c:2288:15\r\n    #3 0x56322212b3c2 in update_screen /home/khlebnikov/src/nvim/neovim/src/nvim/drawscreen.c:639:7\r\n    #4 0x563222517b72 in normal_redraw /home/khlebnikov/src/nvim/neovim/src/nvim/normal.c:1355:5\r\n    #5 0x563222517b72 in normal_check /home/khlebnikov/src/nvim/neovim/src/nvim/normal.c:1451:5\r\n    #6 0x563222729783 in state_enter /home/khlebnikov/src/nvim/neovim/src/nvim/state.c:40:35\r\n    #7 0x5632224e3f8b in normal_enter /home/khlebnikov/src/nvim/neovim/src/nvim/normal.c:516:3\r\n    #8 0x5632223e1346 in main /home/khlebnikov/src/nvim/neovim/src/nvim/main.c:651:3\r\n    #9 0x7f129d229d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16\r\n    #10 0x7f129d229e3f in __libc_start_main csu/../csu/libc-start.c:392:3\r\n    #11 0x563221e99114 in _start (/home/khlebnikov/.local/bin/nvim+0x54a114) (BuildId: a32f770ae24e1bc7740551f792d86e02eadc0b84)\r\n\r\n0x6020000b8f10 is located 0 bytes inside of 3-byte region [0x6020000b8f10,0x6020000b8f13)\r\nfreed by thread T0 here:\r\n    #0 0x563221f1e892 in __interceptor_free (/home/khlebnikov/.local/bin/nvim+0x5cf892) (BuildId: a32f770ae24e1bc7740551f792d86e02eadc0b84)\r\n    #1 0x563222477ee9 in xfree /home/khlebnikov/src/nvim/neovim/src/nvim/memory.c:144:3\r\n    #2 0x563222468999 in ml_flush_line /home/khlebnikov/src/nvim/neovim/src/nvim/memline.c:2805:5\r\n    #3 0x56322246ad4f in ml_get_buf_impl /home/khlebnikov/src/nvim/neovim/src/nvim/memline.c:1884:5\r\n    #4 0x56322246b35f in ml_get_buf /home/khlebnikov/src/nvim/neovim/src/nvim/memline.c:1816:10\r\n    #5 0x56322264ef36 in reg_getline /home/khlebnikov/src/nvim/neovim/src/nvim/regexp.c:1279:10\r\n    #6 0x56322264ef36 in reg_nextline /home/khlebnikov/src/nvim/neovim/src/nvim/regexp.c:1466:25\r\n    #7 0x563222646f6c in nfa_regmatch /home/khlebnikov/src/nvim/neovim/src/nvim/regexp.c:15284:7\r\n    #8 0x56322263eb0e in nfa_regtry /home/khlebnikov/src/nvim/neovim/src/nvim/regexp.c:15366:16\r\n    #9 0x56322263eb0e in nfa_regexec_both /home/khlebnikov/src/nvim/neovim/src/nvim/regexp.c:15551:12\r\n    #10 0x563222602307 in nfa_regexec_multi /home/khlebnikov/src/nvim/neovim/src/nvim/regexp.c:15757:10\r\n    #11 0x5632225ffbad in vim_regexec_multi /home/khlebnikov/src/nvim/neovim/src/nvim/regexp.c:16032:16\r\n    #12 0x56322275d1e5 in syn_regexec /home/khlebnikov/src/nvim/neovim/src/nvim/syntax.c:2683:11\r\n    #13 0x563222753341 in syn_current_attr /home/khlebnikov/src/nvim/neovim/src/nvim/syntax.c:1669:23\r\n    #14 0x563222751e5a in get_syntax_attr /home/khlebnikov/src/nvim/neovim/src/nvim/syntax.c:1469:12\r\n    #15 0x56322210cdd3 in win_line /home/khlebnikov/src/nvim/neovim/src/nvim/drawline.c:1932:24\r\n    #16 0x563222132085 in win_update /home/khlebnikov/src/nvim/neovim/src/nvim/drawscreen.c:2288:15\r\n    #17 0x56322212b3c2 in update_screen /home/khlebnikov/src/nvim/neovim/src/nvim/drawscreen.c:639:7\r\n    #18 0x563222517b72 in normal_redraw /home/khlebnikov/src/nvim/neovim/src/nvim/normal.c:1355:5\r\n    #19 0x563222517b72 in normal_check /home/khlebnikov/src/nvim/neovim/src/nvim/normal.c:1451:5\r\n    #20 0x563222729783 in state_enter /home/khlebnikov/src/nvim/neovim/src/nvim/state.c:40:35\r\n    #21 0x5632224e3f8b in normal_enter /home/khlebnikov/src/nvim/neovim/src/nvim/normal.c:516:3\r\n    #22 0x5632223e1346 in main /home/khlebnikov/src/nvim/neovim/src/nvim/main.c:651:3\r\n    #23 0x7f129d229d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16\r\n\r\npreviously allocated by thread T0 here:\r\n    #0 0x563221f1eb3e in malloc (/home/khlebnikov/.local/bin/nvim+0x5cfb3e) (BuildId: a32f770ae24e1bc7740551f792d86e02eadc0b84)\r\n    #1 0x563222477c1a in try_malloc /home/khlebnikov/src/nvim/neovim/src/nvim/memory.c:98:15\r\n    #2 0x5632224780f6 in xmalloc /home/khlebnikov/src/nvim/neovim/src/nvim/memory.c:132:15\r\n    #3 0x5632224780f6 in xmallocz /home/khlebnikov/src/nvim/neovim/src/nvim/memory.c:204:15\r\n    #4 0x5632224787ac in xmemdupz /home/khlebnikov/src/nvim/neovim/src/nvim/memory.c:222:17\r\n    #5 0x5632224787ac in xstrdup /home/khlebnikov/src/nvim/neovim/src/nvim/memory.c:455:10\r\n    #6 0x56322246b02b in ml_get_buf_impl /home/khlebnikov/src/nvim/neovim/src/nvim/memline.c:1925:29\r\n    #7 0x56322246b35f in ml_get_buf /home/khlebnikov/src/nvim/neovim/src/nvim/memline.c:1816:10\r\n    #8 0x563222105c72 in win_line /home/khlebnikov/src/nvim/neovim/src/nvim/drawline.c:1259:12\r\n    #9 0x563222132085 in win_update /home/khlebnikov/src/nvim/neovim/src/nvim/drawscreen.c:2288:15\r\n    #10 0x56322212b3c2 in update_screen /home/khlebnikov/src/nvim/neovim/src/nvim/drawscreen.c:639:7\r\n    #11 0x563222517b72 in normal_redraw /home/khlebnikov/src/nvim/neovim/src/nvim/normal.c:1355:5\r\n    #12 0x563222517b72 in normal_check /home/khlebnikov/src/nvim/neovim/src/nvim/normal.c:1451:5\r\n    #13 0x563222729783 in state_enter /home/khlebnikov/src/nvim/neovim/src/nvim/state.c:40:35\r\n    #14 0x5632224e3f8b in normal_enter /home/khlebnikov/src/nvim/neovim/src/nvim/normal.c:516:3\r\n    #15 0x5632223e1346 in main /home/khlebnikov/src/nvim/neovim/src/nvim/main.c:651:3\r\n    #16 0x7f129d229d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16\r\n\r\nSUMMARY: AddressSanitizer: heap-use-after-free /home/khlebnikov/src/nvim/neovim/src/nvim/charset.c:895:24 in skipwhite\r\nShadow bytes around the buggy address:\r\n  0x0c048000f190: fa fa fd fa fa fa 00 01 fa fa 00 05 fa fa fd fa\r\n  0x0c048000f1a0: fa fa fd fa fa fa 00 fa fa fa 00 02 fa fa 07 fa\r\n  0x0c048000f1b0: fa fa 00 03 fa fa fd fa fa fa fd fa fa fa 00 01\r\n  0x0c048000f1c0: fa fa 00 05 fa fa 00 02 fa fa fd fa fa fa fd fa\r\n  0x0c048000f1d0: fa fa fd fa fa fa fd fa fa fa 02 fa fa fa fd fd\r\n=>0x0c048000f1e0: fa fa[fd]fa fa fa fd fd fa fa fd fa fa fa fd fa\r\n  0x0c048000f1f0: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fd\r\n  0x0c048000f200: fa fa fd fa fa fa fd fd fa fa fd fa fa fa fd fa\r\n  0x0c048000f210: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fd\r\n  0x0c048000f220: fa fa fd fa fa fa fd fa fa fa fd fd fa fa fd fd\r\n  0x0c048000f230: fa fa fd fa fa fa fd fd fa fa fd fa fa fa fd fd\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07 \r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n==1033999==ABORTING\r\n```\r\n\r\nThis helps (but I have only slight idea what happens in this spaghetti-code).\r\n\r\n```\r\n--- a/src/nvim/drawline.c\r\n+++ b/src/nvim/drawline.c\r\n@@ -1946,6 +1946,7 @@ int win_line(win_T *wp, linenr_T lnum, int startrow, int endrow, int col_rows, s\r\n           // Need to get the line again, a multi-line regexp may\r\n           // have made it invalid.\r\n           line = ml_get_buf(wp->w_buffer, lnum);\r\n+          prev_ptr = line + v + (prev_ptr - ptr);\r\n           ptr = line + v;\r\n \r\n           // no concealing past the end of the line, it interferes\r\n```\r\n\r\n\r\n### Steps to reproduce\r\n\r\nnot sure what triggers it in my setup, prbably LSP or spellchecker\r\n\r\n### Expected behavior\r\n\r\nno use-after-free\r\n\r\n### Neovim version (nvim -v)\r\n\r\ntrunk\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\ndidn't check\r\n\r\n### Operating system/version\r\n\r\nlinux\r\n\r\n### Terminal name/version\r\n\r\ngnome terminal\r\n\r\n### $TERM environment variable\r\n\r\nno\r\n\r\n### Installation\r\n\r\nsources",
    "closed_at": "2024-01-17T23:27:02Z",
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/27066/comments",
    "created_at": "2024-01-17T15:25:52Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/27066/events",
    "html_url": "https://github.com/neovim/neovim/issues/27066",
    "id": 2086428577,
    "labels": [
        {
            "color": "F9D0C4",
            "default": false,
            "description": "issue reporting a crash or segfault",
            "id": 435854234,
            "name": "bug-crash",
            "node_id": "MDU6TGFiZWw0MzU4NTQyMzQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-crash"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "regex syntax or non-regex parsing, lpeg, grammars",
            "id": 531600085,
            "name": "syntax",
            "node_id": "MDU6TGFiZWw1MzE2MDAwODU=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/syntax"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/27066/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM58XF-h",
    "number": 27066,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/27066/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/27066/timeline",
    "title": "use-after-free in win_line()",
    "updated_at": "2024-01-17T23:27:02Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/27066",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/426506?v=4",
        "events_url": "https://api.github.com/users/koct9i/events{/privacy}",
        "followers_url": "https://api.github.com/users/koct9i/followers",
        "following_url": "https://api.github.com/users/koct9i/following{/other_user}",
        "gists_url": "https://api.github.com/users/koct9i/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/koct9i",
        "id": 426506,
        "login": "koct9i",
        "node_id": "MDQ6VXNlcjQyNjUwNg==",
        "organizations_url": "https://api.github.com/users/koct9i/orgs",
        "received_events_url": "https://api.github.com/users/koct9i/received_events",
        "repos_url": "https://api.github.com/users/koct9i/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/koct9i/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/koct9i/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/koct9i"
    }
}