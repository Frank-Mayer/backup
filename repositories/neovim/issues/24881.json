{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nThe problem is outlined in the title, details are under \"Steps to reproduce\". I also found an issue, which may be somewhat related to this one https://github.com/neovim/neovim/issues/23814\n\n### Steps to reproduce\n\nInstall Lua 5.3 and luarocks via a system package manager (in my case, `sudo pacman -S lua53 luarocks`).\r\n\r\nMake sure `~/.luarocks` does not exist at that point, to start cleanly.\r\n\r\nSet Lua 5.3 to be the default version via `luarocks config lua_version 5.3` and enable `local_by_default` via `luarocks config local_by_default true`. This should result in the following `~/.luarocks/default-lua-version.lua`:\r\n\r\n```lua\r\nreturn \"5.3\"\r\n```\r\n\r\nAnd `~/.luarocks/default-lua-version.lua`:\r\n\r\n```lua\r\nlocal_by_default = true\r\nlua_version = \"5.3\"\r\n```\r\n\r\nInstall busted via `luarocks install busted`\r\n\r\nRun `make distclean` and then `make test` in a Neovim repo root.\r\n\r\nI'm seeing the following output:\r\n\r\n```\r\n-- Using NVIM_VERSION: v0.10.0-dev-952+gb1cfb299d\r\n[206/396] Performing download step (download, verify and extract) for 'luarocks'\r\n-- Downloading...\r\n   dst='/home/faergeek/projects/neovim/build/build/downloads/luarocks/v3.9.2.tar.gz'\r\n   timeout='none'\r\n   inactivity timeout='none'\r\n-- Using src='https://github.com/luarocks/luarocks/archive/v3.9.2.tar.gz'\r\n-- verifying file...\r\n       file='/home/faergeek/projects/neovim/build/build/downloads/luarocks/v3.9.2.tar.gz'\r\n-- Downloading... done\r\n-- extracting...\r\n     src='/home/faergeek/projects/neovim/build/build/downloads/luarocks/v3.9.2.tar.gz'\r\n     dst='/home/faergeek/projects/neovim/build/build/src/luarocks'\r\n-- extracting... [tar xfz]\r\n-- extracting... [analysis]\r\n-- extracting... [rename]\r\n-- extracting... [clean up]\r\n-- extracting... done\r\n[227/396] Performing configure step for 'luarocks'\r\n\r\nConfiguring LuaRocks version 3.9.2...\r\n\r\nLua version detected: 5.1\r\nLua interpreter found: /home/faergeek/projects/neovim/.deps/usr/bin/luajit\r\nlua.h found: /home/faergeek/projects/neovim/.deps/usr/include/luajit-2.1/lua.h\r\nunzip found in PATH: /usr/bin\r\n\r\nDone configuring.\r\n\r\nLuaRocks will be installed at......: /home/faergeek/projects/neovim/build/usr\r\nLuaRocks will install rocks at.....: /home/faergeek/projects/neovim/build/usr\r\nLuaRocks configuration directory...: /home/faergeek/projects/neovim/build/usr/etc/luarocks\r\nUsing Lua from.....................: /home/faergeek/projects/neovim/.deps/usr\r\nLua include directory..............: /home/faergeek/projects/neovim/.deps/usr/include/luajit-2.1\r\n\r\n* Type make and make install:\r\n  to install to /home/faergeek/projects/neovim/build/usr as usual.\r\n* Type make bootstrap:\r\n  to install LuaRocks into /home/faergeek/projects/neovim/build/usr as a rock.\r\n\r\n[378/396] Performing install step for 'luarocks'\r\nmake[1]: Entering directory '/home/faergeek/projects/neovim/build/build/src/luarocks'\r\nmkdir -p \"build\"\r\nmkdir -p .luarocks\r\ncp ./build/config-5.1.lua .luarocks/config-5.1.lua\r\nrm -f src/luarocks/core/hardcoded.lua\r\necho \"#!/bin/sh\" > luarocks\r\necho \"unset LUA_PATH LUA_PATH_5_2 LUA_PATH_5_3 LUA_PATH_5_4 LUA_CPATH LUA_CPATH_5_2 LUA_CPATH_5_3 LUA_CPATH_5_4\" >> luarocks\r\necho 'LUAROCKS_SYSCONFDIR=\"/home/faergeek/projects/neovim/build/usr/etc/luarocks\" LUA_PATH=\"/home/faergeek/projects/neovim/build/build/src/luarocks/src/?.lua;;\" exec \"/home/faergeek/projects/neovim/.deps/usr/bin/luajit\" \"/home/faergeek/projects/neovim/build/build/src/luarocks/src/bin/luarocks\" --project-tree=\"/home/faergeek/projects/neovim/build/build/src/luarocks/lua_modules\" \"$@\"' >> luarocks\r\nchmod +rx ./luarocks\r\n./luarocks init\r\n\r\nInitializing project 'luarocks' for Lua 5.3 ...\r\n-----------------------------------------------\r\n\r\nChecking your Lua installation ...\r\nAdding entries to .gitignore ...\r\nPreparing ./.luarocks/ ...\r\nWrote .luarocks/config-5.3.lua\r\nPreparing ./lua_modules/ ...\r\n./luarocks already exists. Not overwriting it!\r\nPreparing ./lua for version 5.3...\r\nmkdir -p \"/home/faergeek/projects/neovim/build/usr/etc/luarocks\"\r\ninstall -m 644 \"build/config-5.1.lua\" \"/home/faergeek/projects/neovim/build/usr/etc/luarocks/config-5.1.lua\"\r\n./luarocks make --tree=\"/home/faergeek/projects/neovim/build/usr\"\r\n\r\nNo existing manifest. Attempting to rebuild...\r\nluarocks 3.9.2-1 is now installed in /home/faergeek/projects/neovim/build/usr (license: MIT)\r\n\r\nmake[1]: Leaving directory '/home/faergeek/projects/neovim/build/build/src/luarocks'\r\n[394/396] Generating usr/bin/luacheck\r\n\r\nluacheck 1.1.0-1 depends on lua >= 5.1 (5.3-1 provided by VM)\r\nluacheck 1.1.0-1 depends on argparse >= 0.6.0 (0.7.1-1 installed)\r\nluacheck 1.1.0-1 depends on luafilesystem >= 1.6.3 (1.8.0-1 installed)\r\nluacheck 1.1.0-1 is now installed in /home/faergeek/.luarocks (license: MIT)\r\n\r\n[395/396] Generating usr/bin/busted\r\n\r\nbusted 2.1.1-1 depends on lua >= 5.1 (5.3-1 provided by VM)\r\nbusted 2.1.1-1 depends on lua_cliargs 3.0 (3.0-2 installed)\r\nbusted 2.1.1-1 depends on luafilesystem >= 1.5.0 (1.8.0-1 installed)\r\nbusted 2.1.1-1 depends on luasystem >= 0.2.0 (0.2.1-0 installed)\r\nbusted 2.1.1-1 depends on dkjson >= 2.1.0 (2.6-1 installed)\r\nbusted 2.1.1-1 depends on say >= 1.4-1 (1.4.1-3 installed)\r\nbusted 2.1.1-1 depends on luassert >= 1.9.0-1 (1.9.0-1 installed)\r\nbusted 2.1.1-1 depends on lua-term >= 0.1 (0.7-1 installed)\r\nbusted 2.1.1-1 depends on penlight >= 1.3.2 (1.13.1-1 installed)\r\nbusted 2.1.1-1 depends on mediator_lua >= 1.1.1 (1.1.2-0 installed)\r\nbusted 2.1.1-1 is now installed in /home/faergeek/.luarocks (license: MIT <http://opensource.org/licenses/MIT>)\r\n\r\n[395/396] cd /home/faergeek/projects/neovim/build/test && /usr/bin/cmake -D N...US_CI= -D CI_BUILD=OFF -P /home/faergeek/projects/neovim/cmake/RunTests.cmake\r\n-- Tests exited non-zero: 1\r\n-- Output to stderr:\r\n/home/faergeek/projects/neovim/test/busted_runner.lua:7: module 'busted.runner' not found:\r\n\tno field package.preload['busted.runner']\r\n\tno file '/home/faergeek/projects/neovim/build/usr/share/lua/5.1/busted/runner.lua'\r\n\tno file '/home/faergeek/projects/neovim/build/usr/share/lua/5.1/busted/runner/init.lua'\r\n\tno file './busted/runner.lua'\r\n\tno file '/home/faergeek/projects/neovim/.deps/usr/share/luajit-2.1/busted/runner.lua'\r\n\tno file '/usr/local/share/lua/5.1/busted/runner.lua'\r\n\tno file '/usr/local/share/lua/5.1/busted/runner/init.lua'\r\n\tno file '/home/faergeek/projects/neovim/.deps/usr/share/lua/5.1/busted/runner.lua'\r\n\tno file '/home/faergeek/projects/neovim/.deps/usr/share/lua/5.1/busted/runner/init.lua'\r\n\tno file '/home/faergeek/projects/neovim/build/usr/lib/lua/5.1/busted/runner.so'\r\n\tno file './busted/runner.so'\r\n\tno file '/usr/local/lib/lua/5.1/busted/runner.so'\r\n\tno file '/home/faergeek/projects/neovim/.deps/usr/lib/lua/5.1/busted/runner.so'\r\n\tno file '/usr/local/lib/lua/5.1/loadall.so'\r\n\tno file '/home/faergeek/projects/neovim/build/usr/lib/lua/5.1/busted.so'\r\n\tno file './busted.so'\r\n\tno file '/usr/local/lib/lua/5.1/busted.so'\r\n\tno file '/home/faergeek/projects/neovim/.deps/usr/lib/lua/5.1/busted.so'\r\n\tno file '/usr/local/lib/lua/5.1/loadall.so'\r\nstack traceback:\r\n\t[C]: in function 'require'\r\n\t/home/faergeek/projects/neovim/test/busted_runner.lua:7: in main chunk\r\n\r\nCMake Error at /home/faergeek/projects/neovim/cmake/RunTests.cmake:103 (message):\r\n  functional tests failed with error: 1\r\n\r\n\r\nFAILED: test/CMakeFiles/functionaltest /home/faergeek/projects/neovim/build/test/CMakeFiles/functionaltest\r\ncd /home/faergeek/projects/neovim/build/test && /usr/bin/cmake -D NVIM_PRG=/home/faergeek/projects/neovim/build/bin/nvim -D WORKING_DIR=/home/faergeek/projects/neovim -D BUSTED_OUTPUT_TYPE=nvim -D TEST_DIR=/home/faergeek/projects/neovim/test -D BUILD_DIR=/home/faergeek/projects/neovim/build -D DEPS_INSTALL_DIR=/home/faergeek/projects/neovim/build/usr -D TEST_TYPE=functional -D CIRRUS_CI= -D CI_BUILD=OFF -P /home/faergeek/projects/neovim/cmake/RunTests.cmake\r\nninja: build stopped: subcommand failed.\r\nmake: *** [Makefile:135: functionaltest] Error 1\r\n```\r\n\r\nNotice the line saying that starting from `./luarocks init` Lua 5.3 is being used instead of 5.1:\r\n\r\n```\r\nInitializing project 'luarocks' for Lua 5.3 ...\"\r\n```\r\n\r\nLooks like it builds busted for Lua 5.3 only because there already exists busted for that version. Then when running tests it looks for busted luarocks for 5.1 and fails because didn't ever exist.\r\n\r\nI was able to work around it by applying the following patch:\r\n\r\n```patch\r\ndiff --git a/cmake/BuildLuarocks.cmake b/cmake/BuildLuarocks.cmake\r\nindex c5e08d2d7..ca38bfc3b 100644\r\n--- a/cmake/BuildLuarocks.cmake\r\n+++ b/cmake/BuildLuarocks.cmake\r\n@@ -82,7 +82,7 @@ function(Download ROCK VER)\r\n     set(OUTPUT ${ROCKS_DIR}/${ROCK})\r\n   endif()\r\n   add_custom_command(OUTPUT ${OUTPUT}\r\n-    COMMAND ${CMAKE_COMMAND} -E env \"${PATH}\" ${LUAROCKS_BINARY} build ${ROCK} ${VER} ${LUAROCKS_BUILDARGS}\r\n+    COMMAND ${CMAKE_COMMAND} -E env \"${PATH}\" ${LUAROCKS_BINARY} --lua-version 5.1 build ${ROCK} ${VER} ${LUAROCKS_BUILDARGS}\r\n     DEPENDS ${CURRENT_DEP})\r\n   add_custom_target(${ROCK} DEPENDS ${OUTPUT})\r\n   set(CURRENT_DEP ${ROCK} PARENT_SCOPE)\r\n```\r\n\r\nBut I'm pretty sure that's not the proper solution.\n\n### Expected behavior\n\nI suppose that better behavior would be to first check if all required rocks of appropriate versions already exist in the system for Lua 5.1. And if not, then build appropriate versions in a separate tree under `.deps`. Not sure if there's an easy way to do this though. But that would fix the following issue as well https://github.com/neovim/neovim/issues/23814\r\n\r\nAnother solution would be to just always build all the required rocks in a local tree under `.deps` and never look at or touch rocks in other trees.\n\n### Neovim version (nvim -v)\n\nv0.10.0-dev-952+gb1cfb299d\n\n### Vim (not Nvim) behaves the same?\n\nn/a\n\n### Operating system/version\n\nArch Linux\n\n### Terminal name/version\n\nalacritty 0.12.2 (9d9982df)\n\n### $TERM environment variable\n\nalacritty\n\n### Installation\n\nbuild from commit b1cfb299df2ef412339f594173ed23c75c090c8a",
    "closed_at": "2023-09-09T16:41:37Z",
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "I dug a bit further into the problem. What I found is that `--force-config` is meant to be used when we want to ignore user local config and various env vars overriding config path. So basically to isolate configuration. But then using \"make bootstrap\" instead of \"make install\" removes file, containing that flag. And then `luarocks init` just copies my local config to the new tree. That's why my local config affects nvim's test dependencies installation. And so the following patch fixes that problem, if the goal is to always ignore lua deps present on the system elsewhere:\r\n\r\n```patch\r\ndiff --git a/cmake/BuildLuarocks.cmake b/cmake/BuildLuarocks.cmake\r\nindex c5e08d2d7..19035bb62 100644\r\n--- a/cmake/BuildLuarocks.cmake\r\n+++ b/cmake/BuildLuarocks.cmake\r\n@@ -31,7 +31,7 @@ if(UNIX)\r\n \r\n   set(LUAROCKS_CONFIGURE_COMMAND ${DEPS_BUILD_DIR}/src/luarocks/configure\r\n       --prefix=${DEPS_INSTALL_DIR} --force-config ${LUAROCKS_OPTS})\r\n-  set(LUAROCKS_INSTALL_COMMAND ${MAKE_PRG} -j1 bootstrap)\r\n+  set(LUAROCKS_INSTALL_COMMAND ${MAKE_PRG} -j1 install)\r\n elseif(MSVC OR MINGW)\r\n   if(MINGW)\r\n     set(COMPILER_FLAG /MW)\r\n```",
            "created_at": "2023-08-26T15:43:36Z",
            "html_url": "https://github.com/neovim/neovim/issues/24881#issuecomment-1694391621",
            "id": 1694391621,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/24881",
            "node_id": "IC_kwDOAPphoM5k_l1F",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1694391621/reactions"
            },
            "updated_at": "2023-08-26T15:43:36Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1694391621",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3524621?v=4",
                "events_url": "https://api.github.com/users/faergeek/events{/privacy}",
                "followers_url": "https://api.github.com/users/faergeek/followers",
                "following_url": "https://api.github.com/users/faergeek/following{/other_user}",
                "gists_url": "https://api.github.com/users/faergeek/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/faergeek",
                "id": 3524621,
                "login": "faergeek",
                "node_id": "MDQ6VXNlcjM1MjQ2MjE=",
                "organizations_url": "https://api.github.com/users/faergeek/orgs",
                "received_events_url": "https://api.github.com/users/faergeek/received_events",
                "repos_url": "https://api.github.com/users/faergeek/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/faergeek/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/faergeek/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/faergeek"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Minor correction, it's not removed. It's not created to begin with.\r\n\r\nHere's what happens on `make bootstrap`:\r\n\r\nhttps://github.com/luarocks/luarocks/blob/bb9d7ed38a092dde2b27e2adc7b386272f2890ee/GNUmakefile#L53\r\n\r\nSo it's removed if it exists. And here's what happens on `make install`:\r\n\r\nhttps://github.com/luarocks/luarocks/blob/bb9d7ed38a092dde2b27e2adc7b386272f2890ee/GNUmakefile#L69-L71\r\n\r\nIt's presence is simulated through `package.loaded`",
            "created_at": "2023-08-26T15:51:00Z",
            "html_url": "https://github.com/neovim/neovim/issues/24881#issuecomment-1694393050",
            "id": 1694393050,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/24881",
            "node_id": "IC_kwDOAPphoM5k_mLa",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1694393050/reactions"
            },
            "updated_at": "2023-08-26T15:51:16Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1694393050",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3524621?v=4",
                "events_url": "https://api.github.com/users/faergeek/events{/privacy}",
                "followers_url": "https://api.github.com/users/faergeek/followers",
                "following_url": "https://api.github.com/users/faergeek/following{/other_user}",
                "gists_url": "https://api.github.com/users/faergeek/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/faergeek",
                "id": 3524621,
                "login": "faergeek",
                "node_id": "MDQ6VXNlcjM1MjQ2MjE=",
                "organizations_url": "https://api.github.com/users/faergeek/orgs",
                "received_events_url": "https://api.github.com/users/faergeek/received_events",
                "repos_url": "https://api.github.com/users/faergeek/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/faergeek/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/faergeek/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/faergeek"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/24881/comments",
    "created_at": "2023-08-26T09:53:21Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/24881/events",
    "html_url": "https://github.com/neovim/neovim/issues/24881",
    "id": 1868006194,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "building and installing Neovim using the provided scripts",
            "id": 84723321,
            "name": "build",
            "node_id": "MDU6TGFiZWw4NDcyMzMyMQ==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/build"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 110418643,
            "name": "test",
            "node_id": "MDU6TGFiZWwxMTA0MTg2NDM=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/test"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "build dependencies (LuaJIT, LibUV, etc.)",
            "id": 1205400704,
            "name": "dependencies",
            "node_id": "MDU6TGFiZWwxMjA1NDAwNzA0",
            "url": "https://api.github.com/repos/neovim/neovim/labels/dependencies"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/24881/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5vV4My",
    "number": 24881,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/24881/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/24881/timeline",
    "title": "Tests fail then `busted` is already installed in a \"user\" tree for a Lua version different from 5.1",
    "updated_at": "2023-09-09T16:41:37Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/24881",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/3524621?v=4",
        "events_url": "https://api.github.com/users/faergeek/events{/privacy}",
        "followers_url": "https://api.github.com/users/faergeek/followers",
        "following_url": "https://api.github.com/users/faergeek/following{/other_user}",
        "gists_url": "https://api.github.com/users/faergeek/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/faergeek",
        "id": 3524621,
        "login": "faergeek",
        "node_id": "MDQ6VXNlcjM1MjQ2MjE=",
        "organizations_url": "https://api.github.com/users/faergeek/orgs",
        "received_events_url": "https://api.github.com/users/faergeek/received_events",
        "repos_url": "https://api.github.com/users/faergeek/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/faergeek/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/faergeek/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/faergeek"
    }
}