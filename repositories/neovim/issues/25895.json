{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Problem\n\nWhen completion popup menu is visible during entering tabstop text but no its entry is selected, snippet state seems to be not updated properly. This situation is common with autocompletion which uses built-in completion or if indeed user wants to use on demand built-in completion.\n\n### Steps to reproduce\n\n1. Create the following config file:\r\n```lua\r\nvim.keymap.set('i', '<C-l>', function() vim.snippet.jump(1) end)\r\nvim.keymap.set('i', '<C-e>', function() vim.snippet.expand('$1 = function($2)\\n$3\\nend') end)\r\n```\r\n2. Start Neovim with `--clean` and this config file.\r\n3. Start Insert mode and press `<C-e>` to expand the snippet.\r\n4. Press `<C-n>` to show completion popup and `<C-p>` to make no item selected.\r\n5. Press `<C-l>` to jump forward.\r\n6. Type any character. Whole line up until cursor is highlighted as if entered text in tabstop. Pressing `<C-l>` again moves cursor to the start of the snippet.\n\n### Expected behavior\n\nSnippet navigation does not depend on whether popup is visible or not.\r\n\r\n------\r\n\r\nWhat I assume is that some state tracking is not triggered when popup menu is visible. There are several places which met the eye on the first sight:\r\n- [These autocommands](https://github.com/neovim/neovim/blob/5cefec7349610853910c21a0215f85a4d47132d1/runtime/lua/vim/snippet.lua#L322) don't include `TextChangedP` (as `TextChangedI` is \"Not triggered when the popup menu is visible.\"). Although, I've added it and didn't see positive changes, but maybe I am missing something.\r\n- [These autocommands](https://github.com/neovim/neovim/blob/5cefec7349610853910c21a0215f85a4d47132d1/runtime/lua/vim/snippet.lua#L276) are not triggered when popup menu is visible (as per `:h CursorMovedI`). I would assume those should not be crucial here because cursor move is done with `vim.snippet.jump()`, but I might be missing something.\n\n### Neovim version (nvim -v)\n\nNVIM v0.10.0-dev-1466+gec66a95fb-dirty\n\n### Vim (not Nvim) behaves the same?\n\nNo\n\n### Operating system/version\n\nEndeavourOS Linux x86_64 (6.5.9-arch2-1)\n\n### Terminal name/version\n\nst-0.9\n\n### $TERM environment variable\n\nst-256color\n\n### Installation\n\nFrom source",
    "closed_at": "2024-02-25T10:05:38Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "@echasnovski I can no longer reproduce this (might have been fixed with #26879). Could you please try it out and lmk?",
            "created_at": "2024-02-19T23:45:57Z",
            "html_url": "https://github.com/neovim/neovim/issues/25895#issuecomment-1953283520",
            "id": 1953283520,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25895",
            "node_id": "IC_kwDOAPphoM50bL3A",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1953283520/reactions"
            },
            "updated_at": "2024-02-19T23:45:57Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1953283520",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/62502207?v=4",
                "events_url": "https://api.github.com/users/MariaSolOs/events{/privacy}",
                "followers_url": "https://api.github.com/users/MariaSolOs/followers",
                "following_url": "https://api.github.com/users/MariaSolOs/following{/other_user}",
                "gists_url": "https://api.github.com/users/MariaSolOs/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/MariaSolOs",
                "id": 62502207,
                "login": "MariaSolOs",
                "node_id": "MDQ6VXNlcjYyNTAyMjA3",
                "organizations_url": "https://api.github.com/users/MariaSolOs/orgs",
                "received_events_url": "https://api.github.com/users/MariaSolOs/received_events",
                "repos_url": "https://api.github.com/users/MariaSolOs/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/MariaSolOs/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/MariaSolOs/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/MariaSolOs"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Yes, I can no longer reproduce this also.\r\n\r\nBecause #26879 does not look like fixing this, I got curious and bisected. This was fixed in d6f429520bce3c9f5d97f920e847fe6f668fac79 (which is part of #25795). And the real culprit fixing this looks like [this `if`](https://github.com/neovim/neovim/blob/eb1e8c12e2c5ad172f2fe54cb96bf31602b16c3d/runtime/lua/vim/snippet.lua#L292-L295). Not sure if `vim.fn.complete(vim.fn.col('.'), {})` is a good way to \"close completion menu\" (I'd prefer something like `vim.fn.feedkeys('\\25', 'n')`, which is for \"stop completion and accept the currently selected entry\"), but I don't have any objective reason to back this up.\r\n\r\nHaving some kind of test against repeating this would be a good idea, though. This issue originally was quite intrusive as it meant that user could not expand snippet when completion menu is visible.",
            "created_at": "2024-02-20T13:41:07Z",
            "html_url": "https://github.com/neovim/neovim/issues/25895#issuecomment-1954241349",
            "id": 1954241349,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25895",
            "node_id": "IC_kwDOAPphoM50e1tF",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1954241349/reactions"
            },
            "updated_at": "2024-02-20T13:41:07Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1954241349",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/24854248?v=4",
                "events_url": "https://api.github.com/users/echasnovski/events{/privacy}",
                "followers_url": "https://api.github.com/users/echasnovski/followers",
                "following_url": "https://api.github.com/users/echasnovski/following{/other_user}",
                "gists_url": "https://api.github.com/users/echasnovski/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/echasnovski",
                "id": 24854248,
                "login": "echasnovski",
                "node_id": "MDQ6VXNlcjI0ODU0MjQ4",
                "organizations_url": "https://api.github.com/users/echasnovski/orgs",
                "received_events_url": "https://api.github.com/users/echasnovski/received_events",
                "repos_url": "https://api.github.com/users/echasnovski/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/echasnovski/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/echasnovski/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/echasnovski"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Interesting, thank you for investigating the problem (and the unintended solution lol).\r\n\r\nI'll be adding a test to prevent a future regression.",
            "created_at": "2024-02-20T18:11:12Z",
            "html_url": "https://github.com/neovim/neovim/issues/25895#issuecomment-1954793801",
            "id": 1954793801,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25895",
            "node_id": "IC_kwDOAPphoM50g8lJ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1954793801/reactions"
            },
            "updated_at": "2024-02-20T18:11:12Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1954793801",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/62502207?v=4",
                "events_url": "https://api.github.com/users/MariaSolOs/events{/privacy}",
                "followers_url": "https://api.github.com/users/MariaSolOs/followers",
                "following_url": "https://api.github.com/users/MariaSolOs/following{/other_user}",
                "gists_url": "https://api.github.com/users/MariaSolOs/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/MariaSolOs",
                "id": 62502207,
                "login": "MariaSolOs",
                "node_id": "MDQ6VXNlcjYyNTAyMjA3",
                "organizations_url": "https://api.github.com/users/MariaSolOs/orgs",
                "received_events_url": "https://api.github.com/users/MariaSolOs/received_events",
                "repos_url": "https://api.github.com/users/MariaSolOs/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/MariaSolOs/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/MariaSolOs/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/MariaSolOs"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/25895/comments",
    "created_at": "2023-11-04T17:47:50Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/25895/events",
    "html_url": "https://github.com/neovim/neovim/issues/25895",
    "id": 1977444812,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "",
            "id": 6207355257,
            "name": "snippets",
            "node_id": "LA_kwDOAPphoM8AAAABcfy5eQ",
            "url": "https://api.github.com/repos/neovim/neovim/labels/snippets"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/25895/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM513WnM",
    "number": 25895,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/25895/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/25895/timeline",
    "title": "Snippet state is not updated when built-in completion popup menu is visible",
    "updated_at": "2024-02-25T10:05:38Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/25895",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/24854248?v=4",
        "events_url": "https://api.github.com/users/echasnovski/events{/privacy}",
        "followers_url": "https://api.github.com/users/echasnovski/followers",
        "following_url": "https://api.github.com/users/echasnovski/following{/other_user}",
        "gists_url": "https://api.github.com/users/echasnovski/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/echasnovski",
        "id": 24854248,
        "login": "echasnovski",
        "node_id": "MDQ6VXNlcjI0ODU0MjQ4",
        "organizations_url": "https://api.github.com/users/echasnovski/orgs",
        "received_events_url": "https://api.github.com/users/echasnovski/received_events",
        "repos_url": "https://api.github.com/users/echasnovski/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/echasnovski/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/echasnovski/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/echasnovski"
    }
}