{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Problem\r\n\r\nWhen changing the height of a window that is not the current window with `splitkeep=screen`, and then moving the cursor to a location in the new window, the cursor will be moved by the splitkeep code to a wrong location instead.\r\n\r\n### Steps to reproduce\r\n\r\nThe editor needs to be open in order to trigger the issue.\r\n\r\nSave the file as `test.lua` and run `nvim -u NONE test.lua`.\r\n\r\nThen inside Neovim, do `:luafile %`\r\n\r\n```lua\r\nvim.o.splitkeep = \"screen\"\r\nvim.o.number = true\r\n\r\n-- create test file\r\nlocal lines = {}\r\nfor i = 1, 200, 1 do\r\n\tlines[#lines + 1] = i .. \"\"\r\nend\r\nlocal fd = assert(io.open(\"./foo.bar\", \"w+\"))\r\nfd:write(table.concat(lines, \"\\n\"))\r\nfd:close()\r\n\r\nlocal win = vim.api.nvim_get_current_win()\r\n\r\n-- create second window\r\nvim.cmd([[vnew]])\r\nlocal win2 = vim.api.nvim_get_current_win()\r\nvim.api.nvim_buf_set_lines(0, 0, -1, false, { \"Second Window\" })\r\n\r\n-- make the previous window active\r\nvim.api.nvim_set_current_win(win)\r\n\r\nvim.api.nvim_create_autocmd({ \"WinResized\" }, {\r\n\tcallback = function()\r\n\t\t-- set to same height\r\n\t\tlocal height = vim.api.nvim_win_get_height(win2)\r\n\t\t-- commenting the line below, will make the issue go away\r\n\t\tvim.api.nvim_win_set_height(win2, height)\r\n\tend,\r\n})\r\n\r\n-- simulates vim.lsp.buf.jump_to_location()\r\nlocal function go(line)\r\n\tlocal win = vim.api.nvim_get_current_win()\r\n\tlocal bufnr = vim.fn.bufadd(\"./foo.bar\")\r\n\tvim.api.nvim_win_set_buf(win, bufnr)\r\n\t-- vim.api.nvim_set_current_win(win)\r\n\tvim.api.nvim_win_set_cursor(win, { line, 1 })\r\n\tvim.api.nvim_win_call(win, function()\r\n\t\tvim.cmd(\"normal! zv\")\r\n\tend)\r\nend\r\n\r\n-- commenting the two lines below also don't trigger the issue\r\ngo(1)\r\nvim.cmd([[bdelete]])\r\n\r\n-- this will trigger the issue\r\n-- instead of at line 100, you'll be at line roughly the same as the editor height\r\ngo(100)\r\n``` \r\n\r\n### Expected behavior\r\n\r\nspitkeep fix cursor should not be called for this case.\r\n\r\n### Neovim version (nvim -v)\r\n\r\nnightly\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\ndidn't test\r\n\r\n### Operating system/version\r\n\r\nlinux\r\n\r\n### Terminal name/version\r\n\r\nkitty\r\n\r\n### $TERM environment variable\r\n\r\nxterm-256-kitty\r\n\r\n### Installation\r\n\r\nbob",
    "closed_at": "2023-08-24T22:02:58Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Closed by accident, I'll look into it thanks.",
            "created_at": "2023-06-02T18:05:50Z",
            "html_url": "https://github.com/neovim/neovim/issues/23888#issuecomment-1574120535",
            "id": 1574120535,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23888",
            "node_id": "IC_kwDOAPphoM5d0yxX",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 1,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1574120535/reactions"
            },
            "updated_at": "2023-06-02T18:05:50Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1574120535",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I'm aware this is probably a very niche problem. It gets triggered a lot in a new plugin I'm working on, but I can easily work around it, so nothing urgent for me.",
            "created_at": "2023-06-02T18:07:22Z",
            "html_url": "https://github.com/neovim/neovim/issues/23888#issuecomment-1574122100",
            "id": 1574122100,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23888",
            "node_id": "IC_kwDOAPphoM5d0zJ0",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1574122100/reactions"
            },
            "updated_at": "2023-06-02T18:07:22Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1574122100",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/292349?v=4",
                "events_url": "https://api.github.com/users/folke/events{/privacy}",
                "followers_url": "https://api.github.com/users/folke/followers",
                "following_url": "https://api.github.com/users/folke/following{/other_user}",
                "gists_url": "https://api.github.com/users/folke/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/folke",
                "id": 292349,
                "login": "folke",
                "node_id": "MDQ6VXNlcjI5MjM0OQ==",
                "organizations_url": "https://api.github.com/users/folke/orgs",
                "received_events_url": "https://api.github.com/users/folke/received_events",
                "repos_url": "https://api.github.com/users/folke/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/folke/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/folke/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/folke"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "So it turns out `win_fix_cursor()` uses an invalid `w_botline` in this repro.\r\nThis patch fixes the issue:\r\n```diff\r\ndiff --git a/src/nvim/window.c b/src/nvim/window.c\r\nindex ebfa538af..88c44b116 100644\r\n--- a/src/nvim/window.c\r\n+++ b/src/nvim/window.c\r\n@@ -6483,6 +6483,7 @@ static void win_fix_cursor(int normal)\r\n   cursor_down_inner(wp, so);\r\n   linenr_T top = wp->w_cursor.lnum;\r\n\r\n+  validate_botline(wp);\r\n   wp->w_cursor.lnum = wp->w_botline - 1;\r\n   cursor_up_inner(wp, so);\r\n   linenr_T bot = wp->w_cursor.lnum;\r\n```\r\n\r\nNow to somehow convert this repro into an oldtest ðŸ˜… \r\n",
            "created_at": "2023-06-02T22:52:37Z",
            "html_url": "https://github.com/neovim/neovim/issues/23888#issuecomment-1574407852",
            "id": 1574407852,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23888",
            "node_id": "IC_kwDOAPphoM5d146s",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1574407852/reactions"
            },
            "updated_at": "2023-06-02T22:52:37Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1574407852",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Wow, I would never have figured that one out :) Nice!",
            "created_at": "2023-06-02T22:55:36Z",
            "html_url": "https://github.com/neovim/neovim/issues/23888#issuecomment-1574412094",
            "id": 1574412094,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23888",
            "node_id": "IC_kwDOAPphoM5d158-",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1574412094/reactions"
            },
            "updated_at": "2023-06-02T22:55:36Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1574412094",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/292349?v=4",
                "events_url": "https://api.github.com/users/folke/events{/privacy}",
                "followers_url": "https://api.github.com/users/folke/followers",
                "following_url": "https://api.github.com/users/folke/following{/other_user}",
                "gists_url": "https://api.github.com/users/folke/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/folke",
                "id": 292349,
                "login": "folke",
                "node_id": "MDQ6VXNlcjI5MjM0OQ==",
                "organizations_url": "https://api.github.com/users/folke/orgs",
                "received_events_url": "https://api.github.com/users/folke/received_events",
                "repos_url": "https://api.github.com/users/folke/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/folke/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/folke/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/folke"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Actually, it is easy to write a test that exhibits unexpected behavior similar to this issue:\r\n```vim\r\nset splitkeep=screen\r\ncall setline(1, range(1, 200))\r\nfunc CursorResize()\r\n  call cursor(100, 1)\r\n  resize -1\r\nendfunc\r\ncall CursorResize()\r\n```\r\n\r\nHowever in this case, both `w_topline` and `w_botline` are not yet updated so adding `validate_botline()` is not enough to fix this issue.\r\nI'm not exactly sure how to fix this yet.\r\n\r\n(Notes to self:)\r\n`nvim_win_set_cursor()` calls `update_topline()`, perhaps `set_cursorpos()` should as well? I think I'll propose that to Bram because it is the only way I can think of to fix that particular issue. Then I still need a different test that fails without adding `invalidate_botline()`.",
            "created_at": "2023-06-03T00:11:21Z",
            "html_url": "https://github.com/neovim/neovim/issues/23888#issuecomment-1574462378",
            "id": 1574462378,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23888",
            "node_id": "IC_kwDOAPphoM5d2GOq",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1574462378/reactions"
            },
            "updated_at": "2023-06-05T14:20:29Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1574462378",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "After some back and forth with Bram about this in https://github.com/vim/vim/pull/12488, I'm no longer sure what can be done about this. It's not clear what should happen when the cursor is moved and windows are resized before a redraw happens if 'splitkeep' != \"cursor.\r\n\r\nAlthough in my eyes the explicit cursor movement should trump the window resize. The problem is that it is hard to make this work without special-casing 'splitkeep' for each cursor movement which according to Bram is unrealistic, which I would agree with.\r\n\r\nUsing the `w_valid` flags or `w_valid_cursor` directly to determine whether the cursor should be adjusted in `win_fix_cursor()` seems like the right approach, but I haven't been able to make that work without breaking numerous 'splitkeep' tests.",
            "created_at": "2023-06-05T14:39:17Z",
            "html_url": "https://github.com/neovim/neovim/issues/23888#issuecomment-1576930922",
            "id": 1576930922,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23888",
            "node_id": "IC_kwDOAPphoM5d_g5q",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1576930922/reactions"
            },
            "updated_at": "2023-06-05T14:39:17Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1576930922",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Fixed in https://github.com/neovim/neovim/pull/24811",
            "created_at": "2023-08-24T22:02:58Z",
            "html_url": "https://github.com/neovim/neovim/issues/23888#issuecomment-1692473926",
            "id": 1692473926,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/23888",
            "node_id": "IC_kwDOAPphoM5k4RpG",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1692473926/reactions"
            },
            "updated_at": "2023-08-24T22:02:58Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1692473926",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/31730729?v=4",
                "events_url": "https://api.github.com/users/luukvbaal/events{/privacy}",
                "followers_url": "https://api.github.com/users/luukvbaal/followers",
                "following_url": "https://api.github.com/users/luukvbaal/following{/other_user}",
                "gists_url": "https://api.github.com/users/luukvbaal/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/luukvbaal",
                "id": 31730729,
                "login": "luukvbaal",
                "node_id": "MDQ6VXNlcjMxNzMwNzI5",
                "organizations_url": "https://api.github.com/users/luukvbaal/orgs",
                "received_events_url": "https://api.github.com/users/luukvbaal/received_events",
                "repos_url": "https://api.github.com/users/luukvbaal/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/luukvbaal/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/luukvbaal/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/luukvbaal"
            }
        }
    ],
    "comments": 7,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/23888/comments",
    "created_at": "2023-06-02T17:44:36Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/23888/events",
    "html_url": "https://github.com/neovim/neovim/issues/23888",
    "id": 1738575145,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "F9D0C4",
            "default": false,
            "description": "wrong behavior inherited from vim",
            "id": 154310492,
            "name": "bug-vim",
            "node_id": "MDU6TGFiZWwxNTQzMTA0OTI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-vim"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/23888/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 117,
        "created_at": "2023-02-02T14:11:43Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1363104?v=4",
            "events_url": "https://api.github.com/users/bfredl/events{/privacy}",
            "followers_url": "https://api.github.com/users/bfredl/followers",
            "following_url": "https://api.github.com/users/bfredl/following{/other_user}",
            "gists_url": "https://api.github.com/users/bfredl/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/bfredl",
            "id": 1363104,
            "login": "bfredl",
            "node_id": "MDQ6VXNlcjEzNjMxMDQ=",
            "organizations_url": "https://api.github.com/users/bfredl/orgs",
            "received_events_url": "https://api.github.com/users/bfredl/received_events",
            "repos_url": "https://api.github.com/users/bfredl/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/bfredl/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/bfredl/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/bfredl"
        },
        "description": "",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/36",
        "id": 8997654,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/36/labels",
        "node_id": "MI_kwDOAPphoM4AiUsW",
        "number": 36,
        "open_issues": 141,
        "state": "open",
        "title": "0.10",
        "updated_at": "2023-08-24T22:17:32Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/36"
    },
    "node_id": "I_kwDOAPphoM5noI0p",
    "number": 23888,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 1,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 1,
        "url": "https://api.github.com/repos/neovim/neovim/issues/23888/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/23888/timeline",
    "title": "splitkeep causes issues when window height is set from an autocmd",
    "updated_at": "2023-08-24T22:05:55Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/23888",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/292349?v=4",
        "events_url": "https://api.github.com/users/folke/events{/privacy}",
        "followers_url": "https://api.github.com/users/folke/followers",
        "following_url": "https://api.github.com/users/folke/following{/other_user}",
        "gists_url": "https://api.github.com/users/folke/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/folke",
        "id": 292349,
        "login": "folke",
        "node_id": "MDQ6VXNlcjI5MjM0OQ==",
        "organizations_url": "https://api.github.com/users/folke/orgs",
        "received_events_url": "https://api.github.com/users/folke/received_events",
        "repos_url": "https://api.github.com/users/folke/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/folke/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/folke/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/folke"
    }
}