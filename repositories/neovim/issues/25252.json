{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\r\n\r\nbisected to d7ae9ae3e\r\n\r\nUPDATE: specifically the combination of https://github.com/tree-sitter/tree-sitter/commit/9564e1706de651cea6df9939b8a5dba02e7dbc71 and https://github.com/neovim/neovim/commit/2ca076e45fb3f1c08f6a1a374834df0701b8d778 causes the issue; since the latter by itself already causes some funky highlighting, I think filing with Neovim is appropriate (I suspect we are passing in invalid data into tree-sitter somehow), but I can also raise it to tree-sitter if I'm unable to figure it out here.\r\n\r\nat a particular part of a test file, if you add and remove a new line repeatedly, the latency will gradually increase until text editing becomes noticeably slow. the bulk of the time is spent in `LanguageTree:parse`:\r\n\r\n![flame](https://github.com/neovim/neovim/assets/5601392/d417880a-4edb-4b69-ae60-355647d07ff2)\r\n\r\nUnfortunately the issue does not reproduce with the inspector open, so I'll have to find a different way to look under the hood.\r\n\r\nI have noticed another interesting thing (video in https://github.com/neovim/neovim/issues/25252#issuecomment-1726756528):\r\n- before 2ca076e45, the highlighting doesn't change (correct) when you add/remove the newline\r\n- after 2ca076e45, the highlight is incorrect after adding/removing the newline, but the performance issue does not appear yet\r\n- after d7ae9ae3e, the highlight is incorrect after adding/removing the newline, but in a different way from before. the performance issue shows up here\r\n\r\n### Steps to reproduce\r\n\r\n`repro.lua` (minimal config):\r\n```lua\r\nvim.api.nvim_create_autocmd(\"FileType\", {\r\n  pattern = { \"*\" },\r\n  callback = function() vim.treesitter.start() end,\r\n})\r\n```\r\n`lspconfig.lua` (the file we are editing): [download (~500 lines)](https://github.com/llllvvuu/dotfiles/blob/9e54b87b4fdb17becef516863ab623756da43ae1/vim/.config/nvim/lua/plugins-tui/lspconfig.lua)\r\n1. `nvim --clean --noplugin -u repro.lua lspconfig.lua`.\r\n2. Adjust winheight to 57 for this demo (`:echo winheight(0)`\r\n3. `/vue<CR>f}i` should place you in insert mode between the brackets. First line of screen should say \"suggest = {\" and last line should say \"on_initialized = function()\"\r\n4. Press `<CR><Backspace><Backspace>` to insert and remove a new line. This should be quite snappy, although the syntax highlighting should be wrong at this point.\r\n5. Repeat step 4 over and over; the 20th time should feel considerably slower.\r\n\r\nNote that although the symptoms are similar to #25104, they were not fully fixed by the recent double recursion fixes (and it was speculated in the OP of #25109 that something still seemed off); the issue still reproduces on `master`, just that the slowdown now seems to accumulate linearly rather than exponentially.\r\n\r\nThe next step might be to try some more logging in `LanguageTree:parse` and/or look into what changed between the upstream tree-sitter versions referenced in `d7ae9ae3e`. I doubt it is purely an upstream tree-sitter problem though.\r\n\r\n### Expected behavior\r\n\r\nLatency is stable.\r\n\r\n### Neovim version (nvim -v)\r\n\r\n0.10 commit 28f54a78782318cb9c356a372b9e52a3a6b1f8dd\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\nno\r\n\r\n### Operating system/version\r\n\r\nmacOS 13.4.1\r\n\r\n### Terminal name/version\r\n\r\nkitty 0.28.1\r\n\r\n### $TERM environment variable\r\n\r\nxterm-kitty\r\n\r\n### Installation\r\n\r\nbuild from repo",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "I have confirmed that the issue does not reproduce with incremental injection turned off (i.e. change last line of `intercepts_region` to `return true`). So it seems the combination of both ingredients (incremental injection + upstream tree-sitter update) are required to produce the full issue (whereas incremental injection by itself only produces an aesthetic issue)",
            "created_at": "2023-09-20T00:35:00Z",
            "html_url": "https://github.com/neovim/neovim/issues/25252#issuecomment-1726717554",
            "id": 1726717554,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25252",
            "node_id": "IC_kwDOAPphoM5m655y",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1726717554/reactions"
            },
            "updated_at": "2023-09-20T00:35:33Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1726717554",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5601392?v=4",
                "events_url": "https://api.github.com/users/llllvvuu/events{/privacy}",
                "followers_url": "https://api.github.com/users/llllvvuu/followers",
                "following_url": "https://api.github.com/users/llllvvuu/following{/other_user}",
                "gists_url": "https://api.github.com/users/llllvvuu/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/llllvvuu",
                "id": 5601392,
                "login": "llllvvuu",
                "node_id": "MDQ6VXNlcjU2MDEzOTI=",
                "organizations_url": "https://api.github.com/users/llllvvuu/orgs",
                "received_events_url": "https://api.github.com/users/llllvvuu/received_events",
                "repos_url": "https://api.github.com/users/llllvvuu/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/llllvvuu/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/llllvvuu/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/llllvvuu"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Attaching the screen recordings of incorrect highlighting (which can be reproduced with steps in the issue description):\r\n\r\nPrior to both changes (correct highlighting):\r\n\r\nhttps://github.com/neovim/neovim/assets/5601392/410ad3e4-cb6a-498c-a035-24ec68b9ae03\r\n\r\nIncremental injection but no tree-sitter update (incorrect highlighting):\r\n\r\nhttps://github.com/neovim/neovim/assets/5601392/8c6819d5-9726-4dd2-bef7-d53daf7ed97e\r\n\r\nIncremental injection and tree-sitter update (different incorrect highlighting):\r\n\r\nhttps://github.com/neovim/neovim/assets/5601392/350c0ad4-e367-49d2-becb-accd4d64437c\r\n\r\n\r\n\r\n",
            "created_at": "2023-09-20T01:39:43Z",
            "html_url": "https://github.com/neovim/neovim/issues/25252#issuecomment-1726756528",
            "id": 1726756528,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/25252",
            "node_id": "IC_kwDOAPphoM5m7Daw",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1726756528/reactions"
            },
            "updated_at": "2023-09-20T01:39:43Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1726756528",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5601392?v=4",
                "events_url": "https://api.github.com/users/llllvvuu/events{/privacy}",
                "followers_url": "https://api.github.com/users/llllvvuu/followers",
                "following_url": "https://api.github.com/users/llllvvuu/following{/other_user}",
                "gists_url": "https://api.github.com/users/llllvvuu/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/llllvvuu",
                "id": 5601392,
                "login": "llllvvuu",
                "node_id": "MDQ6VXNlcjU2MDEzOTI=",
                "organizations_url": "https://api.github.com/users/llllvvuu/orgs",
                "received_events_url": "https://api.github.com/users/llllvvuu/received_events",
                "repos_url": "https://api.github.com/users/llllvvuu/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/llllvvuu/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/llllvvuu/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/llllvvuu"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/25252/comments",
    "created_at": "2023-09-20T00:30:55Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/25252/events",
    "html_url": "https://github.com/neovim/neovim/issues/25252",
    "id": 1903893685,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 1799626557,
            "name": "treesitter",
            "node_id": "MDU6TGFiZWwxNzk5NjI2NTU3",
            "url": "https://api.github.com/repos/neovim/neovim/labels/treesitter"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/25252/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5xexy1",
    "number": 25252,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/25252/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/25252/timeline",
    "title": "bug(treesitter): tree accumulates cruft on repeated operation, leading to slowdown",
    "updated_at": "2023-09-20T01:51:17Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/25252",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/5601392?v=4",
        "events_url": "https://api.github.com/users/llllvvuu/events{/privacy}",
        "followers_url": "https://api.github.com/users/llllvvuu/followers",
        "following_url": "https://api.github.com/users/llllvvuu/following{/other_user}",
        "gists_url": "https://api.github.com/users/llllvvuu/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/llllvvuu",
        "id": 5601392,
        "login": "llllvvuu",
        "node_id": "MDQ6VXNlcjU2MDEzOTI=",
        "organizations_url": "https://api.github.com/users/llllvvuu/orgs",
        "received_events_url": "https://api.github.com/users/llllvvuu/received_events",
        "repos_url": "https://api.github.com/users/llllvvuu/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/llllvvuu/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/llllvvuu/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/llllvvuu"
    }
}