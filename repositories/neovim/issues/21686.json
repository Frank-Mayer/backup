{
    "active_lock_reason": "resolved",
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Neovim version (nvim -v)\n\nHEAD\n\n### Language server name/version\n\nlua-language-server 3.6.4\n\n### Operating system/version\n\nmacOS 12.5.1\n\n### Steps to reproduce using \"nvim -u minimal_init.lua\"\n\nin ftplugin/lua.lua (following suggested place from lsp.txt docs):\r\n\r\n```lua\r\nvim.lsp.start({\r\n  name = 'testservername',\r\n  root_dir = vim.fs.dirname(vim.fs.find('luarc.lua', { upward = true, })[1]),\r\n  cmd = { 'lua-language-server', '--configpath=luarc.lua' },\r\n  settings = {\r\n    Lua = {\r\n      runtime = { version = 'LuaJIT' },\r\n    },\r\n  },\r\n})\r\n```\r\n\r\ncreate a `~/.config/nvim/luarc.lua` file, following the [lua-language-server wiki for custom config files](https://github.com/sumneko/lua-language-server/wiki/Configuration-File#custom-config-file):\r\n\r\n```lua\r\nreturn {\r\n  Lua = {\r\n    workspace = {\r\n      library = vim.api.nvim_get_runtime_file(\"\", true),\r\n    },\r\n    diagnostics = {\r\n      globals = {\r\n        \"vim\"\r\n      }\r\n    },\r\n  }\r\n}\r\n```\r\n\r\n\n\n### Expected behavior\n\n`Lua.diagnostics.globals` list should work in a custom lua config passed to lua-language-server via the `--configpath=` flag.\n\n### Actual behavior\n\nOpen any old neovim lua file with a `vim.whatever` call. Diagnostics will give a warning about the `Undefined global 'vim'.` even though we have declared it in our config file as a known global. It also seems that the `vim.api.nvim_get_runtime_file()` call in `Lua.workspace.library` didn't work either.\r\n\r\nI don't know that this is a LSP client error, or a lua-language-server error, or a bit of both, or neither. I'm thinking it may have something to do with loading order like this other issue: #21588 \n\n### Log file\n\nhttps://gist.github.com/craigmac/ea4d8d1032e5c175090d8a9adbcd2d98",
    "closed_at": "2023-01-09T19:06:12Z",
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "So the lua-lang-server will evaluate `~/.config/nvim/luarc.lua` on its own.\r\nThen obviously it knows nothing about `vim` in `vim.api.nvim_get_runtime_file(\"\", true)`.\r\n",
            "created_at": "2023-01-08T11:01:47Z",
            "html_url": "https://github.com/neovim/neovim/issues/21686#issuecomment-1374802590",
            "id": 1374802590,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21686",
            "node_id": "IC_kwDOAPphoM5R8dKe",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1374802590/reactions"
            },
            "updated_at": "2023-01-08T11:01:47Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1374802590",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/6236829?v=4",
                "events_url": "https://api.github.com/users/haolian9/events{/privacy}",
                "followers_url": "https://api.github.com/users/haolian9/followers",
                "following_url": "https://api.github.com/users/haolian9/following{/other_user}",
                "gists_url": "https://api.github.com/users/haolian9/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/haolian9",
                "id": 6236829,
                "login": "haolian9",
                "node_id": "MDQ6VXNlcjYyMzY4Mjk=",
                "organizations_url": "https://api.github.com/users/haolian9/orgs",
                "received_events_url": "https://api.github.com/users/haolian9/received_events",
                "repos_url": "https://api.github.com/users/haolian9/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/haolian9/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/haolian9/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/haolian9"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "It doesn't that's true, but does this then it stops all processing of the `luarc.lua` at that point? I can't see that in the logs. It seems to have stopped processing the config at that point though, as the neovim rtp hasn't been added, and \"vim\" isn't a recognized global in any lua file after this. Can you think of any workaround to this? I can't use a `.luarc.json` because I'd have to hard-code every single rtp value in there and keep it in sync, rather have it built dynamically. Yes, I could add this in my `vim.lsp.start()` call but I don't want to add these rtp values globally (lua-language-server mentions it slows down the server if you do this globally). ",
            "created_at": "2023-01-08T14:50:00Z",
            "html_url": "https://github.com/neovim/neovim/issues/21686#issuecomment-1374853898",
            "id": 1374853898,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21686",
            "node_id": "IC_kwDOAPphoM5R8psK",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1374853898/reactions"
            },
            "updated_at": "2023-01-08T14:50:00Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1374853898",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7416158?v=4",
                "events_url": "https://api.github.com/users/craigmac/events{/privacy}",
                "followers_url": "https://api.github.com/users/craigmac/followers",
                "following_url": "https://api.github.com/users/craigmac/following{/other_user}",
                "gists_url": "https://api.github.com/users/craigmac/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/craigmac",
                "id": 7416158,
                "login": "craigmac",
                "node_id": "MDQ6VXNlcjc0MTYxNTg=",
                "organizations_url": "https://api.github.com/users/craigmac/orgs",
                "received_events_url": "https://api.github.com/users/craigmac/received_events",
                "repos_url": "https://api.github.com/users/craigmac/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/craigmac/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/craigmac/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/craigmac"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> It doesn't that's true, but does this then it stops all processing of the luarc.lua at that point?\r\n\r\nIt's very likely that it stops evaluating it. \r\n\r\n> Yes, I could add this in my vim.lsp.start() call but I don't want to add these rtp values globally (lua-language-server mentions it slows down the server if you do this globally).\r\n\r\nYou could do it per project if you write your own code that looks for a luarc.lua, evaluates it and calls vim.lsp.start with the resulting settings\r\n\r\nClosing this as it's not a bug in the lsp client",
            "created_at": "2023-01-09T19:06:12Z",
            "html_url": "https://github.com/neovim/neovim/issues/21686#issuecomment-1376141796",
            "id": 1376141796,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21686",
            "node_id": "IC_kwDOAPphoM5SBkHk",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1376141796/reactions"
            },
            "updated_at": "2023-01-09T19:06:12Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1376141796",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/38700?v=4",
                "events_url": "https://api.github.com/users/mfussenegger/events{/privacy}",
                "followers_url": "https://api.github.com/users/mfussenegger/followers",
                "following_url": "https://api.github.com/users/mfussenegger/following{/other_user}",
                "gists_url": "https://api.github.com/users/mfussenegger/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mfussenegger",
                "id": 38700,
                "login": "mfussenegger",
                "node_id": "MDQ6VXNlcjM4NzAw",
                "organizations_url": "https://api.github.com/users/mfussenegger/orgs",
                "received_events_url": "https://api.github.com/users/mfussenegger/received_events",
                "repos_url": "https://api.github.com/users/mfussenegger/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mfussenegger/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mfussenegger/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mfussenegger"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> You could do it per project if you write your own code that looks for a luarc.lua, evaluates it and calls vim.lsp.start with the resulting settings\r\n\r\nGood idea, I'll do that, thanks!",
            "created_at": "2023-01-09T20:29:40Z",
            "html_url": "https://github.com/neovim/neovim/issues/21686#issuecomment-1376277191",
            "id": 1376277191,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21686",
            "node_id": "IC_kwDOAPphoM5SCFLH",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1376277191/reactions"
            },
            "updated_at": "2023-01-09T20:29:40Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1376277191",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7416158?v=4",
                "events_url": "https://api.github.com/users/craigmac/events{/privacy}",
                "followers_url": "https://api.github.com/users/craigmac/followers",
                "following_url": "https://api.github.com/users/craigmac/following{/other_user}",
                "gists_url": "https://api.github.com/users/craigmac/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/craigmac",
                "id": 7416158,
                "login": "craigmac",
                "node_id": "MDQ6VXNlcjc0MTYxNTg=",
                "organizations_url": "https://api.github.com/users/craigmac/orgs",
                "received_events_url": "https://api.github.com/users/craigmac/received_events",
                "repos_url": "https://api.github.com/users/craigmac/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/craigmac/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/craigmac/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/craigmac"
            }
        },
        {
            "author_association": "NONE",
            "body": "I was having the same problem, with similar code for my lsp config:\r\n\r\n```lua\r\nlocal lspconfig = require('lspconfig')\r\n\r\nlspconfig.lua_ls.setup {\r\n  settings = {\r\n    Lua = {\r\n      runtime = {\r\n        -- Tell the language server which version of Lua you're using\r\n        -- (most likely LuaJIT in the case of Neovim)\r\n        version = 'LuaJIT',\r\n      },\r\n      diagnostics = {\r\n        -- Get the language server to recognize the `vim` global\r\n        globals = {\r\n          'vim',\r\n          'require'\r\n        },\r\n      },\r\n      workspace = {\r\n        -- Make the server aware of Neovim runtime files\r\n        library = vim.api.nvim_get_runtime_file(\"\", true),\r\n      },\r\n      -- Do not send telemetry data containing a randomized but unique identifier\r\n      telemetry = {\r\n        enable = false,\r\n      },\r\n    },\r\n  },\r\n}\r\n```\r\n\r\nSaw this week TJ Devries in youtube, searched for his github account, saw his nvim config, and noticed that he places the init/config/setup lua files for the plugins in the folder nvim/after/plugin.\r\nAfter doing this, I no longer have that lua lsp warning: Undefined global 'vim'.\r\nMaybe now this lsp setup is being properly loaded 'after' all other files in the runtime have been loaded.",
            "created_at": "2023-04-25T21:30:46Z",
            "html_url": "https://github.com/neovim/neovim/issues/21686#issuecomment-1522446128",
            "id": 1522446128,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21686",
            "node_id": "IC_kwDOAPphoM5avq8w",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 10,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 10,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1522446128/reactions"
            },
            "updated_at": "2023-04-25T21:30:46Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1522446128",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/36416376?v=4",
                "events_url": "https://api.github.com/users/gsa9/events{/privacy}",
                "followers_url": "https://api.github.com/users/gsa9/followers",
                "following_url": "https://api.github.com/users/gsa9/following{/other_user}",
                "gists_url": "https://api.github.com/users/gsa9/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/gsa9",
                "id": 36416376,
                "login": "gsa9",
                "node_id": "MDQ6VXNlcjM2NDE2Mzc2",
                "organizations_url": "https://api.github.com/users/gsa9/orgs",
                "received_events_url": "https://api.github.com/users/gsa9/received_events",
                "repos_url": "https://api.github.com/users/gsa9/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/gsa9/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/gsa9/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/gsa9"
            }
        },
        {
            "author_association": "NONE",
            "body": "i had the same Warning with lua_ls in neovim \r\nmy nvim -v\r\nNVIM v0.10.0-dev\r\nBuild type: RelWithDebInfo\r\nLuaJIT 2.1.0-beta3\r\nRun \"nvim -V1 -v\" for more info\r\n![Screenshot from 2023-08-15 23-39-10](https://github.com/neovim/neovim/assets/47267790/f04694ee-ce52-4040-9b8e-51950382b522)\r\n\r\n[](url)\r\n",
            "created_at": "2023-08-15T18:12:44Z",
            "html_url": "https://github.com/neovim/neovim/issues/21686#issuecomment-1679380551",
            "id": 1679380551,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/21686",
            "node_id": "IC_kwDOAPphoM5kGVBH",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1679380551/reactions"
            },
            "updated_at": "2023-08-15T18:35:08Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1679380551",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/47267790?v=4",
                "events_url": "https://api.github.com/users/sureshsaragadam/events{/privacy}",
                "followers_url": "https://api.github.com/users/sureshsaragadam/followers",
                "following_url": "https://api.github.com/users/sureshsaragadam/following{/other_user}",
                "gists_url": "https://api.github.com/users/sureshsaragadam/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/sureshsaragadam",
                "id": 47267790,
                "login": "sureshsaragadam",
                "node_id": "MDQ6VXNlcjQ3MjY3Nzkw",
                "organizations_url": "https://api.github.com/users/sureshsaragadam/orgs",
                "received_events_url": "https://api.github.com/users/sureshsaragadam/received_events",
                "repos_url": "https://api.github.com/users/sureshsaragadam/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/sureshsaragadam/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/sureshsaragadam/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/sureshsaragadam"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/21686/comments",
    "created_at": "2023-01-08T01:59:55Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/21686/events",
    "html_url": "https://github.com/neovim/neovim/issues/21686",
    "id": 1524277038,
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": null,
            "id": 662566370,
            "name": "lsp",
            "node_id": "MDU6TGFiZWw2NjI1NjYzNzA=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/lsp"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/21686/labels{/name}",
    "locked": true,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5a2p8u",
    "number": 21686,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/21686/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "not_planned",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/21686/timeline",
    "title": "LSP: Undefined global \"vim\" when using lua-language-server with custom lua config file",
    "updated_at": "2023-08-15T18:35:20Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/21686",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/7416158?v=4",
        "events_url": "https://api.github.com/users/craigmac/events{/privacy}",
        "followers_url": "https://api.github.com/users/craigmac/followers",
        "following_url": "https://api.github.com/users/craigmac/following{/other_user}",
        "gists_url": "https://api.github.com/users/craigmac/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/craigmac",
        "id": 7416158,
        "login": "craigmac",
        "node_id": "MDQ6VXNlcjc0MTYxNTg=",
        "organizations_url": "https://api.github.com/users/craigmac/orgs",
        "received_events_url": "https://api.github.com/users/craigmac/received_events",
        "repos_url": "https://api.github.com/users/craigmac/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/craigmac/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/craigmac/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/craigmac"
    }
}