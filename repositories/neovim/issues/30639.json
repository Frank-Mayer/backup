{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\n`screenpos()` _sometimes_ returns all zeros; ie:\n\n```lua\n{\n  col = 0,\n  curscol = 0,\n  endcol = 0,\n  row = 0\n}\n```\n\ninstead of the actual screen coordinates, causing plug-ins like [nvim-cmp](https://github.com/hrsh7th/nvim-cmp) to draw their autocomplete pop-up menu in the top-left of the screen instead of at the cursor location:\n\n![autocomplete menu appearing in the wrong place](https://github.com/user-attachments/assets/de1f16ee-88ab-4065-9ba1-acc2d0ffcfbc)\n\nThis was originally reported in:\n\n- https://github.com/neovim/neovim/issues/19606\n\nbut without a consistent repro. I've been seeing this happen intermittently for years and have never been able to find a reliable repro recipe, until now.\n\n### Steps to reproduce\n\nThis one is incredibly sensitive to initial conditions (screen size, font size, path lengths), and rather fiddly to reproduce. Nevertheless, I've found that I can trigger the bug from a clean Neovim install by interacting with the [vim-dirvish](https://github.com/justinmk/vim-dirvish) plug-in and following a very precise set of steps. (I don't think this is a bug with vim-dirvish or with nvim-cmp, but they are useful to illustrate the bug.)\n\n1. Size your terminal window such that it is 137 columns wide. Verify this with:\n   ```\n   tput cols\n   ```\n2. Create a new scratch directory in which to reproduce the bug:\n   ```\n   mkdir /tmp/scratch\n   ```\n   Note that the name of the path matters here because the path must be of a certain length to trigger the bug.\n3. Change into the scratch directory:\n   ```\n   cd /tmp/scratch\n   ```\n4. Create directories in which to put the repro files:\n   ```\n   mkdir -p aspects/nvim/files/.config/nvim/plugin/mappings\n   ```\n   There's nothing special about the _contents_ of this path (this is just a path from the project I was in when I discovered how to repro the bug) but the _length_ of the path does matter.\n5. Create repro files (again, contents don't matter, so `touch` will suffice and, again, the names are just take from the project I was in and its the length that matters):\n   ```\n   touch aspects/nvim/files/.config/nvim/plugin/mappings/normal.lua\n   touch aspects/nvim/files/.config/nvim/plugin/mappings/visual.lua\n   ```\n6. Grab a copy of vim-dirvish:\n   ```\n   mkdir -p pack/bundle/opt\n   git clone https://github.com/justinmk/vim-dirvish.git pack/bundle/opt/vim-dirvish\n   ```\n7. Launch Neovim with no config:\n   ```\n   nvim -u NONE\n   ```\n8. Load vim-dirvish:\n   ```\n   set packpath=.\n   packadd vim-dirvish\n   packloadall\n   ```\n9. Create a mapping so that you can inspect the result of `screenpos()` (this one taken from #19606):\n   ```\n   :nmap <c-s> :lua print(vim.inspect(vim.fn.screenpos(0, vim.api.nvim_win_get_cursor(0)[1], vim.api.nvim_win_get_cursor(0)[2]+1)))<cr>\n   ```\n10. Open the first of the repro files:\n    ```\n    :e aspects/nvim/files/.config/nvim/plugin/mappings/normal.lua\n    ```\n11. Create a vertical split:\n    ```\n    :vs\n    ```\n12. Move focus to window on right side of the split:\n    ```\n    <C-w l>\n    ```\n13. Invoke vim-dirvish to show the contents of the containing directory:\n    ```\n    :Dirvish\n    ```\n14. Hit `j` to move down to the sibling file (`visual.lua`).\n15. Hit `Enter` to open the file.\n16. Hit the `<C-s>` binding you created previously to display the `screenpos()` result; note that it's all zeros:\n    ```\n    {\n      col = 0,\n      curscol = 0,\n      endcol = 0,\n      row = 0\n    }\n    ```\n\nAdditional notes:\n\n- This repros both inside tmux (`TERM=tmux-256color`) and outside (`TERM=xterm-kitty`).\n- It also appears to affect the Vim (tested using `-u DEFAULTS` on version 9.1 from Homebrew and 9.0, as provided by Apple with the OS)[^vim].\n- As I mentioned above, this whole thing is very sensitive to path lengths and cursor position:\n  - In the vim-dirvish listing, move the cursor to the end (`$`) before opening the second file, and the bug repros.\n  - Move it to the beginning (`^`) before opening the second file, and it does not repro.\n- In common with the original report (#19606), after you've seen the bug, running `:set wrap` (even if it was already set) temporarily fixes the problem and hitting the `<C-s>` mapping shows that `screenpos()` will return sensible results again.\n- Font size matters, because it affects the number of characters that appear before the line is too wide to show on the screen. For example, if I make my font small enough so that everything fits, this no longer repros. For reference, this screenshot shows my font size when reproing the issue: ![font size reference](https://github.com/user-attachments/assets/0dc0041f-3add-403c-8a37-621323f73613)\n\n[^vim]: I posted this here first because Neovim is my daily driver, but I will also report upstream.\n\n### Expected behavior\n\n`screenpos()` should return real screen coordinates, like:\n\n```\n{\n  col = 70,\n  curscol = 70,\n  endcol = 70,\n  row = 1\n}\n```\n\n### Nvim version (nvim -v)\n\n- NVIM v0.10.1\n- NVIM v0.10.2\n\n### Vim (not Nvim) behaves the same?\n\nyes, 9.1\n\n### Operating system/version\n\nmacOS 14.7\n\n### Terminal name/version\n\nkitty 0.36.4\n\n### $TERM environment variable\n\ntmux-256color\n\n### Installation\n\nHomebrew",
    "closed_at": "2024-10-05T22:49:24Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/35768171?v=4",
        "events_url": "https://api.github.com/users/zeertzjq/events{/privacy}",
        "followers_url": "https://api.github.com/users/zeertzjq/followers",
        "following_url": "https://api.github.com/users/zeertzjq/following{/other_user}",
        "gists_url": "https://api.github.com/users/zeertzjq/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/zeertzjq",
        "id": 35768171,
        "login": "zeertzjq",
        "node_id": "MDQ6VXNlcjM1NzY4MTcx",
        "organizations_url": "https://api.github.com/users/zeertzjq/orgs",
        "received_events_url": "https://api.github.com/users/zeertzjq/received_events",
        "repos_url": "https://api.github.com/users/zeertzjq/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/zeertzjq/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zeertzjq/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/zeertzjq"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Great report, thanks! Since you mentioned Dirvish I was going to suggest disabling conceal (`set conceallevel=0`) to see if that changes the behavior, but your screenshot looks like it already did?\r\n\r\nAlso try clearing syntax in the dirvish buffer: `:syn clear`",
            "created_at": "2024-10-03T20:38:39Z",
            "html_url": "https://github.com/neovim/neovim/issues/30639#issuecomment-2392290518",
            "id": 2392290518,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/30639",
            "node_id": "IC_kwDOAPphoM6Ol3TW",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2392290518/reactions"
            },
            "updated_at": "2024-10-03T20:38:39Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2392290518",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk"
            }
        },
        {
            "author_association": "NONE",
            "body": "> Great report, thanks! Since you mentioned Dirvish I was going to suggest disabling conceal (`set conceallevel=0`) to see if that changes the behavior, but your screenshot looks like it already did?\n> \n> Also try clearing syntax in the dirvish buffer: `:syn clear`\n\nNo, I haven't touched `conceallevel`; it's `0` by default, and `2` in the vim-dirvish buffer. If I set it back to `0` in the vim-dirvish buffer, the bug still manifests. Likewise, it still manifests after a `:syn clear`.\n\nTrying it out just now I found I can simplify the repro a little:\n\n- I found that the vertical split isn't needed to repro the bug; the only thing that does is narrow the window enough to make the bug happen. So, if I shrink my terminal window (to 68 columns, as reported by `tput cols`), the bug reproduced without needing a split.\n- Likewise, I don't need to actually swap between two files. I can just open vim-dirvish with `:Dirvish`, then hit `<CR>` to open the same file, and the bug repros.\n\nSo, it's all about width, and it only happens when `:set wrap?` reports `wrap`.\n\nMeanwhile, there's a potential suggested fix over here:\n\n- https://github.com/vim/vim/issues/15792#issuecomment-2392387779\n\n> Hm, `w_leftcol` hasn't been updated yet and has still the old value. This patch fixes it:\n> \n> ```\n> diff --git a/src/move.c b/src/move.c\n> index f2780e584..b6623e8a0 100644\n> --- a/src/move.c\n> +++ b/src/move.c\n> @@ -1494,7 +1494,8 @@ textpos2screenpos(\n>                 col -= rowoff * width;\n>                 row += rowoff;\n>             }\n> -           col -= wp->w_leftcol;\n> +           if (col > (int)wp->w_leftcol)\n> +               col -= wp->w_leftcol;\n>             if (col >= wp->w_width)\n>                 col = -1;\n>             if (col >= 0 && row >= 0 && row < wp->w_height)\n> ```\n>\n> As the comment a few lines above states, it should behave similar to `validate_cursor_col()` which is what this patch does.\n\nI tried a similar patch against current `master`:\n\n```diff\ndiff --git a/src/nvim/move.c b/src/nvim/move.c\nindex 6324466dc..0c2c59f78 100644\n--- a/src/nvim/move.c\n+++ b/src/nvim/move.c\n@@ -1080,7 +1080,9 @@ void textpos2screenpos(win_T *wp, pos_T *pos, int *rowp, int *scolp, int *ccolp,\n         row += rowoff;\n       }\n \n-      col -= wp->w_leftcol;\n+      if (col > (int)wp->w_leftcol) {\n+        col -= wp->w_leftcol;\n+      }\n \n       if (col >= 0 && col < wp->w_width_inner && row >= 0 && row < wp->w_height_inner) {\n         coloff = col - scol + (local ? 0 : wp->w_wincol + wp->w_wincol_off) + 1;\n```\n\nand it does seem to fix the bug.\n\nI note that `move.c` (and `textpos2screenpos()`) has diverged a bit between Vim and Neovim at this point, so not sure if there's anything else to take into consideration.",
            "created_at": "2024-10-04T10:05:19Z",
            "html_url": "https://github.com/neovim/neovim/issues/30639#issuecomment-2393338439",
            "id": 2393338439,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/30639",
            "node_id": "IC_kwDOAPphoM6Op3JH",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2393338439/reactions"
            },
            "updated_at": "2024-10-04T10:05:19Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2393338439",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7074?v=4",
                "events_url": "https://api.github.com/users/wincent/events{/privacy}",
                "followers_url": "https://api.github.com/users/wincent/followers",
                "following_url": "https://api.github.com/users/wincent/following{/other_user}",
                "gists_url": "https://api.github.com/users/wincent/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/wincent",
                "id": 7074,
                "login": "wincent",
                "node_id": "MDQ6VXNlcjcwNzQ=",
                "organizations_url": "https://api.github.com/users/wincent/orgs",
                "received_events_url": "https://api.github.com/users/wincent/received_events",
                "repos_url": "https://api.github.com/users/wincent/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/wincent/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/wincent/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/wincent"
            }
        },
        {
            "author_association": "NONE",
            "body": "Sent a PR with the suggested fix:\n\n- https://github.com/neovim/neovim/pull/30653\n\nNot sure how to write a test for this though.",
            "created_at": "2024-10-04T10:16:05Z",
            "html_url": "https://github.com/neovim/neovim/issues/30639#issuecomment-2393357102",
            "id": 2393357102,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/30639",
            "node_id": "IC_kwDOAPphoM6Op7su",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2393357102/reactions"
            },
            "updated_at": "2024-10-04T10:16:05Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/2393357102",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7074?v=4",
                "events_url": "https://api.github.com/users/wincent/events{/privacy}",
                "followers_url": "https://api.github.com/users/wincent/followers",
                "following_url": "https://api.github.com/users/wincent/following{/other_user}",
                "gists_url": "https://api.github.com/users/wincent/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/wincent",
                "id": 7074,
                "login": "wincent",
                "node_id": "MDQ6VXNlcjcwNzQ=",
                "organizations_url": "https://api.github.com/users/wincent/orgs",
                "received_events_url": "https://api.github.com/users/wincent/received_events",
                "repos_url": "https://api.github.com/users/wincent/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/wincent/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/wincent/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/wincent"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/30639/comments",
    "created_at": "2024-10-03T12:36:46Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/30639/events",
    "html_url": "https://github.com/neovim/neovim/issues/30639",
    "id": 2563949106,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "F9D0C4",
            "default": false,
            "description": "wrong behavior inherited from vim",
            "id": 154310492,
            "name": "bug-vim",
            "node_id": "MDU6TGFiZWwxNTQzMTA0OTI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-vim"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/30639/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 3,
        "created_at": "2024-09-30T11:50:04Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
            "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
            "followers_url": "https://api.github.com/users/justinmk/followers",
            "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
            "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/justinmk",
            "id": 1359421,
            "login": "justinmk",
            "node_id": "MDQ6VXNlcjEzNTk0MjE=",
            "organizations_url": "https://api.github.com/users/justinmk/orgs",
            "received_events_url": "https://api.github.com/users/justinmk/received_events",
            "repos_url": "https://api.github.com/users/justinmk/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/justinmk"
        },
        "description": "",
        "due_on": null,
        "html_url": "https://github.com/neovim/neovim/milestone/45",
        "id": 11652398,
        "labels_url": "https://api.github.com/repos/neovim/neovim/milestones/45/labels",
        "node_id": "MI_kwDOAPphoM4Asc0u",
        "number": 45,
        "open_issues": 5,
        "state": "open",
        "title": "0.10.3",
        "updated_at": "2024-10-07T23:22:09Z",
        "url": "https://api.github.com/repos/neovim/neovim/milestones/45"
    },
    "node_id": "I_kwDOAPphoM6Y0sIy",
    "number": 30639,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/30639/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/30639/timeline",
    "title": "`screenpos()` returns all zeros under specific circumstances",
    "updated_at": "2024-10-06T08:28:07Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/30639",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/7074?v=4",
        "events_url": "https://api.github.com/users/wincent/events{/privacy}",
        "followers_url": "https://api.github.com/users/wincent/followers",
        "following_url": "https://api.github.com/users/wincent/following{/other_user}",
        "gists_url": "https://api.github.com/users/wincent/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/wincent",
        "id": 7074,
        "login": "wincent",
        "node_id": "MDQ6VXNlcjcwNzQ=",
        "organizations_url": "https://api.github.com/users/wincent/orgs",
        "received_events_url": "https://api.github.com/users/wincent/received_events",
        "repos_url": "https://api.github.com/users/wincent/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/wincent/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/wincent/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/wincent"
    }
}