{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nIf you use `tsnode:tree()` and then start editing the file, after a while, neovim will crash, with exit code 134 or 139.\r\n\n\n### Steps to reproduce\n\n```\r\nnvim --clean\r\nifoo<esc>\r\n:lua vim.treesitter.start(0,'lua')\r\n:lua vim.treesitter.get_node():tree()\r\nofoobarbazfoobarbazfoobarbazfoobarbazfoobarbazfoobarbaz\r\n```\n\n### Expected behavior\n\nneovim not crashing\n\n### Neovim version (nvim -v)\n\nv0.10.0-dev-f0e6e2a\n\n### Vim (not Nvim) behaves the same?\n\nN/A\n\n### Operating system/version\n\nlinux 6.4.10-arch1-1\n\n### Terminal name/version\n\nalacritty\n\n### $TERM environment variable\n\nalacritty\n\n### Installation\n\nbuild from repo",
    "closed_at": "2023-08-29T08:48:25Z",
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "minimal lua to crash nvim  \r\n```lua\r\nvim.api.nvim_buf_set_lines(0, 0, 0, false, { 'F' })\r\nvim.treesitter.start(0, 'lua')\r\nvim.treesitter.get_node():tree()\r\nvim.treesitter.get_node():tree()\r\ncollectgarbage()\r\n```\r\nIt seems that `push_tree` called from `node_tree` creates a new userdata for a C object that already belongs to some userdata, and lua will call __gc metamethod for every userdata, when it garbage collects it, so underlying C object is gonna get freed multiple times.  \r\nhttps://github.com/neovim/neovim/blob/f0e6e2ae463aa5f9c5e64e6fe01c1bab82131933/src/nvim/lua/treesitter.c#L1317-L1327\r\n\r\nquick fix is to just change `push_tree`'s `do_copy` argument to `true`:\r\n```diff\r\ndiff --git a/src/nvim/lua/treesitter.c b/src/nvim/lua/treesitter.c\r\nindex 1e559316d..23cda780f 100644\r\n--- a/src/nvim/lua/treesitter.c\r\n+++ b/src/nvim/lua/treesitter.c\r\n@@ -1321,7 +1321,7 @@ static int node_tree(lua_State *L)\r\n     return 0;\r\n   }\r\n \r\n-  push_tree(L, (TSTree *)node.tree, false);\r\n+  push_tree(L, (TSTree *)node.tree, true);\r\n   return 1;\r\n }\r\n \r\n```",
            "created_at": "2023-08-18T16:37:56Z",
            "html_url": "https://github.com/neovim/neovim/issues/24783#issuecomment-1684167458",
            "id": 1684167458,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/24783",
            "node_id": "IC_kwDOAPphoM5kYlsi",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1684167458/reactions"
            },
            "updated_at": "2023-08-18T16:37:56Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1684167458",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/105592020?v=4",
                "events_url": "https://api.github.com/users/nwounkn/events{/privacy}",
                "followers_url": "https://api.github.com/users/nwounkn/followers",
                "following_url": "https://api.github.com/users/nwounkn/following{/other_user}",
                "gists_url": "https://api.github.com/users/nwounkn/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/nwounkn",
                "id": 105592020,
                "login": "nwounkn",
                "node_id": "U_kgDOBks01A",
                "organizations_url": "https://api.github.com/users/nwounkn/orgs",
                "received_events_url": "https://api.github.com/users/nwounkn/received_events",
                "repos_url": "https://api.github.com/users/nwounkn/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/nwounkn/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/nwounkn/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/nwounkn"
            }
        },
        {
            "author_association": "NONE",
            "body": "yeah, i have been having crash a lot and have been  managing it, but not sure if it is the exact same issue, i dont have neovim or C experience to debug. i have remove most of my plugin and readded them back but could not find the root, but see your post, i will disabled TS and see.\r\n\r\nfor me it occures very oftern\r\n![image](https://github.com/neovim/neovim/assets/32944188/c06c5a02-d5f7-42f6-b081-6cbaba78a9eb)\r\n\r\nThis is my latest coredump, not sure if it will be of help to anyone\r\n[core.nvim.1000.57765eeb4a9244f3925e2ba2c8bfd2a3.9603.zip](https://github.com/neovim/neovim/files/12384513/core.nvim.1000.57765eeb4a9244f3925e2ba2c8bfd2a3.9603.zip)\r\n",
            "created_at": "2023-08-19T00:02:05Z",
            "html_url": "https://github.com/neovim/neovim/issues/24783#issuecomment-1684561451",
            "id": 1684561451,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/24783",
            "node_id": "IC_kwDOAPphoM5kaF4r",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1684561451/reactions"
            },
            "updated_at": "2023-08-19T00:02:05Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1684561451",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/32944188?v=4",
                "events_url": "https://api.github.com/users/talk2drys/events{/privacy}",
                "followers_url": "https://api.github.com/users/talk2drys/followers",
                "following_url": "https://api.github.com/users/talk2drys/following{/other_user}",
                "gists_url": "https://api.github.com/users/talk2drys/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/talk2drys",
                "id": 32944188,
                "login": "talk2drys",
                "node_id": "MDQ6VXNlcjMyOTQ0MTg4",
                "organizations_url": "https://api.github.com/users/talk2drys/orgs",
                "received_events_url": "https://api.github.com/users/talk2drys/received_events",
                "repos_url": "https://api.github.com/users/talk2drys/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/talk2drys/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/talk2drys/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/talk2drys"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/24783/comments",
    "created_at": "2023-08-18T13:26:04Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/24783/events",
    "html_url": "https://github.com/neovim/neovim/issues/24783",
    "id": 1856725052,
    "labels": [
        {
            "color": "F9D0C4",
            "default": false,
            "description": "issue reporting a crash or segfault",
            "id": 435854234,
            "name": "bug-crash",
            "node_id": "MDU6TGFiZWw0MzU4NTQyMzQ=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-crash"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 1799626557,
            "name": "treesitter",
            "node_id": "MDU6TGFiZWwxNzk5NjI2NTU3",
            "url": "https://api.github.com/repos/neovim/neovim/labels/treesitter"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/24783/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5uq2A8",
    "number": 24783,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 1,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 1,
        "url": "https://api.github.com/repos/neovim/neovim/issues/24783/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/24783/timeline",
    "title": "crash(nightly) when using `TSNode:tree()` ",
    "updated_at": "2023-08-29T08:48:25Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/24783",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/107814000?v=4",
        "events_url": "https://api.github.com/users/altermo/events{/privacy}",
        "followers_url": "https://api.github.com/users/altermo/followers",
        "following_url": "https://api.github.com/users/altermo/following{/other_user}",
        "gists_url": "https://api.github.com/users/altermo/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/altermo",
        "id": 107814000,
        "login": "altermo",
        "node_id": "U_kgDOBm0ccA",
        "organizations_url": "https://api.github.com/users/altermo/orgs",
        "received_events_url": "https://api.github.com/users/altermo/received_events",
        "repos_url": "https://api.github.com/users/altermo/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/altermo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/altermo/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/altermo"
    }
}