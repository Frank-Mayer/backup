{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\n\n`vim.fn.complete_info` returns incorrect index programmatically, preventing plugins like `nvim-cmp` from being able to work with native `pumenu` properly. There is some subtle change in behavior depending at least on if `completopt` includes `noselect`.\r\n\r\nSee hrsh7th/nvim-cmp#1326 for more context on how this bug was discovered\n\n### Steps to reproduce\n\n- Save this file as `neovim_complete_info_vimrc`\r\n  ```vim\r\n  set completeopt=menu,preview\r\n  nmap \\\\ iaaa<CR>bbb<CR>ccc<CR>ddd<CR>eee<CR>fff<CR>\r\n  imap , <cmd>put =execute('lua print(vim.fn.complete_info({''selected''}).selected)')<CR>\r\n  ```\r\n- `vim --clean -u neovim_complete_info_vimrc`\r\n- normal mode `\\\\`, which is nmapped to give\r\n  ```\r\n  aaa\r\n  bbb\r\n  ccc\r\n  ddd\r\n  eee\r\n  fff\r\n  ```\r\n  and will put you in insert mode on a newline\r\n- insert mode `<C-X><C-L>` to open lines `pumenu`\r\n      - with default `completeopt=menu,preview` will select \"fff\"\r\n- insert mode `<C-P>`, to navigate up the list once\r\n      - selecting \"eee\"\r\n- insert mode `,,,,`, imapped to `put` into the buffer the value of `complete_info` index\r\n      - The `,` was hit multiple times so that the `complete_info` index isn't hidden behind the `pumenu` and you can see the value of the index\r\n\r\n**BUG: The inserted index value is `1` when it should be `4`**\r\n\r\nThe bug behavior is that index counts from the bottom instead of from the top. On it's own, this would be behavior that could be worked around. However, the actual index behavior depends on `completeopt` value. \r\n- `completeopt=menu,preview`\r\n      - behavior describe above\r\n- if `completeopt=menu,preview,noselect`, then the indexing shows 2 divergent behaviors\r\n      - navigate `pumenu` with `<C-N>` first --> you get the expected index\r\n      - navigate `pumenu` with `<C-P>` first --> you get the reversed index (counting from bottom instead of top), acting like the `menu,preview` case\n\n### Expected behavior\n\nHitting `,` should insert `4` from it's call to `vim.fn.complete_info({'selected'}).selected`\r\n\r\n\n\n### Neovim version (nvim -v)\n\nNVIM v0.8.3 Build type: Release LuaJIT 2.1.0-beta3 Compiled by builduser  Features: +acl +iconv +tui\n\n### Vim (not Nvim) behaves the same?\n\nyes, requires a modified non-Lua vimrc. Will provide vimrc below\n\n### Operating system/version\n\nArch LInux, via WSL2 on Win11\n\n### Terminal name/version\n\nWindows Terminal\n\n### $TERM environment variable\n\nxterm-256color\n\n### Installation\n\nsystem package manager (pacman)",
    "closed_at": "2023-10-12T00:21:03Z",
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "Config to repro with vim instead of neovim\r\n\r\n```vim\r\nset completeopt=menu,preview\r\nset cpoptions-=<\r\nnmap \\\\ iaaa<CR>bbb<CR>ccc<CR>ddd<CR>eee<CR>fff<CR>\r\nimap , <Cmd>put =complete_info(['selected'])['selected']<CR>\r\n```\r\n\r\n<details>\r\n<summary>VIM - Vi IMproved 9.0 (2022 Jun 28, compiled Mar 21 2023 20:51:42) [expand to see full version info]</summary>\r\n\r\n```\r\nVIM - Vi IMproved 9.0 (2022 Jun 28, compiled Mar 21 2023 20:51:42)\r\nIncluded patches: 1-1420\r\nCompiled by Arch Linux\r\nHuge version without GUI.  Features included (+) or not (-):\r\n+acl               +file_in_path      +mouse_urxvt       -tag_any_white\r\n+arabic            +find_in_path      +mouse_xterm       +tcl/dyn\r\n+autocmd           +float             +multi_byte        +termguicolors\r\n+autochdir         +folding           +multi_lang        +terminal\r\n-autoservername    -footer            -mzscheme          +terminfo\r\n-balloon_eval      +fork()            +netbeans_intg     +termresponse\r\n+balloon_eval_term +gettext           +num64             +textobjects\r\n-browse            -hangul_input      +packages          +textprop\r\n++builtin_terms    +iconv             +path_extra        +timers\r\n+byte_offset       +insert_expand     +perl/dyn          +title\r\n+channel           +ipv6              +persistent_undo   -toolbar\r\n+cindent           +job               +popupwin          +user_commands\r\n-clientserver      +jumplist          +postscript        +vartabs\r\n-clipboard         +keymap            +printer           +vertsplit\r\n+cmdline_compl     +lambda            +profile           +vim9script\r\n+cmdline_hist      +langmap           -python            +viminfo\r\n+cmdline_info      +libcall           +python3/dyn       +virtualedit\r\n+comments          +linebreak         +quickfix          +visual\r\n+conceal           +lispindent        +reltime           +visualextra\r\n+cryptv            +listcmds          +rightleft         +vreplace\r\n+cscope            +localmap          +ruby/dyn          +wildignore\r\n+cursorbind        +lua/dyn           +scrollbind        +wildmenu\r\n+cursorshape       +menu              +signs             +windows\r\n+dialog_con        +mksession         +smartindent       +writebackup\r\n+diff              +modify_fname      -sodium            -X11\r\n+digraphs          +mouse             -sound             -xfontset\r\n-dnd               -mouseshape        +spell             -xim\r\n-ebcdic            +mouse_dec         +startuptime       -xpm\r\n+emacs_tags        +mouse_gpm         +statusline        -xsmp\r\n+eval              -mouse_jsbterm     -sun_workshop      -xterm_clipboard\r\n+ex_extra          +mouse_netterm     +syntax            -xterm_save\r\n+extra_search      +mouse_sgr         +tag_binary\r\n-farsi             -mouse_sysmouse    -tag_old_static\r\n   system vimrc file: \"/etc/vimrc\"\r\n     user vimrc file: \"$HOME/.vimrc\"\r\n 2nd user vimrc file: \"~/.vim/vimrc\"\r\n      user exrc file: \"$HOME/.exrc\"\r\n       defaults file: \"$VIMRUNTIME/defaults.vim\"\r\n  fall-back for $VIM: \"/usr/share/vim\"\r\nCompilation: gcc -c -I. -Iproto -DHAVE_CONFIG_H -march=x86-64 -mtune=generic -O2 -pipe -fno-plt -fexceptions -Wformat -Werror=format-security -fstack-clash-protection -fcf-protection -g -ffile-prefix-map=/build/vim/src=/usr/src/debug/vim -flto=auto -D_REENTRANT -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=1\r\nLinking: gcc -Wl,-E -Wl,-rpath,/usr/lib/perl5/5.36/core_perl/CORE -Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now -flto=auto -L/usr/local/lib -o vim -lm -ltinfo -lelf -lacl -lattr -lgpm -Wl,-E -Wl,-rpath,/usr/lib/perl5/5.36/core_perl/CORE -Wl,-O1,--sort-common,--as-needed,-z,relro,-z,now -flto=auto -fstack-protector-strong -L/usr/local/lib -L/usr/lib/perl5/5.36/core_perl/CORE -lperl -lpthread -ldl -lm -lcrypt -lutil -lc -L/usr/lib -ltclstub8.6 -ldl -lz -lpthread -lm\r\n```\r\n</details>",
            "created_at": "2023-04-05T07:09:22Z",
            "html_url": "https://github.com/neovim/neovim/issues/22892#issuecomment-1497021664",
            "id": 1497021664,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/22892",
            "node_id": "IC_kwDOAPphoM5ZOrzg",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1497021664/reactions"
            },
            "updated_at": "2023-04-05T07:09:22Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1497021664",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/107967151?v=4",
                "events_url": "https://api.github.com/users/d-r-a-b/events{/privacy}",
                "followers_url": "https://api.github.com/users/d-r-a-b/followers",
                "following_url": "https://api.github.com/users/d-r-a-b/following{/other_user}",
                "gists_url": "https://api.github.com/users/d-r-a-b/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/d-r-a-b",
                "id": 107967151,
                "login": "d-r-a-b",
                "node_id": "U_kgDOBm9yrw",
                "organizations_url": "https://api.github.com/users/d-r-a-b/orgs",
                "received_events_url": "https://api.github.com/users/d-r-a-b/received_events",
                "repos_url": "https://api.github.com/users/d-r-a-b/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/d-r-a-b/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/d-r-a-b/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/d-r-a-b"
            }
        },
        {
            "author_association": "NONE",
            "body": "Is there coordination between the vim and neovim projects with respect to issue tracking? Seeing the label `needs:vim-patch` makes me think I should file an issue with `vim/vim` but I also don't want to create unnecessary issue spam if `vim/vim` contributors already look at `needs:vim-patch`.\r\n\r\nFrom the perspective of the `neovim/neovim` developers, should I file a new issue in `vim/vim` for this?",
            "created_at": "2023-04-05T20:35:32Z",
            "html_url": "https://github.com/neovim/neovim/issues/22892#issuecomment-1498119559",
            "id": 1498119559,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/22892",
            "node_id": "IC_kwDOAPphoM5ZS32H",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1498119559/reactions"
            },
            "updated_at": "2023-04-05T20:35:32Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1498119559",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/107967151?v=4",
                "events_url": "https://api.github.com/users/d-r-a-b/events{/privacy}",
                "followers_url": "https://api.github.com/users/d-r-a-b/followers",
                "following_url": "https://api.github.com/users/d-r-a-b/following{/other_user}",
                "gists_url": "https://api.github.com/users/d-r-a-b/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/d-r-a-b",
                "id": 107967151,
                "login": "d-r-a-b",
                "node_id": "U_kgDOBm9yrw",
                "organizations_url": "https://api.github.com/users/d-r-a-b/orgs",
                "received_events_url": "https://api.github.com/users/d-r-a-b/received_events",
                "repos_url": "https://api.github.com/users/d-r-a-b/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/d-r-a-b/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/d-r-a-b/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/d-r-a-b"
            }
        },
        {
            "author_association": "MEMBER",
            "body": ">  vim/vim contributors already look at needs:vim-patch.\r\n\r\nThey do not. If you can reproduce this with Vim, opening an issue there would be appreciated.",
            "created_at": "2023-04-05T20:57:31Z",
            "html_url": "https://github.com/neovim/neovim/issues/22892#issuecomment-1498146350",
            "id": 1498146350,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/22892",
            "node_id": "IC_kwDOAPphoM5ZS-Yu",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1498146350/reactions"
            },
            "updated_at": "2023-04-05T20:57:31Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1498146350",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/22892/comments",
    "created_at": "2023-04-05T07:05:40Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/22892/events",
    "html_url": "https://github.com/neovim/neovim/issues/22892",
    "id": 1655058701,
    "labels": [
        {
            "color": "0E8A16",
            "default": false,
            "description": "issue is fixed in vim and patch needs to be ported",
            "id": 152276149,
            "name": "has:vim-patch",
            "node_id": "MDU6TGFiZWwxNTIyNzYxNDk=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/has:vim-patch"
        },
        {
            "color": "F9D0C4",
            "default": false,
            "description": "wrong behavior inherited from vim",
            "id": 154310492,
            "name": "bug-vim",
            "node_id": "MDU6TGFiZWwxNTQzMTA0OTI=",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug-vim"
        },
        {
            "color": "C5DEF5",
            "default": false,
            "description": "Nvim built-in (omni)completion",
            "id": 3214348835,
            "name": "completion",
            "node_id": "MDU6TGFiZWwzMjE0MzQ4ODM1",
            "url": "https://api.github.com/repos/neovim/neovim/labels/completion"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/22892/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM5ipjEN",
    "number": 22892,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/22892/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/22892/timeline",
    "title": "`complete_info()` returns incorrect index with behavior that depends on `completeopt`",
    "updated_at": "2023-10-12T00:21:03Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/22892",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/107967151?v=4",
        "events_url": "https://api.github.com/users/d-r-a-b/events{/privacy}",
        "followers_url": "https://api.github.com/users/d-r-a-b/followers",
        "following_url": "https://api.github.com/users/d-r-a-b/following{/other_user}",
        "gists_url": "https://api.github.com/users/d-r-a-b/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/d-r-a-b",
        "id": 107967151,
        "login": "d-r-a-b",
        "node_id": "U_kgDOBm9yrw",
        "organizations_url": "https://api.github.com/users/d-r-a-b/orgs",
        "received_events_url": "https://api.github.com/users/d-r-a-b/received_events",
        "repos_url": "https://api.github.com/users/d-r-a-b/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/d-r-a-b/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/d-r-a-b/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/d-r-a-b"
    }
}