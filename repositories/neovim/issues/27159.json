{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Problem\r\n\r\ncalling `:lua vim.treesitter.inspect_tree()` with neovim `0.9.5` on the rust code below produces a parse error inside the `macro_invocation` node of the document CST.\r\n\r\n#### `lib.rs`:\r\n```rust\r\nfn main() {\r\n    println!(\"ok\");\r\n}\r\n```\r\n\r\n\r\n---\r\n\r\nneovim `0.9.5` `vim.treesitter.inspect_tree()` output:\r\n\r\n```scm\r\n(function_item) ; [1:1 - 3:1]\r\n name: (identifier) ; [1:4 - 7]\r\n parameters: (parameters) ; [1:8 - 9]\r\n body: (block) ; [1:11 - 3:1]\r\n  (expression_statement) ; [2:5 - 19]\r\n   (macro_invocation) ; [2:5 - 18]\r\n    macro: (identifier) ; [2:5 - 11]\r\n    (token_tree) ; [2:13 - 18]\r\n     (ERROR) ; [2:13 - 18]\r\n      (unit_expression) ; [2:13 - 18]\r\n     (string_literal) ; [2:14 - 17]\r\n```\r\n\r\n---\r\n\r\nhttps://github.com/neovim/neovim/blob/8744ee8783a8597f9fce4a573ae05aca2f412120/cmake.deps/CMakeLists.txt#L199\r\nUsing the same version of tree-sitter that was built with neovim `0.9.5` produces a valid CST:\r\n```\r\n$ tree-sitter --version\r\ntree-sitter 0.20.8\r\n```\r\n`tree-sitter parse ./lib.rs` output:\r\n```scm\r\n(source_file [0, 0] - [3, 0]\r\n  (function_item [0, 0] - [2, 1]\r\n    name: (identifier [0, 3] - [0, 7])\r\n    parameters: (parameters [0, 7] - [0, 9])\r\n    body: (block [0, 10] - [2, 1]\r\n      (expression_statement [1, 4] - [1, 19]\r\n        (macro_invocation [1, 4] - [1, 18]\r\n          macro: (identifier [1, 4] - [1, 11])\r\n          (token_tree [1, 12] - [1, 18]\r\n            (string_literal [1, 13] - [1, 17])))))))\r\n```\r\n\r\n---\r\n\r\n* The parse error is reproducible with neovim `0.9` onward\r\n* Said error manifests in both `:lua vim.treesitter.inspect_tree()`  and `:TSPlayground`\r\n* neovim `0.8.3` produces a fully valid CST of the rust code above (using the same `minimal.lua`).\r\n\r\nrelated issue: https://github.com/nvim-treesitter/nvim-treesitter/issues/5958\r\n\r\n---\r\n\r\n### Steps to reproduce\r\n\r\n#### `minimal.lua`:\r\n```lua\r\nfor name, url in pairs{\r\n  nvim_treesitter = \"https://github.com/nvim-treesitter/nvim-treesitter\",\r\n  playground = \"https://github.com/nvim-treesitter/playground\"\r\n} do\r\n  local install_path = vim.fn.fnamemodify('nvim_issue/'..name, ':p')\r\n  if vim.fn.isdirectory(install_path) == 0 then\r\n    vim.fn.system { 'git', 'clone', '--depth=1', url, install_path }\r\n  end\r\n  vim.opt.runtimepath:append(install_path)\r\nend\r\n```\r\n\r\n1. `nvim --clean -u minimal.lua`\r\n2. `:TSInstall rust`\r\n3.  `:edit ./lib.rs`\r\n4. `:lua vim.treesitter.inspect_tree()` (or `:TSPlayground` for neovim `0.8.3`)\r\n\r\n\r\n### Expected behavior\r\n\r\nThe expected behaviour can be found by calling `:TSPlayground` with neovim `0.8.3`:\r\n\r\n```\r\n$ nvim_0.8.3/nvim --version\r\n\r\nNVIM v0.8.3\r\nBuild type: Release\r\nLuaJIT 2.1.0-beta3\r\nCompiled by runner@Mac-1675344370646.local\r\n\r\nFeatures: +acl +iconv +tui\r\nSee \":help feature-compile\"\r\n\r\n   system vimrc file: \"$VIM/sysinit.vim\"\r\n  fall-back for $VIM: \"/share/nvim\"\r\n\r\nRun :checkhealth for more info\r\n```\r\n\r\n```scm\r\nfunction_item [0, 0] - [2, 1]\r\n  name: identifier [0, 3] - [0, 7]\r\n  parameters: parameters [0, 7] - [0, 9]\r\n  body: block [0, 10] - [2, 1]\r\n    expression_statement [1, 4] - [1, 19]\r\n      macro_invocation [1, 4] - [1, 18]\r\n        macro: identifier [1, 4] - [1, 11]\r\n        token_tree [1, 12] - [1, 18]\r\n          string_literal [1, 13] - [1, 17]\r\n```\r\n\r\n### Neovim version (nvim -v)\r\n\r\nNVIM v0.9.5\r\n\r\n### Vim (not Nvim) behaves the same?\r\n\r\ntree sitter not supported in Vim\r\n\r\n### Operating system/version\r\n\r\nmacos 14.2.1\r\n\r\n### Terminal name/version\r\n\r\ntmux\r\n\r\n### $TERM environment variable\r\n\r\ntmux-256color-italic\r\n\r\n### Installation\r\n\r\nhttps://github.com/neovim/neovim/releases/tag/v0.9.5",
    "closed_at": "2024-01-25T01:22:53Z",
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "The above errors no matter what, tree-sitter, tree-sitter-rust, helix, or any version of neovim\r\n\r\nThe minimal test file for rust should be something of\r\n```rust\r\nfn main() {\r\n  println!(\"{}\", returns_string_hello());\r\n}\r\n```\r\n\r\nAdditionally, the issue is on nvim-treesitter's side for not following upstream queries. Not neovim",
            "created_at": "2024-01-24T03:17:14Z",
            "html_url": "https://github.com/neovim/neovim/issues/27159#issuecomment-1907286944",
            "id": 1907286944,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27159",
            "node_id": "IC_kwDOAPphoM5xruOg",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1907286944/reactions"
            },
            "updated_at": "2024-01-24T03:17:14Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1907286944",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/29790821?v=4",
                "events_url": "https://api.github.com/users/lucario387/events{/privacy}",
                "followers_url": "https://api.github.com/users/lucario387/followers",
                "following_url": "https://api.github.com/users/lucario387/following{/other_user}",
                "gists_url": "https://api.github.com/users/lucario387/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lucario387",
                "id": 29790821,
                "login": "lucario387",
                "node_id": "MDQ6VXNlcjI5NzkwODIx",
                "organizations_url": "https://api.github.com/users/lucario387/orgs",
                "received_events_url": "https://api.github.com/users/lucario387/received_events",
                "repos_url": "https://api.github.com/users/lucario387/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lucario387/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lucario387/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lucario387"
            }
        },
        {
            "author_association": "NONE",
            "body": "The above rust code does not error using `tree-sitter` 0.20.8 using https://github.com/tree-sitter/tree-sitter-rust/commit/e0e8b6de6e4aa354749c794f5f36a906dcccda74 (on macOS), instead it produces the tree below:\r\n```scm\r\n(source_file [0, 0] - [3, 0]\r\n  (function_item [0, 0] - [2, 1]\r\n    name: (identifier [0, 3] - [0, 7])\r\n    parameters: (parameters [0, 7] - [0, 9])\r\n    body: (block [0, 10] - [2, 1]\r\n      (expression_statement [1, 4] - [1, 19]\r\n        (macro_invocation [1, 4] - [1, 18]\r\n          macro: (identifier [1, 4] - [1, 11])\r\n          (token_tree [1, 12] - [1, 18]\r\n            (string_literal [1, 13] - [1, 17])))))))\r\n```",
            "created_at": "2024-01-24T04:17:04Z",
            "html_url": "https://github.com/neovim/neovim/issues/27159#issuecomment-1907350541",
            "id": 1907350541,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27159",
            "node_id": "IC_kwDOAPphoM5xr9wN",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1907350541/reactions"
            },
            "updated_at": "2024-01-24T04:23:47Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1907350541",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/11223234?v=4",
                "events_url": "https://api.github.com/users/mkatychev/events{/privacy}",
                "followers_url": "https://api.github.com/users/mkatychev/followers",
                "following_url": "https://api.github.com/users/mkatychev/following{/other_user}",
                "gists_url": "https://api.github.com/users/mkatychev/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mkatychev",
                "id": 11223234,
                "login": "mkatychev",
                "node_id": "MDQ6VXNlcjExMjIzMjM0",
                "organizations_url": "https://api.github.com/users/mkatychev/orgs",
                "received_events_url": "https://api.github.com/users/mkatychev/received_events",
                "repos_url": "https://api.github.com/users/mkatychev/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mkatychev/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mkatychev/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mkatychev"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> The above rust code does not error using `tree-sitter` 0.20.8 using [tree-sitter/tree-sitter-rust@e0e8b6d](https://github.com/tree-sitter/tree-sitter-rust/commit/e0e8b6de6e4aa354749c794f5f36a906dcccda74) (on macOS), instead it produces the tree below:\r\n\r\nYou may not know,  but the parsed tree of `tree-sitter` CLI does not account for injections, which is what causing the `(ERROR)` node \r\n\r\n",
            "created_at": "2024-01-24T04:30:44Z",
            "html_url": "https://github.com/neovim/neovim/issues/27159#issuecomment-1907358922",
            "id": 1907358922,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27159",
            "node_id": "IC_kwDOAPphoM5xr_zK",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1907358922/reactions"
            },
            "updated_at": "2024-01-24T04:30:44Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1907358922",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/29790821?v=4",
                "events_url": "https://api.github.com/users/lucario387/events{/privacy}",
                "followers_url": "https://api.github.com/users/lucario387/followers",
                "following_url": "https://api.github.com/users/lucario387/following{/other_user}",
                "gists_url": "https://api.github.com/users/lucario387/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lucario387",
                "id": 29790821,
                "login": "lucario387",
                "node_id": "MDQ6VXNlcjI5NzkwODIx",
                "organizations_url": "https://api.github.com/users/lucario387/orgs",
                "received_events_url": "https://api.github.com/users/lucario387/received_events",
                "repos_url": "https://api.github.com/users/lucario387/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lucario387/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lucario387/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lucario387"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Here is the parsed result of `:InspectTree` if I were to disable all injections\r\n```\r\n(function_item ; [1:1 - 4:1]\r\n  name: (identifier) ; [1:4 - 7]\r\n  parameters: (parameters) ; [1:8 - 9]\r\n  body: (block ; [1:11 - 4:1]\r\n    (expression_statement ; [2:3 - 17]\r\n      (macro_invocation ; [2:3 - 16]\r\n        macro: (identifier) ; [2:3 - 9]\r\n        (token_tree ; [2:11 - 16]\r\n          (string_literal)))) ; [2:12 - 15]\r\n```",
            "created_at": "2024-01-24T04:31:28Z",
            "html_url": "https://github.com/neovim/neovim/issues/27159#issuecomment-1907359381",
            "id": 1907359381,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27159",
            "node_id": "IC_kwDOAPphoM5xr_6V",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1907359381/reactions"
            },
            "updated_at": "2024-01-24T04:31:28Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1907359381",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/29790821?v=4",
                "events_url": "https://api.github.com/users/lucario387/events{/privacy}",
                "followers_url": "https://api.github.com/users/lucario387/followers",
                "following_url": "https://api.github.com/users/lucario387/following{/other_user}",
                "gists_url": "https://api.github.com/users/lucario387/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lucario387",
                "id": 29790821,
                "login": "lucario387",
                "node_id": "MDQ6VXNlcjI5NzkwODIx",
                "organizations_url": "https://api.github.com/users/lucario387/orgs",
                "received_events_url": "https://api.github.com/users/lucario387/received_events",
                "repos_url": "https://api.github.com/users/lucario387/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lucario387/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lucario387/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lucario387"
            }
        },
        {
            "author_association": "NONE",
            "body": "resolved by https://github.com/nvim-treesitter/nvim-treesitter/commit/41128a7724ec40a33ce01b133aec1e9928ca4312\r\n\r\nthanks for the turnaround @lucario387!\r\nGlad I was initially right! https://github.com/nvim-treesitter/nvim-treesitter/issues/5958#issuecomment-1905243017\r\n\r\nWould be helpful if `:InspectTree` returned `ERROR` nodes with data to see the source of the issue since nvim-treesitter overlaps queries from different sources:\r\n```scm\r\n(function_item) ; [1:1 - 3:1]\r\n name: (identifier) ; [1:4 - 7]\r\n parameters: (parameters) ; [1:8 - 9]\r\n body: (block) ; [1:11 - 3:1]\r\n  (expression_statement) ; [2:5 - 19]\r\n   (macro_invocation) ; [2:5 - 18]\r\n    macro: (identifier) ; [2:5 - 11]\r\n    (token_tree) ; [2:13 - 18]\r\n     (ERROR) ; [2:13 - 18] - source: injection.scm\r\n      (unit_expression) ; [2:13 - 18]\r\n     (string_literal) ; [2:14 - 17]\r\n```     ",
            "created_at": "2024-01-25T01:22:53Z",
            "html_url": "https://github.com/neovim/neovim/issues/27159#issuecomment-1909191825",
            "id": 1909191825,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27159",
            "node_id": "IC_kwDOAPphoM5xy_SR",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1909191825/reactions"
            },
            "updated_at": "2024-01-25T01:25:43Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1909191825",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/11223234?v=4",
                "events_url": "https://api.github.com/users/mkatychev/events{/privacy}",
                "followers_url": "https://api.github.com/users/mkatychev/followers",
                "following_url": "https://api.github.com/users/mkatychev/following{/other_user}",
                "gists_url": "https://api.github.com/users/mkatychev/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mkatychev",
                "id": 11223234,
                "login": "mkatychev",
                "node_id": "MDQ6VXNlcjExMjIzMjM0",
                "organizations_url": "https://api.github.com/users/mkatychev/orgs",
                "received_events_url": "https://api.github.com/users/mkatychev/received_events",
                "repos_url": "https://api.github.com/users/mkatychev/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mkatychev/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mkatychev/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mkatychev"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/27159/comments",
    "created_at": "2024-01-23T20:09:03Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/27159/events",
    "html_url": "https://github.com/neovim/neovim/issues/27159",
    "id": 2096897406,
    "labels": [
        {
            "color": "f9d0c4",
            "default": true,
            "description": "issues reporting wrong behavior",
            "id": 77997474,
            "name": "bug",
            "node_id": "MDU6TGFiZWw3Nzk5NzQ3NA==",
            "url": "https://api.github.com/repos/neovim/neovim/labels/bug"
        },
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 1799626557,
            "name": "treesitter",
            "node_id": "MDU6TGFiZWwxNzk5NjI2NTU3",
            "url": "https://api.github.com/repos/neovim/neovim/labels/treesitter"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/27159/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM58_B1-",
    "number": 27159,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/27159/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/27159/timeline",
    "title": "`vim.treesitter.inspect_tree()` produces an invalid CST for rust macros",
    "updated_at": "2024-01-25T01:25:43Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/27159",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/11223234?v=4",
        "events_url": "https://api.github.com/users/mkatychev/events{/privacy}",
        "followers_url": "https://api.github.com/users/mkatychev/followers",
        "following_url": "https://api.github.com/users/mkatychev/following{/other_user}",
        "gists_url": "https://api.github.com/users/mkatychev/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/mkatychev",
        "id": 11223234,
        "login": "mkatychev",
        "node_id": "MDQ6VXNlcjExMjIzMjM0",
        "organizations_url": "https://api.github.com/users/mkatychev/orgs",
        "received_events_url": "https://api.github.com/users/mkatychev/received_events",
        "repos_url": "https://api.github.com/users/mkatychev/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/mkatychev/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mkatychev/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/mkatychev"
    }
}