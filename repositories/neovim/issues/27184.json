{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Problem\n\nEditing cpp files can be remarkably slower when Treesitter highlighting is enabled.\r\n\r\nThere seems to a lot of invocation to on_bytes, and a lot of calls to tree:edit because all trees have their `tree:edit` method called, is this necessary? For notice: I'm rather new to neovim/treesitter development.\n\n### Steps to reproduce\n\nHave a cpp file with this content:\r\n```cpp\r\n#define A 0\r\n```\r\nrepeated for 2 lines (`tmp_2.cpp`) or 10 000 lines (`tmp_10000.cpp`).\r\n\r\nConfiguration file with only treesitter and nvim-profiler enabled:\r\n```vim\r\ncall plug#begin(stdpath('data') . '/treesitter_plugged')\r\nPlug 'nvim-treesitter/nvim-treesitter'\r\nPlug 'https://github.com/wookayin/nvim-profiler'\r\ncall plug#end()\r\n\r\nlua require('nvim-treesitter.configs').setup { highlight = {enable=true}}\r\n```\r\n\r\n## Scenario 1.\r\nVisually select all 10k lines and perform `<c-a>` to increment the number on each line, notice the significant delay until the command completes.\r\n\r\nWhen profiled from the command line with hyperfine we can see the different in time with treesitter highlight enabled/disabled.\r\n\r\n- Treesitter enabled: `239.3 ms`\r\n- Treesitter disabled: `25.8 ms`\r\n\r\n\r\n### Details treesitter enabled\r\n```console\r\n$ VIMRUNTIME=./runtime hyperfine --ignore-failure 'build/bin/nvim -u ~/.config/nvim/treesitter.vim ~/tmp_10000.cpp -c\"normal! V10000j^A\" -c\"cq\"'\r\nBenchmark 1: build/bin/nvim -u ~/.config/nvim/treesitter.vim ~/tmp.cpp -c\"normal! V10000j\" -c\"cq\"\r\n  Time (mean ± σ):     258.8 ms ±  15.1 ms    [User: 230.9 ms, System: 17.1 ms]\r\n  Range (min … max):   239.3 ms … 274.4 ms    10 runs\r\n  ```\r\n\r\n### Details treesitter disabled:\r\n```console\r\n$ VIMRUNTIME=./runtime hyperfine --ignore-failure 'build/bin/nvim -u ~/.config/nvim/treesitter.vim ~/tmp.cpp -c\"normal! V10000j^A\" -c\"cq\"'\r\nBenchmark 1: build/bin/nvim -u ~/.config/nvim/treesitter.vim ~/tmp.cpp -c\"normal! V10000j^A\" -c\"cq\"\r\n  Time (mean ± σ):      34.0 ms ±  10.2 ms    [User: 25.6 ms, System: 7.7 ms]\r\n  Range (min … max):    25.8 ms …  59.4 ms    49 runs\r\n  ```\r\n\r\nWhen profiled with `:LuaProfile run 3000` the top of the log says:\r\n```\r\n  181  ./runtime/lua/vim/treesitter/languagetree.lua:908\r\n  <-   180  ./runtime/lua/vim/treesitter/languagetree.lua:947 < ./runtime/lua/vim/treesitter/languagetree.lua:1005 < ./runtime/lua/vim/treesitter.lua:67\r\n  <-     1  ./runtime/lua/vim/treesitter/languagetree.lua:1005 < ./runtime/lua/vim/treesitter.lua:67\r\n```\r\n\r\nLooking at the code at line 908, we see:\r\n```lua       \r\n  print(\"#self._trees\", #self._trees)       \" < -- this print is inserted by me\r\n  for _, tree in pairs(self._trees) do\r\n    tree:edit(                                              \" <--- this is line 908\r\n      start_byte,\r\n      end_byte_old,\r\n      end_byte_new,\r\n      start_row,\r\n      start_col,\r\n      end_row_old,\r\n      end_col_old,\r\n      end_row_new,\r\n      end_col_new\r\n    )\r\n  end\r\n```\r\n  which is called after invoking on_bytes due to an edit (according to `runtime/doc/api.txt:2111`.\r\n\r\n## Scenario 2.\r\nPutting some prints in the runtime lua code to instrument number of calls being done and for loop iterations. Then run this\r\n1. open `tmp_10000.cpp`\r\n1. Modify window/textsize to only show 10 lines of code\r\n1. Visually select the first two lines\r\n1. Press  `<ctrl-a>` (only the first two lines are changed, no other line is actually modified or editted)\r\n\r\nOutput:\r\n```\r\n1\r\n#self._trees 1\r\n#self._trees 11\r\n2\r\n#self._trees 1\r\n#self._trees 11\r\n3\r\n#self._trees 1\r\n#self._trees 11\r\n4\r\n#self._trees 1\r\n#self._trees 11\r\n```\r\n\r\nStrangeness:\r\n- Why are there 4 calls and not 2 to `function LanguageTree:_on_bytes()`?\r\n- For each call, all trees visible in the window(?) + 1(why?), is iterated over. Is this necessary when actually onlt the first two lines changed?\r\n\r\nThe `:InspectTree` output for the `tmp_2.cpp` file looks like this:\r\n```\r\n(preproc_def ; [1:1 - 2:0]\r\n  name: (identifier) ; [1:9 - 9]\r\n  value: (preproc_arg ; [1:11 - 11]\r\n    (ERROR ; [1:11 - 11]\r\n      (number_literal)))) ; [1:11 - 11]\r\n(preproc_def ; [2:1 - 3:0]\r\n  name: (identifier) ; [2:9 - 9]\r\n  value: (preproc_arg ; [2:11 - 11]\r\n    (ERROR ; [2:11 - 11]\r\n      (number_literal)))) ; [2:11 - 11]\r\n```\n\n### Expected behavior\n\nTreesitter should not add much delay to simple editing commands.\n\n### Neovim version (nvim -v)\n\nNVIM v0.10.0-dev-2186+gb280d57db\n\n### Vim (not Nvim) behaves the same?\n\nno, related to treesitter\n\n### Operating system/version\n\nUbuntu 22.04\n\n### Terminal name/version\n\nWezterm\n\n### $TERM environment variable\n\nxterm-256color\n\n### Installation\n\nRelWithDebInfo build from repo",
    "closed_at": "2024-01-24T22:51:05Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Duplicate. Please search open (and closed) issues first.",
            "created_at": "2024-01-24T22:51:05Z",
            "html_url": "https://github.com/neovim/neovim/issues/27184#issuecomment-1909050191",
            "id": 1909050191,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27184",
            "node_id": "IC_kwDOAPphoM5xyctP",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1909050191/reactions"
            },
            "updated_at": "2024-01-24T22:51:05Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1909050191",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "(TL;DR: Edits invalidate all injections. Files with many injections -- comments, macros -- have known performance issues. Disable injections for such files as a workaround.)",
            "created_at": "2024-01-24T22:52:27Z",
            "html_url": "https://github.com/neovim/neovim/issues/27184#issuecomment-1909051749",
            "id": 1909051749,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27184",
            "node_id": "IC_kwDOAPphoM5xydFl",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1909051749/reactions"
            },
            "updated_at": "2024-01-24T22:52:27Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1909051749",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2361214?v=4",
                "events_url": "https://api.github.com/users/clason/events{/privacy}",
                "followers_url": "https://api.github.com/users/clason/followers",
                "following_url": "https://api.github.com/users/clason/following{/other_user}",
                "gists_url": "https://api.github.com/users/clason/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/clason",
                "id": 2361214,
                "login": "clason",
                "node_id": "MDQ6VXNlcjIzNjEyMTQ=",
                "organizations_url": "https://api.github.com/users/clason/orgs",
                "received_events_url": "https://api.github.com/users/clason/received_events",
                "repos_url": "https://api.github.com/users/clason/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/clason/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/clason/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/clason"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "To provide more explanation: this should be another instance of #27155 (tracked in #22426;  Injection queries are run too often -- Currently we run the full injection query on every edit to a buffer)\r\n\r\nNote that \"C preprocessors\" involves injections of the C lang itself:\r\n\r\n```\r\n((preproc_arg) @injection.content\r\n  (#set! injection.language \"c\"))\r\n```\r\n\r\n",
            "created_at": "2024-01-24T23:06:38Z",
            "html_url": "https://github.com/neovim/neovim/issues/27184#issuecomment-1909068618",
            "id": 1909068618,
            "issue_url": "https://api.github.com/repos/neovim/neovim/issues/27184",
            "node_id": "IC_kwDOAPphoM5xyhNK",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1909068618/reactions"
            },
            "updated_at": "2024-01-24T23:10:27Z",
            "url": "https://api.github.com/repos/neovim/neovim/issues/comments/1909068618",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1009873?v=4",
                "events_url": "https://api.github.com/users/wookayin/events{/privacy}",
                "followers_url": "https://api.github.com/users/wookayin/followers",
                "following_url": "https://api.github.com/users/wookayin/following{/other_user}",
                "gists_url": "https://api.github.com/users/wookayin/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/wookayin",
                "id": 1009873,
                "login": "wookayin",
                "node_id": "MDQ6VXNlcjEwMDk4NzM=",
                "organizations_url": "https://api.github.com/users/wookayin/orgs",
                "received_events_url": "https://api.github.com/users/wookayin/received_events",
                "repos_url": "https://api.github.com/users/wookayin/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/wookayin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/wookayin/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/wookayin"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/neovim/neovim/issues/27184/comments",
    "created_at": "2024-01-24T22:49:57Z",
    "events_url": "https://api.github.com/repos/neovim/neovim/issues/27184/events",
    "html_url": "https://github.com/neovim/neovim/issues/27184",
    "id": 2099245321,
    "labels": [
        {
            "color": "c5def5",
            "default": false,
            "description": "",
            "id": 1799626557,
            "name": "treesitter",
            "node_id": "MDU6TGFiZWwxNzk5NjI2NTU3",
            "url": "https://api.github.com/repos/neovim/neovim/labels/treesitter"
        },
        {
            "color": "e6e6e6",
            "default": false,
            "description": "issues that are closed as duplicates of other issues",
            "id": 3221613764,
            "name": "closed:duplicate",
            "node_id": "MDU6TGFiZWwzMjIxNjEzNzY0",
            "url": "https://api.github.com/repos/neovim/neovim/labels/closed:duplicate"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/neovim/issues/27184/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAPphoM59H_EJ",
    "number": 27184,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/neovim/issues/27184/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/neovim",
    "state": "closed",
    "state_reason": "not_planned",
    "timeline_url": "https://api.github.com/repos/neovim/neovim/issues/27184/timeline",
    "title": "Treesitter performance in cpp: editing with treesitter highlightning is noticably slow",
    "updated_at": "2024-01-24T23:10:27Z",
    "url": "https://api.github.com/repos/neovim/neovim/issues/27184",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/4508793?v=4",
        "events_url": "https://api.github.com/users/kaddkaka/events{/privacy}",
        "followers_url": "https://api.github.com/users/kaddkaka/followers",
        "following_url": "https://api.github.com/users/kaddkaka/following{/other_user}",
        "gists_url": "https://api.github.com/users/kaddkaka/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/kaddkaka",
        "id": 4508793,
        "login": "kaddkaka",
        "node_id": "MDQ6VXNlcjQ1MDg3OTM=",
        "organizations_url": "https://api.github.com/users/kaddkaka/orgs",
        "received_events_url": "https://api.github.com/users/kaddkaka/received_events",
        "repos_url": "https://api.github.com/users/kaddkaka/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/kaddkaka/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/kaddkaka/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/kaddkaka"
    }
}