{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "\r\nAs detailed in https://github.com/neovim/node-client/issues/342, there is still a problem of node-client sending data to nvim.exe in some scenarios with node-client 5.1.0. The problem described here is that after the https://github.com/neovim/node-client/issues/329 patch, when data is sent to nvim.exe, it does not crash nvim.exe anymore, however node.exe is terminated instead.\r\n\r\n# environment\r\n\r\nneovim version (nightly from \r\nhttps://github.com/neovim/neovim/releases/):\r\n\r\n```\r\nNVIM v0.10.0-dev-2698+g00e71d3da\r\nBuild type: RelWithDebInfo\r\nLuaJIT 2.1.1710088188\r\n```\r\n\r\nnode-client version: 5.1.0\r\n\r\nEnvironment variable defined: `ALLOW_CONSOLE=1` (without it, it does not trigger)\r\n\r\nnode: https://nodejs.org/dist/latest-v21.x/node-v21.7.1-x64.msi\r\n\r\n# nvim.exe receiving the data but not crashing\r\n\r\n```\r\n0:008> bp nvim!receive_msgpack+0xad \".printf \\\"size: 0x%lx\\\\n\\\", poi(rsi+6c0); db poi(rsi+6b8); g\"\r\n0:008> g\r\nsize: 0x16\r\n00000000`00000000  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????\r\n00000000`00000010  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????\r\n00000000`00000020  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????\r\n00000000`00000030  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????\r\n00000000`00000040  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????\r\n00000000`00000050  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????\r\n00000000`00000060  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????\r\n00000000`00000070  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????\r\nsize: 0x17\r\n00000105`39fe8e76  0a 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................\r\n00000105`39fe8e86  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................\r\n00000105`39fe8e96  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................\r\n00000105`39fe8ea6  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................\r\n00000105`39fe8eb6  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................\r\n00000105`39fe8ec6  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................\r\n00000105`39fe8ed6  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................\r\n00000105`39fe8ee6  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................\r\n(f84.4b74): Unknown exception - code e24c4a02 (first chance)\r\n```\r\n\r\nthen breaking manually into debugger:\r\n\r\n```\r\nntdll!DbgBreakPoint:\r\n00007ffa`199b0b10 cc              int     3\r\n0:001> k\r\n # Child-SP          RetAddr               Call Site\r\n00 00000004`027ffb68 00007ffa`199dca0e     ntdll!DbgBreakPoint\r\n01 00000004`027ffb70 00007ffa`18f17344     ntdll!DbgUiRemoteBreakin+0x4e\r\n02 00000004`027ffba0 00007ffa`199626b1     KERNEL32!BaseThreadInitThunk+0x14\r\n03 00000004`027ffbd0 00000000`00000000     ntdll!RtlUserThreadStart+0x21\r\n```\r\n\r\n# node.exe terminated\r\n\r\n```\r\n0:000> k\r\n # Child-SP          RetAddr               Call Site\r\n00 000000de`cc7ff788 00007ffa`1996da98     ntdll!NtTerminateProcess+0x14\r\n01 000000de`cc7ff790 00007ffa`18f1e3bb     ntdll!RtlExitUserProcess+0xb8\r\n02 000000de`cc7ff7c0 00007ff6`30c19ff9     KERNEL32!FatalExit+0xb\r\n03 000000de`cc7ff7f0 00007ff6`30c19fc4     node_exe!exit_or_terminate_process+0x31 [minkernel\\crts\\ucrt\\src\\appcrt\\startup\\exit.cpp @ 137] \r\n04 000000de`cc7ff820 00007ff6`30c046b7     node_exe!common_exit+0xc4 [minkernel\\crts\\ucrt\\src\\appcrt\\startup\\exit.cpp @ 274] \r\n05 000000de`cc7ff880 00007ffa`18f17344     node_exe!__scrt_common_main_seh+0x173 [D:\\a\\_work\\1\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl @ 295] \r\n06 000000de`cc7ff8c0 00007ffa`199626b1     KERNEL32!BaseThreadInitThunk+0x14\r\n07 000000de`cc7ff8f0 00000000`00000000     ntdll!RtlUserThreadStart+0x21\r\n```\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Not sure how this is different from https://github.com/neovim/node-client/issues/342\r\n\r\n> `ALLOW_CONSOLE=1` by definition will break a RPC channel because the \"console\" is stdout, which is also the RPC channel.\r\n> \r\n> It's documented at https://github.com/neovim/node-client?tab=readme-ov-file#logging but I'll make it clearer.\r\n\r\n# Proposal\r\n\r\nWe could try writing to stderr instead of stdout.",
            "created_at": "2024-03-26T14:21:50Z",
            "html_url": "https://github.com/neovim/node-client/issues/343#issuecomment-2020566990",
            "id": 2020566990,
            "issue_url": "https://api.github.com/repos/neovim/node-client/issues/343",
            "node_id": "IC_kwDOAdOzk854b2fO",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/neovim/node-client/issues/comments/2020566990/reactions"
            },
            "updated_at": "2024-03-26T16:08:47Z",
            "url": "https://api.github.com/repos/neovim/node-client/issues/comments/2020566990",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1359421?v=4",
                "events_url": "https://api.github.com/users/justinmk/events{/privacy}",
                "followers_url": "https://api.github.com/users/justinmk/followers",
                "following_url": "https://api.github.com/users/justinmk/following{/other_user}",
                "gists_url": "https://api.github.com/users/justinmk/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/justinmk",
                "id": 1359421,
                "login": "justinmk",
                "node_id": "MDQ6VXNlcjEzNTk0MjE=",
                "organizations_url": "https://api.github.com/users/justinmk/orgs",
                "received_events_url": "https://api.github.com/users/justinmk/received_events",
                "repos_url": "https://api.github.com/users/justinmk/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/justinmk/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/justinmk/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/justinmk"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/neovim/node-client/issues/343/comments",
    "created_at": "2024-03-26T14:13:11Z",
    "events_url": "https://api.github.com/repos/neovim/node-client/issues/343/events",
    "html_url": "https://github.com/neovim/node-client/issues/343",
    "id": 2208379607,
    "labels": [
        {
            "color": "c2e0c6",
            "default": true,
            "description": "",
            "id": 176078512,
            "name": "enhancement",
            "node_id": "MDU6TGFiZWwxNzYwNzg1MTI=",
            "url": "https://api.github.com/repos/neovim/node-client/labels/enhancement"
        }
    ],
    "labels_url": "https://api.github.com/repos/neovim/node-client/issues/343/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOAdOzk86DoTLX",
    "number": 343,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/neovim/node-client/issues/343/reactions"
    },
    "repository_url": "https://api.github.com/repos/neovim/node-client",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/neovim/node-client/issues/343/timeline",
    "title": "ALLOW_CONSOLE should write to stderr instead of stdout, to avoid breaking stdio RPC channel",
    "updated_at": "2024-03-26T16:09:24Z",
    "url": "https://api.github.com/repos/neovim/node-client/issues/343",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/387346?v=4",
        "events_url": "https://api.github.com/users/saidelike/events{/privacy}",
        "followers_url": "https://api.github.com/users/saidelike/followers",
        "following_url": "https://api.github.com/users/saidelike/following{/other_user}",
        "gists_url": "https://api.github.com/users/saidelike/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/saidelike",
        "id": 387346,
        "login": "saidelike",
        "node_id": "MDQ6VXNlcjM4NzM0Ng==",
        "organizations_url": "https://api.github.com/users/saidelike/orgs",
        "received_events_url": "https://api.github.com/users/saidelike/received_events",
        "repos_url": "https://api.github.com/users/saidelike/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/saidelike/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/saidelike/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/saidelike"
    }
}